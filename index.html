<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè™ Smart Pork Skewer Business Advisor</title>
    
    <!-- Firebase v9 Compat -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-compat-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-compat-firestore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-compat-auth.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Notification Container -->
    <div id="notification-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <i class="fas fa-circle-notch fa-spin"></i>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">
                    <i class="fas fa-utensils"></i>
                    Smart Pork Skewer Advisor
                </h1>
                <div class="header-stats">
                    <div class="stat-item">
                        <i class="fas fa-calendar-day"></i>
                        <span id="current-date"></span>
                    </div>
                    <div class="stat-item online-status" id="online-status">
                        <i class="fas fa-wifi"></i>
                        <span>Online</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
        <div class="container">
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
                </button>
                <button class="tab-btn" data-tab="tools">
                    <i class="fas fa-tools"></i>
                    <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span>
                </button>
                <button class="tab-btn" data-tab="sales">
                    <i class="fas fa-chart-line"></i>
                    <span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span>
                </button>
                <button class="tab-btn" data-tab="advisor">
                    <i class="fas fa-robot"></i>
                    <span>‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI</span>
                </button>
                <button class="tab-btn" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard-tab">
                <div class="dashboard-grid">
                    <!-- Today's Recommendations -->
                    <div class="card primary-card">
                        <div class="card-header">
                            <h3><i class="fas fa-star"></i> ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <button class="refresh-btn" id="refresh-recommendations">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="recommended-price" id="recommended-price">
                                <div class="price-value">‡∏ø15-20</div>
                                <div class="price-subtitle">‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ</div>
                            </div>
                            <div class="recommendation-details" id="recommendation-details">
                                <p>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 17:00-21:00 ‡∏ô.</p>
                                <p>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</p>
                            </div>
                        </div>
                    </div>

                    <!-- Market Prices -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-shopping-cart"></i> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏°‡∏π‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</h3>
                        </div>
                        <div class="card-body">
                            <div class="market-prices" id="market-prices">
                                <div class="price-item">
                                    <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô</span>
                                    <span class="price-value">‡∏ø180/‡∏Å‡∏Å.</span>
                                </div>
                                <div class="price-item">
                                    <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠</span>
                                    <span class="price-value">‡∏ø220/‡∏Å‡∏Å.</span>
                                </div>
                                <div class="price-item">
                                    <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡πÉ‡∏ô</span>
                                    <span class="price-value">‡∏ø250/‡∏Å‡∏Å.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weather Info -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-cloud-sun"></i> ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
                        </div>
                        <div class="card-body">
                            <div class="weather-info" id="weather-info">
                                <div class="weather-temp">28¬∞C</div>
                                <div class="weather-desc">‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™</div>
                                <div class="weather-details">
                                    <span><i class="fas fa-eye"></i> ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Ç‡∏≤‡∏¢</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profit Estimate -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-coins"></i> ‡∏Å‡∏≥‡πÑ‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</h3>
                        </div>
                        <div class="card-body">
                            <div class="profit-estimate" id="profit-estimate">
                                <div class="profit-value">‡∏ø800-1,200</div>
                                <div class="profit-subtitle">‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div>
                                <div class="profit-details">
                                    <small>‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 80-120 ‡πÑ‡∏°‡πâ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Tools Tab -->
            <div class="tab-content" id="tools-tab">
                <div class="tools-grid">
                    
                    <!-- Business Model Selection -->
                    <div class="card full-width">
                        <div class="card-header">
                            <h3><i class="fas fa-business-time"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h3>
                        </div>
                        <div class="card-body">
                            <div class="business-models">
                                <div class="model-option" data-model="manufacture">
                                    <div class="model-icon"><i class="fas fa-industry"></i></div>
                                    <h4>‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏≠‡∏á</h4>
                                    <p>‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏≠‡∏á</p>
                                    <div class="model-stats">
                                        <span>‡∏Å‡∏≥‡πÑ‡∏£: 60-70%</span>
                                        <span>‡∏•‡∏á‡∏ó‡∏∏‡∏ô: ‡∏™‡∏π‡∏á</span>
                                    </div>
                                </div>
                                <div class="model-option" data-model="resell">
                                    <div class="model-icon"><i class="fas fa-handshake"></i></div>
                                    <h4>‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Ç‡∏≤‡∏¢</h4>
                                    <p>‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏Ç‡∏≤‡∏¢</p>
                                    <div class="model-stats">
                                        <span>‡∏Å‡∏≥‡πÑ‡∏£: 30-40%</span>
                                        <span>‡∏•‡∏á‡∏ó‡∏∏‡∏ô: ‡∏Å‡∏•‡∏≤‡∏á</span>
                                    </div>
                                </div>
                                <div class="model-option" data-model="franchise">
                                    <div class="model-icon"><i class="fas fa-store"></i></div>
                                    <h4>‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå</h4>
                                    <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
                                    <div class="model-stats">
                                        <span>‡∏Å‡∏≥‡πÑ‡∏£: 40-50%</span>
                                        <span>‡∏•‡∏á‡∏ó‡∏∏‡∏ô: ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cost Calculator -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-calculator"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h3>
                        </div>
                        <div class="card-body">
                            <div class="calculator-form">
                                <div class="form-group">
                                    <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)</label>
                                    <input type="number" id="meat-price" value="200" min="0">
                                </div>
                                <div class="form-group">
                                    <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ (‡∏Å‡∏£‡∏±‡∏°)</label>
                                    <input type="number" id="weight-per-stick" value="80" min="0">
                                </div>
                                <div class="form-group">
                                    <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó/‡πÑ‡∏°‡πâ)</label>
                                    <input type="number" id="other-costs" value="3" min="0">
                                </div>
                                <button class="btn btn-primary" id="calculate-cost">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                                
                                <div class="calculation-result" id="cost-result">
                                    <div class="result-item">
                                        <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ:</span>
                                        <span class="result-value">‡∏ø19</span>
                                    </div>
                                    <div class="result-item">
                                        <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span>
                                        <span class="result-value">‡∏ø25-30</span>
                                    </div>
                                    <div class="result-item">
                                        <span>‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ:</span>
                                        <span class="result-value">‡∏ø6-11</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Business Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-pie"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h3>
                        </div>
                        <div class="card-body">
                            <div class="analysis-controls">
                                <div class="form-group">
                                    <label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡πÑ‡∏°‡πâ)</label>
                                    <input type="number" id="daily-target" value="100" min="0">
                                </div>
                                <div class="form-group">
                                    <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó/‡πÑ‡∏°‡πâ)</label>
                                    <input type="number" id="avg-selling-price" value="25" min="0">
                                </div>
                                <button class="btn btn-secondary" id="analyze-business">
                                    <span class="btn-text">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                                    <span class="btn-loading hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>
                                </button>
                            </div>
                            
                            <div class="analysis-result" id="analysis-result">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Tracking Tab -->
            <div class="tab-content" id="sales-tab">
                <div class="sales-grid">
                    
                    <!-- Daily Sales Entry -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-plus-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        </div>
                        <div class="card-body">
                            <div class="sales-form">
                                <div class="form-group">
                                    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</label>
                                    <input type="number" id="sticks-sold" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 85">
                                </div>
                                <div class="form-group">
                                    <label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" id="total-revenue" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2125">
                                </div>
                                <div class="form-group">
                                    <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                                    <input type="number" id="total-cost" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1275">
                                </div>
                                <div class="form-group">
                                    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                                    <textarea id="sales-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡∏ô‡∏ï‡∏Å ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢"></textarea>
                                </div>
                                <button class="btn btn-success" id="save-sales">
                                    <span class="btn-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</span>
                                    <span class="btn-loading hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 7-Day Sales History -->
                    <div class="card full-width">
                        <div class="card-header">
                            <h3><i class="fas fa-history"></i> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                            <button class="refresh-btn" id="refresh-sales-history">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="sales-history" id="sales-history">
                                <!-- Sales history will be populated here -->
                            </div>
                            <div class="sales-chart-container">
                                <canvas id="sales-chart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- AI Forecast -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-brain"></i> AI ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ</h3>
                        </div>
                        <div class="card-body">
                            <div class="forecast-content" id="forecast-content">
                                <div class="forecast-item">
                                    <div class="forecast-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
                                    <div class="forecast-value">90-110 ‡πÑ‡∏°‡πâ</div>
                                </div>
                                <div class="forecast-item">
                                    <div class="forecast-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</div>
                                    <div class="forecast-value">8-9 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</div>
                                </div>
                                <div class="forecast-recommendations">
                                    <h4>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</h4>
                                    <ul id="forecast-tips">
                                        <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô 5 ‡∏Å‡∏Å. ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠ 3 ‡∏Å‡∏Å.</li>
                                        <li>‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Advisor Tab -->
            <div class="tab-content" id="advisor-tab">
                <div class="advisor-container">
                    <div class="chat-container">
                        <div class="chat-header">
                            <h3><i class="fas fa-robot"></i> ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á</h3>
                            <button class="btn btn-outline" id="clear-chat">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
                        </div>
                        
                        <div class="chat-messages" id="chat-messages">
                            <div class="message bot-message">
                                <div class="message-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content">
                                    <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á</p>
                                    <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:</p>
                                    <ul>
                                        <li>‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</li>
                                        <li>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</li>
                                        <li>‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</li>
                                        <li>‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡πÄ‡∏•</li>
                                        <li>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</li>
                                    </ul>
                                    <p>‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏≤‡∏Å‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-input-container">
                            <div class="quick-questions">
                                <button class="quick-btn" data-question="‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î">‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?</button>
                                <button class="quick-btn" data-question="‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà">‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?</button>
                                <button class="quick-btn" data-question="‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£">‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</button>
                            </div>
                            <div class="chat-input">
                                <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
                                <button id="send-message" class="send-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <div class="settings-grid">
                    
                    <!-- API Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-key"></i> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API</h3>
                        </div>
                        <div class="card-body">
                            <div class="settings-form">
                                <div class="form-group">
                                    <label>OpenAI API Key</label>
                                    <input type="password" id="openai-api-key" placeholder="sk-...">
                                    <small>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI Advisor</small>
                                </div>
                                <div class="form-group">
                                    <label>Weather API Key</label>
                                    <input type="password" id="weather-api-key" placeholder="API Key">
                                    <small>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</small>
                                </div>
                                <button class="btn btn-primary" id="save-api-settings">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                            </div>
                        </div>
                    </div>

                    <!-- Shop Information -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-store"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="settings-form">
                                <div class="form-group">
                                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                                    <input type="text" id="shop-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á‡∏õ‡πâ‡∏≤‡∏™‡∏°">
                                </div>
                                <div class="form-group">
                                    <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                                    <textarea id="shop-address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                                    <input type="tel" id="shop-phone" placeholder="08x-xxx-xxxx">
                                </div>
                                <div class="form-group">
                                    <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î</label>
                                    <input type="text" id="shop-hours" placeholder="‡πÄ‡∏ä‡πà‡∏ô 16:00-22:00 ‡∏ô.">
                                </div>
                                <button class="btn btn-primary" id="save-shop-info">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-bell"></i> ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                        </div>
                        <div class="card-body">
                            <div class="settings-form">
                                <div class="form-group">
                                    <div class="switch-group">
                                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</label>
                                        <label class="switch">
                                            <input type="checkbox" id="daily-sales-reminder" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="switch-group">
                                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                                        <label class="switch">
                                            <input type="checkbox" id="price-alert" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="switch-group">
                                        <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</label>
                                        <label class="switch">
                                            <input type="checkbox" id="weather-alert" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <button class="btn btn-primary" id="save-notification-settings">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="card full-width">
                        <div class="card-header">
                            <h3><i class="fas fa-database"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                        </div>
                        <div class="card-body">
                            <div class="data-management">
                                <div class="management-actions">
                                    <button class="btn btn-info" id="export-data">
                                        <i class="fas fa-download"></i>
                                        ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    </button>
                                    <button class="btn btn-warning" id="backup-data">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    </button>
                                    <button class="btn btn-danger" id="clear-all-data">
                                        <i class="fas fa-trash-alt"></i>
                                        ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                    </button>
                                </div>
                                <div class="data-stats">
                                    <div class="stat-item">
                                        <span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</span>
                                        <span id="total-sales-records">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó:</span>
                                        <span id="total-chat-messages">0 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="firebase-config.js"></script>
    <script src="notification-system.js"></script>
    <script src="utils.js"></script>
    <script src="dashboard.js"></script>
    <script src="business-tools.js"></script>
    <script src="sales-tracking.js"></script>
    <script src="ai-advisor.js"></script>
    <script src="settings.js"></script>
    <script src="app.js"></script>
</body>
</html>

/* Thai Fonts */
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap');

/* CSS Variables */
:root {
    --primary-color: #FF6B35;
    --secondary-color: #F7931E;
    --accent-color: #FFD23F;
    --success-color: #06D6A0;
    --danger-color: #EF476F;
    --warning-color: #F77F00;
    --info-color: #118AB2;
    --dark-color: #073B4C;
    --light-color: #FFFFFF;
    --gray-100: #F8F9FA;
    --gray-200: #E9ECEF;
    --gray-300: #DEE2E6;
    --gray-400: #CED4DA;
    --gray-500: #ADB5BD;
    --gray-600: #6C757D;
    --gray-700: #495057;
    --gray-800: #343A40;
    --gray-900: #212529;
    
    --font-primary: 'Sarabun', sans-serif;
    --font-secondary: 'Prompt', sans-serif;
    --font-accent: 'Kanit', sans-serif;
    
    --border-radius: 12px;
    --box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    --box-shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    
    --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    --gradient-accent: linear-gradient(135deg, var(--accent-color), var(--warning-color));
    --gradient-success: linear-gradient(135deg, var(--success-color), #00B894);
    --gradient-danger: linear-gradient(135deg, var(--danger-color), #D63031);
}

/* Reset & Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-primary);
    font-size: 16px;
    line-height: 1.6;
    color: var(--gray-800);
    background: linear-gradient(135deg

, #f8fafc 0%, #e2e8f0 100%);
   min-height: 100vh;
   overflow-x: hidden;
}

.container {
   max-width: 1200px;
   margin: 0 auto;
   padding: 0 20px;
}

/* Notification System */
#notification-container {
   position: fixed;
   top: 20px;
   right: 20px;
   z-index: 10000;
   display: flex;
   flex-direction: column;
   gap: 10px;
   max-width: 400px;
   pointer-events: none;
}

.notification {
   background: white;
   border-radius: var(--border-radius);
   box-shadow: var(--box-shadow-hover);
   padding: 16px 20px;
   display: flex;
   align-items: center;
   gap: 12px;
   transform: translateX(420px);
   opacity: 0;
   transition: var(--transition);
   pointer-events: auto;
   border-left: 4px solid var(--info-color);
   min-height: 70px;
   position: relative;
   overflow: hidden;
}

.notification.show {
   transform: translateX(0);
   opacity: 1;
}

.notification.success {
   border-left-color: var(--success-color);
}

.notification.error {
   border-left-color: var(--danger-color);
}

.notification.warning {
   border-left-color: var(--warning-color);
}

.notification .notification-icon {
   font-size: 20px;
   color: var(--info-color);
   min-width: 20px;
}

.notification.success .notification-icon {
   color: var(--success-color);
}

.notification.error .notification-icon {
   color: var(--danger-color);
}

.notification.warning .notification-icon {
   color: var(--warning-color);
}

.notification .notification-content {
   flex: 1;
}

.notification .notification-title {
   font-weight: 600;
   font-size: 14px;
   margin-bottom: 4px;
   color: var(--gray-800);
}

.notification .notification-message {
   font-size: 13px;
   color: var(--gray-600);
   line-height: 1.4;
}

.notification .notification-close {
   background: none;
   border: none;
   color: var(--gray-400);
   cursor: pointer;
   font-size: 16px;
   padding: 4px;
   border-radius: 4px;
   transition: var(--transition);
   min-width: 24px;
   height: 24px;
   display: flex;
   align-items: center;
   justify-content: center;
}

.notification .notification-close:hover {
   color: var(--gray-600);
   background: var(--gray-100);
}

.notification .notification-progress {
   position: absolute;
   bottom: 0;
   left: 0;
   height: 3px;
   background: var(--info-color);
   width: 100%;
   transform-origin: left;
   animation: notificationProgress 5s linear forwards;
}

.notification.success .notification-progress {
   background: var(--success-color);
}

.notification.error .notification-progress {
   background: var(--danger-color);
}

.notification.warning .notification-progress {
   background: var(--warning-color);
}

@keyframes notificationProgress {
   to {
       transform: scaleX(0);
   }
}

/* Loading Overlay */
.loading-overlay {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background: rgba(255, 255, 255, 0.9);
   backdrop-filter: blur(4px);
   display: flex;
   align-items: center;
   justify-content: center;
   z-index: 9999;
   transition: var(--transition);
}

.loading-overlay.hidden {
   opacity: 0;
   pointer-events: none;
}

.loading-spinner {
   text-align: center;
   color: var(--primary-color);
}

.loading-spinner i {
   font-size: 48px;
   margin-bottom: 16px;
   display: block;
}

.loading-spinner p {
   font-size: 16px;
   font-weight: 500;
}

/* Header */
.header {
   background: var(--gradient-primary);
   color: white;
   padding: 20px 0;
   box-shadow: var(--box-shadow);
   position: relative;
   overflow: hidden;
}

.header::before {
   content: '';
   position: absolute;
   top: 0;
   left: 0;
   right: 0;
   bottom: 0;
   background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
   opacity: 0.1;
}

.header-content {
   display: flex;
   justify-content: space-between;
   align-items: center;
   position: relative;
   z-index: 1;
}

.logo {
   font-family: var(--font-accent);
   font-size: 28px;
   font-weight: 700;
   display: flex;
   align-items: center;
   gap: 12px;
}

.logo i {
   font-size: 32px;
   filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.header-stats {
   display: flex;
   gap: 24px;
   align-items: center;
}

.stat-item {
   display: flex;
   align-items: center;
   gap: 8px;
   font-size: 14px;
   font-weight: 500;
   opacity: 0.9;
}

.stat-item i {
   font-size: 16px;
}

.online-status.offline {
   color: var(--danger-color);
}

.online-status.offline i {
   animation: pulse 2s infinite;
}

@keyframes pulse {
   0%, 100% { opacity: 1; }
   50% { opacity: 0.5; }
}

/* Navigation Tabs */
.nav-tabs {
   background: white;
   box-shadow: 0 2px 8px rgba(0,0,0,0.06);
   position: sticky;
   top: 0;
   z-index: 100;
}

.tab-buttons {
   display: flex;
   gap: 0;
   overflow-x: auto;
   scrollbar-width: none;
   -ms-overflow-style: none;
}

.tab-buttons::-webkit-scrollbar {
   display: none;
}

.tab-btn {
   background: none;
   border: none;
   padding: 16px 24px;
   display: flex;
   flex-direction: column;
   align-items: center;
   gap: 6px;
   cursor: pointer;
   transition: var(--transition);
   border-bottom: 3px solid transparent;
   min-width: 120px;
   font-family: var(--font-primary);
   font-size: 13px;
   font-weight: 500;
   color: var(--gray-600);
   position: relative;
   flex-shrink: 0;
}

.tab-btn i {
   font-size: 20px;
   transition: var(--transition);
}

.tab-btn:hover {
   color: var(--primary-color);
   background: var(--gray-100);
}

.tab-btn.active {
   color: var(--primary-color);
   border-bottom-color: var(--primary-color);
   background: linear-gradient(to bottom, rgba(255, 107, 53, 0.05), transparent);
}

.tab-btn.active i {
   transform: scale(1.1);
}

/* Main Content */
.main-content {
   padding: 32px 0;
   min-height: calc(100vh - 200px);
}

.tab-content {
   display: none;
   animation: fadeInUp 0.5s ease-out;
}

.tab-content.active {
   display: block;
}

@keyframes fadeInUp {
   from {
       opacity: 0;
       transform: translateY(20px);
   }
   to {
       opacity: 1;
       transform: translateY(0);
   }
}

/* Cards */
.card {
   background: white;
   border-radius: var(--border-radius);
   box-shadow: var(--box-shadow);
   overflow: hidden;
   transition: var(--transition);
   border: 1px solid var(--gray-200);
}

.card:hover {
   box-shadow: var(--box-shadow-hover);
   transform: translateY(-2px);
}

.card.primary-card {
   background: var(--gradient-primary);
   color: white;
   border: none;
}

.card.primary-card .card-header h3 {
   color: white;
}

.card-header {
   padding: 20px 24px 16px;
   border-bottom: 1px solid var(--gray-200);
   display: flex;
   justify-content: space-between;
   align-items: center;
}

.card.primary-card .card-header {
   border-bottom-color: rgba(255, 255, 255, 0.2);
}

.card-header h3 {
   font-family: var(--font-secondary);
   font-size: 18px;
   font-weight: 600;
   color: var(--gray-800);
   display: flex;
   align-items: center;
   gap: 10px;
}

.card-header h3 i {
   font-size: 20px;
   color: var(--primary-color);
}

.card.primary-card .card-header h3 i {
   color: white;
}

.card-body {
   padding: 24px;
}

.refresh-btn {
   background: none;
   border: 1px solid var(--gray-300);
   border-radius: 8px;
   padding: 8px 12px;
   cursor: pointer;
   transition: var(--transition);
   color: var(--gray-600);
   font-size: 14px;
}

.refresh-btn:hover {
   background: var(--gray-100);
   border-color: var(--gray-400);
}

.card.primary-card .refresh-btn {
   border-color: rgba(255, 255, 255, 0.3);
   color: white;
}

.card.primary-card .refresh-btn:hover {
   background: rgba(255, 255, 255, 0.1);
   border-color: rgba(255, 255, 255, 0.5);
}

.refresh-btn.loading i {
   animation: spin 1s linear infinite;
}

@keyframes spin {
   to {
       transform: rotate(360deg);
   }
}

/* Grid Layouts */
.dashboard-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
   gap: 24px;
}

.tools-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
   gap: 24px;
}

.sales-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
   gap: 24px;
}

.settings-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
   gap: 24px;
}

.full-width {
   grid-column: 1 / -1;
}

/* Dashboard Components */
.recommended-price {
   text-align: center;
   margin-bottom: 20px;
}

.price-value {
   font-size: 36px;
   font-weight: 700;
   font-family: var(--font-accent);
   margin-bottom: 4px;
}

.price-subtitle {
   font-size: 14px;
   opacity: 0.8;
}

.recommendation-details {
   text-align: center;
}

.recommendation-details p {
   margin-bottom: 8px;
   font-size: 14px;
   opacity: 0.9;
}

.market-prices {
   display: flex;
   flex-direction: column;
   gap: 12px;
}

.price-item {
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 12px 16px;
   background: var(--gray-100);
   border-radius: 8px;
   transition: var(--transition);
}

.price-item:hover {
   background: var(--gray-200);
}

.price-label {
   font-weight: 500;
   color: var(--gray-700);
}

.price-value {
   font-weight: 600;
   font-family: var(--font-accent);
   color: var(--primary-color);
}

.weather-info {
   text-align: center;
}

.weather-temp {
   font-size: 32px;
   font-weight: 700;
   font-family: var(--font-accent);
   color: var(--primary-color);
   margin-bottom: 8px;
}

.weather-desc {
   font-size: 16px;
   font-weight: 500;
   margin-bottom: 12px;
   color: var(--gray-700);
}

.weather-details {
   font-size: 14px;
   color: var(--success-color);
   font-weight: 500;
}

.profit-estimate {
   text-align: center;
}

.profit-estimate .profit-value {
   font-size: 28px;
   font-weight: 700;
   font-family: var(--font-accent);
   color: var(--success-color);
   margin-bottom: 4px;
}

.profit-subtitle {
   font-size: 14px;
   color: var(--gray-600);
   margin-bottom: 8px;
}

.profit-details {
   font-size: 12px;
   color: var(--gray-500);
}

/* Business Tools */
.business-models {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
   gap: 16px;
}

.model-option {
   background: var(--gray-100);
   border-radius: var(--border-radius);
   padding: 20px;
   text-align: center;
   cursor: pointer;
   transition: var(--transition);
   border: 2px solid transparent;
}

.model-option:hover {
   background: var(--gray-200);
   transform: translateY(-2px);
}

.model-option.selected {
   border-color: var(--primary-color);
   background: rgba(255, 107, 53, 0.1);
}

.model-icon {
   font-size: 32px;
   color: var(--primary-color);
   margin-bottom: 12px;
}

.model-option h4 {
   font-family: var(--font-secondary);
   font-size: 16px;
   font-weight: 600;
   margin-bottom: 8px;
   color: var(--gray-800);
}

.model-option p {
   font-size: 14px;
   color: var(--gray-600);
   margin-bottom: 12px;
   line-height: 1.4;
}

.model-stats {
   display: flex;
   justify-content: space-around;
   font-size: 12px;
   font-weight: 500;
}

.model-stats span {
   padding: 4px 8px;
   background: white;
   border-radius: 6px;
   color: var(--gray-700);
}

/* Form Elements */
.form-group {
   margin-bottom: 20px;
}

.form-group label {
   display: block;
   margin-bottom: 8px;
   font-weight: 500;
   color: var(--gray-700);
   font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
   width: 100%;
   padding: 12px 16px;
   border: 2px solid var(--gray-300);
   border-radius: 8px;
   font-size: 14px;
   font-family: var(--font-primary);
   transition: var(--transition);
   background: white;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
   outline: none;
   border-color: var(--primary-color);
   box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}

.form-group textarea {
   resize: vertical;
   min-height: 80px;
}

.form-group small {
   display: block;
   margin-top: 4px;
   font-size: 12px;
   color: var(--gray-500);
}

/* Buttons */
.btn {
   background: var(--primary-color);
   color: white;
   border: none;
   padding: 12px 24px;
   border-radius: 8px;
   font-size: 14px;
   font-weight: 500;
   font-family: var(--font-primary);
   cursor: pointer;
   transition: var(--transition);
   display: inline-flex;
   align-items: center;
   justify-content: center;
   gap: 8px;
   min-height: 44px;
   position: relative;
   overflow: hidden;
}

.btn:hover {
   background: var(--secondary-color);
   transform: translateY(-1px);
   box-shadow: var(--box-shadow);
}

.btn:active {
   transform: translateY(0);
}

.btn:disabled {
   opacity: 0.6;
   cursor: not-allowed;
   transform: none;
}

.btn-secondary {
   background: var(--gray-600);
}

.btn-secondary:hover {
   background: var(--gray-700);
}

.btn-success {
   background: var(--success-color);
}

.btn-success:hover {
   background: #00B894;
}

.btn-danger {
   background: var(--danger-color);
}

.btn-danger:hover {
   background: #D63031;
}

.btn-warning {
   background: var(--warning-color);
}

.btn-warning:hover {
   background: #E17000;
}

.btn-info {
   background: var(--info-color);
}

.btn-info:hover {
   background: #0F7A9A;
}

.btn-outline {
   background: transparent;
   color: var(--primary-color);
   border: 2px solid var(--primary-color);
}

.btn-outline:hover {
   background: var(--primary-color);
   color: white;
}

.btn .btn-loading {
   position: absolute;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
}

.btn .btn-loading.hidden {
   display: none;
}

.btn.loading .btn-text {
   opacity: 0;
}

.btn.loading .btn-loading {
   display: block;
}

/* Switch Component */
.switch-group {
   display: flex;
   justify-content: space-between;
   align-items: center;
}

.switch {
   position: relative;
   display: inline-block;
   width: 50px;
   height: 24px;
}

.switch input {
   opacity: 0;
   width: 0;
   height: 0;
}

.slider {
   position: absolute;
   cursor: pointer;
   top: 0;
   left: 0;
   right: 0;
   bottom: 0;
   background-color: var(--gray-400);
   transition: var(--transition);
   border-radius: 24px;
}

.slider:before {
   position: absolute;
   content: "";
   height: 18px;
   width: 18px;
   left: 3px;
   bottom: 3px;
   background-color: white;
   transition: var(--transition);
   border-radius: 50%;
}

input:checked + .slider {
   background-color: var(--success-color);
}

input:checked + .slider:before {
   transform: translateX(26px);
}

/* Responsive Design */
@media (max-width: 768px) {
   .container {
       padding: 0 16px;
   }
   
   .header-content {
       flex-direction: column;
       gap: 16px;
       text-align: center;
   }
   
   .logo {
       font-size: 24px;
   }
   
   .tab-btn {
       min-width: 100px;
       padding: 12px 16px;
       font-size: 12px;
   }
   
   .dashboard-grid,
   .tools-grid,
   .sales-grid,
   .settings-grid {
       grid-template-columns: 1fr;
       gap: 16px;
   }
   
   .business-models {
       grid-template-columns: 1fr;
   }
   
   .main-content {
       padding: 20px 0;
   }
   
   .card-body {
       padding: 16px;
   }
   
   #notification-container {
       left: 16px;
       right: 16px;
       max-width: none;
   }
   
   .notification {
       transform: translateY(-100px);
   }
   
   .notification.show {
       transform: translateY(0);
   }
}

/* Utility Classes */
.hidden {
   display: none !important;
}

.text-center {
   text-align: center;
}

.text-right {
   text-align: right;
}

.font-weight-bold {
   font-weight: 600;
}

.text-muted {
   color: var(--gray-500);
}

.text-primary {
   color: var(--primary-color);
}

.text-success {
   color: var(--success-color);
}

.text-danger {
   color: var(--danger-color);
}

.text-warning {
   color: var(--warning-color);
}

.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 16px; }
.mb-3 { margin-bottom: 24px; }
.mb-4 { margin-bottom: 32px; }

.mt-0 { margin-top: 0; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }
.mt-4 { margin-top: 32px; }

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDFETQF_lUuU_HeUa_9pnpAkDyMATUKB7g",
    authDomain: "pork-pricing-app.firebaseapp.com",
    projectId: "pork-pricing-app",
    storageBucket: "pork-pricing-app.firebasestorage.app",
    messagingSenderId: "604634104081",
    appId: "1:604634104081:web:cc318ac88d381cf4384cb0",
    measurementId: "G-0224PTLW7P"
};

// Initialize Firebase
let db = null;
let auth = null;
let isOfflineMode = false;

async function initializeFirebase() {
    try {
        // Initialize Firebase App
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Initialize Firestore
        db = firebase.firestore();
        
        // Enable offline persistence
        try {
            await db.enablePersistence({
                synchronizeTabs: true
            });
            console.log('‚úÖ Firebase offline persistence enabled');
        } catch (err) {
            if (err.code === 'failed-precondition') {
                console.warn('‚ö†Ô∏è Multiple tabs open, persistence only enabled in one tab');
            } else if (err.code === 'unimplemented') {
                console.warn('‚ö†Ô∏è Browser doesn\'t support offline persistence');
            }
        }
        
        // Initialize Auth
        auth = firebase.auth();
        
        // Sign in anonymously
        try {
            const userCredential = await auth.signInAnonymously();
            console.log('‚úÖ Signed in anonymously:', userCredential.user.uid);
        } catch (error) {
            console.error('‚ùå Anonymous sign-in failed:', error);
            isOfflineMode = true;
        }
        
        // Monitor connection state
        const connectedRef = db.ref('.info/connected');
        if (connectedRef) {
            connectedRef.on('value', (snapshot) => {
                const connected = snapshot.val();
                updateConnectionStatus(connected);
            });
        }
        
        // Set up auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('‚úÖ User authenticated:', user.uid);
                isOfflineMode = false;
            } else {
                console.log('‚ö†Ô∏è User not authenticated, switching to offline mode');
                isOfflineMode = true;
            }
            updateConnectionStatus(!isOfflineMode);
        });
        
        return true;
    } catch (error) {
        console.error('‚ùå Firebase initialization failed:', error);
        isOfflineMode = true;
        updateConnectionStatus(false);
        return false;
    }
}

function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('online-status');
    if (statusElement) {
        if (connected && !isOfflineMode) {
            statusElement.className = 'stat-item online-status';
            statusElement.innerHTML = '<i class="fas fa-wifi"></i><span>Online</span>';
        } else {
            statusElement.className = 'stat-item online-status offline';
            statusElement.innerHTML = '<i class="fas fa-wifi"></i><span>Offline</span>';
        }
    }
}

// Firebase utility functions with error handling and timeout
async function firebaseOperation(operation, timeout = 10000) {
    if (isOfflineMode) {
        throw new Error('‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
    }
    
    return new Promise(async (resolve, reject) => {
        const timeoutId = setTimeout(() => {
            reject(new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'));
        }, timeout);
        
        try {
            const result = await operation();
            clearTimeout(timeoutId);
            resolve(result);
        } catch (error) {
            clearTimeout(timeoutId);
            reject(error);
        }
    });
}

// Save data to Firestore with error handling
async function saveToFirestore(collection, data, docId = null) {
    return firebaseOperation(async () => {
        const user = auth.currentUser;
        if (!user) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }
        
        const dataWithMetadata = {
            ...data,
            userId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (docId) {
            await db.collection(collection).doc(docId).set(dataWithMetadata, { merge: true });
            return docId;
        } else {
            const docRef = await db.collection(collection).add(dataWithMetadata);
            return docRef.id;
        }
    });
}

// Get data from Firestore with error handling
async function getFromFirestore(collection, docId = null, orderBy = null, limit = null) {
    return firebaseOperation(async () => {
        const user = auth.currentUser;
        if (!user) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }
        
        let query = db.collection(collection).where('userId', '==', user.uid);
        
        if (orderBy) {
            query = query.orderBy(orderBy.field, orderBy.direction || 'desc');
        }
        
        if (limit) {
            query = query.limit(limit);
        }
        
        if (docId) {
            const doc = await db.collection(collection).doc(docId).get();
            if (doc.exists && doc.data().userId === user.uid) {
                return { id: doc.id, ...doc.data() };
            } else {
                throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');
            }
        } else {
            const snapshot = await query.get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
    });
}

// Delete data from Firestore with error handling
async function deleteFromFirestore(collection, docId) {
    return firebaseOperation(async () => {
        const user = auth.currentUser;
        if (!user) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }
        
        const doc = await db.collection(collection).doc(docId).get();
        if (doc.exists && doc.data().userId === user.uid) {
            await db.collection(collection).doc(docId).delete();
            return true;
        } else {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ

}
   });
}

// Local storage fallback for offline mode
const localStorageKeys = {
   SALES_DATA: 'pork_advisor_sales',
   SHOP_INFO: 'pork_advisor_shop_info',
   SETTINGS: 'pork_advisor_settings',
   CHAT_HISTORY: 'pork_advisor_chat',
   API_KEYS: 'pork_advisor_api_keys'
};

function saveToLocalStorage(key, data) {
   try {
       const dataWithTimestamp = {
           ...data,
           timestamp: Date.now(),
           offline: true
       };
       localStorage.setItem(key, JSON.stringify(dataWithTimestamp));
       return true;
   } catch (error) {
       console.error('‚ùå Failed to save to localStorage:', error);
       return false;
   }
}

function getFromLocalStorage(key) {
   try {
       const data = localStorage.getItem(key);
       return data ? JSON.parse(data) : null;
   } catch (error) {
       console.error('‚ùå Failed to get from localStorage:', error);
       return null;
   }
}

function removeFromLocalStorage(key) {
   try {
       localStorage.removeItem(key);
       return true;
   } catch (error) {
       console.error('‚ùå Failed to remove from localStorage:', error);
       return false;
   }
}

// Hybrid save function (tries Firebase first, falls back to localStorage)
async function hybridSave(collection, data, docId = null, localKey = null) {
   try {
       // Try Firebase first
       const result = await saveToFirestore(collection, data, docId);
       
       // Also save to localStorage as backup
       if (localKey) {
           saveToLocalStorage(localKey, data);
       }
       
       return result;
   } catch (error) {
       console.warn('‚ö†Ô∏è Firebase save failed, using localStorage:', error.message);
       
       // Fall back to localStorage
       if (localKey) {
           const success = saveToLocalStorage(localKey, data);
           if (success) {
               throw new Error('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
           }
       }
       
       throw error;
   }
}

// Hybrid get function (tries Firebase first, falls back to localStorage)
async function hybridGet(collection, docId = null, orderBy = null, limit = null, localKey = null) {
   try {
       // Try Firebase first
       return await getFromFirestore(collection, docId, orderBy, limit);
   } catch (error) {
       console.warn('‚ö†Ô∏è Firebase get failed, using localStorage:', error.message);
       
       // Fall back to localStorage
       if (localKey) {
           const localData = getFromLocalStorage(localKey);
           if (localData) {
               // Return in Firebase-like format
               return Array.isArray(localData) ? localData : [localData];
           }
       }
       
       throw error;
   }
}

// Initialize Firebase when the page loads
document.addEventListener('DOMContentLoaded', initializeFirebase);

// Export functions for use in other modules
window.firebaseUtils = {
   saveToFirestore,
   getFromFirestore,
   deleteFromFirestore,
   firebaseOperation,
   hybridSave,
   hybridGet,
   saveToLocalStorage,
   getFromLocalStorage,
   removeFromLocalStorage,
   localStorageKeys,
   isOfflineMode: () => isOfflineMode,
   getAuth: () => auth,
   getDb: () => db
};

// Advanced Notification System with Queue Management
class NotificationSystem {
    constructor() {
        this.container = null;
        this.queue = [];
        this.activeNotifications = [];
        this.maxNotifications = 5;
        this.defaultDuration = 5000;
        this.spacing = 10;
        this.init();
    }

    init() {
        this.container = document.getElementById('notification-container');
        if (!this.container) {
            console.error('‚ùå Notification container not found');
            return;
        }
    }

    show(message, type = 'info', duration = null, title = null) {
        const notification = {
            id: this.generateId(),
            message,
            type,
            title,
            duration: duration || this.defaultDuration,
            timestamp: Date.now()
        };

        // Add to queue
        this.queue.push(notification);
        this.processQueue();

        return notification.id;
    }

    processQueue() {
        // Process queue if we have space for more notifications
        while (this.queue.length > 0 && this.activeNotifications.length < this.maxNotifications) {
            const notification = this.queue.shift();
            this.displayNotification(notification);
        }
    }

    displayNotification(notification) {
        const element = this.createNotificationElement(notification);
        this.container.appendChild(element);
        this.activeNotifications.push({ ...notification, element });

        // Position all notifications
        this.repositionNotifications();

        // Show with animation
        requestAnimationFrame(() => {
            element.classList.add('show');
        });

        // Auto remove after duration
        setTimeout(() => {
            this.remove(notification.id);
        }, notification.duration);
    }

    createNotificationElement(notification) {
        const element = document.createElement('div');
        element.className = `notification ${notification.type}`;
        element.setAttribute('data-id', notification.id);

        const iconMap = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };

        const icon = iconMap[notification.type] || iconMap.info;

        element.innerHTML = `
            <div class="notification-icon">
                <i class="${icon}"></i>
            </div>
            <div class="notification-content">
                ${notification.title ? `<div class="notification-title">${notification.title}</div>` : ''}
                <div class="notification-message">${notification.message}</div>
            </div>
            <button class="notification-close" onclick="notificationSystem.remove('${notification.id}')">
                <i class="fas fa-times"></i>
            </button>
            <div class="notification-progress"></div>
        `;

        return element;
    }

    repositionNotifications() {
        let currentTop = 0;
        
        this.activeNotifications.forEach((notification, index) => {
            if (notification.element && notification.element.parentNode) {
                notification.element.style.transform = `translateX(0) translateY(${currentTop}px)`;
                currentTop += notification.element.offsetHeight + this.spacing;
            }
        });
    }

    remove(notificationId) {
        const index = this.activeNotifications.findIndex(n => n.id === notificationId);
        
        if (index === -1) return;

        const notification = this.activeNotifications[index];
        const element = notification.element;

        if (element && element.parentNode) {
            // Animate out
            element.style.transform = 'translateX(420px)';
            element.style.opacity = '0';

            setTimeout(() => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
                
                // Remove from active list
                this.activeNotifications.splice(index, 1);
                
                // Reposition remaining notifications
                this.repositionNotifications();
                
                // Process queue for any waiting notifications
                this.processQueue();
            }, 300);
        } else {
            // Remove from active list immediately if element doesn't exist
            this.activeNotifications.splice(index, 1);
            this.processQueue();
        }
    }

    clear() {
        this.queue = [];
        this.activeNotifications.forEach(notification => {
            if (notification.element && notification.element.parentNode) {
                notification.element.parentNode.removeChild(notification.element);
            }
        });
        this.activeNotifications = [];
    }

    generateId() {
        return 'notification_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Convenience methods
    success(message, title = null, duration = null) {
        return this.show(message, 'success', duration, title);
    }

    error(message, title = null, duration = null) {
        return this.show(message, 'error', duration || 8000, title);
    }

    warning(message, title = null, duration = null) {
        return this.show(message, 'warning', duration || 6000, title);
    }

    info(message, title = null, duration = null) {
        return this.show(message, 'info', duration, title);
    }

    // For loading states
    loading(message, title = null) {
        return this.show(message, 'info', 0, title); // 0 duration means manual removal
    }

    // Update existing notification
    update(notificationId, message, type = null, title = null) {
        const notification = this.activeNotifications.find(n => n.id === notificationId);
        if (notification && notification.element) {
            const contentElement = notification.element.querySelector('.notification-content');
            if (contentElement) {
                contentElement.innerHTML = `
                    ${title ? `<div class="notification-title">${title}</div>` : ''}
                    <div class="notification-message">${message}</div>
                `;
            }

            if (type && type !== notification.type) {
                notification.element.className = `notification ${type}`;
                notification.type = type;
            }
        }
    }
}

// Create global instance
const notificationSystem = new NotificationSystem();

// Export for use in other modules
window.notificationSystem = notificationSystem;

// Helper functions for backward compatibility
window.showNotification = (message, type = 'info', duration = null, title = null) => {
    return notificationSystem.show(message, type, duration, title);
};

window.showSuccess = (message, title = null) => {
    return notificationSystem.success(message, title);
};

window.showError = (message, title = null) => {
    return notificationSystem.error(message, title);
};

window.showWarning = (message, title = null) => {
    return notificationSystem.warning(message, title);
};

window.showInfo = (message, title = null) => {
    return notificationSystem.info(message, title);
};

// Utility Functions for Pork Skewer Business Advisor
class Utils {
    constructor() {
        this.thaiMonths = [
            '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
            '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
        ];
        
        this.thaiDays = [
            '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'
        ];
    }

    // Format number to Thai currency
    formatCurrency(amount, showUnit = true) {
        try {
            const formatted = new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount);
            
            return showUnit ? `‡∏ø${formatted}` : formatted;
        } catch (error) {
            console.error('‚ùå Currency formatting error:', error);
            return showUnit ? `‡∏ø${amount}` : amount.toString();
        }
    }

    // Format date to Thai format
    formatThaiDate(date = null, includeTime = false) {
        try {
            const targetDate = date ? new Date(date) : new Date();
            
            if (isNaN(targetDate.getTime())) {
                throw new Error('Invalid date');
            }

            const day = targetDate.getDate();
            const month = this.thaiMonths[targetDate.getMonth()];
            const year = targetDate.getFullYear() + 543; // Convert to Buddhist calendar
            const dayName = this.thaiDays[targetDate.getDay()];

            let formatted = `‡∏ß‡∏±‡∏ô${dayName}‡∏ó‡∏µ‡πà ${day} ${month} ${year}`;

            if (includeTime) {
                const hours = targetDate.getHours().toString().padStart(2, '0');
                const minutes = targetDate.getMinutes().toString().padStart(2, '0');
                formatted += ` ‡πÄ‡∏ß‡∏•‡∏≤ ${hours}:${minutes} ‡∏ô.`;
            }

            return formatted;
        } catch (error) {
            console.error('‚ùå Date formatting error:', error);
            return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        }
    }

    // Format short date for displays
    formatShortDate(date = null) {
        try {
            const targetDate = date ? new Date(date) : new Date();
            
            if (isNaN(targetDate.getTime())) {
                throw new Error('Invalid date');
            }

            const day = targetDate.getDate();
            const month = targetDate.getMonth() + 1;
            const year = targetDate.getFullYear() + 543;

            return `${day}/${month}/${year}`;
        } catch (error) {
            console.error('‚ùå Short date formatting error:', error);
            return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        }
    }

    // Validate and sanitize input
    sanitizeInput(input, type = 'string') {
        try {
            if (input === null || input === undefined) {
                return type === 'number' ? 0 : '';
            }

            switch (type) {
                case 'number':
                    const num = parseFloat(input);
                    return isNaN(num) ? 0 : num;
                
                case 'integer':
                    const int = parseInt(input);
                    return isNaN(int) ? 0 : int;
                
                case 'string':
                    return String(input).trim();
                
                case 'phone':
                    return String(input).replace(/[^0-9-]/g, '');
                
                default:
                    return String(input).trim();
            }
        } catch (error) {
            console.error('‚ùå Input sanitization error:', error);
            return type === 'number' ? 0 : '';
        }
    }

    // Generate unique ID
    generateId(prefix = 'id') {
        return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // Debounce function for performance optimization
    debounce(func, wait, immediate = false) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                timeout = null;
                if (!immediate) func.apply(this, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(this, args);
        };
    }

    // Throttle function for performance optimization
    throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func.apply(this, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }

    // Safe element selection with error handling
    safeGetElement(selector, parent = document) {
        try {
            const element = parent.querySelector(selector);
            if (!element) {
                console.warn(`‚ö†Ô∏è Element not found: ${selector}`);
                return null;
            }
            return element;
        } catch (error) {
            console.error(`‚ùå Error selecting element ${selector}:`, error);
            return null;
        }
    }

    // Safe element selection for multiple elements
    safeGetElements(selector, parent = document) {
        try {
            return Array.from(parent.querySelectorAll(selector));
        } catch (error) {
            console.error(`‚ùå Error selecting elements ${selector}:`, error);
            return [];
        }
    }

    // Button state management
    setButtonLoading(button, loading = true, loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
        if (!button) return;

        try {
            const textElement = button.querySelector('.btn-text');
            const loadingElement = button.querySelector('.btn-loading');

            if (loading) {
                button.disabled = true;
                button.classList.add('loading');
                
                if (textElement) {
                    textElement.style.opacity = '0';
                }
                
                if (loadingElement) {
                    loadingElement.textContent = loadingText;
                    loadingElement.classList.remove('hidden');
                } else {
                    // Fallback: change button text
                    button.dataset.originalText = button.textContent;
                    button.textContent = loadingText;
                }
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                
                if (textElement) {
                    textElement.style.opacity = '1';
                }
                
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                } else {
                    // Fallback: restore original text
                    if (button.dataset.originalText) {
                        button.textContent = button.dataset.originalText;
                        delete button.dataset.originalText;
                    }
                }
            }
        } catch (error) {
            console.error('‚ùå Button state management error:', error);
            // Fallback: simple disable/enable
            button.disabled = loading;
        }
    }

    // Async operation wrapper with timeout and error handling
    async withTimeout(operation, timeout = 10000, timeoutMessage = '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ') {
        return new Promise(async (resolve, reject) => {
            const timeoutId = setTimeout(() => {
                reject(new Error(timeoutMessage));
            }, timeout);

            try {
                const result = await operation();
                clearTimeout(timeoutId);
                resolve(result);
            } catch (error) {
                clearTimeout(timeoutId);
                reject(error);
            }
        });
    }

    // Local storage with error handling
    setLocalStorage(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (error) {
            console.error('‚ùå LocalStorage save error:', error);
            return false;
        }
    }

    getLocalStorage(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (error) {
            console.error('‚ùå LocalStorage get error:', error);
            return defaultValue;
        }
    }

    removeLocalStorage(key) {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (error) {
            console.error('‚ùå LocalStorage remove error:', error);
            return false;
        }
    }

    // Calculate business metrics
    calculateCostPerStick(meatPrice, weightPerStick, otherCosts = 0) {
        try {
            const meatCost = (meatPrice / 1000) * weightPerStick; // Convert kg to grams
            return meatCost + otherCosts;
        } catch (error) {
            console.error('‚ùå Cost calculation error:', error);
            return 0;
        }
    }

    calculateRecommendedPrice(costPerStick, marginPercent = 60) {
        try {
            const markup = 1 + (marginPercent / 100);
            const basePrice = costPerStick * markup;
            
            // Round to nearest 5 baht for practical pricing
            const rounded = Math.ceil(basePrice / 5) * 5;
            
            return {
                min: rounded,
                max: rounded + 5,
                profit: rounded - costPerStick
            };
        } catch (error) {
            console.error('‚ùå Price calculation error:', error);
            return { min: 0, max: 0, profit: 0 };
        }
    }

    calculateDailyProfit(sticksPerDay, pricePerStick, costPerStick) {
        try {
            const revenue = sticksPerDay * pricePerStick;
            const totalCost = sticksPerDay * costPerStick;
            const profit = revenue - totalCost;
            const marginPercent = totalCost > 0 ? ((profit / revenue) * 100) : 0;

            return {
                revenue,
                totalCost,
                profit,
                marginPercent: marginPercent.toFixed(1)
            };
        } catch (error) {
            console.error('‚ùå Profit calculation error:', error);
            return { revenue: 0, totalCost: 0, profit: 0, marginPercent: '0' };
        }
    }

    // Validation helpers
    validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    validatePhone(phone) {
        const re = /^[0-9-+\s()]{8,15}$/;
        return re.test(phone);
    }

    validateNumber(value, min = null, max = null) {
        const num = parseFloat(value);
        if (isNaN(num)) return false;
        if (min !== null && num < min) return false;
        if (max !== null && num > max) return false;
        return true;
    }

    // Array helpers
    arrayAverage(arr) {
        try {
            const validNumbers = arr.filter(item => !isNaN(parseFloat(item)));
            if (validNumbers.length === 0) return 0;
            const sum = validNumbers.reduce((acc, val) => acc + parseFloat(val), 0);
            return sum / validNumbers.length;
        } catch (error) {
            console.error('‚ùå Array average error:', error);
            return 0;
        }
    }

    arraySum(arr) {
        try {
            const validNumbers = arr.filter(item => !isNaN(parseFloat(item)));
            return validNumbers.reduce((acc, val) => acc + parseFloat(val), 0);
        } catch (error) {
            console.error('‚ùå Array sum error:', error);
            return 0;
        }
    }

    // Weather condition helpers
    getWeatherRecommendation(temp, condition) {
        try {
            const recommendations = [];

            if (temp >= 25 && temp <= 35) {
                recommendations.push('‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á');
            } else if (temp > 35) {
                recommendations.push('‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≠‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô');
            } else if (temp < 20) {
                recommendations.push('‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏ô');
            }

            const lowerCondition = condition.toLowerCase();
            if (lowerCondition.includes('rain') || lowerCondition.includes('‡∏ù‡∏ô')) {
                recommendations.push('‡∏ù‡∏ô‡∏ï‡∏Å ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á');
            } else if (lowerCondition.includes('clear') || lowerCondition.includes('‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™')) {
                recommendations.push('‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞');
            }

            return recommendations.length > 0 ? recommendations : ['‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏Å‡∏ï‡∏¥'];
        } catch (error) {
            console.error('‚ùå Weather recommendation error:', error);
            return ['‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ'];
        }
    }

    // Export data to CSV
    exportToCSV(data, filename = 'data.csv') {
        try {
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
            }

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',') 
                            ? `"${value}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            return true;
        } catch (error) {
            console.error('‚ùå CSV export error:', error);
            throw error;
        }
    }
}

// Create global instance
const utils = new Utils();

// Export for use in other modules
window.utils = utils;

// Helper functions for backward compatibility
window.formatCurrency = (amount, showUnit = true) => utils.formatCurrency(amount, showUnit);
window.formatThaiDate = (date = null, includeTime = false) => utils.formatThaiDate(date, includeTime);
window.setButtonLoading = (button, loading = true, loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') => utils.setButtonLoading(button, loading, loadingText);
window.safeGetElement = (selector, parent = document) => utils.safeGetElement(selector, parent);

// Dashboard functionality with comprehensive error handling
class Dashboard {
    constructor() {
        this.isInitialized = false;
        this.refreshIntervals = new Map();
        this.lastRefreshTime = new Map();
        this.minRefreshInterval = 30000; // 30 seconds minimum between refreshes
        this.init();
    }

    async init() {
        try {
            this.setupEventListeners();
            await this.loadInitialData();
            this.startAutoRefresh();
            this.isInitialized = true;
            console.log('‚úÖ Dashboard initialized successfully');
        } catch (error) {
            console.error('‚ùå Dashboard initialization failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    setupEventListeners() {
        // Refresh recommendations button
        const refreshBtn = utils.safeGetElement('#refresh-recommendations');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', this.handleRefreshRecommendations.bind(this));
        }

        // Set up current date display
        this.updateCurrentDate();
        setInterval(() => this.updateCurrentDate(), 60000); // Update every minute
    }

    async loadInitialData() {
        const loadingId = notificationSystem.loading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î...', '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
        
        try {
            // Load all dashboard data in parallel
            await Promise.all([
                this.loadRecommendations(),
                this.loadMarketPrices(),
                this.loadWeatherInfo(),
                this.loadProfitEstimate()
            ]);

            notificationSystem.remove(loadingId);
            notificationSystem.success('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } catch (error) {
            notificationSystem.remove(loadingId);
            throw error;
        }
    }

    async loadRecommendations() {
        try {
            const today = new Date();
            const currentHour = today.getHours();
            
            // Get weather and market data for intelligent recommendations
            const [weatherData, marketData] = await Promise.all([
                this.getWeatherData().catch(() => null),
                this.getMarketData().catch(() => null)
            ]);

            const recommendations = this.generateRecommendations(currentHour, weatherData, marketData);
            this.updateRecommendationsDisplay(recommendations);
            
            this.lastRefreshTime.set('recommendations', Date.now());
        } catch (error) {
            console.error('‚ùå Failed to load recommendations:', error);
            this.showFallbackRecommendations();
        }
    }

    generateRecommendations(currentHour, weatherData, marketData) {
        const recommendations = {
            priceRange: '‡∏ø15-20',
            timeSlot: '17:00-21:00 ‡∏ô.',
            details: []
        };

        // Time-based recommendations
        if (currentHour >= 16 && currentHour <= 21) {
            recommendations.details.push('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢');
            recommendations.priceRange = '‡∏ø18-22';
        } else if (currentHour >= 11 && currentHour <= 14) {
            recommendations.details.push('‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≤‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®');
            recommendations.priceRange = '‡∏ø15-18';
        } else {
            recommendations.details.push('‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å');
            recommendations.priceRange = '‡∏ø12-16';
        }

        // Weather-based recommendations
        if (weatherData) {
            const temp = weatherData.temperature || 28;
            const condition = weatherData.condition || 'clear';
            
            if (temp > 30) {
                recommendations.details.push('‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≠‡∏ô ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡πà‡∏°');
            } else if (temp < 25) {
                recommendations.details.push('‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏ô');
                recommendations.priceRange = this.adjustPriceRange(recommendations.priceRange, 1.1); // Increase 10%
            }

            if (condition.includes('rain') || condition.includes('‡∏ù‡∏ô')) {
                recommendations.details.push('‡∏ù‡∏ô‡∏ï‡∏Å ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏ö‡∏±‡∏á');
                recommendations.priceRange = this.adjustPriceRange(recommendations.priceRange, 0.9); // Decrease 10%
            }
        }

        // Market price-based recommendations
        if (marketData && marketData.porkPrice) {
            if (marketData.porkPrice > 200) {
                recommendations.details.push('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏°‡∏π‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ç‡∏≤‡∏¢');
                recommendations.priceRange = this.adjustPriceRange(recommendations.priceRange, 1.15);
            } else if (marketData.porkPrice < 180) {
                recommendations.details.push('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏°‡∏π‡∏ï‡πà‡∏≥ ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô');
            }
        }

        // Default details if none added
        if (recommendations.details.length === 0) {
            recommendations.details.push('‡∏™‡∏†‡∏≤‡∏û‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢');
        }

        return recommendations;
    }

    adjustPriceRange(priceRange, multiplier) {
        try {
            const match = priceRange.match(/‡∏ø(\d+)-(\d+)/);
            if (match) {
                const min = Math.round(parseInt(match[1]) * multiplier);
                const max = Math.round(parseInt(match[2]) * multiplier);
                return `‡∏ø${min}-${max}`;
            }
            return priceRange;
        } catch (error) {
            console.error('‚ùå Price range adjustment error:', error);
            return priceRange;
        }
    }

    updateRecommendationsDisplay(recommendations) {
        const priceElement = utils.safeGetElement('#recommended-price .price-value');
        const detailsElement = utils.safeGetElement('#recommendation-details');

        if (priceElement) {
            priceElement.textContent = recommendations.priceRange;
        }

        if (detailsElement) {
            detailsElement.innerHTML = recommendations.details
                .map(detail => `<p>${detail}</p>`)
                .join('');
        }
    }

    showFallbackRecommendations() {
        const priceElement = utils.safeGetElement('#recommended-price .price-value');
        const detailsElement = utils.safeGetElement('#recommendation-details');

        if (priceElement) {
            priceElement.textContent = '‡∏ø15-20';
        }

        if (detailsElement) {
            detailsElement.innerHTML = `
                <p>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 17:00-21:00 ‡∏ô.</p>
                <p>‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
            `;
        }
    }

    async loadMarketPrices() {
        try {
            // Try to get fresh market data
            const marketData = await this.getMarketData();
            this.updateMarketPricesDisplay(marketData);
        } catch (error) {
            console.error('‚ùå Failed to load market prices:', error);
            this.showFallbackMarketPrices();
        }
    }

    async getMarketData() {
        // Simulate API call with realistic data
        return new Promise((resolve) => {
            setTimeout(() => {
                const basePrice = 200;
                const variation = (Math.random() - 0.5) * 40; // ¬±20 variation
                
                resolve({
                    porkBelly: Math.round(basePrice + variation),
                    porkNeck: Math.round(basePrice + variation + 20),
                    porkTenderloin: Math.round(basePrice + variation + 50),
                    lastUpdated: new Date()
                });
            }, Math.random() * 2000 + 500); // 0.5-2.5 seconds delay
        });
    }

    updateMarketPricesDisplay(marketData) {
        const pricesContainer = utils.safeGetElement('#market-prices');
        if (!pricesContainer) return;

        pricesContainer.innerHTML = `
            <div class="price-item">
                <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô</span>
                <span class="price-value">‡∏ø${marketData.porkBelly}/‡∏Å‡∏Å.</span>
            </div>
            <div class="price-item">
                <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠</span>
                <span class="price-value">‡∏ø${marketData.porkNeck}/‡∏Å‡∏Å.</span>
            </div>
            <div class="price-item">
                <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡πÉ‡∏ô</span>
                <span class="price-value">‡∏ø${marketData.porkTenderloin}/‡∏Å‡∏Å.</span>
            </div>
        `;
    }

    showFallbackMarketPrices() {
        const pricesContainer = utils.safeGetElement('#market-prices');
        if (!pricesContainer) return;

        pricesContainer.innerHTML = `
            <div class="price-item">
                <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô</span>
                <span class="price-value">‡∏ø180/‡∏Å‡∏Å.</span>
            </div>
            <div class="price-item">
                <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠</span>
                <span class="price-value">‡∏ø220/‡∏Å‡∏Å.</span>
            </div>
            <div class="price-item">
                <span class="price-label">‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡πÉ‡∏ô</span>
                <span class="price-value">‡∏ø250/‡∏Å‡∏Å.</span>
            </div>
        `;
    }

    async loadWeatherInfo() {
        try {
            const weatherData = await this.getWeatherData();
            this.updateWeatherDisplay(weatherData);
        } catch (error) {
            console.error('‚ùå Failed to load weather info:', error);
            this.showFallbackWeather();
        }
    }

    async getWeatherData() {
        // Get API key from settings
        const apiKey = utils.getLocalStorage('weather_api_key');
        if (!apiKey) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Weather API Key');
        }

        // Simulate weather API call
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (Math.random() > 0.1) { // 90% success rate
                    const temps = [25, 26, 27, 28, 29, 30, 31, 32];
                    const conditions = ['‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™', '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á', '‡∏°‡∏µ‡πÄ‡∏°‡∏Ü', '‡∏ù‡∏ô‡∏ü‡πâ‡∏≤‡∏Ñ‡∏∞‡∏ô‡∏≠‡∏á'];
                    
                    resolve({
                        temperature: temps[Math.floor(Math.random() * temps.length)],
                        condition: conditions[Math.floor(Math.random() * conditions.length)],
                        humidity: Math.floor(Math.random() * 30) + 60, // 60-90%
                        windSpeed: Math.floor(Math.random() * 15) + 5 // 5-20 km/h
                    });
                } else {
                    reject(new Error('Weather API error'));
                }
            }, Math.random() * 3000 + 1000); // 1-4 seconds delay
        });
    }

    updateWeatherDisplay(weatherData) {
        const weatherContainer = utils.safeGetElement('#weather-info');
        if (!weatherContainer) return;

        const recommendation = this.getWeatherBasedRecommendation(weatherData);

        weatherContainer.innerHTML = `
            <div class="weather-temp">${weatherData.temperature}¬∞C</div>
            <div class="weather-desc">${weatherData.condition}</div>
            <div class="weather-details">
                <span><i class="fas fa-eye"></i> ${recommendation}</span>
            </div>
        `;
    }

    getWeatherBasedRecommendation(weatherData) {
        const temp = weatherData.temperature;
        const condition = weatherData.condition;

        if (condition.includes('‡∏ù‡∏ô')) {
            return '‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ù‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≤‡∏à‡∏ô‡πâ‡∏≠‡∏¢';
        } else if (temp >= 25 && temp <= 32) {
            return '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Ç‡∏≤‡∏¢';
        } else if (temp > 32) {
            return '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≠‡∏ô ‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡πà‡∏°';
        } else {
            return '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Ç‡∏≤‡∏¢‡∏£‡πâ‡∏≠‡∏ô';
        }
    }

    showFallbackWeather() {
        const weatherContainer = utils.safeGetElement('#weather-info');
        if (!weatherContainer) return;

        weatherContainer.innerHTML = `
            <div class="weather-temp">28¬∞C</div>
            <div class="weather-desc">‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™</div>
            <div class="weather-details">
                <span><i class="fas fa-eye"></i> ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Ç‡∏≤‡∏¢</span>
            </div>
        `;
    }

    async loadProfitEstimate() {
        try {
            // Get recent sales data for better estimates
            const recentSales = await this.getRecentSalesData();
            const estimate = this.calculateProfitEstimate(recentSales);
            this.updateProfitEstimateDisplay(estimate);
        } catch (error) {
            console.error('‚ùå Failed to load profit estimate:', error);
            this.showFallbackProfitEstimate();
        }
    }

    async getRecentSalesData() {
        try {
            // Try to get from Firebase first
            return await window.firebaseUtils.hybridGet(
                'sales', 
                null, 
                { field: 'createdAt', direction: 'desc' }, 
                7, // Last 7 days
                window.firebaseUtils.localStorageKeys.SALES_DATA
            );
        } catch (error) {
            console.warn('‚ö†Ô∏è Could not get recent sales data:', error);
            return [];
        }
    }

    calculateProfitEstimate(salesData) {
        if (!salesData || salesData.length === 0) {
            return {
                dailyProfit: '‡∏ø800-1,200',
                sticksRange: '80-120 ‡πÑ‡∏°‡πâ',
                confidence: '‡∏ï‡πà‡∏≥'
            };
        }

        try {
            const validSales = salesData.filter(sale => 
                sale.sticksSold && sale.totalRevenue && sale.totalCost
            );

            if (validSales.length === 0) {
                throw new Error('No valid sales data');
            }

            const profits = validSales.map(sale => 
                sale.totalRevenue - sale.totalCost
            );

            const avgProfit = utils.arrayAverage(profits);
            const minProfit = Math.min(...profits);
            const maxProfit = Math.max(...profits);

            const avgSticks = utils.arrayAverage(validSales.map(sale => sale.sticksSold));
            const minSticks = Math.min(...validSales.map(sale => sale.sticksSold));
            const maxSticks = Math.max(...validSales.map(sale => sale.sticksSold));

            return {
                dailyProfit: `‡∏ø${Math.round(minProfit)}-${Math.round(maxProfit)}`,
                sticksRange: `${Math.round(minSticks)}-${Math.round(maxSticks)} ‡πÑ‡∏°‡πâ`,
                confidence: validSales.length >= 5 ? '‡∏™‡∏π‡∏á' : validSales.length >= 3 ? '‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ï‡πà‡∏≥'
            };
        } catch (error) {
            console.error('‚ùå Profit calculation error:', error);
            return {
                dailyProfit: '‡∏ø600-1,000',
                sticksRange: '60-100 ‡πÑ‡∏°‡πâ',
                confidence: '‡∏ï‡πà‡∏≥'
            };
        }
    }

    updateProfitEstimateDisplay(estimate) {
        const profitContainer = utils.safeGetElement('#profit-estimate');
        if (!profitContainer) return;

        profitContainer.innerHTML = `
            <div class="profit-value">${estimate.dailyProfit}</div>
            <div class="profit-subtitle">‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div>
            <div class="profit-details">
                <small>‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ${estimate.sticksRange}</small>
                <br>
                <small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠: ${estimate.confidence}</small>
            </div>
        `;
    }

    showFallbackProfitEstimate() {
        const profitContainer = utils.safeGetElement('#profit-estimate');
        if (!profitContainer) return;

        profitContainer.innerHTML = `
            <div class="profit-value">‡∏ø800-1,200</div>
            <div class="profit-subtitle">‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div>
            <div class="profit-details">
                <small>‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 80-120 ‡πÑ‡∏°‡πâ</small>
                <br>
                <small>‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</small>
            </div>
        `;
    }

    async handleRefreshRecommendations(event) {
        const button = event.target.closest('.refresh-btn');
        if (!button) return;

        // Check if minimum time has passed since last refresh
        const lastRefresh = this.lastRefreshTime.get('recommendations') || 0;
        const timeSinceLastRefresh = Date.now() - lastRefresh;

        if (timeSinceLastRefresh < this.minRefreshInterval) {
            const remainingTime = Math.ceil((this.minRefreshInterval - timeSinceLastRefresh) / 1000);
            notificationSystem.warning(
                `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${remainingTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏´‡∏°‡πà`,
                '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ'
            );
            return;
        }

        try {
            utils.setButtonLoading(button, true);
            
            await utils.withTimeout(
                () => this.loadRecommendations(),
                15000,
                '‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ'
            );

            notificationSystem.success('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } catch (error) {
            console.error('‚ùå Refresh recommendations failed:', error);
            notificationSystem.error(
                error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ',
                '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
            );
        } finally {
            utils.setButtonLoading(button, false);
        }
    }

    updateCurrentDate() {
        const dateElement = utils.safeGetElement('#current-date');
        if (dateElement) {
            dateElement.textContent = utils.formatThaiDate();
        }
    }

    startAutoRefresh() {
        // Auto-refresh every 5 minutes
        const autoRefreshInterval = setInterval(async () => {
            try {
                await this.loadInitialData();
                console.log('‚úÖ Auto-refresh completed');
            } catch (error) {
                console.error('‚ùå Auto-refresh failed:', error);
            }
        }, 5 * 60 * 1000); // 5 minutes

        this.refreshIntervals.set('auto', autoRefreshInterval);
    }

    destroy() {
        // Clean up intervals
        this.refreshIntervals.forEach((interval) => {
            clearInterval(interval);
        });
        this.refreshIntervals.clear();
        this.isInitialized = false;
    }
}

// Create and export dashboard instance
const dashboard = new Dashboard();
window.dashboard = dashboard;
// Business Tools functionality with robust error handling
class BusinessTools {
    constructor() {
        this.selectedBusinessModel = null;
        this.isInitialized = false;
        this.calculationCache = new Map();
        this.analysisTimeout = null;
        this.init();
    }

    async init() {
        try {
            this.setupEventListeners();
            this.loadSavedSettings();
            this.isInitialized = true;
            console.log('‚úÖ Business Tools initialized successfully');
        } catch (error) {
            console.error('‚ùå Business Tools initialization failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    setupEventListeners() {
        // Business model selection
        const modelOptions = utils.safeGetElements('.model-option');
        modelOptions.forEach(option => {
            option.addEventListener('click', this.handleModelSelection.bind(this));
        });

        // Cost calculator
        const calculateBtn = utils.safeGetElement('#calculate-cost');
        if (calculateBtn) {
            calculateBtn.addEventListener('click', this.handleCostCalculation.bind(this));
        }

        // Business analysis
        const analyzeBtn = utils.safeGetElement('#analyze-business');
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', this.handleBusinessAnalysis.bind(this));
        }

        // Real-time calculation on input change
        const calculatorInputs = utils.safeGetElements('#meat-price, #weight-per-stick, #other-costs');
        calculatorInputs.forEach(input => {
            input.addEventListener('input', utils.debounce(this.updateCalculation.bind(this), 500));
        });

        // Analysis inputs
        const analysisInputs = utils.safeGetElements('#daily-target, #avg-selling-price');
        analysisInputs.forEach(input => {
            input.addEventListener('input', utils.debounce(this.updateAnalysisPreview.bind(this), 500));
        });
    }

    loadSavedSettings() {
        try {
            const savedSettings = utils.getLocalStorage('business_tools_settings', {});
            
            // Load business model selection
            if (savedSettings.businessModel) {
                this.selectBusinessModel(savedSettings.businessModel, false);
            }

            // Load calculator values
            if (savedSettings.calculator) {
                const meatPriceInput = utils.safeGetElement('#meat-price');
                const weightInput = utils.safeGetElement('#weight-per-stick');
                const otherCostsInput = utils.safeGetElement('#other-costs');

                if (meatPriceInput && savedSettings.calculator.meatPrice) {
                    meatPriceInput.value = savedSettings.calculator.meatPrice;
                }
                if (weightInput && savedSettings.calculator.weightPerStick) {
                    weightInput.value = savedSettings.calculator.weightPerStick;
                }
                if (otherCostsInput && savedSettings.calculator.otherCosts) {
                    otherCostsInput.value = savedSettings.calculator.otherCosts;
                }

                // Trigger calculation with saved values
                this.updateCalculation();
            }

            // Load analysis values
            if (savedSettings.analysis) {
                const targetInput = utils.safeGetElement('#daily-target');
                const priceInput = utils.safeGetElement('#avg-selling-price');

                if (targetInput && savedSettings.analysis.dailyTarget) {
                    targetInput.value = savedSettings.analysis.dailyTarget;
                }
                if (priceInput && savedSettings.analysis.avgSellingPrice) {
                    priceInput.value = savedSettings.analysis.avgSellingPrice;
                }
            }
        } catch (error) {
            console.error('‚ùå Failed to load saved settings:', error);
        }
    }

    saveSettings() {
        try {
            const settings = {
                businessModel: this.selectedBusinessModel,
                calculator: {
                    meatPrice: utils.safeGetElement('#meat-price')?.value || '',
                    weightPerStick: utils.safeGetElement('#weight-per-stick')?.value || '',
                    otherCosts: utils.safeGetElement('#other-costs')?.value || ''
                },
                analysis: {
                    dailyTarget: utils.safeGetElement('#daily-target')?.value || '',
                    avgSellingPrice: utils.safeGetElement('#avg-selling-price')?.value || ''
                }
            };

            utils.setLocalStorage('business_tools_settings', settings);
        } catch (error) {
            console.error('‚ùå Failed to save settings:', error);
        }
    }

    handleModelSelection(event) {
        const option = event.currentTarget;
        const model = option.dataset.model;
        
        if (!model) return;

        this.selectBusinessModel(model, true);
    }

    selectBusinessModel(model, showNotification = true) {
        try {
            // Remove previous selection
            const allOptions = utils.safeGetElements('.model-option');
            allOptions.forEach(opt => opt.classList.remove('selected'));

            // Select new model
            const selectedOption = utils.safeGetElement(`[data-model="${model}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                this.selectedBusinessModel = model;

                if (showNotification) {
                    const modelNames = {
                        'manufacture': '‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏≠‡∏á',
                        'resell': '‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Ç‡∏≤‡∏¢',
                        'franchise': '‡πÅ‡∏ü‡∏£‡∏ô‡πÑ‡∏ä‡∏™‡πå'
                    };

                    notificationSystem.success(
                        `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à: ${modelNames[model]}`,
                        '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'
                    );
                }

                // Update calculations based on selected model
                this.updateCalculationForModel(model);
                this.saveSettings();
            }
        } catch (error) {
            console.error('‚ùå Model selection failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    updateCalculationForModel(model) {
        try {
            const otherCostsInput = utils.safeGetElement('#other-costs');
            if (!otherCostsInput) return;

            // Adjust other costs based on business model
            const defaultCosts = {
                'manufacture': 5, // Higher costs for manufacturing
                'resell': 2,      // Lower costs for reselling
                'franchise': 3    // Medium costs for franchise
            };

            if (defaultCosts[model] !== undefined) {
                otherCostsInput.value = defaultCosts[model];
                this.updateCalculation();
            }
        } catch (error) {
            console.error('‚ùå Model calculation update failed:', error);
        }
    }

    handleCostCalculation(event) {
        try {
            const button = event.target;
            utils.setButtonLoading(button, true);

            // Simulate processing time for better UX
            setTimeout(() => {
                this.updateCalculation();
                utils.setButtonLoading(button, false);
                notificationSystem.success('‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }, 800);
        } catch (error) {
            console.error('‚ùå Cost calculation failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            utils.setButtonLoading(event.target, false);
        }
    }

    updateCalculation() {
        try {
            const meatPrice = utils.sanitizeInput(
                utils.safeGetElement('#meat-price')?.value, 'number'
            );
            const weightPerStick = utils.sanitizeInput(
                utils.safeGetElement('#weight-per-stick')?.value, 'number'
            );
            const otherCosts = utils.sanitizeInput(
                utils.safeGetElement('#other-costs')?.value, 'number'
            );

            // Validate inputs
            if (meatPrice <= 0 || weightPerStick <= 0) {
                this.showCalculationError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            // Calculate costs
            const costPerStick = utils.calculateCostPerStick(meatPrice, weightPerStick, otherCosts);
            const recommendedPrice = utils.calculateRecommendedPrice(costPerStick, this.getMarginForModel());

            // Cache the result
            const cacheKey = `${meatPrice}-${weightPerStick}-${otherCosts}`;
            this.calculationCache.set(cacheKey, {
                costPerStick,
                recommendedPrice,
                timestamp: Date.now()
            });

            this.displayCalculationResult(costPerStick, recommendedPrice);
            this.saveSettings();
        } catch (error) {
            console.error('‚ùå Calculation update failed:', error);
            this.showCalculationError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì');
        }
    }

    getMarginForModel() {
        const margins = {
            'manufacture': 65, // 65% margin
            'resell': 35,      // 35% margin
            'franchise': 45    // 45% margin
        };

        return margins[this.selectedBusinessModel] || 60;
    }

    displayCalculationResult(costPerStick, recommendedPrice) {
        const resultContainer = utils.safeGetElement('#cost-result');
        if (!resultContainer) return;

        resultContainer.innerHTML = `
            <div class="result-item">
                <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ:</span>
                <span class="result-value">${utils.formatCurrency(costPerStick)}</span>
            </div>
            <div class="result-item">
                <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span>
                <span class="result-value">${utils.formatCurrency(recommendedPrice.min)}-${utils.formatCurrency(recommendedPrice.max)}</span>
            </div>
            <div class="result-item">
                <span>‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ:</span>
<span class="result-value text-success">${utils.formatCurrency(recommendedPrice.profit)}-${utils.formatCurrency(recommendedPrice.profit + 5)}</span>
           </div>
           <div class="result-item">
               <span>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£:</span>
               <span class="result-value">${this.getMarginForModel()}%</span>
           </div>
       `;

       // Add animation
       resultContainer.style.opacity = '0';
       resultContainer.style.transform = 'translateY(10px)';
       
       setTimeout(() => {
           resultContainer.style.transition = 'all 0.3s ease';
           resultContainer.style.opacity = '1';
           resultContainer.style.transform = 'translateY(0)';
       }, 100);
   }

   showCalculationError(message) {
       const resultContainer = utils.safeGetElement('#cost-result');
       if (!resultContainer) return;

       resultContainer.innerHTML = `
           <div class="result-item text-danger">
               <span><i class="fas fa-exclamation-triangle"></i> ${message}</span>
           </div>
       `;
   }

   async handleBusinessAnalysis(event) {
       const button = event.target;
       
       if (!button) return;

       // Clear any existing timeout
       if (this.analysisTimeout) {
           clearTimeout(this.analysisTimeout);
       }

       try {
           utils.setButtonLoading(button, true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...');

           // Validate inputs first
           const dailyTarget = utils.sanitizeInput(
               utils.safeGetElement('#daily-target')?.value, 'number'
           );
           const avgSellingPrice = utils.sanitizeInput(
               utils.safeGetElement('#avg-selling-price')?.value, 'number'
           );

           if (dailyTarget <= 0 || avgSellingPrice <= 0) {
               throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
           }

           // Simulate analysis processing time
           await new Promise(resolve => {
               this.analysisTimeout = setTimeout(resolve, 2000 + Math.random() * 2000);
           });

           const analysisResult = await this.performBusinessAnalysis(dailyTarget, avgSellingPrice);
           this.displayAnalysisResult(analysisResult);
           
           notificationSystem.success('‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
           
       } catch (error) {
           console.error('‚ùå Business analysis failed:', error);
           notificationSystem.error(
               error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ',
               '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
           );
           this.showAnalysisError(error.message);
       } finally {
           utils.setButtonLoading(button, false);
       }
   }

   async performBusinessAnalysis(dailyTarget, avgSellingPrice) {
       try {
           // Get current cost calculation
           const meatPrice = utils.sanitizeInput(
               utils.safeGetElement('#meat-price')?.value, 'number'
           );
           const weightPerStick = utils.sanitizeInput(
               utils.safeGetElement('#weight-per-stick')?.value, 'number'
           );
           const otherCosts = utils.sanitizeInput(
               utils.safeGetElement('#other-costs')?.value, 'number'
           );

           const costPerStick = utils.calculateCostPerStick(meatPrice, weightPerStick, otherCosts);
           
           // Calculate daily metrics
           const dailyRevenue = dailyTarget * avgSellingPrice;
           const dailyCost = dailyTarget * costPerStick;
           const dailyProfit = dailyRevenue - dailyCost;
           const profitMargin = dailyRevenue > 0 ? ((dailyProfit / dailyRevenue) * 100) : 0;

           // Calculate monthly and yearly projections
           const monthlyProfit = dailyProfit * 25; // Assuming 25 working days per month
           const yearlyProfit = monthlyProfit * 12;

           // Get recent sales data for comparison
           let avgDailySales = 0;
           let salesGrowthTrend = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
           
           try {
               const recentSales = await window.firebaseUtils.hybridGet(
                   'sales',
                   null,
                   { field: 'createdAt', direction: 'desc' },
                   30,
                   window.firebaseUtils.localStorageKeys.SALES_DATA
               );

               if (recentSales && recentSales.length > 0) {
                   const validSales = recentSales.filter(sale => sale.sticksSold && sale.sticksSold > 0);
                   if (validSales.length > 0) {
                       avgDailySales = utils.arrayAverage(validSales.map(sale => sale.sticksSold));
                       
                       // Calculate trend (simple linear regression on last 7 sales)
                       if (validSales.length >= 7) {
                           const recent7 = validSales.slice(0, 7);
                           const older7 = validSales.slice(7, 14);
                           
                           if (older7.length >= 7) {
                               const recentAvg = utils.arrayAverage(recent7.map(s => s.sticksSold));
                               const olderAvg = utils.arrayAverage(older7.map(s => s.sticksSold));
                               
                               if (recentAvg > olderAvg * 1.05) {
                                   salesGrowthTrend = '‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï';
                               } else if (recentAvg < olderAvg * 0.95) {
                                   salesGrowthTrend = '‡∏•‡∏î‡∏•‡∏á';
                               } else {
                                   salesGrowthTrend = '‡∏Ñ‡∏á‡∏ó‡∏µ‡πà';
                               }
                           }
                       }
                   }
               }
           } catch (error) {
               console.warn('‚ö†Ô∏è Could not get sales data for analysis:', error);
           }

           // Generate recommendations
           const recommendations = this.generateBusinessRecommendations({
               dailyTarget,
               avgSellingPrice,
               costPerStick,
               profitMargin,
               avgDailySales,
               salesGrowthTrend
           });

           // Risk assessment
           const riskFactors = this.assessBusinessRisk({
               profitMargin,
               dailyTarget,
               avgDailySales,
               costPerStick,
               avgSellingPrice
           });

           return {
               dailyMetrics: {
                   revenue: dailyRevenue,
                   cost: dailyCost,
                   profit: dailyProfit,
                   margin: profitMargin
               },
               projections: {
                   monthly: monthlyProfit,
                   yearly: yearlyProfit
               },
               comparison: {
                   currentAvg: avgDailySales,
                   target: dailyTarget,
                   gap: dailyTarget - avgDailySales,
                   trend: salesGrowthTrend
               },
               recommendations,
               riskFactors,
               breakEvenPoint: Math.ceil(dailyCost > 0 ? dailyCost / (avgSellingPrice - costPerStick) : 0)
           };
       } catch (error) {
           console.error('‚ùå Analysis calculation failed:', error);
           throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
       }
   }

   generateBusinessRecommendations(data) {
       const recommendations = [];

       // Profit margin recommendations
       if (data.profitMargin < 30) {
           recommendations.push({
               type: 'warning',
               title: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≥',
               message: '‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢',
               priority: '‡∏™‡∏π‡∏á'
           });
       } else if (data.profitMargin > 70) {
           recommendations.push({
               type: 'info',
               title: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á',
               message: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
               priority: '‡∏Å‡∏•‡∏≤‡∏á'
           });
       }

       // Target vs current sales
       if (data.avgDailySales > 0) {
           const gap = data.dailyTarget - data.avgDailySales;
           if (gap > 20) {
               recommendations.push({
                   type: 'info',
                   title: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',
                   message: `‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ${Math.round(gap)} ‡πÑ‡∏°‡πâ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô`,
                   priority: '‡∏Å‡∏•‡∏≤‡∏á'
               });
           } else if (gap < -10) {
               recommendations.push({
                   type: 'success',
                   title: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',
                   message: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏î‡πâ',
                   priority: '‡∏ï‡πà‡∏≥'
               });
           }
       }

       // Sales trend recommendations
       if (data.salesGrowthTrend === '‡∏•‡∏î‡∏•‡∏á') {
           recommendations.push({
               type: 'warning',
               title: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏•‡∏î‡∏•‡∏á',
               message: '‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô',
               priority: '‡∏™‡∏π‡∏á'
           });
       } else if (data.salesGrowthTrend === '‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï') {
           recommendations.push({
               type: 'success',
               title: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï',
               message: '‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï',
               priority: '‡∏Å‡∏•‡∏≤‡∏á'
           });
       }

       // Cost efficiency recommendations
       if (data.costPerStick > 15) {
           recommendations.push({
               type: 'warning',
               title: '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏™‡∏π‡∏á',
               message: '‡∏Ñ‡∏ß‡∏£‡∏´‡∏≤‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤',
               priority: '‡∏Å‡∏•‡∏≤‡∏á'
           });
       }

       // Default recommendation if none generated
       if (recommendations.length === 0) {
           recommendations.push({
               type: 'success',
               title: '‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏°‡∏µ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ',
               message: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',
               priority: '‡∏ï‡πà‡∏≥'
           });
       }

       return recommendations;
   }

   assessBusinessRisk(data) {
       const risks = [];

       // Low profit margin risk
       if (data.profitMargin < 25) {
           risks.push({
               level: '‡∏™‡∏π‡∏á',
               factor: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≥',
               impact: '‡∏≠‡∏≤‡∏à‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô'
           });
       }

       // High target vs current performance
       if (data.avgDailySales > 0 && data.dailyTarget > data.avgDailySales * 1.5) {
           risks.push({
               level: '‡∏Å‡∏•‡∏≤‡∏á',
               factor: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
               impact: '‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ'
           });
       }

       // Price competition risk
       if (data.avgSellingPrice < data.costPerStick * 1.3) {
           risks.push({
               level: '‡∏™‡∏π‡∏á',
               factor: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô',
               impact: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤'
           });
       }

       // High cost per stick
       if (data.costPerStick > 18) {
           risks.push({
               level: '‡∏Å‡∏•‡∏≤‡∏á',
               factor: '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏á',
               impact: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏•‡∏î‡∏•‡∏á'
           });
       }

       return risks;
   }

   displayAnalysisResult(result) {
       const resultContainer = utils.safeGetElement('#analysis-result');
       if (!resultContainer) return;

       const riskLevel = this.calculateOverallRiskLevel(result.riskFactors);
       const riskColor = riskLevel === '‡∏™‡∏π‡∏á' ? 'danger' : riskLevel === '‡∏Å‡∏•‡∏≤‡∏á' ? 'warning' : 'success';

       resultContainer.innerHTML = `
           <div class="analysis-summary">
               <div class="summary-cards">
                   <div class="summary-card">
                       <div class="card-header">
                           <h4><i class="fas fa-chart-line"></i> ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h4>
                       </div>
                       <div class="card-value text-primary">${utils.formatCurrency(result.dailyMetrics.revenue)}</div>
                       <div class="card-subtitle">‡∏à‡∏≤‡∏Å ${utils.safeGetElement('#daily-target')?.value} ‡πÑ‡∏°‡πâ</div>
                   </div>
                   
                   <div class="summary-card">
                       <div class="card-header">
                           <h4><i class="fas fa-coins"></i> ‡∏Å‡∏≥‡πÑ‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h4>
                       </div>
                       <div class="card-value text-success">${utils.formatCurrency(result.dailyMetrics.profit)}</div>
                       <div class="card-subtitle">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£ ${result.dailyMetrics.margin.toFixed(1)}%</div>
                   </div>
                   
                   <div class="summary-card">
                       <div class="card-header">
                           <h4><i class="fas fa-calendar-alt"></i> ‡∏Å‡∏≥‡πÑ‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                       </div>
                       <div class="card-value text-info">${utils.formatCurrency(result.projections.monthly)}</div>
                       <div class="card-subtitle">25 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                   </div>
                   
                   <div class="summary-card">
                       <div class="card-header">
                           <h4><i class="fas fa-balance-scale"></i> ‡∏à‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô</h4>
                       </div>
                       <div class="card-value text-secondary">${result.breakEvenPoint} ‡πÑ‡∏°‡πâ</div>
                       <div class="card-subtitle">‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div>
                   </div>
               </div>
           </div>

           ${result.comparison.currentAvg > 0 ? `
               <div class="analysis-comparison">
                   <h4><i class="fas fa-chart-bar"></i> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                   <div class="comparison-data">
                       <div class="comparison-item">
                           <span>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
                           <span class="comparison-value">${Math.round(result.comparison.currentAvg)} ‡πÑ‡∏°‡πâ/‡∏ß‡∏±‡∏ô</span>
                       </div>
                       <div class="comparison-item">
                           <span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</span>
                           <span class="comparison-value">${result.comparison.target} ‡πÑ‡∏°‡πâ/‡∏ß‡∏±‡∏ô</span>
                       </div>
                       <div class="comparison-item">
                           <span>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á:</span>
                           <span class="comparison-value ${result.comparison.gap > 0 ? 'text-warning' : 'text-success'}">
                               ${result.comparison.gap > 0 ? '+' : ''}${Math.round(result.comparison.gap)} ‡πÑ‡∏°‡πâ
                           </span>
                       </div>
                       <div class="comparison-item">
                           <span>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°:</span>
                           <span class="comparison-value">${result.comparison.trend}</span>
                       </div>
                   </div>
               </div>
           ` : ''}

           <div class="analysis-recommendations">
               <h4><i class="fas fa-lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h4>
               <div class="recommendations-list">
                   ${result.recommendations.map(rec => `
                       <div class="recommendation-item ${rec.type}">
                           <div class="recommendation-header">
                               <span class="recommendation-title">${rec.title}</span>
                               <span class="recommendation-priority priority-${rec.priority === '‡∏™‡∏π‡∏á' ? 'high' : rec.priority === '‡∏Å‡∏•‡∏≤‡∏á' ? 'medium' : 'low'}">
                                   ${rec.priority}
                               </span>
                           </div>
                           <div class="recommendation-message">${rec.message}</div>
                       </div>
                   `).join('')}
               </div>
           </div>

           ${result.riskFactors.length > 0 ? `
               <div class="analysis-risks">
                   <h4><i class="fas fa-exclamation-triangle"></i> ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h4>
                   <div class="risk-level-indicator risk-${riskColor}">
                       ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°: <strong>${riskLevel}</strong>
                   </div>
                   <div class="risks-list">
                       ${result.riskFactors.map(risk => `
                           <div class="risk-item risk-level-${risk.level === '‡∏™‡∏π‡∏á' ? 'high' : risk.level === '‡∏Å‡∏•‡∏≤‡∏á' ? 'medium' : 'low'}">
                               <div class="risk-factor">${risk.factor}</div>
                               <div class="risk-impact">${risk.impact}</div>
                               <div class="risk-level">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${risk.level}</div>
                           </div>
                       `).join('')}
                   </div>
               </div>
           ` : ''}
       `;

       // Add CSS for analysis result if not already added
       this.addAnalysisStyles();

       // Animate the result
       resultContainer.style.opacity = '0';
       resultContainer.style.transform = 'translateY(20px)';
       
       setTimeout(() => {
           resultContainer.style.transition = 'all 0.5s ease';
           resultContainer.style.opacity = '1';
           resultContainer.style.transform = 'translateY(0)';
       }, 100);
   }

   calculateOverallRiskLevel(riskFactors) {
       if (riskFactors.length === 0) return '‡∏ï‡πà‡∏≥';
       
       const highRisks = riskFactors.filter(r => r.level === '‡∏™‡∏π‡∏á').length;
       const mediumRisks = riskFactors.filter(r => r.level === '‡∏Å‡∏•‡∏≤‡∏á').length;
       
       if (highRisks >= 2) return '‡∏™‡∏π‡∏á';
       if (highRisks >= 1 || mediumRisks >= 3) return '‡∏Å‡∏•‡∏≤‡∏á';
       return '‡∏ï‡πà‡∏≥';
   }

   showAnalysisError(message) {
       const resultContainer = utils.safeGetElement('#analysis-result');
       if (!resultContainer) return;

       resultContainer.innerHTML = `
           <div class="analysis-error">
               <div class="error-icon">
                   <i class="fas fa-exclamation-triangle"></i>
               </div>
               <div class="error-message">
                   <h4>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ</h4>
                   <p>${message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à'}</p>
               </div>
           </div>
       `;
   }

   updateAnalysisPreview() {
       // This could show a quick preview of analysis results
       // Implementation would depend on specific requirements
   }

   addAnalysisStyles() {
       if (document.getElementById('analysis-styles')) return;

       const style = document.createElement('style');
       style.id = 'analysis-styles';
       style.textContent = `
           .analysis-summary .summary-cards {
               display: grid;
               grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
               gap: 16px;
               margin-bottom: 24px;
           }

           .summary-card {
               background: var(--gray-100);
               border-radius: 8px;
               padding: 16px;
               text-align: center;
               transition: var(--transition);
           }

           .summary-card:hover {
               background: var(--gray-200);
               transform: translateY(-2px);
           }

           .summary-card .card-header h4 {
               font-size: 14px;
               margin-bottom: 8px;
               color: var(--gray-600);
               display: flex;
               align-items: center;
               justify-content: center;
               gap: 6px;
           }

           .summary-card .card-value {
               font-size: 20px;
               font-weight: 700;
               font-family: var(--font-accent);
               margin-bottom: 4px;
           }

           .summary-card .card-subtitle {
               font-size: 12px;
               color: var(--gray-500);
           }

           .analysis-comparison,
           .analysis-recommendations,
           .analysis-risks {
               margin: 24px 0;
               padding: 20px;
               background: var(--gray-100);
               border-radius: var(--border-radius);
           }

           .analysis-comparison h4,
           .analysis-recommendations h4,
           .analysis-risks h4 {
               margin-bottom: 16px;
               color: var(--gray-800);
               display: flex;
               align-items: center;
               gap: 8px;
           }

           .comparison-data {
               display: grid;
               grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
               gap: 12px;
           }

           .comparison-item {
               display: flex;
               justify-content: space-between;
               padding: 8px 12px;
               background: white;
               border-radius: 6px;
               font-size: 14px;
           }

           .comparison-value {
               font-weight: 600;
           }

           .recommendation-item {
               background: white;
               border-radius: 8px;
               padding: 16px;
               margin-bottom: 12px;
               border-left: 4px solid var(--info-color);
           }

           .recommendation-item.success {
               border-left-color: var(--success-color);
           }

           .recommendation-item.warning {
               border-left-color: var(--warning-color);
           }

           .recommendation-header {
               display: flex;
               justify-content: space-between;
               align-items: center;
               margin-bottom: 8px;
           }

           .recommendation-title {
               font-weight: 600;
               color: var(--gray-800);
           }

           .recommendation-priority {
               font-size: 12px;
               padding: 2px 8px;
               border-radius: 4px;
               font-weight: 500;
           }

           .recommendation-priority.priority-high {
               background: var(--danger-color);
               color: white;
           }

           .recommendation-priority.priority-medium {
               background: var(--warning-color);
               color: white;
           }

           .recommendation-priority.priority-low {
               background: var(--gray-400);
               color: white;
           }

           .recommendation-message {
               font-size: 14px;
               color: var(--gray-600);
               line-height: 1.4;
           }

           .risk-level-indicator {
               padding: 12px 16px;
               border-radius: 8px;
               margin-bottom: 16px;
               font-weight: 500;
           }

           .risk-level-indicator.risk-success {
               background: var(--success-color);
               color: white;
           }

           .risk-level-indicator.risk-warning {
               background: var(--warning-color);
               color: white;
           }

           .risk-level-indicator.risk-danger {
               background: var(--danger-color);
               color: white;
           }

           .risk-item {
               background: white;
               border-radius: 8px;
               padding: 16px;
               margin-bottom: 12px;
               border-left: 4px solid var(--gray-400);
           }

           .risk-item.risk-level-high {
               border-left-color: var(--danger-color);
           }

           .risk-item.risk-level-medium {
               border-left-color: var(--warning-color);
           }

           .risk-item.risk-level-low {
               border-left-color: var(--success-color);
           }

           .risk-factor {
               font-weight: 600;
               color: var(--gray-800);
               margin-bottom: 4px;
           }

           .risk-impact {
               font-size: 14px;
               color: var(--gray-600);
               margin-bottom: 8px;
           }

           .risk-level {
               font-size: 12px;
               font-weight: 500;
               color: var(--gray-500);
           }

           .analysis-error {
               text-align: center;
               padding: 40px 20px;
               color: var(--gray-600);
           }

           .analysis-error .error-icon {
               font-size: 48px;
               color: var(--warning-color);
               margin-bottom: 16px;
           }

           .analysis-error h4 {
               margin-bottom: 8px;
               color: var(--gray-800);
           }

           @media (max-width: 768px) {
               .analysis-summary .summary-cards {
                   grid-template-columns: 1fr;
               }
               
               .comparison-data {
                   grid-template-columns: 1fr;
               }
               
               .recommendation-header {
                   flex-direction: column;
                   align-items: flex-start;
                   gap: 8px;
               }
           }
       `;

       document.head.appendChild(style);
   }

   destroy() {
       if (this.analysisTimeout) {
           clearTimeout(this.analysisTimeout);
       }
       this.calculationCache.clear();
       this.isInitialized = false;
   }
}

// Create and export business tools instance
const businessTools = new BusinessTools();
window.businessTools = businessTools;

// Sales Tracking functionality with comprehensive error handling
class SalesTracking {
    constructor() {
        this.isInitialized = false;
        this.chartInstance = null;
        this.salesData = [];
        this.lastForecastUpdate = 0;
        this.forecastCache = null;
        this.init();
    }

    async init() {
        try {
            this.setupEventListeners();
            await this.loadSalesHistory();
            this.generateForecast();
            this.isInitialized = true;
            console.log('‚úÖ Sales Tracking initialized successfully');
        } catch (error) {
            console.error('‚ùå Sales Tracking initialization failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    setupEventListeners() {
        // Save sales button
        const saveSalesBtn = utils.safeGetElement('#save-sales');
        if (saveSalesBtn) {
            saveSalesBtn.addEventListener('click', this.handleSaveSales.bind(this));
        }

        // Refresh sales history button
        const refreshHistoryBtn = utils.safeGetElement('#refresh-sales-history');
        if (refreshHistoryBtn) {
            refreshHistoryBtn.addEventListener('click', this.handleRefreshHistory.bind(this));
        }

        // Auto-calculate revenue based on sticks sold
        const sticksInput = utils.safeGetElement('#sticks-sold');
        const revenueInput = utils.safeGetElement('#total-revenue');
        
        if (sticksInput && revenueInput) {
            sticksInput.addEventListener('input', utils.debounce((e) => {
                this.autoCalculateRevenue(e.target.value);
            }, 500));
        }

        // Auto-calculate cost based on sticks sold
        if (sticksInput) {
            const costInput = utils.safeGetElement('#total-cost');
            if (costInput) {
                sticksInput.addEventListener('input', utils.debounce((e) => {
                    this.autoCalculateCost(e.target.value);
                }, 500));
            }
        }

        // Form validation on input
        const formInputs = utils.safeGetElements('#sticks-sold, #total-revenue, #total-cost');
        formInputs.forEach(input => {
            input.addEventListener('blur', this.validateInput.bind(this));
        });
    }

    autoCalculateRevenue(sticksCount) {
        try {
            const sticks = utils.sanitizeInput(sticksCount, 'number');
            if (sticks <= 0) return;

            // Get average selling price from business tools or use default
            const avgPriceInput = utils.safeGetElement('#avg-selling-price');
            const avgPrice = avgPriceInput ? 
                utils.sanitizeInput(avgPriceInput.value, 'number') : 20;

            if (avgPrice > 0) {
                const estimatedRevenue = sticks * avgPrice;
                const revenueInput = utils.safeGetElement('#total-revenue');
                if (revenueInput && !revenueInput.value) {
                    revenueInput.value = estimatedRevenue;
                    revenueInput.style.backgroundColor = '#f
0f8ff';
                   setTimeout(() => {
                       revenueInput.style.backgroundColor = '';
                   }, 1500);
               }
           }
       } catch (error) {
           console.error('‚ùå Auto revenue calculation failed:', error);
       }
   }

   autoCalculateCost(sticksCount) {
       try {
           const sticks = utils.sanitizeInput(sticksCount, 'number');
           if (sticks <= 0) return;

           // Get cost per stick from business tools
           const meatPrice = utils.sanitizeInput(
               utils.safeGetElement('#meat-price')?.value || '200', 'number'
           );
           const weightPerStick = utils.sanitizeInput(
               utils.safeGetElement('#weight-per-stick')?.value || '80', 'number'
           );
           const otherCosts = utils.sanitizeInput(
               utils.safeGetElement('#other-costs')?.value || '3', 'number'
           );

           const costPerStick = utils.calculateCostPerStick(meatPrice, weightPerStick, otherCosts);
           
           if (costPerStick > 0) {
               const estimatedCost = sticks * costPerStick;
               const costInput = utils.safeGetElement('#total-cost');
               if (costInput && !costInput.value) {
                   costInput.value = Math.round(estimatedCost);
                   costInput.style.backgroundColor = '#f0f8ff';
                   setTimeout(() => {
                       costInput.style.backgroundColor = '';
                   }, 1500);
               }
           }
       } catch (error) {
           console.error('‚ùå Auto cost calculation failed:', error);
       }
   }

   validateInput(event) {
       const input = event.target;
       const value = utils.sanitizeInput(input.value, 'number');
       
       // Remove any existing validation styling
       input.classList.remove('input-error', 'input-warning');
       
       if (input.id === 'sticks-sold' && value <= 0) {
           this.showInputError(input, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
       } else if (input.id === 'total-revenue' && value <= 0) {
           this.showInputError(input, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
       } else if (input.id === 'total-cost' && value < 0) {
           this.showInputError(input, '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ');
       } else {
           this.clearInputError(input);
       }
   }

   showInputError(input, message) {
       input.classList.add('input-error');
       
       // Remove existing error message
       const existingError = input.parentNode.querySelector('.input-error-message');
       if (existingError) {
           existingError.remove();
       }
       
       // Add new error message
       const errorDiv = document.createElement('div');
       errorDiv.className = 'input-error-message';
       errorDiv.textContent = message;
       errorDiv.style.cssText = `
           color: var(--danger-color);
           font-size: 12px;
           margin-top: 4px;
       `;
       
       input.parentNode.appendChild(errorDiv);
   }

   clearInputError(input) {
       input.classList.remove('input-error');
       const errorMessage = input.parentNode.querySelector('.input-error-message');
       if (errorMessage) {
           errorMessage.remove();
       }
   }

   async handleSaveSales(event) {
       const button = event.target;
       if (!button) return;

       try {
           utils.setButtonLoading(button, true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');

           // Validate form data
           const salesData = this.collectSalesFormData();
           this.validateSalesData(salesData);

           // Save to database
           const salesId = await this.saveSalesData(salesData);
           
           // Clear form
           this.clearSalesForm();
           
           // Refresh history
           await this.loadSalesHistory();
           
           // Update forecast
           this.generateForecast();
           
           notificationSystem.success(
               `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡∏Å‡∏≥‡πÑ‡∏£: ${utils.formatCurrency(salesData.profit)}`,
               '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
           );

       } catch (error) {
           console.error('‚ùå Save sales failed:', error);
           notificationSystem.error(
               error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
               '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
           );
       } finally {
           utils.setButtonLoading(button, false);
       }
   }

   collectSalesFormData() {
       const sticksInput = utils.safeGetElement('#sticks-sold');
       const revenueInput = utils.safeGetElement('#total-revenue');
       const costInput = utils.safeGetElement('#total-cost');
       const noteInput = utils.safeGetElement('#sales-note');

       const data = {
           sticksSold: utils.sanitizeInput(sticksInput?.value, 'number'),
           totalRevenue: utils.sanitizeInput(revenueInput?.value, 'number'),
           totalCost: utils.sanitizeInput(costInput?.value, 'number'),
           note: utils.sanitizeInput(noteInput?.value, 'string'),
           date: new Date().toISOString().split('T')[0], // YYYY-MM-DD format
           timestamp: new Date()
       };

       // Calculate derived values
       data.profit = data.totalRevenue - data.totalCost;
       data.profitMargin = data.totalRevenue > 0 ? 
           ((data.profit / data.totalRevenue) * 100) : 0;
       data.pricePerStick = data.sticksSold > 0 ? 
           (data.totalRevenue / data.sticksSold) : 0;
       data.costPerStick = data.sticksSold > 0 ? 
           (data.totalCost / data.sticksSold) : 0;

       return data;
   }

   validateSalesData(data) {
       const errors = [];

       if (data.sticksSold <= 0) {
           errors.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
       }

       if (data.totalRevenue <= 0) {
           errors.push('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
       }

       if (data.totalCost < 0) {
           errors.push('‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ');
       }

       if (data.sticksSold > 1000) {
           errors.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πâ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1,000 ‡πÑ‡∏°‡πâ)');
       }

       if (data.pricePerStick > 100) {
           errors.push('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 100 ‡∏ö‡∏≤‡∏ó)');
       }

       if (data.pricePerStick < 5) {
           errors.push('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ö‡∏≤‡∏ó)');
       }

       if (data.profit < 0 && Math.abs(data.profitMargin) > 50) {
           errors.push('‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 50% ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
       }

       if (errors.length > 0) {
           throw new Error(errors.join('\n'));
       }
   }

   async saveSalesData(data) {
       try {
           return await window.firebaseUtils.hybridSave(
               'sales',
               data,
               null,
               window.firebaseUtils.localStorageKeys.SALES_DATA
           );
       } catch (error) {
           console.error('‚ùå Database save failed:', error);
           
           // If hybrid save fails, try localStorage only
           try {
               const existingData = utils.getLocalStorage('sales_backup', []);
               existingData.push({ ...data, id: utils.generateId('sales') });
               utils.setLocalStorage('sales_backup', existingData);
               
               throw new Error('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
           } catch (localError) {
               throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
           }
       }
   }

   clearSalesForm() {
       const inputs = utils.safeGetElements('#sticks-sold, #total-revenue, #total-cost, #sales-note');
       inputs.forEach(input => {
           input.value = '';
           this.clearInputError(input);
       });
   }

   async handleRefreshHistory(event) {
       const button = event.target.closest('.refresh-btn');
       if (!button) return;

       try {
           utils.setButtonLoading(button, true);
           await this.loadSalesHistory();
           notificationSystem.success('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
       } catch (error) {
           console.error('‚ùå Refresh history failed:', error);
           notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
       } finally {
           utils.setButtonLoading(button, false);
       }
   }

   async loadSalesHistory() {
       try {
           // Get sales data from last 7 days
           const salesData = await window.firebaseUtils.hybridGet(
               'sales',
               null,
               { field: 'timestamp', direction: 'desc' },
               7,
               window.firebaseUtils.localStorageKeys.SALES_DATA
           );

           this.salesData = salesData || [];
           this.displaySalesHistory();
           this.updateSalesChart();

       } catch (error) {
           console.error('‚ùå Failed to load sales history:', error);
           this.showFallbackSalesHistory();
       }
   }

   displaySalesHistory() {
       const historyContainer = utils.safeGetElement('#sales-history');
       if (!historyContainer) return;

       if (this.salesData.length === 0) {
           historyContainer.innerHTML = `
               <div class="no-sales-data">
                   <div class="no-data-icon">
                       <i class="fas fa-chart-line"></i>
                   </div>
                   <h4>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h4>
                   <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</p>
               </div>
           `;
           return;
       }

       const salesItems = this.salesData.map(sale => {
           const date = new Date(sale.timestamp || sale.createdAt);
           const profitClass = sale.profit >= 0 ? 'text-success' : 'text-danger';
           
           return `
               <div class="sales-history-item">
                   <div class="sales-date">
                       <div class="date-main">${utils.formatShortDate(date)}</div>
                       <div class="date-sub">${utils.formatThaiDate(date, true).split('‡πÄ‡∏ß‡∏•‡∏≤')[1] || ''}</div>
                   </div>
                   <div class="sales-details">
                       <div class="sales-main">
                           <span class="sales-sticks">${sale.sticksSold} ‡πÑ‡∏°‡πâ</span>
                           <span class="sales-revenue">${utils.formatCurrency(sale.totalRevenue)}</span>
                       </div>
                       <div class="sales-sub">
                           <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${utils.formatCurrency(sale.totalCost)}</span>
                           <span class="sales-profit ${profitClass}">
                               ‡∏Å‡∏≥‡πÑ‡∏£: ${utils.formatCurrency(sale.profit)}
                           </span>
                       </div>
                       ${sale.note ? `<div class="sales-note">${sale.note}</div>` : ''}
                   </div>
                   <div class="sales-metrics">
                       <div class="metric-item">
                           <span class="metric-label">‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÑ‡∏°‡πâ</span>
                           <span class="metric-value">${utils.formatCurrency(sale.pricePerStick || 0)}</span>
                       </div>
                       <div class="metric-item">
                           <span class="metric-label">‡∏Å‡∏≥‡πÑ‡∏£%</span>
                           <span class="metric-value ${profitClass}">
                               ${(sale.profitMargin || 0).toFixed(1)}%
                           </span>
                       </div>
                   </div>
               </div>
           `;
       }).join('');

       historyContainer.innerHTML = salesItems;
       this.addSalesHistoryStyles();
   }

   showFallbackSalesHistory() {
       const historyContainer = utils.safeGetElement('#sales-history');
       if (!historyContainer) return;

       historyContainer.innerHTML = `
           <div class="sales-history-error">
               <div class="error-icon">
                   <i class="fas fa-exclamation-triangle"></i>
               </div>
               <h4>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h4>
               <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</p>
               <button class="btn btn-primary btn-sm" onclick="salesTracking.loadSalesHistory()">
                   <i class="fas fa-sync-alt"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
               </button>
           </div>
       `;
   }

   updateSalesChart() {
       const chartCanvas = utils.safeGetElement('#sales-chart');
       if (!chartCanvas) return;

       try {
           // Destroy existing chart
           if (this.chartInstance) {
               this.chartInstance.destroy();
               this.chartInstance = null;
           }

           // Prepare chart data
           const chartData = this.prepareChartData();
           
           // Create new chart
           this.chartInstance = this.createSalesChart(chartCanvas, chartData);

       } catch (error) {
           console.error('‚ùå Chart update failed:', error);
           this.showChartError(chartCanvas);
       }
   }

   prepareChartData() {
       if (this.salesData.length === 0) {
           return {
               labels: [],
               datasets: []
           };
       }

       // Sort by date and get last 7 days
       const sortedData = [...this.salesData]
           .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
           .slice(-7);

       const labels = sortedData.map(sale => {
           const date = new Date(sale.timestamp || sale.createdAt);
           return utils.formatShortDate(date);
       });

       const revenueData = sortedData.map(sale => sale.totalRevenue || 0);
       const profitData = sortedData.map(sale => sale.profit || 0);
       const sticksData = sortedData.map(sale => sale.sticksSold || 0);

       return {
           labels,
           datasets: [
               {
                   label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                   data: revenueData,
                   borderColor: 'rgb(255, 107, 53)',
                   backgroundColor: 'rgba(255, 107, 53, 0.1)',
                   yAxisID: 'y',
                   fill: true
               },
               {
                   label: '‡∏Å‡∏≥‡πÑ‡∏£ (‡∏ö‡∏≤‡∏ó)',
                   data: profitData,
                   borderColor: 'rgb(6, 214, 160)',
                   backgroundColor: 'rgba(6, 214, 160, 0.1)',
                   yAxisID: 'y',
                   fill: false
               },
               {
                   label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πâ',
                   data: sticksData,
                   borderColor: 'rgb(17, 138, 178)',
                   backgroundColor: 'rgba(17, 138, 178, 0.1)',
                   yAxisID: 'y1',
                   fill: false
               }
           ]
       };
   }

   createSalesChart(canvas, data) {
       // Since Chart.js might not be available, create a simple canvas chart
       const ctx = canvas.getContext('2d');
       
       // Clear canvas
       ctx.clearRect(0, 0, canvas.width, canvas.height);
       
       if (data.labels.length === 0) {
           this.drawNoDataMessage(ctx, canvas);
           return null;
       }

       // Simple line chart implementation
       return this.drawSimpleChart(ctx, canvas, data);
   }

   drawNoDataMessage(ctx, canvas) {
       ctx.fillStyle = '#9CA3AF';
       ctx.font = '16px Arial';
       ctx.textAlign = 'center';
       ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤—Ñ', canvas.width / 2, canvas.height / 2);
   }

   drawSimpleChart(ctx, canvas, data) {
       const padding = 40;
       const chartWidth = canvas.width - (padding * 2);
       const chartHeight = canvas.height - (padding * 2);
       
       // Calculate scales
       const maxRevenue = Math.max(...data.datasets[0].data, 0);
       const maxSticks = Math.max(...data.datasets[2].data, 0);
       
       if (maxRevenue === 0 && maxSticks === 0) {
           this.drawNoDataMessage(ctx, canvas);
           return null;
       }

       // Draw revenue line (primary dataset)
       if (maxRevenue > 0) {
           ctx.strokeStyle = 'rgb(255, 107, 53)';
           ctx.lineWidth = 2;
           ctx.beginPath();
           
           data.datasets[0].data.forEach((value, index) => {
               const x = padding + (index * chartWidth / (data.labels.length - 1 || 1));
               const y = padding + chartHeight - (value / maxRevenue * chartHeight);
               
               if (index === 0) {
                   ctx.moveTo(x, y);
               } else {
                   ctx.lineTo(x, y);
               }
           });
           
           ctx.stroke();
       }

       // Draw labels
       ctx.fillStyle = '#374151';
       ctx.font = '12px Arial';
       ctx.textAlign = 'center';
       
       data.labels.forEach((label, index) => {
           const x = padding + (index * chartWidth / (data.labels.length - 1 || 1));
           ctx.fillText(label, x, canvas.height - 10);
       });

       // Draw simple legend
       ctx.textAlign = 'left';
       ctx.fillStyle = 'rgb(255, 107, 53)';
       ctx.fillText('‚óè ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 10, 20);
       
       return { destroy: () => {} }; // Mock chart instance
   }

   showChartError(canvas) {
       const ctx = canvas.getContext('2d');
       ctx.clearRect(0, 0, canvas.width, canvas.height);
       ctx.fillStyle = '#EF4444';
       ctx.font = '14px Arial';
       ctx.textAlign = 'center';
       ctx.fillText('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ', canvas.width / 2, canvas.height / 2);
   }

   generateForecast() {
       try {
           // Check if enough time has passed since last forecast
           const now = Date.now();
           if (now - this.lastForecastUpdate < 60000 && this.forecastCache) {
               this.displayForecast(this.forecastCache);
               return;
           }

           const forecast = this.calculateForecast();
           this.forecastCache = forecast;
           this.lastForecastUpdate = now;
           this.displayForecast(forecast);

       } catch (error) {
           console.error('‚ùå Forecast generation failed:', error);
           this.showFallbackForecast();
       }
   }

   calculateForecast() {
       if (this.salesData.length === 0) {
           return this.getDefaultForecast();
       }

       try {
           // Calculate averages from recent data
           const recentSales = this.salesData.slice(0, 5); // Last 5 days
           
           const avgSticks = utils.arrayAverage(recentSales.map(s => s.sticksSold || 0));
           const avgRevenue = utils.arrayAverage(recentSales.map(s => s.totalRevenue || 0));
           const avgCost = utils.arrayAverage(recentSales.map(s => s.totalCost || 0));
           
           // Calculate weight needed (assuming 80g per stick)
           const weightNeeded = Math.ceil(avgSticks * 0.08); // 80g = 0.08kg
           
           // Apply day-of-week and weather adjustments
           const tomorrow = new Date();
           tomorrow.setDate(tomorrow.getDate() + 1);
           
           const dayMultiplier = this.getDayOfWeekMultiplier(tomorrow.getDay());
           const weatherMultiplier = this.getWeatherMultiplier();
           
           const adjustedSticks = Math.round(avgSticks * dayMultiplier * weatherMultiplier);
           const adjustedWeight = Math.ceil(adjustedSticks * 0.08);
           
           // Generate tips
           const tips = this.generateForecastTips(adjustedSticks, avgSticks, dayMultiplier, weatherMultiplier);

           return {
               predictedSales: `${Math.max(adjustedSticks - 10, 0)}-${adjustedSticks + 10} ‡πÑ‡∏°‡πâ`,
               materialNeeded: `${Math.max(adjustedWeight - 1, 1)}-${adjustedWeight + 1} ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°`,
               tips,
               confidence: recentSales.length >= 3 ? '‡∏Å‡∏•‡∏≤‡∏á-‡∏™‡∏π‡∏á' : '‡∏ï‡πà‡∏≥',
               basedOn: `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${recentSales.length} ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á`
           };

       } catch (error) {
           console.error('‚ùå Forecast calculation error:', error);
           return this.getDefaultForecast();
       }
   }

   getDayOfWeekMultiplier(dayOfWeek) {
       // 0 = Sunday, 6 = Saturday
       const multipliers = {
           0: 1.2,  // Sunday
           1: 0.8,  // Monday
           2: 0.9,  // Tuesday
           3: 0.9,  // Wednesday
           4: 1.0,  // Thursday
           5: 1.3,  // Friday
           6: 1.4   // Saturday
       };
       
       return multipliers[dayOfWeek] || 1.0;
   }

   getWeatherMultiplier() {
       // This would ideally use real weather data
       // For now, return random factor between 0.8-1.2
       return 0.8 + (Math.random() * 0.4);
   }

   generateForecastTips(adjustedSticks, avgSticks, dayMultiplier, weatherMultiplier) {
       const tips = [];
       
       // Day-based tips
       const tomorrow = new Date();
       tomorrow.setDate(tomorrow.getDate() + 1);
       const dayName = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'][tomorrow.getDay()];
       
       if (dayMultiplier > 1.1) {
           tips.push(`‡∏ß‡∏±‡∏ô${dayName} ‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°`);
       } else if (dayMultiplier < 0.9) {
           tips.push(`‡∏ß‡∏±‡∏ô${dayName} ‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢ ‡∏≠‡∏≤‡∏à‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï`);
       }

       // Weather-based tips
       if (weatherMultiplier > 1.1) {
           tips.push('‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞');
       } else if (weatherMultiplier < 0.9) {
           tips.push('‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á');
       }

       // Stock recommendations
       const weightKg = Math.ceil(adjustedSticks * 0.08);
       const belly = Math.ceil(weightKg * 0.6); // 60% belly
       const neck = Math.ceil(weightKg * 0.4);  // 40% neck
       
       tips.push(`‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô ${belly} ‡∏Å‡∏Å. ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠ ${neck} ‡∏Å‡∏Å.`);

       // Trend-based tips
       if (adjustedSticks > avgSticks * 1.1) {
           tips.push('‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©');
       } else if (adjustedSticks < avgSticks * 0.9) {
           tips.push('‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
       }

       return tips.length > 0 ? tips : ['‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢'];
   }

   getDefaultForecast() {
       return {
           predictedSales: '80-120 ‡πÑ‡∏°‡πâ',
           materialNeeded: '7-10 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°',
           tips: [
               '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô 5 ‡∏Å‡∏Å. ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠ 3 ‡∏Å‡∏Å.',
               '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô'
           ],
           confidence: '‡∏ï‡πà‡∏≥',
           basedOn: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô'
       };
   }

   displayForecast(forecast) {
       const forecastContainer = utils.safeGetElement('#forecast-content');
       if (!forecastContainer) return;

       const confidenceClass = forecast.confidence.includes('‡∏™‡∏π‡∏á') ? 'text-success' : 
                              forecast.confidence.includes('‡∏Å‡∏•‡∏≤‡∏á') ? 'text-warning' : 'text-muted';

       forecastContainer.innerHTML = `
           <div class="forecast-item">
               <div class="forecast-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
               <div class="forecast-value">${forecast.predictedSales}</div>
           </div>
           <div class="forecast-item">
               <div class="forecast-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</div>
               <div class="forecast-value">${forecast.materialNeeded}</div>
           </div>
           <div class="forecast-confidence">
               <span class="confidence-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠:</span>
               <span class="confidence-value ${confidenceClass}">${forecast.confidence}</span>
               <span class="confidence-base">(${forecast.basedOn})</span>
           </div>
           <div class="forecast-recommendations">
               <h4>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</h4>
               <ul id="forecast-tips">
                   ${forecast.tips.map(tip => `<li>${tip}</li>`).join('')}
               </ul>
           </div>
       `;
   }

   showFallbackForecast() {
       const forecastContainer = utils.safeGetElement('#forecast-content');
       if (!forecastContainer) return;

       forecastContainer.innerHTML = `
           <div class="forecast-item">
               <div class="forecast-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
               <div class="forecast-value">90-110 ‡πÑ‡∏°‡πâ</div>
           </div>
           <div class="forecast-item">
               <div class="forecast-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</div>
               <div class="forecast-value">8-9 ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</div>
           </div>
           <div class="forecast-recommendations">
               <h4>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</h4>
               <ul id="forecast-tips">
                   <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô 5 ‡∏Å‡∏Å. ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠ 3 ‡∏Å‡∏Å.</li>
                   <li>‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ</li>
               </ul>
           </div>
       `;
   }

   addSalesHistoryStyles() {
       if (document.getElementById('sales-history-styles')) return;

       const style = document.createElement('style');
       style.id = 'sales-history-styles';
       style.textContent = `
           .sales-history-item {
               display: grid;
               grid-template-columns: auto 1fr auto;
               gap: 16px;
               padding: 16px;
               background: white;
               border-radius: 8px;
               margin-bottom: 12px;
               border: 1px solid var(--gray-200);
               transition: var(--transition);
           }

           .sales-history-item:hover {
               border-color: var(--primary-color);
               transform: translateY(-1px);
               box-shadow: var(--box-shadow);
           }

           .sales-date {
               display: flex;
               flex-direction: column;
               align-items: center;
               min-width: 80px;
           }

           .date-main {
               font-weight: 600;
               font-size: 14px;
               color:

var(--gray-800);
           }

           .date-sub {
               font-size: 12px;
               color: var(--gray-500);
           }

           .sales-details {
               flex: 1;
           }

           .sales-main {
               display: flex;
               justify-content: space-between;
               align-items: center;
               margin-bottom: 4px;
           }

           .sales-sticks {
               font-weight: 600;
               color: var(--primary-color);
           }

           .sales-revenue {
               font-weight: 600;
               font-family: var(--font-accent);
               color: var(--gray-800);
           }

           .sales-sub {
               display: flex;
               justify-content: space-between;
               font-size: 13px;
               color: var(--gray-600);
           }

           .sales-profit {
               font-weight: 500;
           }

           .sales-note {
               font-size: 12px;
               color: var(--gray-500);
               font-style: italic;
               margin-top: 8px;
               padding: 8px;
               background: var(--gray-100);
               border-radius: 4px;
           }

           .sales-metrics {
               display: flex;
               flex-direction: column;
               gap: 8px;
               min-width: 80px;
           }

           .metric-item {
               display: flex;
               flex-direction: column;
               align-items: center;
               text-align: center;
           }

           .metric-label {
               font-size: 11px;
               color: var(--gray-500);
               margin-bottom: 2px;
           }

           .metric-value {
               font-size: 13px;
               font-weight: 600;
               font-family: var(--font-accent);
           }

           .no-sales-data,
           .sales-history-error {
               text-align: center;
               padding: 40px 20px;
               color: var(--gray-600);
           }

           .no-data-icon,
           .error-icon {
               font-size: 48px;
               color: var(--gray-400);
               margin-bottom: 16px;
           }

           .sales-history-error .error-icon {
               color: var(--warning-color);
           }

           .no-sales-data h4,
           .sales-history-error h4 {
               margin-bottom: 8px;
               color: var(--gray-800);
           }

           .input-error {
               border-color: var(--danger-color) !important;
               box-shadow: 0 0 0 3px rgba(239, 71, 111, 0.1) !important;
           }

           .forecast-item {
               display: flex;
               justify-content: space-between;
               align-items: center;
               padding: 12px 0;
               border-bottom: 1px solid var(--gray-200);
           }

           .forecast-item:last-child {
               border-bottom: none;
           }

           .forecast-label {
               font-weight: 500;
               color: var(--gray-700);
           }

           .forecast-value {
               font-weight: 600;
               font-family: var(--font-accent);
               color: var(--primary-color);
           }

           .forecast-confidence {
               margin: 16px 0;
               padding: 12px;
               background: var(--gray-100);
               border-radius: 6px;
               font-size: 14px;
           }

           .confidence-label {
               color: var(--gray-600);
           }

           .confidence-value {
               font-weight: 600;
               margin: 0 8px;
           }

           .confidence-base {
               font-size: 12px;
               color: var(--gray-500);
           }

           .forecast-recommendations h4 {
               margin-bottom: 12px;
               color: var(--gray-800);
               font-size: 16px;
           }

           .forecast-recommendations ul {
               margin: 0;
               padding-left: 20px;
           }

           .forecast-recommendations li {
               margin-bottom: 8px;
               color: var(--gray-700);
               line-height: 1.4;
           }

           @media (max-width: 768px) {
               .sales-history-item {
                   grid-template-columns: 1fr;
                   gap: 12px;
               }

               .sales-date {
                   flex-direction: row;
                   justify-content: space-between;
                   min-width: auto;
               }

               .sales-main,
               .sales-sub {
                   flex-direction: column;
                   align-items: flex-start;
                   gap: 4px;
               }

               .sales-metrics {
                   flex-direction: row;
                   justify-content: space-around;
                   min-width: auto;
               }
           }
       `;

       document.head.appendChild(style);
   }

   destroy() {
       if (this.chartInstance) {
           this.chartInstance.destroy();
           this.chartInstance = null;
       }
       this.salesData = [];
       this.forecastCache = null;
       this.isInitialized = false;
   }
}

// Create and export sales tracking instance
const salesTracking = new SalesTracking();
window.salesTracking = salesTracking;

// AI Advisor functionality with comprehensive error handling
class AIAdvisor {
    constructor() {
        this.isInitialized = false;
        this.chatHistory = [];
        this.isTyping = false;
        this.messageQueue = [];
        this.apiKey = null;
        this.maxHistoryLength = 50;
        this.responseTimeout = 30000; // 30 seconds
        this.init();
    }

    async init() {
        try {
            this.setupEventListeners();
            this.loadChatHistory();
            this.loadAPIKey();
            this.isInitialized = true;
            console.log('‚úÖ AI Advisor initialized successfully');
        } catch (error) {
            console.error('‚ùå AI Advisor initialization failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    setupEventListeners() {
        // Send message button
        const sendBtn = utils.safeGetElement('#send-message');
        if (sendBtn) {
            sendBtn.addEventListener('click', this.handleSendMessage.bind(this));
        }

        // Chat input field
        const chatInput = utils.safeGetElement('#chat-input');
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.handleSendMessage();
                }
            });

            chatInput.addEventListener('input', this.handleInputChange.bind(this));
        }

        // Quick question buttons
        const quickBtns = utils.safeGetElements('.quick-btn');
        quickBtns.forEach(btn => {
            btn.addEventListener('click', this.handleQuickQuestion.bind(this));
        });

        // Clear chat button
        const clearBtn = utils.safeGetElement('#clear-chat');
        if (clearBtn) {
            clearBtn.addEventListener('click', this.handleClearChat.bind(this));
        }
    }

    loadAPIKey() {
        try {
            this.apiKey = utils.getLocalStorage('openai_api_key');
            if (!this.apiKey) {
                this.showAPIKeyWarning();
            }
        } catch (error) {
            console.error('‚ùå Failed to load API key:', error);
        }
    }

    showAPIKeyWarning() {
        this.addBotMessage(
            '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° OpenAI API Key\n\n‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',
            'system'
        );
    }

    loadChatHistory() {
        try {
            const savedHistory = utils.getLocalStorage('chat_history', []);
            this.chatHistory = savedHistory.slice(-this.maxHistoryLength);
            this.displayChatHistory();
        } catch (error) {
            console.error('‚ùå Failed to load chat history:', error);
            this.chatHistory = [];
        }
    }

    saveChatHistory() {
        try {
            const historyToSave = this.chatHistory.slice(-this.maxHistoryLength);
            utils.setLocalStorage('chat_history', historyToSave);
        } catch (error) {
            console.error('‚ùå Failed to save chat history:', error);
        }
    }

    displayChatHistory() {
        const messagesContainer = utils.safeGetElement('#chat-messages');
        if (!messagesContainer) return;

        // Clear existing messages except the welcome message
        const welcomeMessage = messagesContainer.querySelector('.message.bot-message');
        messagesContainer.innerHTML = '';
        
        if (welcomeMessage) {
            messagesContainer.appendChild(welcomeMessage);
        }

        // Display chat history
        this.chatHistory.forEach(message => {
            this.displayMessage(message, false);
        });

        this.scrollToBottom();
    }

    handleInputChange(event) {
        const input = event.target;
        const sendBtn = utils.safeGetElement('#send-message');
        
        if (sendBtn) {
            sendBtn.disabled = input.value.trim().length === 0 || this.isTyping;
        }
    }

    handleQuickQuestion(event) {
        const button = event.target.closest('.quick-btn');
        if (!button) return;

        const question = button.dataset.question;
        if (question) {
            const chatInput = utils.safeGetElement('#chat-input');
            if (chatInput) {
                chatInput.value = question;
                this.handleSendMessage();
            }
        }
    }

    async handleSendMessage() {
        const chatInput = utils.safeGetElement('#chat-input');
        if (!chatInput) return;

        const message = chatInput.value.trim();
        if (!message || this.isTyping) return;

        try {
            // Clear input and disable send button
            chatInput.value = '';
            this.updateSendButton(true);

            // Add user message
            this.addUserMessage(message);

            // Show typing indicator
            this.showTypingIndicator();

            // Get AI response
            const response = await this.getAIResponse(message);

            // Remove typing indicator and add bot response
            this.hideTypingIndicator();
            this.addBotMessage(response);

        } catch (error) {
            console.error('‚ùå Send message failed:', error);
            this.hideTypingIndicator();
            this.addBotMessage(
                '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                'error'
            );
        } finally {
            this.updateSendButton(false);
        }
    }

    addUserMessage(message) {
        const messageObj = {
            id: utils.generateId('msg'),
            type: 'user',
            content: message,
            timestamp: new Date()
        };

        this.chatHistory.push(messageObj);
        this.displayMessage(messageObj);
        this.saveChatHistory();
    }

    addBotMessage(message, type = 'bot') {
        const messageObj = {
            id: utils.generateId('msg'),
            type: type,
            content: message,
            timestamp: new Date()
        };

        this.chatHistory.push(messageObj);
        this.displayMessage(messageObj);
        this.saveChatHistory();
    }

    displayMessage(messageObj, animate = true) {
        const messagesContainer = utils.safeGetElement('#chat-messages');
        if (!messagesContainer) return;

        const messageElement = document.createElement('div');
        messageElement.className = `message ${messageObj.type === 'user' ? 'user-message' : 'bot-message'}`;
        messageElement.setAttribute('data-id', messageObj.id);

        if (messageObj.type === 'user') {
            messageElement.innerHTML = `
                <div class="message-content">
                    <p>${this.formatMessage(messageObj.content)}</p>
                    <div class="message-time">${this.formatTime(messageObj.timestamp)}</div>
                </div>
                <div class="message-avatar">
                    <i class="fas fa-user"></i>
                </div>
            `;
        } else {
            const iconClass = messageObj.type === 'error' ? 'fas fa-exclamation-triangle' : 
                             messageObj.type === 'system' ? 'fas fa-info-circle' : 'fas fa-robot';
            
            messageElement.innerHTML = `
                <div class="message-avatar">
                    <i class="${iconClass}"></i>
                </div>
                <div class="message-content">
                    ${this.formatMessage(messageObj.content)}
                    <div class="message-time">${this.formatTime(messageObj.timestamp)}</div>
                </div>
            `;
        }

        if (animate) {
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(20px)';
        }

        messagesContainer.appendChild(messageElement);

        if (animate) {
            requestAnimationFrame(() => {
                messageElement.style.transition = 'all 0.3s ease';
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            });
        }

        this.scrollToBottom();
    }

    formatMessage(content) {
        // Handle multi-line messages
        const lines = content.split('\n');
        
        if (lines.length === 1) {
            return `<p>${this.escapeHtml(content)}</p>`;
        }

        // Format as paragraphs and lists
        let formatted = '';
        let inList = false;
        
        lines.forEach(line => {
            const trimmed = line.trim();
            
            if (trimmed.startsWith('‚Ä¢') || trimmed.startsWith('-')) {
                if (!inList) {
                    formatted += '<ul>';
                    inList = true;
                }
                formatted += `<li>${this.escapeHtml(trimmed.substring(1).trim())}</li>`;
            } else {
                if (inList) {
                    formatted += '</ul>';
                    inList = false;
                }
                if (trimmed) {
                    formatted += `<p>${this.escapeHtml(trimmed)}</p>`;
                }
            }
        });
        
        if (inList) {
            formatted += '</ul>';
        }
        
        return formatted;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('th-TH', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    showTypingIndicator() {
        if (this.isTyping) return;
        
        this.isTyping = true;
        const messagesContainer = utils.safeGetElement('#chat-messages');
        if (!messagesContainer) return;

        const typingElement = document.createElement('div');
        typingElement.className = 'message bot-message typing-indicator';
        typingElement.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;

        messagesContainer.appendChild(typingElement);
        this.scrollToBottom();
        this.addTypingStyles();
    }

    hideTypingIndicator() {
        this.isTyping = false;
        const typingIndicator = utils.safeGetElement('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    updateSendButton(disabled) {
        const sendBtn = utils.safeGetElement('#send-message');
        const chatInput = utils.safeGetElement('#chat-input');
        
        if (sendBtn) {
            sendBtn.disabled = disabled || (chatInput && chatInput.value.trim().length === 0);
        }
    }

    async getAIResponse(message) {
        try {
            // Check if API key is available
            if (this.apiKey && this.apiKey.startsWith('sk-')) {
                return await this.getOpenAIResponse(message);
            } else {
                return this.getPredefinedResponse(message);
            }
        } catch (error) {
            console.error('‚ùå AI response failed:', error);
            throw error;
        }
    }

    async getOpenAIResponse(message) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.responseTimeout);

        try {
            // Prepare context from recent messages
            const context = this.prepareContext();
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'system',
                            content: this.getSystemPrompt()
                        },
                        ...context,
                        {
                            role: 'user',
                            content: message
                        }
                    ],
                    max_tokens: 500,
                    temperature: 0.7
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.choices && data.choices[0] && data.choices[0].message) {
                return data.choices[0].message.content.trim();
            } else {
                throw new Error('Invalid API response');
            }

        } catch (error) {
            clearTimeout(timeoutId);
            
            if (error.name === 'AbortError') {
                throw new Error('‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            } else if (error.message.includes('401')) {
                throw new Error('API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
            } else if (error.message.includes('429')) {
                throw new Error('‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô API ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
            } else {
                throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ OpenAI ‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á');
            }
        }
    }

    getSystemPrompt() {
        return `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:
- ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢
- ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
- ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡πÄ‡∏•
- ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡πÑ‡∏£

‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á`;
    }

    prepareContext() {
        // Get last 5 messages for context
        const recentMessages = this.chatHistory
            .slice(-10)
            .filter(msg => msg.type === 'user' || msg.type === 'bot')
            .slice(-5);

        return recentMessages.map(msg => ({
            role: msg.type === 'user' ? 'user' : 'assistant',
            content: msg.content
        }));
    }

    getPredefinedResponse(message) {
        return new Promise((resolve) => {
            // Simulate API delay
            setTimeout(() => {
                const response = this.matchPredefinedResponse(message);
                resolve(response);
            }, 1000 + Math.random() * 2000);
        });
    }

    matchPredefinedResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        // Price-related questions
        if (lowerMessage.includes('‡∏£‡∏≤‡∏Ñ‡∏≤') || lowerMessage.includes('‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà')) {
            return `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π + ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á + ‡πÅ‡∏Å‡πä‡∏™ + ‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô)
- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£ 50-70% ‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
- ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
- ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏≥‡πÄ‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û

‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: 15-25 ‡∏ö‡∏≤‡∏ó/‡πÑ‡∏°‡πâ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏≥‡πÄ‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô`;
        }

        // Time-related questions
        if (lowerMessage.includes('‡πÄ‡∏ß‡∏•‡∏≤') || lowerMessage.includes('‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô')) {
            return `‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á:

- 16:00-21:00 ‡∏ô. = ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
- 11:30-14:00 ‡∏ô. = ‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á (‡πÉ‡∏Å‡∏•‡πâ‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®/‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô)
- ‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå-‡πÄ‡∏™‡∏≤‡∏£‡πå = ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
- ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏û‡∏∏‡∏ò = ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤

‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ô‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á 17:00-20:00 ‡∏ô. ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å`;
        }

        // Cost reduction questions
        if (lowerMessage.includes('‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô') || lowerMessage.includes('‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î')) {
            return `‡∏ß‡∏¥‡∏ò‡∏µ‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á:

- ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π‡∏à‡∏≤‡∏Å‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡πÅ‡∏ó‡∏ô‡∏ã‡∏∏‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏°‡∏≤‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ï
- ‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏°‡∏≤‡∏Å (‡∏Ç‡∏≤‡∏¢‡∏™‡πà‡∏á)
- ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πä‡∏™‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ
- ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏≠‡∏á ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ
- ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏µ ‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢

‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏î‡πâ 15-25% ‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô`;
        }

        // Location questions
        if (lowerMessage.includes('‡∏ó‡∏≥‡πÄ‡∏•') || lowerMessage.includes('‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á')) {
            return `‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡πÄ‡∏•‡∏Ç‡∏≤‡∏¢‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á:

‡∏ó‡∏≥‡πÄ‡∏•‡∏î‡∏µ:
- ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏≠‡∏û‡∏±‡∏Å ‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢
- ‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô
- ‡∏Ç‡πâ‡∏≤‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô)
- ‡πÉ‡∏ô‡∏ã‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡∏≠‡∏∞

‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á:
- ‡∏ñ‡∏ô‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏¢‡∏≤‡∏Å
- ‡πÉ‡∏Å‡∏•‡πâ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏ß‡∏±‡∏î
- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î

‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ`;
        }

        // Stock management questions
        if (lowerMessage.includes('‡∏™‡∏ï‡πá‡∏≠‡∏Å') || lowerMessage.includes('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°')) {
            return `‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á:

‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:
- ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 80-100 ‡∏Å‡∏£‡∏±‡∏° ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ
- 1 ‡∏Å‡∏Å. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π = 12-13 ‡πÑ‡∏°‡πâ
- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 10-15% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:
- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° 60% ‡∏´‡∏°‡∏π‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô, 40% ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠
- ‡∏´‡∏°‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 2-4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
- ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏≥‡πÉ‡∏™‡πà‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ

‡∏´‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 100 ‡πÑ‡∏°‡πâ/‡∏ß‡∏±‡∏ô ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° 8-9 ‡∏Å‡∏Å.`;
        }

        // General business questions
        if (lowerMessage.includes('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô') || lowerMessage.includes('‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à')) {
            return `‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á:

‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: 15,000-30,000 ‡∏ö‡∏≤‡∏ó
- ‡πÄ‡∏ï‡∏≤‡∏õ‡∏¥‡πâ‡∏á‡∏¢‡∏≤‡∏á + ‡πÅ‡∏Å‡πä‡∏™: 8,000 ‡∏ö‡∏≤‡∏ó
- ‡πÇ‡∏ï‡πä‡∏∞ ‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: 5,000 ‡∏ö‡∏≤‡∏ó
- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏£‡∏Å: 3,000 ‡∏ö‡∏≤‡∏ó
- ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á: 5,000-10,000 ‡∏ö‡∏≤‡∏ó

‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:
1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡πÄ‡∏•
2. ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå
3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
4. ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏™‡∏π‡∏ï‡∏£
5. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≤‡∏¢

‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô 3-6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
        }

        // Marketing questions
        if (lowerMessage.includes('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô') || lowerMessage.includes('‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î')) {
            return `‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á:

‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏•:
- ‡∏ã‡∏∑‡πâ‡∏≠ 10 ‡πÅ‡∏ñ‡∏° 1
- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏ñ‡∏° 5 ‡πÑ‡∏°‡πâ
- ‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î ‡∏•‡∏î 20%
- ‡πÅ‡∏û‡πá‡∏Å‡∏Ñ‡∏π‡πà (‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á + ‡∏ô‡πâ‡∏≥) ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©

‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î:
- ‡πÉ‡∏™‡πà‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ä‡∏ô
- ‡πÇ‡∏û‡∏™‡∏ï‡πå Facebook ‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô
- ‡πÉ‡∏™‡πà‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏Å‡∏•
- ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ñ‡∏á‡∏ó‡∏µ‡πà

‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢: ‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏°‡∏±‡∏Å‡πÄ‡∏≠‡∏á ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ`;
        }

        // Default response
        return `‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°! 

‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡∏õ‡∏¥‡πâ‡∏á ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì:

- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡πÄ‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢  
- ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏£‡∏™‡∏ä‡∏≤‡∏ï‡∏¥
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥
- ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡πÑ‡∏£

‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ó‡∏≥‡πÄ‡∏• ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏ú‡∏°‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå`;
    }

    handleClearChat() {
        if (this.chatHistory.length === 0) {
            notificationSystem.info('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á');
            return;
        }

        if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            this.chatHistory = [];
            this.saveChatHistory();
            
            // Clear display but keep welcome message
            const messagesContainer = utils.safeGetElement('#chat-messages');
            if (messagesContainer) {
                const welcomeMessage = messagesContainer.querySelector('.message.bot-message');
                messagesContainer.innerHTML = '';
                if (welcomeMessage) {
                    messagesContainer.appendChild(welcomeMessage);
                }
            }

            notificationSystem.success('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
    }

    scrollToBottom() {
        const messagesContainer = utils.safeGetElement('#chat-messages');
        if (messagesContainer) {

messagesContainer.scrollTop = messagesContainer.scrollHeight;
       }
   }

   addTypingStyles() {
       if (document.getElementById('typing-styles')) return;

       const style = document.createElement('style');
       style.id = 'typing-styles';
       style.textContent = `
           .typing-indicator {
               opacity: 0.7;
           }

           .typing-dots {
               display: flex;
               align-items: center;
               gap: 4px;
               padding: 12px 16px;
           }

           .typing-dots span {
               width: 8px;
               height: 8px;
               background: var(--primary-color);
               border-radius: 50%;
               animation: typing 1.4s infinite ease-in-out;
           }

           .typing-dots span:nth-child(1) {
               animation-delay: -0.32s;
           }

           .typing-dots span:nth-child(2) {
               animation-delay: -0.16s;
           }

           @keyframes typing {
               0%, 80%, 100% {
                   transform: scale(0.8);
                   opacity: 0.5;
               }
               40% {
                   transform: scale(1);
                   opacity: 1;
               }
           }

           .message {
               display: flex;
               gap: 12px;
               margin-bottom: 16px;
               max-width: 100%;
           }

           .user-message {
               flex-direction: row-reverse;
               margin-left: 20%;
           }

           .bot-message {
               margin-right: 20%;
           }

           .message-avatar {
               width: 36px;
               height: 36px;
               border-radius: 50%;
               display: flex;
               align-items: center;
               justify-content: center;
               flex-shrink: 0;
               font-size: 16px;
               color: white;
           }

           .user-message .message-avatar {
               background: var(--primary-color);
           }

           .bot-message .message-avatar {
               background: var(--info-color);
           }

           .message-content {
               flex: 1;
               background: white;
               border-radius: 12px;
               padding: 12px 16px;
               box-shadow: 0 2px 8px rgba(0,0,0,0.1);
               position: relative;
           }

           .user-message .message-content {
               background: var(--primary-color);
               color: white;
           }

           .user-message .message-content::after {
               content: '';
               position: absolute;
               right: -8px;
               top: 12px;
               width: 0;
               height: 0;
               border-left: 8px solid var(--primary-color);
               border-top: 8px solid transparent;
               border-bottom: 8px solid transparent;
           }

           .bot-message .message-content::after {
               content: '';
               position: absolute;
               left: -8px;
               top: 12px;
               width: 0;
               height: 0;
               border-right: 8px solid white;
               border-top: 8px solid transparent;
               border-bottom: 8px solid transparent;
           }

           .message-content p {
               margin: 0 0 8px 0;
               line-height: 1.4;
           }

           .message-content p:last-child {
               margin-bottom: 0;
           }

           .message-content ul {
               margin: 8px 0;
               padding-left: 20px;
           }

           .message-content li {
               margin-bottom: 4px;
               line-height: 1.4;
           }

           .message-time {
               font-size: 11px;
               opacity: 0.7;
               margin-top: 8px;
               text-align: right;
           }

           .user-message .message-time {
               color: rgba(255, 255, 255, 0.8);
           }

           .chat-container {
               display: flex;
               flex-direction: column;
               height: 600px;
               background: white;
               border-radius: var(--border-radius);
               box-shadow: var(--box-shadow);
               overflow: hidden;
           }

           .chat-header {
               padding: 20px 24px;
               border-bottom: 1px solid var(--gray-200);
               display: flex;
               justify-content: space-between;
               align-items: center;
               background: var(--gray-100);
           }

           .chat-header h3 {
               margin: 0;
               display: flex;
               align-items: center;
               gap: 10px;
               color: var(--gray-800);
           }

           .chat-messages {
               flex: 1;
               padding: 20px;
               overflow-y: auto;
               background: var(--gray-50);
           }

           .chat-input-container {
               border-top: 1px solid var(--gray-200);
               background: white;
           }

           .quick-questions {
               padding: 16px 20px 8px;
               display: flex;
               gap: 8px;
               flex-wrap: wrap;
           }

           .quick-btn {
               background: var(--gray-100);
               border: 1px solid var(--gray-300);
               border-radius: 20px;
               padding: 6px 12px;
               font-size: 12px;
               cursor: pointer;
               transition: var(--transition);
               color: var(--gray-700);
           }

           .quick-btn:hover {
               background: var(--primary-color);
               color: white;
               border-color: var(--primary-color);
           }

           .chat-input {
               display: flex;
               padding: 16px 20px;
               gap: 12px;
               align-items: flex-end;
           }

           .chat-input input {
               flex: 1;
               border: 2px solid var(--gray-300);
               border-radius: 20px;
               padding: 10px 16px;
               font-size: 14px;
               resize: none;
               outline: none;
               transition: var(--transition);
           }

           .chat-input input:focus {
               border-color: var(--primary-color);
               box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
           }

           .send-btn {
               width: 40px;
               height: 40px;
               border-radius: 50%;
               background: var(--primary-color);
               color: white;
               border: none;
               display: flex;
               align-items: center;
               justify-content: center;
               cursor: pointer;
               transition: var(--transition);
               flex-shrink: 0;
           }

           .send-btn:hover:not(:disabled) {
               background: var(--secondary-color);
               transform: scale(1.05);
           }

           .send-btn:disabled {
               background: var(--gray-400);
               cursor: not-allowed;
               transform: none;
           }

           @media (max-width: 768px) {
               .chat-container {
                   height: 500px;
               }

               .user-message,
               .bot-message {
                   margin-left: 0;
                   margin-right: 0;
               }

               .message-avatar {
                   width: 32px;
                   height: 32px;
                   font-size: 14px;
               }

               .quick-questions {
                   padding: 12px 16px 8px;
               }

               .quick-btn {
                   font-size: 11px;
                   padding: 4px 8px;
               }

               .chat-input {
                   padding: 12px 16px;
               }
           }
       `;

       document.head.appendChild(style);
   }

   // Method to update API key from settings
   updateAPIKey(newApiKey) {
       this.apiKey = newApiKey;
       if (newApiKey && newApiKey.startsWith('sk-')) {
           this.addBotMessage(
               '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ OpenAI API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
               'system'
           );
       }
   }

   // Export chat history
   exportChatHistory() {
       try {
           if (this.chatHistory.length === 0) {
               throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
           }

           const exportData = this.chatHistory.map(msg => ({
               ‡πÄ‡∏ß‡∏•‡∏≤: utils.formatThaiDate(msg.timestamp, true),
               ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á: msg.type === 'user' ? '‡∏Ñ‡∏∏‡∏ì' : 'AI',
               ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: msg.content
           }));

           const filename = `chat_history_${utils.formatShortDate().replace(/\//g, '_')}.csv`;
           utils.exportToCSV(exportData, filename);
           
           notificationSystem.success('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
           return true;
       } catch (error) {
           console.error('‚ùå Export chat history failed:', error);
           notificationSystem.error(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ');
           return false;
       }
   }

   // Get chat statistics
   getChatStatistics() {
       try {
           const totalMessages = this.chatHistory.length;
           const userMessages = this.chatHistory.filter(msg => msg.type === 'user').length;
           const botMessages = this.chatHistory.filter(msg => msg.type === 'bot').length;
           
           const today = new Date();
           const todayMessages = this.chatHistory.filter(msg => {
               const msgDate = new Date(msg.timestamp);
               return msgDate.toDateString() === today.toDateString();
           }).length;

           return {
               total: totalMessages,
               user: userMessages,
               bot: botMessages,
               today: todayMessages
           };
       } catch (error) {
           console.error('‚ùå Get chat statistics failed:', error);
           return {
               total: 0,
               user: 0,
               bot: 0,
               today: 0
           };
       }
   }

   destroy() {
       this.chatHistory = [];
       this.messageQueue = [];
       this.isTyping = false;
       this.forecastCache = null;
       this.isInitialized = false;
       
       // Remove typing styles
       const typingStyles = document.getElementById('typing-styles');
       if (typingStyles) {
           typingStyles.remove();
       }
   }
}

// Create and export AI advisor instance
const aiAdvisor = new AIAdvisor();
window.aiAdvisor = aiAdvisor;

// Settings functionality with comprehensive error handling
class Settings {
    constructor() {
        this.isInitialized = false;
        this.settings = {
            apiKeys: {},
            shopInfo: {},
            notifications: {
                dailySalesReminder: true,
                priceAlert: true,
                weatherAlert: true
            }
        };
        this.init();
    }

    async init() {
        try {
            this.setupEventListeners();
            this.loadSettings();
            this.updateStatistics();
            this.isInitialized = true;
            console.log('‚úÖ Settings initialized successfully');
        } catch (error) {
            console.error('‚ùå Settings initialization failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    setupEventListeners() {
        // API Settings
        const saveApiBtn = utils.safeGetElement('#save-api-settings');
        if (saveApiBtn) {
            saveApiBtn.addEventListener('click', this.handleSaveAPISettings.bind(this));
        }

        // Shop Information
        const saveShopBtn = utils.safeGetElement('#save-shop-info');
        if (saveShopBtn) {
            saveShopBtn.addEventListener('click', this.handleSaveShopInfo.bind(this));
        }

        // Notification Settings
        const saveNotificationBtn = utils.safeGetElement('#save-notification-settings');
        if (saveNotificationBtn) {
            saveNotificationBtn.addEventListener('click', this.handleSaveNotificationSettings.bind(this));
        }

        // Data Management
        const exportBtn = utils.safeGetElement('#export-data');
        if (exportBtn) {
            exportBtn.addEventListener('click', this.handleExportData.bind(this));
        }

        const backupBtn = utils.safeGetElement('#backup-data');
        if (backupBtn) {
            backupBtn.addEventListener('click', this.handleBackupData.bind(this));
        }

        const clearBtn = utils.safeGetElement('#clear-all-data');
        if (clearBtn) {
            clearBtn.addEventListener('click', this.handleClearAllData.bind(this));
        }

        // Real-time validation for API keys
        const apiKeyInputs = utils.safeGetElements('#openai-api-key, #weather-api-key');
        apiKeyInputs.forEach(input => {
            input.addEventListener('input', utils.debounce(this.validateAPIKey.bind(this), 500));
        });
    }

    loadSettings() {
        try {
            // Load API Keys
            this.settings.apiKeys = {
                openai: utils.getLocalStorage('openai_api_key', ''),
                weather: utils.getLocalStorage('weather_api_key', '')
            };

            // Load Shop Info
            this.settings.shopInfo = utils.getLocalStorage('shop_info', {
                name: '',
                address: '',
                phone: '',
                hours: '16:00-22:00 ‡∏ô.'
            });

            // Load Notification Settings
            this.settings.notifications = utils.getLocalStorage('notification_settings', {
                dailySalesReminder: true,
                priceAlert: true,
                weatherAlert: true
            });

            this.populateSettings();
        } catch (error) {
            console.error('‚ùå Failed to load settings:', error);
        }
    }

    populateSettings() {
        // Populate API Keys (show masked)
        const openaiInput = utils.safeGetElement('#openai-api-key');
        const weatherInput = utils.safeGetElement('#weather-api-key');

        if (openaiInput && this.settings.apiKeys.openai) {
            openaiInput.value = this.maskAPIKey(this.settings.apiKeys.openai);
            openaiInput.dataset.masked = 'true';
            openaiInput.dataset.realValue = this.settings.apiKeys.openai;
        }

        if (weatherInput && this.settings.apiKeys.weather) {
            weatherInput.value = this.maskAPIKey(this.settings.apiKeys.weather);
            weatherInput.dataset.masked = 'true';
            weatherInput.dataset.realValue = this.settings.apiKeys.weather;
        }

        // Populate Shop Info
        const shopNameInput = utils.safeGetElement('#shop-name');
        const shopAddressInput = utils.safeGetElement('#shop-address');
        const shopPhoneInput = utils.safeGetElement('#shop-phone');
        const shopHoursInput = utils.safeGetElement('#shop-hours');

        if (shopNameInput) shopNameInput.value = this.settings.shopInfo.name || '';
        if (shopAddressInput) shopAddressInput.value = this.settings.shopInfo.address || '';
        if (shopPhoneInput) shopPhoneInput.value = this.settings.shopInfo.phone || '';
        if (shopHoursInput) shopHoursInput.value = this.settings.shopInfo.hours || '16:00-22:00 ‡∏ô.';

        // Populate Notification Settings
        const dailyReminderCheck = utils.safeGetElement('#daily-sales-reminder');
        const priceAlertCheck = utils.safeGetElement('#price-alert');
        const weatherAlertCheck = utils.safeGetElement('#weather-alert');

        if (dailyReminderCheck) dailyReminderCheck.checked = this.settings.notifications.dailySalesReminder;
        if (priceAlertCheck) priceAlertCheck.checked = this.settings.notifications.priceAlert;
        if (weatherAlertCheck) weatherAlertCheck.checked = this.settings.notifications.weatherAlert;
    }

    maskAPIKey(key) {
        if (!key || key.length < 8) return '';
        return key.substring(0, 8) + '*'.repeat(Math.max(0, key.length - 8));
    }

    validateAPIKey(event) {
        const input = event.target;
        const value = input.value.trim();

        // Remove existing validation styling
        input.classList.remove('input-error', 'input-valid');
        this.clearValidationMessage(input);

        if (!value) return;

        if (input.id === 'openai-api-key') {
            if (value.startsWith('sk-') && value.length > 20) {
                this.showValidationSuccess(input, '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö API Key ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            } else if (!value.includes('*')) {
                this.showValidationError(input, 'OpenAI API Key ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ sk- ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 20 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
            }
        } else if (input.id === 'weather-api-key') {
            if (value.length >= 16 && value.length <= 40) {
                this.showValidationSuccess(input, '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö API Key ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            } else if (!value.includes('*')) {
                this.showValidationError(input, 'Weather API Key ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 16-40 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
            }
        }
    }

    showValidationError(input, message) {
        input.classList.add('input-error');
        this.showValidationMessage(input, message, 'error');
    }

    showValidationSuccess(input, message) {
        input.classList.add('input-valid');
        this.showValidationMessage(input, message, 'success');
    }

    showValidationMessage(input, message, type) {
        this.clearValidationMessage(input);

        const messageDiv = document.createElement('div');
        messageDiv.className = `validation-message validation-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            color: ${type === 'error' ? 'var(--danger-color)' : 'var(--success-color)'};
            font-size: 12px;
            margin-top: 4px;
        `;

        input.parentNode.appendChild(messageDiv);
    }

    clearValidationMessage(input) {
        const existingMessage = input.parentNode.querySelector('.validation-message');
        if (existingMessage) {
            existingMessage.remove();
        }
    }

    async handleSaveAPISettings(event) {
        const button = event.target;
        if (!button) return;

        try {
            utils.setButtonLoading(button, true);

            const openaiInput = utils.safeGetElement('#openai-api-key');
            const weatherInput = utils.safeGetElement('#weather-api-key');

            let openaiKey = '';
            let weatherKey = '';

            // Handle masked values
            if (openaiInput) {
                if (openaiInput.dataset.masked === 'true' && openaiInput.value.includes('*')) {
                    openaiKey = openaiInput.dataset.realValue || '';
                } else {
                    openaiKey = openaiInput.value.trim();
                }
            }

            if (weatherInput) {
                if (weatherInput.dataset.masked === 'true' && weatherInput.value.includes('*')) {
                    weatherKey = weatherInput.dataset.realValue || '';
                } else {
                    weatherKey = weatherInput.value.trim();
                }
            }

            // Validate API keys
            if (openaiKey && (!openaiKey.startsWith('sk-') || openaiKey.length < 20)) {
                throw new Error('OpenAI API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }

            if (weatherKey && (weatherKey.length < 16 || weatherKey.length > 40)) {
                throw new Error('Weather API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }

            // Save to localStorage
            if (openaiKey) {
                utils.setLocalStorage('openai_api_key', openaiKey);
                this.settings.apiKeys.openai = openaiKey;
            }

            if (weatherKey) {
                utils.setLocalStorage('weather_api_key', weatherKey);
                this.settings.apiKeys.weather = weatherKey;
            }

            // Update AI Advisor if OpenAI key is set
            if (openaiKey && window.aiAdvisor) {
                window.aiAdvisor.updateAPIKey(openaiKey);
            }

            // Re-mask the inputs
            if (openaiInput && openaiKey) {
                openaiInput.value = this.maskAPIKey(openaiKey);
                openaiInput.dataset.masked = 'true';
                openaiInput.dataset.realValue = openaiKey;
            }

            if (weatherInput && weatherKey) {
                weatherInput.value = this.maskAPIKey(weatherKey);
                weatherInput.dataset.masked = 'true';
                weatherInput.dataset.realValue = weatherKey;
            }

            notificationSystem.success('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

        } catch (error) {
            console.error('‚ùå Save API settings failed:', error);
            notificationSystem.error(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ');
        } finally {
            utils.setButtonLoading(button, false);
        }
    }

    async handleSaveShopInfo(event) {
        const button = event.target;
        if (!button) return;

        try {
            utils.setButtonLoading(button, true);

            const shopInfo = {
                name: utils.sanitizeInput(utils.safeGetElement('#shop-name')?.value),
                address: utils.sanitizeInput(utils.safeGetElement('#shop-address')?.value),
                phone: utils.sanitizeInput(utils.safeGetElement('#shop-phone')?.value, 'phone'),
                hours: utils.sanitizeInput(utils.safeGetElement('#shop-hours')?.value)
            };

            // Validate phone number
            if (shopInfo.phone && !utils.validatePhone(shopInfo.phone)) {
                throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }

            // Save to localStorage and Firebase
            utils.setLocalStorage('shop_info', shopInfo);
            this.settings.shopInfo = shopInfo;

            // Try to save to Firebase
            try {
                await window.firebaseUtils.hybridSave(
                    'settings',
                    { shopInfo },
                    'shop_info',
                    'shop_info_backup'
                );
            } catch (firebaseError) {
                console.warn('‚ö†Ô∏è Firebase save failed, saved locally:', firebaseError);
            }

            notificationSystem.success('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

        } catch (error) {
            console.error('‚ùå Save shop info failed:', error);
            notificationSystem.error(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
        } finally {
            utils.setButtonLoading(button, false);
        }
    }

    async handleSaveNotificationSettings(event) {
        const button = event.target;
        if (!button) return;

        try {
            utils.setButtonLoading(button, true);

            const notifications = {
                dailySalesReminder: utils.safeGetElement('#daily-sales-reminder')?.checked || false,
                priceAlert: utils.safeGetElement('#price-alert')?.checked || false,
                weatherAlert: utils.safeGetElement('#weather-alert')?.checked || false
            };

            // Save settings
            utils.setLocalStorage('notification_settings', notifications);
            this.settings.notifications = notifications;

            // Set up notification schedules if enabled
            this.setupNotificationSchedules();

            notificationSystem.success('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

        } catch (error) {
            console.error('‚ùå Save notification settings failed:', error);
            notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ');
        } finally {
            utils.setButtonLoading(button, false);
        }
    }

    setupNotificationSchedules() {
        // This would set up actual notification schedules
        // For now, just show a confirmation
        const enabledNotifications = [];
        
        if (this.settings.notifications.dailySalesReminder) {
            enabledNotifications.push('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô');
        }
        if (this.settings.notifications.priceAlert) {
            enabledNotifications.push('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö');
        }
        if (this.settings.notifications.weatherAlert) {
            enabledNotifications.push('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®');
        }

        if (enabledNotifications.length > 0) {
            console.log('‚úÖ Notification schedules set up:', enabledNotifications);
        }
    }

    async handleExportData(event) {
        const button = event.target;
        if (!button) return;

        try {
            utils.setButtonLoading(button, true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å...');

            // Collect all data for export
            const exportData = await this.collectExportData();
            
            if (!exportData || exportData.length === 0) {
                throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
            }

            const filename = `pork_advisor_data_${utils.formatShortDate().replace(/\//g, '_')}.csv`;
            utils.exportToCSV(exportData, filename);

            notificationSystem.success(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${exportData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);

        } catch (error) {
            console.error('‚ùå Export data failed:', error);
            notificationSystem.error(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        } finally {
            utils.setButtonLoading(button, false);
        }
    }

    async collectExportData() {
        try {
            const allData = [];

            // Get sales data
            try {
                const salesData = await window.firebaseUtils.hybridGet(
                    'sales',
                    null,
                    { field: 'timestamp', direction: 'desc' },
                    null,
                    window.firebaseUtils.localStorageKeys.SALES_DATA
                );

                if (salesData && salesData.length > 0) {
                    salesData.forEach(sale => {
                        allData.push({
                            ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: utils.formatThaiDate(sale.timestamp || sale.createdAt, true),
                            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πâ: sale.sticksSold || 0,
                            ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: sale.totalRevenue || 0,
                            ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: sale.totalCost || 0,
                            ‡∏Å‡∏≥‡πÑ‡∏£: sale.profit || 0,
                            ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: sale.note || ''
                        });
                    });
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not get sales data for export:', error);
            }

            // Get business tools settings
            const businessSettings = utils.getLocalStorage('business_tools_settings');
            if (businessSettings) {
                allData.push({
                    ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à',
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: utils.formatThaiDate(),
                    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à: businessSettings.businessModel || '',
                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π: businessSettings.calculator?.meatPrice || '',
                    ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πâ: businessSettings.calculator?.weightPerStick || '',
                    ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ: businessSettings.calculator?.otherCosts || ''
                });
            }

            // Get shop info
            if (this.settings.shopInfo.name) {
                allData.push({
                    ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô',
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: utils.formatThaiDate(),
                    ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô: this.settings.shopInfo.name,
                    ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: this.settings.shopInfo.address,
                    ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: this.settings.shopInfo.phone,
                    ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î: this.settings.shopInfo.hours
                });
            }

            return allData;
        } catch (error) {
            console.error('‚ùå Collect export data failed:', error);
            throw error;
        }
    }

    async handleBackupData(event) {
        const button = event.target;
        if (!button) return;

        try {
            utils.setButtonLoading(button, true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á...');

            // Create comprehensive backup
            const backupData = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                data: {
                    settings: this.settings,
                    businessTools: utils.getLocalStorage('business_tools_settings'),
                    chatHistory: utils.getLocalStorage('chat_history'),
                }
            };

            // Try to save to Firebase
            try {
                await window.firebaseUtils.saveToFirestore(
                    'backups',
                    backupData,
                    `backup_${Date.now()}`
                );
                notificationSystem.success('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            } catch (firebaseError) {
                // Fall back to local download
                const backupJson = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.

download = `pork_advisor_backup_${utils.formatShortDate().replace(/\//g, '_')}.json`;
               link.click();
               
               URL.revokeObjectURL(url);
               notificationSystem.warning('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase');
           }

       } catch (error) {
           console.error('‚ùå Backup data failed:', error);
           notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
       } finally {
           utils.setButtonLoading(button, false);
       }
   }

   async handleClearAllData(event) {
       const button = event.target;
       if (!button) return;

       // Double confirmation for data clearing
       const firstConfirm = confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö:\n- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢\n- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à\n- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤\n- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
       
       if (!firstConfirm) return;

       const secondConfirm = confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ\n\n‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
       
       if (!secondConfirm) return;

       const confirmText = prompt('‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:');
       if (confirmText !== '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
           notificationSystem.info('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
           return;
       }

       try {
           utils.setButtonLoading(button, true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');

           // Clear all localStorage data
           const keysToDelete = [
               'business_tools_settings',
               'chat_history', 
               'shop_info',
               'notification_settings',
               'sales_backup',
               window.firebaseUtils.localStorageKeys.SALES_DATA,
               window.firebaseUtils.localStorageKeys.SHOP_INFO,
               window.firebaseUtils.localStorageKeys.SETTINGS,
               window.firebaseUtils.localStorageKeys.CHAT_HISTORY
           ];

           keysToDelete.forEach(key => {
               utils.removeLocalStorage(key);
           });

           // Try to clear Firebase data
           try {
               const user = window.firebaseUtils.getAuth()?.currentUser;
               if (user) {
                   // This would require admin privileges or careful structuring
                   console.log('üîÑ Firebase data clear would require admin privileges');
               }
           } catch (firebaseError) {
               console.warn('‚ö†Ô∏è Could not clear Firebase data:', firebaseError);
           }

           // Reset all modules
           if (window.businessTools) {
               window.businessTools.destroy();
           }
           if (window.salesTracking) {
               window.salesTracking.destroy();
           }
           if (window.aiAdvisor) {
               window.aiAdvisor.destroy();
           }

           // Reset settings
           this.settings = {
               apiKeys: {},
               shopInfo: {},
               notifications: {
                   dailySalesReminder: true,
                   priceAlert: true,
                   weatherAlert: true
               }
           };

           // Clear form inputs
           this.clearAllInputs();
           
           // Update statistics
           this.updateStatistics();

           notificationSystem.success('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ');

           // Reload page after 3 seconds
           setTimeout(() => {
               window.location.reload();
           }, 3000);

       } catch (error) {
           console.error('‚ùå Clear all data failed:', error);
           notificationSystem.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
       } finally {
           utils.setButtonLoading(button, false);
       }
   }

   clearAllInputs() {
       // Clear all input fields in settings
       const inputs = utils.safeGetElements('#settings-tab input, #settings-tab textarea');
       inputs.forEach(input => {
           if (input.type === 'checkbox') {
               input.checked = input.id !== 'daily-sales-reminder' && 
                               input.id !== 'price-alert' && 
                               input.id !== 'weather-alert';
           } else {
               input.value = '';
               if (input.dataset.masked) {
                   delete input.dataset.masked;
                   delete input.dataset.realValue;
               }
           }
           this.clearValidationMessage(input);
       });
   }

   updateStatistics() {
       try {
           // Get sales statistics
           let totalSalesRecords = 0;
           try {
               const salesData = utils.getLocalStorage(window.firebaseUtils.localStorageKeys.SALES_DATA);
               if (salesData && Array.isArray(salesData)) {
                   totalSalesRecords = salesData.length;
               }
           } catch (error) {
               console.warn('‚ö†Ô∏è Could not get sales statistics:', error);
           }

           // Get chat statistics
           let totalChatMessages = 0;
           if (window.aiAdvisor) {
               const chatStats = window.aiAdvisor.getChatStatistics();
               totalChatMessages = chatStats.total;
           }

           // Update display
           const salesRecordsElement = utils.safeGetElement('#total-sales-records');
           const chatMessagesElement = utils.safeGetElement('#total-chat-messages');

           if (salesRecordsElement) {
               salesRecordsElement.textContent = `${totalSalesRecords} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
           }

           if (chatMessagesElement) {
               chatMessagesElement.textContent = `${totalChatMessages} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°`;
           }

       } catch (error) {
           console.error('‚ùå Update statistics failed:', error);
       }
   }

   // Add custom CSS for settings validation
   addSettingsStyles() {
       if (document.getElementById('settings-styles')) return;

       const style = document.createElement('style');
       style.id = 'settings-styles';
       style.textContent = `
           .input-valid {
               border-color: var(--success-color) !important;
               box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.1) !important;
           }

           .data-management {
               display: flex;
               flex-direction: column;
               gap: 20px;
           }

           .management-actions {
               display: grid;
               grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
               gap: 12px;
           }

           .data-stats {
               background: var(--gray-100);
               border-radius: 8px;
               padding: 16px;
               display: grid;
               grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
               gap: 12px;
           }

           .stat-item {
               display: flex;
               justify-content: space-between;
               align-items: center;
               font-size: 14px;
           }

           .stat-item span:first-child {
               color: var(--gray-600);
           }

           .stat-item span:last-child {
               font-weight: 600;
               color: var(--gray-800);
           }

           @media (max-width: 768px) {
               .management-actions {
                   grid-template-columns: 1fr;
               }

               .data-stats {
                   grid-template-columns: 1fr;
               }
           }
       `;

       document.head.appendChild(style);
   }

   destroy() {
       this.settings = {
           apiKeys: {},
           shopInfo: {},
           notifications: {
               dailySalesReminder: true,
               priceAlert: true,
               weatherAlert: true
           }
       };
       this.isInitialized = false;
   }
}

// Create and export settings instance
const settings = new Settings();
window.settings = settings;




<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Pork Skewer Business Advisor AI</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
apiKey: "AIzaSyDFETQF_lUuU_HeUa_9pnpAkDyMATUKB7g",
authDomain: "pork-pricing-app.firebaseapp.com",
projectId: "pork-pricing-app",
storageBucket: "pork-pricing-app.firebasestorage.app",
messagingSenderId: "604634104081",
appId: "1:604634104081:web:cc318ac88d381cf4384cb0",
measurementId: "G-0224PTLW7P"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
console.log("Firebase initialized successfully");
</script>

    <style>
:root {
--primary-color: #FF5722;
--primary-dark: #E64A19;
--primary-light: #FFAB91;
--secondary-color: #FF9800;
--secondary-dark: #F57C00;
--accent-color: #FFEB3B;
--dark-color: #5D4037;
--light-color: #FFF8E1;
--light-alt-color: #FFECB3;
--white-color: #FFFFFF;
--success-color: #4CAF50;
--success-dark: #388E3C;
--error-color: #F44336;
--error-dark: #D32F2F;
--info-color: #2196F3;
--info-dark: #1976D2;
--warning-color: #FFC107;
--warning-dark: #FFA000;
--shadow-color: rgba(0, 0, 0, 0.2);
--business-color: #9C27B0;
--business-dark: #7B1FA2;
--analysis-color: #3F51B5;
--analysis-dark: #303F9F;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Sarabun', 'Prompt', 'Kanit', -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
background: linear-gradient(-45deg, #FFF8E1, #FFECB3, #E8F5E8, #E3F2FD, #FCE4EC);
background-size: 400% 400%;
animation: bodyGradientShift 15s ease infinite;
color: var(--dark-color);
line-height: 1.6;
padding-bottom: 80px;
}

@keyframes bodyGradientShift {
0% { background-position: 0% 50%; }
25% { background-position: 100% 25%; }
50% { background-position: 100% 100%; }
75% { background-position: 0% 75%; }
100% { background-position: 0% 50%; }
}

.container {
max-width: 1200px;
margin: 0 auto;
padding: 0 15px;
}

header {
background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
color: white;
text-align: center;
padding: 25px 0;
margin-bottom: 25px;
border-bottom: 5px solid var(--secondary-color);
position: relative;
overflow: hidden;
box-shadow: 0 4px 10px var(--shadow-color);
animation: headerColorShift 10s infinite;
}

@keyframes headerColorShift {
0% { background: linear-gradient(135deg, #FF5722, #E64A19); }
20% { background: linear-gradient(135deg, #E91E63, #C2185B); }
40% { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }
60% { background: linear-gradient(135deg, #3F51B5, #303F9F); }
80% { background: linear-gradient(135deg, #00BCD4, #0097A7); }
100% { background: linear-gradient(135deg, #FF5722, #E64A19); }
}

.header-content {
position: relative;
z-index: 2;
}

.header-bg {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNMjAsMzAgQzIwLDY1IDgwLDY1IDgwLDMwIiBzdHJva2U9IiNGRkM3QTciIHN0cm9rZS13aWR0aD0iMi41IiBmaWxsPSJub25lIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjMwIiByPSI2IiBmaWxsPSIjRkZDN0E3Ii8+PC9zdmc+') repeat;
opacity: 0.2;
z-index: 1;
}

h1 {
font-size: 2.2rem;
margin-bottom: 8px;
text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
font-weight: 700;
}

h2 {
font-size: 1.4rem;
font-weight: 400;
margin-bottom: 12px;
text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

.date-display {
background-color: var(--secondary-color);
color: white;
padding: 8px 20px;
border-radius: 25px;
display: inline-block;
margin-top: 12px;
font-size: 1rem;
font-weight: 500;
box-shadow: 0 3px 8px rgba(0,0,0,0.2);
text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
animation: dateDisplayShift 13s infinite;
}

@keyframes dateDisplayShift {
0% { background-color: #FF9800; }
20% { background-color: #F06292; }
40% { background-color: #BA68C8; }
60% { background-color: #7986CB; }
80% { background-color: #4DD0E1; }
100% { background-color: #FF9800; }
}

/* ปรับแท็บให้รองรับ 5 แท็บ */
.tabs {
display: flex;
margin-bottom: 25px;
border-radius: 12px;
overflow: hidden;
background-color: #FFF;
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.tab {
flex: 1;
text-align: center;
background-color: #FFF;
color: var(--dark-color);
padding: 16px 8px;
cursor: pointer;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
font-weight: 600;
font-size: 0.95rem;
border-bottom: 3px solid transparent;
position: relative;
overflow: hidden;
min-height: 70px;
display: flex;
align-items: center;
justify-content: center;
}

.tab:hover {
background-color: var(--light-alt-color);
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.tab:active {
transform: translateY(1px);
box-shadow: none;
}

.tab.active {
color: var(--primary-color);
border-bottom: 3px solid var(--primary-color);
background-color: var(--light-alt-color);
box-shadow: inset 0 -3px 0 var(--primary-color);
animation: tabActiveShift 7s infinite;
}

@keyframes tabActiveShift {
0% { border-bottom-color: #FF5722; }
25% { border-bottom-color: #E91E63; }
50% { border-bottom-color: #9C27B0; }
75% { border-bottom-color: #3F51B5; }
100% { border-bottom-color: #FF5722; }
}

.tab::after {
content: '';
position: absolute;
width: 100%;
height: 3px;
background-color: var(--primary-color);
bottom: 0;
left: 0;
transform: scaleX(0);
transition: transform 0.3s ease;
}

.tab:hover::after {
transform: scaleX(1);
}

.tab-content {
display: none;
background-color: white;
padding: 30px;
border-radius: 16px;
box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
margin-bottom: 25px;
animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
transform: translateY(0);
transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.tab-content.active {
display: block;
}

.tab-content:hover {
transform: translateY(-5px);
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(30px); }
to { opacity: 1; transform: translateY(0); }
}

/* สไตล์สำหรับเครื่องมือธุรกิจ */
.business-type-selector {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.business-type-card {
background: linear-gradient(145deg, white, #f8f9fa);
border: 3px solid #e0e0e0;
border-radius: 16px;
padding: 25px;
cursor: pointer;
transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
text-align: center;
position: relative;
overflow: hidden;
box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.business-type-card:hover {
transform: translateY(-8px);
box-shadow: 0 15px 35px rgba(0,0,0,0.15);
border-color: var(--business-color);
}

.business-type-card.selected {
background: linear-gradient(145deg, var(--business-color), var(--business-dark));
border-color: var(--business-dark);
color: white;
box-shadow: 0 12px 30px rgba(156, 39, 176, 0.3);
transform: translateY(-5px);
}

.business-type-card.selected:hover {
transform: translateY(-10px);
box-shadow: 0 18px 40px rgba(156, 39, 176, 0.4);
}

.business-icon {
font-size: 3rem;
margin-bottom: 15px;
display: block;
}

.business-type-card.selected .business-icon {
animation: iconBounce 2s infinite;
}

@keyframes iconBounce {
0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
40% { transform: translateY(-10px); }
60% { transform: translateY(-5px); }
}

.business-title {
font-size: 1.3rem;
font-weight: 700;
margin-bottom: 10px;
}

.business-description {
font-size: 0.95rem;
line-height: 1.5;
opacity: 0.8;
}

.business-type-card.selected .business-description {
opacity: 0.95;
}

/* วิเคราะห์ต้นทุนและผลกำไร */
.cost-analysis-section {
background: linear-gradient(135deg, #f8f9fa, #e9ecef);
border-radius: 16px;
padding: 25px;
margin: 25px 0;
border-left: 5px solid var(--analysis-color);
}

.analysis-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-top: 20px;
}

.analysis-card {
background: white;
border-radius: 12px;
padding: 20px;
box-shadow: 0 6px 20px rgba(0,0,0,0.08);
transition: transform 0.3s ease;
}

.analysis-card:hover {
transform: translateY(-3px);
box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}

.analysis-title {
font-size: 1.1rem;
font-weight: 600;
color: var(--analysis-color);
margin-bottom: 15px;
display: flex;
align-items: center;
gap: 8px;
}

.cost-breakdown {
list-style: none;
padding: 0;
}

.cost-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 8px 0;
border-bottom: 1px solid #f0f0f0;
}

.cost-item:last-child {
border-bottom: none;
font-weight: 600;
color: var(--primary-color);
}

.profit-scenarios {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin-top: 20px;
}

.scenario-card {
background: linear-gradient(145deg, white, #f8f9fa);
border-radius: 12px;
padding: 18px;
text-align: center;
border: 2px solid #e0e0e0;
transition: all 0.3s ease;
}

.scenario-card:hover {
border-color: var(--success-color);
transform: translateY(-2px);
}

.scenario-card.recommended {
border-color: var(--success-color);
background: linear-gradient(145deg, var(--success-color), var(--success-dark));
color: white;
}

.scenario-price {
font-size: 1.8rem;
font-weight: 700;
margin-bottom: 5px;
}

.scenario-profit {
font-size: 1rem;
margin-bottom: 8px;
opacity: 0.9;
}

.scenario-label {
font-size: 0.85rem;
opacity: 0.8;
}

/* รูปแบบฟอร์มที่ปรับปรุง */
.form-group {
margin-bottom: 25px;
}

.form-row {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
}

label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: var(--dark-color);
font-size: 1rem;
}

input[type="text"],
input[type="number"],
input[type="password"],
input[type="date"],
select,
textarea {
width: 100%;
padding: 15px;
border: 2px solid #e0e0e0;
border-radius: 10px;
font-size: 1rem;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
background-color: #f9f9f9;
box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
font-family: inherit;
}

input[type="text"]:focus,
input[type="number"]:focus,
input[type="password"]:focus,
input[type="date"]:focus,
select:focus,
textarea:focus {
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.1);
outline: none;
background-color: #fff;
transform: translateY(-1px);
}

.option-group {
display: flex;
flex-wrap: wrap;
gap: 12px;
margin-bottom: 20px;
}

.option-button {
flex: 1;
min-width: 120px;
background-color: #FFF;
border: 2px solid #e0e0e0;
border-radius: 12px;
padding: 15px 12px;
cursor: pointer;
text-align: center;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
font-size: 0.95rem;
font-weight: 500;
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
position: relative;
overflow: hidden;
}

.option-button:hover {
border-color: var(--secondary-color);
transform: translateY(-3px);
box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.option-button:active {
transform: translateY(1px);
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.option-button.selected {
background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
border-color: var(--primary-dark);
color: white;
box-shadow: 0 6px 18px rgba(255, 87, 34, 0.3);
transform: translateY(-2px);
animation: selectedButtonShift 6s infinite;
}

@keyframes selectedButtonShift {
0% { background: linear-gradient(145deg, #FF5722, #E64A19); }
33% { background: linear-gradient(145deg, #E91E63, #C2185B); }
66% { background: linear-gradient(145deg, #9C27B0, #7B1FA2); }
100% { background: linear-gradient(145deg, #FF5722, #E64A19); }
}

.option-button.selected:hover {
transform: translateY(-4px);
box-shadow: 0 10px 25px rgba(255, 87, 34, 0.35);
}

.option-button img, .option-button svg {
display: block;
width: 32px;
height: 32px;
margin: 0 auto 8px;
}

/* ปุ่มต่างๆ */
.calculate-btn, .action-btn {
display: block;
width: 100%;
background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
color: white;
border: none;
border-radius: 12px;
padding: 18px;
font-size: 1.2rem;
font-weight: 700;
cursor: pointer;
margin: 25px 0;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 0 8px 0 var(--primary-dark), 0 8px 20px rgba(0,0,0,0.15);
position: relative;
overflow: hidden;
text-transform: uppercase;
letter-spacing: 1px;
animation: buttonColorShift 8s infinite;
font-family: inherit;
}

@keyframes buttonColorShift {
0% { background: linear-gradient(145deg, #FF5722, #E64A19); }
25% { background: linear-gradient(145deg, #E91E63, #C2185B); }
50% { background: linear-gradient(145deg, #9C27B0, #7B1FA2); }
75% { background: linear-gradient(145deg, #3F51B5, #303F9F); }
100% { background: linear-gradient(145deg, #FF5722, #E64A19); }
}

.calculate-btn:hover, .action-btn:hover {
background: linear-gradient(145deg, var(--secondary-color), var(--secondary-dark));
box-shadow: 0 8px 0 var(--secondary-dark), 0 8px 25px rgba(0,0,0,0.2);
transform: translateY(-2px);
}

.calculate-btn:active, .action-btn:active {
transform: translateY(6px);
box-shadow: 0 2px 0 var(--primary-dark), 0 2px 8px rgba(0,0,0,0.1);
}

.calculate-btn::after, .action-btn::after {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
transition: 0.5s;
}

.calculate-btn:hover::after, .action-btn:hover::after {
left: 100%;
}

/* ส่วนแสดงผลลัพธ์ */
.result-section {
background: linear-gradient(145deg, var(--secondary-color), var(--secondary-dark));
color: white;
padding: 30px;
border-radius: 16px;
text-align: center;
margin-bottom: 25px;
display: none;
box-shadow: 0 15px 35px rgba(255, 152, 0, 0.3);
transform: translateY(0);
transition: transform 0.3s ease;
animation: resultColorShift 9s infinite;
}

@keyframes resultColorShift {
0% { background: linear-gradient(145deg, #FF9800, #F57C00); }
25% { background: linear-gradient(145deg, #F06292, #E91E63); }
50% { background: linear-gradient(145deg, #BA68C8, #9C27B0); }
75% { background: linear-gradient(145deg, #7986CB, #3F51B5); }
100% { background: linear-gradient(145deg, #FF9800, #F57C00); }
}

.result-section:hover {
transform: translateY(-5px);
}

.price-recommendation {
font-size: 3.5rem;
font-weight: 800;
margin: 20px 0;
text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
}

.profit-estimate {
font-size: 1.5rem;
margin-bottom: 25px;
text-shadow: 1px 1px 4px rgba(0,0,0,0.2);
}

.additional-tips {
background-color: rgba(255,255,255,0.95);
padding: 25px;
border-radius: 12px;
margin-top: 20px;
color: var(--dark-color);
text-align: left;
box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.additional-tips h4 {
color: var(--primary-color);
margin-bottom: 15px;
font-size: 1.3rem;
font-weight: 600;
}

.additional-tips ul {
padding-left: 0;
list-style: none;
}

.additional-tips li {
margin-bottom: 12px;
position: relative;
padding-left: 25px;
line-height: 1.6;
}

.additional-tips li::before {
content: '🎯';
position: absolute;
left: 0;
font-size: 1.1rem;
}

/* การ์ดและสถิติ */
.card {
background-color: white;
border-radius: 16px;
box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
padding: 30px;
margin-bottom: 25px;
transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
transform: translateY(-8px);
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.card-title {
font-size: 1.4rem;
color: var(--primary-color);
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 2px solid #f0f0f0;
position: relative;
font-weight: 600;
}

.card-title::after {
content: '';
position: absolute;
bottom: -2px;
left: 0;
width: 80px;
height: 2px;
background-color: var(--primary-color);
}

.dashboard-stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-bottom: 25px;
}

.stat-card {
background-color: white;
border-radius: 16px;
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
padding: 25px;
text-align: center;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
position: relative;
overflow: hidden;
}

.stat-card:hover {
transform: translateY(-8px);
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.stat-card::before {
content: '';
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 5px;
background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
animation: statBorderShift 11s infinite;
}

@keyframes statBorderShift {
0% { background: linear-gradient(90deg, #FF5722, #FF9800); }
25% { background: linear-gradient(90deg, #E91E63, #F06292); }
50% { background: linear-gradient(90deg, #9C27B0, #BA68C8); }
75% { background: linear-gradient(90deg, #3F51B5, #7986CB); }
100% { background: linear-gradient(90deg, #FF5722, #FF9800); }
}

.stat-value {
font-size: 2.2rem;
font-weight: 800;
color: var(--primary-color);
margin: 15px 0;
text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
}

.stat-label {
font-size: 1rem;
color: #666;
margin-bottom: 5px;
font-weight: 500;
}

/* การแจ้งเตือน */
.notification {
padding: 20px;
border-radius: 12px;
margin-bottom: 20px;
display: flex;
align-items: flex-start;
box-shadow: 0 8px 25px rgba(0,0,0,0.1);
transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.notification:hover {
transform: translateY(-3px);
box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}

.notification.info {
background-color: rgba(33, 150, 243, 0.15);
border-left: 5px solid var(--info-color);
}

.notification.warning {
background-color: rgba(255, 193, 7, 0.15);
border-left: 5px solid var(--warning-color);
}

.notification.error {
background-color: rgba(244, 67, 54, 0.15);
border-left: 5px solid var(--error-color);
}

.notification.success {
background-color: rgba(76, 175, 80, 0.15);
border-left: 5px solid var(--success-color);
}

.notification svg {
width: 28px;
height: 28px;
margin-right: 15px;
flex-shrink: 0;
}

.notification-content {
flex: 1;
}

.pulse {
animation: pulse 2s infinite;
}

@keyframes pulse {
0% {
box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.4);
}
70% {
box-shadow: 0 0 0 15px rgba(255, 87, 34, 0);
}
100% {
box-shadow: 0 0 0 0 rgba(255, 87, 34, 0);
}
}

.hidden {
display: none !important;
}

.footer {
text-align: center;
margin-top: 40px;
color: var(--dark-color);
font-size: 0.95rem;
padding: 25px;
background-color: rgba(255,255,255,0.6);
border-radius: 12px;
box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}

/* ตารางยอดขาย */
.sales-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
overflow-x: auto;
display: block;
white-space: nowrap;
border-radius: 12px;
overflow: hidden;
box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.sales-table thead,
.sales-table tbody {
display: table;
width: 100%;
table-layout: fixed;
}

.sales-table th,
.sales-table td {
padding: 15px 12px;
text-align: center;
border: 1px solid #e0e0e0;
word-wrap: break-word;
}

.sales-table th {
background: linear-gradient(135deg, var(--light-color), var(--light-alt-color));
color: var(--dark-color);
font-weight: 600;
border-bottom: 2px solid var(--primary-color);
}

.sales-table tr:nth-child(even) {
background-color: #f9f9f9;
}

.sales-table tr:hover {
background-color: var(--light-alt-color);
transform: scale(1.01);
transition: all 0.3s ease;
}

.prediction-highlight {
background: linear-gradient(135deg, var(--success-color), var(--success-dark));
color: white;
padding: 25px;
border-radius: 16px;
text-align: center;
margin-top: 20px;
box-shadow: 0 12px 30px rgba(76, 175, 80, 0.3);
}

.prediction-amount {
font-size: 2.8rem;
font-weight: 800;
margin-bottom: 12px;
}

.prediction-reason {
font-size: 1.1rem;
opacity: 0.95;
line-height: 1.5;
}

/* Responsive Design */
@media (max-width: 768px) {
.container {
padding: 0 10px;
}

h1 {
font-size: 1.8rem;
}

h2 {
font-size: 1.2rem;
}

.tab {
padding: 12px 6px;
font-size: 0.85rem;
min-height: 60px;
}

.dashboard-stats {
grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
gap: 15px;
}

.business-type-selector {
grid-template-columns: 1fr;
gap: 15px;
}

.analysis-grid {
grid-template-columns: 1fr;
gap: 15px;
}

.profit-scenarios {
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 10px;
}

.form-row {
grid-template-columns: 1fr;
gap: 15px;
}

.option-button {
font-size: 0.85rem;
padding: 12px 10px;
min-width: 100px;
}

.price-recommendation {
font-size: 2.5rem;
}

.stat-value {
font-size: 1.8rem;
}

.card, .tab-content {
padding: 20px;
}

.calculate-btn, .action-btn {
padding: 15px;
font-size: 1.1rem;
}

.sales-table {
font-size: 0.9rem;
}

.sales-table th,
.sales-table td {
padding: 10px 8px;
}

.prediction-amount {
font-size: 2.2rem;
}

.business-type-card {
padding: 20px;
}

.cost-analysis-section {
padding: 20px;
}

.analysis-card {
padding: 15px;
}
}

@media (max-width: 480px) {
h1 {
font-size: 1.6rem;
}

.tab {
font-size: 0.8rem;
padding: 10px 4px;
}

.dashboard-stats {
grid-template-columns: 1fr;
}

.option-group {
flex-direction: column;
}

.option-button {
min-width: auto;
}

.business-icon {
font-size: 2.5rem;
}

.price-recommendation {
font-size: 2rem;
}

.profit-scenarios {
grid-template-columns: 1fr;
}
}

/* แอนิเมชันพิเศษ */
@keyframes slideInUp {
from {
opacity: 0;
transform: translateY(30px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

@keyframes fadeInScale {
from {
opacity: 0;
transform: scale(0.9);
}
to {
opacity: 1;
transform: scale(1);
}
}

.slide-in {
animation: slideInUp 0.6s ease-out;
}

.fade-scale {
animation: fadeInScale 0.5s ease-out;
}

/* สไตล์สำหรับแชท */
.chat-ui {
background-color: white;
border-radius: 16px;
box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
margin-bottom: 25px;
overflow: hidden;
display: flex;
flex-direction: column;
height: 500px;
transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.chat-ui:hover {
transform: translateY(-5px);
box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
}

.chat-messages {
flex: 1;
padding: 25px;
overflow-y: auto;
background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.message {
margin-bottom: 20px;
max-width: 85%;
animation: messageIn 0.4s ease;
padding: 16px 20px;
border-radius: 20px;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
line-height: 1.5;
}

.message.user {
margin-left: auto;
background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
color: white;
border-radius: 20px 20px 4px 20px;
}

.message.ai {
margin-right: auto;
background-color: white;
color: var(--dark-color);
border-radius: 20px 20px 20px 4px;
border-left: 4px solid var(--primary-color);
}

.message-time {
font-size: 0.8rem;
opacity: 0.7;
margin-top: 8px;
text-align: right;
}

@keyframes messageIn {
from { opacity: 0; transform: translateY(20px) scale(0.95); }
to { opacity: 1; transform: translateY(0) scale(1); }
}

.chat-input-container {
display: flex;
padding: 20px;
border-top: 1px solid #e0e0e0;
background-color: #fff;
gap: 15px;
}

.chat-input {
flex: 1;
padding: 15px 20px;
border: 2px solid #e0e0e0;
border-radius: 30px;
font-size: 1rem;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 0 2px 8px rgba(0,0,0,0.05);
font-family: inherit;
}

.chat-input:focus {
border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.1);
outline: none;
}

.chat-send-btn {
background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
color: white;
border: none;
border-radius: 50%;
width: 55px;
height: 55px;
cursor: pointer;
display: flex;
justify-content: center;
align-items: center;
box-shadow: 0 6px 15px rgba(255, 87, 34, 0.3);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
animation: chatButtonShift 5s infinite;
}

@keyframes chatButtonShift {
0% { background: linear-gradient(145deg, #FF5722, #E64A19); }
50% { background: linear-gradient(145deg, #9C27B0, #7B1FA2); }
100% { background: linear-gradient(145deg, #FF5722, #E64A19); }
}

.chat-send-btn:hover {
transform: translateY(-2px) scale(1.05);
box-shadow: 0 8px 20px rgba(255, 87, 34, 0.4);
}

.chat-send-btn:active {
transform: translateY(1px) scale(0.98);
box-shadow: 0 3px 8px rgba(255, 87, 34, 0.2);
}

/* Typing indicator */
.typing-indicator {
display: flex;
align-items: center;
padding: 10px 0;
}

.typing-indicator span {
height: 8px;
width: 8px;
float: left;
margin: 0 2px;
background-color: #9E9E9E;
display: block;
border-radius: 50%;
opacity: 0.4;
animation: 1s blink infinite;
}

.typing-indicator span:nth-of-type(1) { animation-delay: 0.3333s; }
.typing-indicator span:nth-of-type(2) { animation-delay: 0.6666s; }
.typing-indicator span:nth-of-type(3) { animation-delay: 0.9999s; }

@keyframes blink {
50% { opacity: 1; }
}

/* กลยุทธ์การขาย */
.strategy-item {
display: flex;
gap: 15px;
background: white;
padding: 20px;
border-radius: 12px;
margin-bottom: 15px;
box-shadow: 0 6px 15px rgba(0,0,0,0.08);
transition: all 0.3s ease;
border-left: 4px solid var(--primary-color);
}

.strategy-item:hover {
transform: translateX(5px);
box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.strategy-icon {
flex-shrink: 0;
}

.strategy-content h4 {
color: var(--primary-color);
margin-bottom: 10px;
font-weight: 600;
}

.strategy-content p {
line-height: 1.6;
margin-bottom: 8px;
}

/* โหลดดิ้ง */
.loading-spinner {
border: 3px solid #f3f3f3;
border-top: 3px solid var(--primary-color);
border-radius: 50%;
width: 30px;
height: 30px;
animation: spin 1s linear infinite;
margin: 10px auto;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* สไตล์เพิ่มเติมสำหรับความสวยงาม */
.highlight-box {
background: linear-gradient(135deg, rgba(255, 87, 34, 0.1), rgba(255, 152, 0, 0.1));
border: 2px solid rgba(255, 87, 34, 0.2);
border-radius: 12px;
padding: 20px;
margin: 15px 0;
}

.success-box {
background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(56, 142, 60, 0.1));
border: 2px solid rgba(76, 175, 80, 0.2);
border-radius: 12px;
padding: 20px;
margin: 15px 0;
}

.warning-box {
background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 160, 0, 0.1));
border: 2px solid rgba(255, 193, 7, 0.2);
border-radius: 12px;
padding: 20px;
margin: 15px 0;
}

/* แก้ไข scrollbar */
::-webkit-scrollbar {
width: 8px;
}

::-webkit-scrollbar-track {
background: #f1f1f1;
border-radius: 10px;
}

::-webkit-scrollbar-thumb {
background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
}
</style>
</head>

<body>
<header>
<div class="header-bg"></div>
<div class="header-content container">
<h1>🏪 Smart Pork Skewer Business Advisor AI</h1>
<h2>ที่ปรึกษาธุรกิจหมูปิ้งอัจฉริยะ</h2>
<div class="date-display" id="current-date">วันที่ ...</div>
</div>
</header>

<div class="container">
<div class="notification info" id="api-key-notification">
<svg viewBox="0 0 24 24" fill="none" stroke="#2196F3" stroke-width="2">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" y1="8" x2="12" y2="12"></line>
<line x1="12" y1="16" x2="12" y2="16"></line>
</svg>
<div class="notification-content">
<p>ข้อมูลของคุณจะถูกบันทึกอย่างปลอดภัยใน Firebase Database แล้ว หากต้องการใช้งาน AI เต็มรูปแบบ โปรดตั้งค่า API Key ใน "การตั้งค่า"</p>
</div>
</div>

<!-- แท็บใหม่ที่ปรับปรุงแล้ว -->
<div class="tabs">
<div class="tab active" data-tab="dashboard">📊 หน้าหลัก</div>
<div class="tab" data-tab="business-tools">🛠️ เครื่องมือธุรกิจ</div>
<div class="tab" data-tab="sales">📈 บันทึกยอดขาย</div>
<div class="tab" data-tab="advisor">🤖 ที่ปรึกษา AI</div>
<div class="tab" data-tab="settings">⚙️ การตั้งค่า</div>
</div>

<!-- แดชบอร์ด -->
<div id="dashboard-tab" class="tab-content active">
<div class="dashboard-stats">
<div class="stat-card">
<div class="stat-label">ราคาแนะนำวันนี้</div>
<div class="stat-value" id="today-price">-- บาท</div>
<div class="stat-label">ต่อไม้</div>
</div>
<div class="stat-card">
<div class="stat-label">ราคาหมูในตลาด</div>
<div class="stat-value" id="market-price">-- บาท</div>
<div class="stat-label">ต่อกิโลกรัม</div>
<div class="stat-label" id="price-update-time">อัปเดตเมื่อ: --</div>
</div>
<div class="stat-card">
<div class="stat-label">สภาพอากาศ</div>
<div class="stat-value" id="weather-status">--</div>
<div class="stat-label">ความชื้น: <span id="humidity">--</span>%</div>
</div>
<div class="stat-card">
<div class="stat-label">กำไรประมาณการ</div>
<div class="stat-value" id="estimated-profit">-- บาท</div>
<div class="stat-label">ต่อวัน</div>
</div>
</div>

<div class="card">
<div class="card-title">💡 แนะนำประจำวัน</div>
<div id="daily-recommendation">
<div id="recommendation-content">
<p>วันนี้สภาพอากาศ <span id="weather-desc">--</span> เหมาะกับการขายที่ <span id="location-rec">--</span></p>
<p>แนะนำให้ตั้งราคาที่ <span id="price-rec">--</span> บาทต่อไม้</p>
<p>เพราะ <span id="price-reason">--</span></p>
<div class="additional-tips">
<h4>🎯 เทคนิคพิเศษสำหรับวันนี้</h4>
<ul id="daily-tips">
<li>กำลังโหลด...</li>
</ul>
</div>
</div>
</div>
<button class="action-btn pulse" id="refresh-recommendation">🔄 รีเฟรชคำแนะนำ</button>
</div>

<div class="card">
<div class="card-title">📊 สรุปยอดขาย 7 วันย้อนหลัง</div>
<div id="dashboard-sales-summary">
<p>ยังไม่มีข้อมูลการขาย กรุณาบันทึกยอดขายในแท็บ "บันทึกยอดขาย"</p>
</div>
</div>
</div>

<!-- เครื่องมือธุรกิจ (แท็บใหม่) -->
<div id="business-tools-tab" class="tab-content">
<div class="card">
<div class="card-title">🏢 เลือกรูปแบบธุรกิจของคุณ</div>
<div class="business-type-selector">
<div class="business-type-card" data-type="producer">
<div class="business-icon">🏭</div>
<div class="business-title">ผลิตเอง</div>
<div class="business-description">ซื้อเนื้อหมูสด เตรียมและปรุงรสเอง ควบคุมคุณภาพได้ทุกขั้นตอน</div>
</div>
<div class="business-type-card" data-type="reseller">
<div class="business-icon">🛒</div>
<div class="business-title">ซื้อมาขาย</div>
<div class="business-description">ซื้อหมูปิ้งสำเร็จรูปจากผู้ผลิต นำมาขายต่อ ลงทุนน้อยเริ่มง่าย</div>
</div>
<div class="business-type-card" data-type="franchise">
<div class="business-icon">🏪</div>
<div class="business-title">แฟรนไชส์</div>
<div class="business-description">เข้าร่วมกับแบรนด์ที่มีชื่อเสียง มีการสนับสนุนและระบบที่เป็นมาตรฐาน</div>
</div>
</div>
</div>

<!-- ส่วนคำนวณต้นทุนและราคา -->
<div class="card" id="cost-calculation-section" style="display: none;">
<div class="card-title">💰 การวิเคราะห์ต้นทุนและกำไร</div>
<form id="business-calculator-form">
<!-- ฟอร์มสำหรับแต่ละประเภทธุรกิจ จะแสดงตาม JavaScript -->
<div id="producer-form" class="business-form" style="display: none;">
<div class="form-row">
<div class="form-group">
<label for="producer-meat-price">ราคาเนื้อหมู (บาท/กก.)</label>
<input type="number" id="producer-meat-price" min="50" value="190">
</div>
<div class="form-group">
<label for="producer-meat-weight">น้ำหนักเนื้อต่อไม้ (กรัม)</label>
<input type="number" id="producer-meat-weight" min="15" max="50" value="25">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="producer-seasoning-cost">ต้นทุนเครื่องปรุง/ไม้ (บาท)</label>
<input type="number" id="producer-seasoning-cost" min="0" step="0.1" value="0.5">
</div>
<div class="form-group">
<label for="producer-stick-cost">ต้นทุนไม้จิ้ม/ไม้ (บาท)</label>
<input type="number" id="producer-stick-cost" min="0" step="0.1" value="0.3">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="producer-gas-cost">ต้นทุนแก๊ส/ไม้ (บาท)</label>
<input type="number" id="producer-gas-cost" min="0" step="0.1" value="0.2">
</div>
<div class="form-group">
<label for="producer-labor-cost">ต้นทุนแรงงาน/ไม้ (บาท)</label>
<input type="number" id="producer-labor-cost" min="0" step="0.1" value="1.0">
</div>
</div>
</div>

<div id="reseller-form" class="business-form" style="display: none;">
<div class="form-row">
<div class="form-group">
<label for="reseller-buy-price">ราคาซื้อ/ไม้ (บาท)</label>
<input type="number" id="reseller-buy-price" min="1" step="0.5" value="8">
</div>
<div class="form-group">
<label for="reseller-transport-cost">ต้นทุนขนส่ง/ไม้ (บาท)</label>
<input type="number" id="reseller-transport-cost" min="0" step="0.1" value="0.5">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="reseller-storage-cost">ต้นทุนเก็บรักษา/ไม้ (บาท)</label>
<input type="number" id="reseller-storage-cost" min="0" step="0.1" value="0.2">
</div>
<div class="form-group">
<label for="reseller-gas-cost">ต้นทุนแก๊สอุ่น/ไม้ (บาท)</label>
<input type="number" id="reseller-gas-cost" min="0" step="0.1" value="0.3">
</div>
</div>
</div>

<div id="franchise-form" class="business-form" style="display: none;">
<div class="form-row">
<div class="form-group">
<label for="franchise-product-cost">ต้นทุนสินค้า/ไม้ (บาท)</label>
<input type="number" id="franchise-product-cost" min="1" step="0.5" value="9">
</div>
<div class="form-group">
<label for="franchise-royalty">ค่าแฟรนไชส์/ไม้ (บาท)</label>
<input type="number" id="franchise-royalty" min="0" step="0.1" value="0.5">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="franchise-marketing">ค่าการตลาด/ไม้ (บาท)</label>
<input type="number" id="franchise-marketing" min="0" step="0.1" value="0.3">
</div>
<div class="form-group">
<label for="franchise-support">ค่าสนับสนุน/ไม้ (บาท)</label>
<input type="number" id="franchise-support" min="0" step="0.1" value="0.2">
</div>
</div>
</div>

<!-- ข้อมูลตลาดและสภาพแวดล้อม -->
<div class="form-group">
<label for="location">ตำแหน่งขาย</label>
<select id="location">
<option value="market">ตลาดสด/ตลาดนัด</option>
<option value="street">ริมถนน/จุดผ่านคน</option>
<option value="community">ชุมชน/หมู่บ้าน</option>
<option value="school">สถานศึกษา/มหาวิทยาลัย</option>
<option value="office">ออฟฟิศ/ย่านธุรกิจ</option>
<option value="mall">ศูนย์การค้า/ห้างสรรพสินค้า</option>
</select>
</div>

<div class="form-group">
<label for="daily-volume">ปริมาณขายต่อวัน (ไม้)</label>
<select id="daily-volume">
<option value="50">น้อย (น้อยกว่า 100 ไม้)</option>
<option value="200" selected>ปานกลาง (100-300 ไม้)</option>
<option value="400">มาก (300-500 ไม้)</option>
<option value="600">มากมาย (มากกว่า 500 ไม้)</option>
</select>
</div>

<div class="form-group">
<label>สภาพอากาศ</label>
<div class="option-group">
<div class="option-button selected" data-value="sunny">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<circle cx="12" cy="12" r="5"></circle>
<line x1="12" y1="1" x2="12" y2="3"></line>
<line x1="12" y1="21" x2="12" y2="23"></line>
<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
<line x1="1" y1="12" x2="3" y2="12"></line>
<line x1="21" y1="12" x2="23" y2="12"></line>
<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>
แดดออก
</div>
<div class="option-button" data-value="cloudy">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
</svg>
มีเมฆ
</div>
<div class="option-button" data-value="rainy">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M20 16.2A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path>
<line x1="8" y1="16" x2="8.01" y2="16"></line>
<line x1="8" y1="20" x2="8.01" y2="20"></line>
<line x1="12" y1="18" x2="12.01" y2="18"></line>
<line x1="12" y1="22" x2="12.01" y2="22"></line>
<line x1="16" y1="16" x2="16.01" y2="16"></line>
<line x1="16" y1="20" x2="16.01" y2="20"></line>
</svg>
ฝนตก
</div>
</div>
</div>

<div class="form-group">
<label>สภาพเศรษฐกิจในพื้นที่</label>
<div class="option-group">
<div class="option-button" data-value="excellent">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
</svg>
ดีเยี่ยม
</div>
<div class="option-button" data-value="good">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"></path>
<path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
<line x1="9" y1="9" x2="9.01" y2="9"></line>
<line x1="15" y1="9" x2="15.01" y2="9"></line>
</svg>
ดี
</div>
<div class="option-button selected" data-value="normal">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"></path>
<line x1="8" y1="15" x2="16" y2="15"></line>
<line x1="9" y1="9" x2="9.01" y2="9"></line>
<line x1="15" y1="9" x2="15.01" y2="9"></line>
</svg>
ปกติ
</div>
<div class="option-button" data-value="bad">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"></path>
<path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
<line x1="9" y1="9" x2="9.01" y2="9"></line>
<line x1="15" y1="9" x2="15.01" y2="9"></line>
</svg>
แย่
</div>
</div>
</div>

<button type="button" class="calculate-btn pulse" id="calculate-business-btn">🧮 วิเคราะห์ธุรกิจและคำนวณราคา</button>
</form>
</div>

<!-- ผลการวิเคราะห์ -->
<div class="cost-analysis-section" id="business-analysis-result" style="display: none;">
<h3>📊 ผลการวิเคราะห์ธุรกิจ</h3>
<div class="analysis-grid">
<div class="analysis-card">
<div class="analysis-title">
💰 การวิเคราะห์ต้นทุน
</div>
<ul class="cost-breakdown" id="cost-breakdown">
<!-- จะถูกเติมด้วย JavaScript -->
</ul>
</div>

<div class="analysis-card">
<div class="analysis-title">
📈 จุดคุ้มทุน (Break-even)
</div>
<div id="breakeven-analysis">
<!-- จะถูกเติมด้วย JavaScript -->
</div>
</div>

<div class="analysis-card">
<div class="analysis-title">
🎯 ตำแหน่งในตลาด
</div>
<div id="market-position">
<!-- จะถูกเติมด้วย JavaScript -->
</div>
</div>
</div>

<div class="profit-scenarios">
<div class="scenario-card">
<div class="scenario-price" id="conservative-price">-- บาท</div>
<div class="scenario-profit" id="conservative-profit">กำไร: -- บาท/วัน</div>
<div class="scenario-label">💚 ราคาปลอดภัย</div>
</div>
<div class="scenario-card recommended">
<div class="scenario-price" id="recommended-price">-- บาท</div>
<div class="scenario-profit" id="recommended-profit">กำไร: -- บาท/วัน</div>
<div class="scenario-label">⭐ ราคาแนะนำ</div>
</div>
<div class="scenario-card">
<div class="scenario-price" id="aggressive-price">-- บาท</div>
<div class="scenario-profit" id="aggressive-profit">กำไร: -- บาท/วัน</div>
<div class="scenario-label">🚀 ราคาท้าทาย</div>
</div>
</div>

<div class="additional-tips" id="business-strategies">
<h4>🎯 กลยุทธ์ธุรกิจที่แนะนำ</h4>
<div id="strategy-content">
<!-- จะถูกเติมด้วย JavaScript -->
</div>
</div>
</div>
</div>

<!-- บันทึกยอดขาย -->
<div id="sales-tab" class="tab-content">
<div class="card">
<div class="card-title">📝 บันทึกยอดขายประจำวัน</div>
<div class="form-row">
<div class="form-group">
<label for="sale-date">วันที่</label>
<input type="date" id="sale-date">
</div>
<div class="form-group">
<label for="prepared-amount">จำนวนที่เตรียมไป (ไม้)</label>
<input type="number" id="prepared-amount" min="0" placeholder="เช่น 150">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label for="sold-amount">ขายได้จริง (ไม้)</label>
<input type="number" id="sold-amount" min="0" placeholder="เช่น 140">
</div>
<div class="form-group">
<label for="average-price">ราคาขายเฉลี่ย (บาท/ไม้)</label>
<input type="number" id="average-price" min="0" step="0.5" placeholder="เช่น 12">
</div>
</div>

<div class="form-group">
<label for="weather-condition">สภาพอากาศวันนั้น</label>
<select id="weather-condition">
<option value="sunny">แดดออก</option>
<option value="cloudy">มีเมฆ</option>
<option value="rainy">ฝนตก</option>
</select>
</div>

<div class="form-group">
<label for="sale-notes">หมายเหตุ (ถ้ามี)</label>
<textarea id="sale-notes" rows="3" placeholder="เช่น วันหยุด, เทศกาล, เงินเดือนออก, โปรโมชั่นพิเศษ"></textarea>
</div>

<button class="action-btn" id="save-sales-btn">💾 บันทึกยอดขาย</button>
</div>

<!-- แสดงข้อมูล 7 วันย้อนหลัง -->
<div class="card">
<div class="card-title">📊 ยอดขาย 7 วันย้อนหลัง</div>
<div id="sales-history">
<p>ยังไม่มีข้อมูล กรุณาบันทึกยอดขายก่อน</p>
</div>
</div>

<!-- พยากรณ์วันพรุ่งนี้ -->
<div class="card">
<div class="card-title">🔮 AI พยากรณ์การเตรียมวันพรุ่งนี้</div>
<div id="prediction-result">
<div class="prediction-highlight">
<div class="prediction-amount" id="predicted-amount">-- ไม้</div>
<div class="prediction-reason" id="prediction-reason">กรุณาบันทึกข้อมูลอย่างน้อย 3 วัน เพื่อให้ระบบ AI คำนวณได้แม่นยำ</div>
</div>
</div>
</div>
</div>

<!-- ที่ปรึกษา AI -->
<div id="advisor-tab" class="tab-content">
<div class="card">
<div class="card-title">💬 แชทกับที่ปรึกษา AI</div>
<div class="chat-ui">
<div class="chat-messages" id="chat-messages">
<div class="message ai">
สวัสดีครับ! ผมคือ AI ที่ปรึกษาธุรกิจหมูปิ้งอัจฉริยะ 🤖
<br><br>
ผมพร้อมให้คำแนะนำทั้งเรื่อง:
<br>• การตั้งราคาและคำนวณต้นทุน 💰
<br>• กลยุทธ์การขายและการตลาด 📈
<br>• การแก้ปัญหาและเพิ่มประสิทธิภาพ 🎯
<br>• การรับมือกับสถานการณ์ต่างๆ ⚡
<br><br>
ลองถามผมได้เลยครับ ทุกคำถามเกี่ยวกับธุรกิจหมูปิ้ง! 🥢
<div class="message-time">เมื่อสักครู่</div>
</div>
</div>
<div class="chat-input-container">
<input type="text" class="chat-input" id="chat-input" placeholder="ถามคำถามเกี่ยวกับธุรกิจหมูปิ้ง...">
<button class="chat-send-btn" id="chat-send-btn">
<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
<line x1="22" y1="2" x2="11" y2="13"></line>
<polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
</svg>
</button>
</div>
</div>
</div>

<div class="card">
<div class="card-title">💡 คำแนะนำตามสถานการณ์</div>
<div class="strategy-item">
<div class="strategy-icon">
<svg viewBox="0 0 24 24" fill="none" stroke="#FF5722" stroke-width="2">
<path d="M20 16.2A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path>
<line x1="8" y1="16" x2="8.01" y2="16"></line>
<line x1="8" y1="20" x2="8.01" y2="20"></line>
<line x1="12" y1="18" x2="12.01" y2="18"></line>
<line x1="12" y1="22" x2="12.01" y2="22"></line>
<line x1="16" y1="16" x2="16.01" y2="16"></line>
<line x1="16" y1="20" x2="16.01" y2="20"></line>
</svg>
</div>
<div class="strategy-content">
<h4>🌧️ กลยุทธ์วันฝนตก</h4>
<p>• ทำที่กันฝนเล็กๆ ให้ลูกค้ายืนไม่เปียก หรือมีบริการส่งถึงรถ</p>
<p>• เตรียมถุงพลาสติกให้ลูกค้าใส่หมูปิ้งกลับบ้าน</p>
<p>• ลดราคาลง 1-2 บาทเพื่อดึงดูดลูกค้า หรือทำโปรโมชั่นพิเศษ "ซื้อ 10 แถม 1 เฉพาะวันฝนตก"</p>
</div>
</div>

<div class="strategy-item">
<div class="strategy-icon">
<svg viewBox="0 0 24 24" fill="none" stroke="#FF5722" stroke-width="2">
<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"></path>
<path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
<line x1="9" y1="9" x2="9.01" y2="9"></line>
<line x1="15" y1="9" x2="15.01" y2="9"></line>
</svg>
</div>
<div class="strategy-content">
<h4>📉 กลยุทธ์เศรษฐกิจช่วงแย่</h4>
<p>• ลดขนาดไม้เล็กน้อยแต่คงราคาเดิม หรือเพิ่มโปรโมชั่น เช่น ซื้อ 5 ไม้แถม 1</p>
<p>• เน้นการตลาดโดยใช้คำว่า "อิ่มคุ้ม" หรือ "ประหยัด"</p>
<p>• นำเสนอชุดราคาพิเศษ เช่น หมูปิ้ง + ข้าวเหนียว หรือ เซ็ตครอบครัว</p>
</div>
</div>

<div class="strategy-item">
<div class="strategy-icon">
<svg viewBox="0 0 24 24" fill="none" stroke="#FF5722" stroke-width="2">
<circle cx="12" cy="12" r="5"></circle>
<line x1="12" y1="1" x2="12" y2="3"></line>
<line x1="12" y1="21" x2="12" y2="23"></line>
<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
<line x1="1" y1="12" x2="3" y2="12"></line>
<line x1="21" y1="12" x2="23" y2="12"></line>
<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>
</div>
<div class="strategy-content">
<h4>☀️ กลยุทธ์อากาศร้อนจัด</h4>
<p>• เตรียมน้ำดื่มเย็นๆ ไว้บริการฟรี หรือขายราคาถูก</p>
<p>• ใช้ร่มบังแดดให้ลูกค้า และปิ้งหมูสดใหม่ตลอด ไม่ปิ้งเก็บไว้นานเกินไป</p>
<p>• พิจารณาเพิ่มเมนูน้ำแข็งไสหรือเครื่องดื่มเย็นๆ เพื่อเพิ่มรายได้</p>
</div>
</div>
</div>
</div>

<!-- การตั้งค่า -->
<div id="settings-tab" class="tab-content">
<div class="card">
<div class="card-title">🔑 ตั้งค่า API Key สำหรับ AI</div>
<div class="form-group">
<label for="api-provider">ผู้ให้บริการ AI</label>
<select id="api-provider">
<option value="openai">OpenAI (GPT-4)</option>
<option value="anthropic">Anthropic (Claude)</option>
<option value="gemini">Google Gemini</option>
</select>
</div>
<div class="form-group">
<label for="api-key">API Key</label>
<input type="password" id="api-key" placeholder="ใส่ API Key ของคุณ">
</div>
<button class="action-btn" id="save-api-key">💾 บันทึก API Key</button>
<div class="warning-box" style="margin-top: 15px;">
<p><strong>🔒 ความปลอดภัย:</strong> API Key จะถูกเก็บใน Firebase ของคุณเท่านั้น ปลอดภัยและเข้าถึงได้เฉพาะคุณ</p>
</div>
</div>

<div class="card">
<div class="card-title">🏪 ข้อมูลร้านค้า</div>
<div class="form-group">
<label for="business-name">ชื่อร้าน</label>
<input type="text" id="business-name" placeholder="เช่น หมูปิ้งป้าสมหวัง">
</div>
<div class="form-group">
<label for="business-location">ที่ตั้งร้าน</label>
<input type="text" id="business-location" placeholder="เช่น เชียงราย, กรุงเทพ, ขอนแก่น">
</div>
<div class="form-group">
<label for="business-type-setting">ประเภทธุรกิจหลัก</label>
<select id="business-type-setting">
<option value="">เลือกประเภทธุรกิจ</option>
<option value="producer">ผลิตเอง</option>
<option value="reseller">ซื้อมาขาย</option>
<option value="franchise">แฟรนไชส์</option>
</select>
</div>
<div class="form-group">
<label for="business-description">รายละเอียดร้าน</label>
<textarea id="business-description" rows="3" placeholder="เล่าเกี่ยวกับร้านของคุณ, จุดเด่น, ประสบการณ์, สูตรพิเศษ"></textarea>
</div>
<button class="action-btn" id="save-business-info">💾 บันทึกข้อมูลร้าน</button>
</div>

<div class="card">
<div class="card-title">🔔 การแจ้งเตือน</div>
<div class="form-group">
<label>
<input type="checkbox" id="weather-alert" checked>
🌤️ แจ้งเตือนสภาพอากาศและคำแนะนำกลยุทธ์
</label>
</div>
<div class="form-group">
<label>
<input type="checkbox" id="price-alert" checked>
💰 แจ้งเตือนการเปลี่ยนแปลงราคาวัตถุดิบ
</label>
</div>
<div class="form-group">
<label>
<input type="checkbox" id="event-alert" checked>
🎊 แจ้งเตือนเทศกาลและโอกาสพิเศษ
</label>
</div>
<div class="form-group">
<label>
<input type="checkbox" id="sales-reminder" checked>
📊 แจ้งเตือนให้บันทึกยอดขายประจำวัน
</label>
</div>
<button class="action-btn" id="save-alert-settings">💾 บันทึกการตั้งค่าแจ้งเตือน</button>
</div>

<div class="card">
<div class="card-title">📱 ข้อมูลแอปพลิเคชัน</div>
<div class="highlight-box">
<h4>🚀 Smart Pork Skewer Business Advisor AI v4.0</h4>
<p><strong>คุณสมบัติหลัก:</strong></p>
<ul style="padding-left: 20px; margin-top: 10px;">
<li>🧮 ระบบคำนวณต้นทุนและราคาแบบละเอียด</li>
<li>📊 วิเคราะห์ธุรกิจและจุดคุ้มทุน</li>
<li>🤖 AI ที่ปรึกษาและแชทบอท</li>
<li>📈 ระบบบันทึกยอดขายและพยากรณ์</li>
<li>🌤️ ข้อมูลสภาพอากาศและคำแนะนำ</li>
<li>💾 ระบบฐานข้อมูล Firebase</li>
</ul>
</div>
<div class="success-box" style="margin-top: 15px;">
<p><strong>🎯 พัฒนาโดย:</strong> AI และ Firebase Technology</p>
<p><strong>📅 อัปเดตล่าสุด:</strong> พฤษภาคม 2025</p>
<p><strong>🔧 เวอร์ชัน:</strong> 4.0 - Business Intelligence Edition</p>
</div>
</div>
</div>

<div class="footer">
<p><strong>🏪 Smart Pork Skewer Business Advisor AI v4.0</strong></p>
<p>ที่ปรึกษาธุรกิจหมูปิ้งอัจฉริยะ - เพื่อความสำเร็จของธุรกิจคุณ</p>
<p>พัฒนาด้วย ❤️ โดยใช้ AI และ Firebase Technology</p>
</div>
</div>

<script>
// =====================
// ระบบจัดการข้อมูลผู้ใช้ด้วย Firebase (ปรับปรุง)
// =====================

const UserDataManager = {
userData: {
profile: {
businessName: '',
location: '',
description: '',
businessType: ''
},
preferences: {
weatherAlert: true,
priceAlert: true,
eventAlert: true,
salesReminder: true
},
apiSettings: {
provider: 'openai',
apiKey: ''
},
businessData: {
selectedType: '',
lastCalculation: null,
averageDailyVolume: 200
},
lastPorkPrice: 190,
lastUpdate: new Date().toISOString()
},

currentUserId: null,
isInitialized: false,

// เริ่มต้นระบบ Auth
initAuth: function() {
return new Promise((resolve, reject) => {
auth.onAuthStateChanged(async (user) => {
if (user) {
this.currentUserId = user.uid;
console.log('User logged in:', this.currentUserId);
await this.loadUserData();
this.isInitialized = true;
resolve(user);
} else {
try {
const result = await auth.signInAnonymously();
this.currentUserId = result.user.uid;
console.log('Anonymous login successful:', this.currentUserId);
this.isInitialized = true;
resolve(result.user);
} catch (error) {
console.error('Authentication failed:', error);
reject(error);
}
}
});
});
},

// บันทึกข้อมูลลง Firestore
saveUserData: async function() {
if (!this.isInitialized || !this.currentUserId) {
console.log('Not ready to save data');
return false;
}

try {
await db.collection('users').doc(this.currentUserId).set(this.userData);
console.log('Data saved successfully to Firebase');
return true;
} catch (error) {
console.error('Error saving data to Firebase:', error);
return false;
}
},

// โหลดข้อมูลจาก Firestore
loadUserData: async function() {
if (!this.currentUserId) {
console.log('No user ID available');
return false;
}

try {
const doc = await db.collection('users').doc(this.currentUserId).get();
if (doc.exists) {
this.userData = { ...this.userData, ...doc.data() };
console.log('Data loaded from Firebase:', this.userData);
this.updateUIWithUserData();
return true;
} else {
console.log('No user data found, using defaults');
await this.saveUserData();
return false;
}
} catch (error) {
console.error('Error loading from Firebase:', error);
return false;
}
},

// อัปเดต UI ด้วยข้อมูลผู้ใช้
updateUIWithUserData: function() {
const elements = {
'api-provider': this.userData.apiSettings.provider,
'api-key': this.userData.apiSettings.apiKey,
'business-name': this.userData.profile.businessName,
'business-location': this.userData.profile.location,
'business-description': this.userData.profile.description,
'business-type-setting': this.userData.profile.businessType,
'weather-alert': this.userData.preferences.weatherAlert,
'price-alert': this.userData.preferences.priceAlert,
'event-alert': this.userData.preferences.eventAlert,
'sales-reminder': this.userData.preferences.salesReminder
};

Object.entries(elements).forEach(([id, value]) => {
const element = document.getElementById(id);
if (element) {
if (element.type === 'checkbox') {
element.checked = value;
} else {
element.value = value || '';
}
}
});

updateApiKeyNotification();
},

updateBusinessInfo: async function(name, location, description, businessType) {
this.userData.profile.businessName = name;
this.userData.profile.location = location;
this.userData.profile.description = description;
this.userData.profile.businessType = businessType;
return await this.saveUserData();
},

updateAlertSettings: async function(weatherAlert, priceAlert, eventAlert, salesReminder) {
this.userData.preferences.weatherAlert = weatherAlert;
this.userData.preferences.priceAlert = priceAlert;
this.userData.preferences.eventAlert = eventAlert;
this.userData.preferences.salesReminder = salesReminder;
return await this.saveUserData();
},

updateApiSettings: async function(provider, apiKey) {
this.userData.apiSettings.provider = provider;
this.userData.apiSettings.apiKey = apiKey;
const result = await this.saveUserData();
updateApiKeyNotification();
return result;
},

updateBusinessData: async function(selectedType, calculationData) {
this.userData.businessData.selectedType = selectedType;
this.userData.businessData.lastCalculation = calculationData;
return await this.saveUserData();
},

hasApiKey: function() {
return !!this.userData.apiSettings.apiKey;
}
};

// ฟังก์ชันอัปเดตการแจ้งเตือน API Key
function updateApiKeyNotification() {
const notification = document.getElementById('api-key-notification');
if (notification) {
notification.style.display = UserDataManager.hasApiKey() ? 'none' : 'flex';
}
}

// =====================
// ระบบจัดการยอดขาย (ปรับปรุง)
// =====================

const SalesManager = {
// บันทึกยอดขาย
saveDailySales: async function(salesData) {
if (!UserDataManager.isInitialized || !UserDataManager.currentUserId) {
console.log('User not initialized');
return false;
}

try {
const revenue = salesData.sold * salesData.averagePrice;
const sellThroughRate = Math.round((salesData.sold / salesData.prepared) * 100);

await db.collection('daily_sales').add({
userId: UserDataManager.currentUserId,
date: salesData.date,
prepared: salesData.prepared,
sold: salesData.sold,
leftover: salesData.prepared - salesData.sold,
averagePrice: salesData.averagePrice,
revenue: revenue,
weather: salesData.weather,
notes: salesData.notes,
sellThroughRate: sellThroughRate,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
});

console.log('Sales data saved successfully');
return true;
} catch (error) {
console.error('Error saving sales data:', error);
return false;
}
},

// ดึงข้อมูล 7 วันย้อนหลัง
getLast7DaysSales: async function() {
if (!UserDataManager.currentUserId) {
return [];
}

try {
const sevenDaysAgo = new Date();
sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

const snapshot = await db.collection('daily_sales')
.where('userId', '==', UserDataManager.currentUserId)
.where('date', '>=', sevenDaysAgo.toISOString().split('T')[0])
.orderBy('date', 'desc')
.limit(7)
.get();

return snapshot.docs.map(doc => doc.data());
} catch (error) {
console.error('Error getting sales history:', error);
return [];
}
},

// ดึงข้อมูลทั้งหมด
getAllSalesData: async function() {
if (!UserDataManager.currentUserId) {
return [];
}

try {
const snapshot = await db.collection('daily_sales')
.where('userId', '==', UserDataManager.currentUserId)
.orderBy('date', 'desc')
.get();

return snapshot.docs.map(doc => doc.data());
} catch (error) {
console.error('Error getting all sales data:', error);
return [];
}
},

// คำนวณการพยากรณ์ (AI Enhanced)
calculatePrediction: function(salesHistory) {
if (salesHistory.length < 3) {
return {
amount: 0,
reason: 'ต้องมีข้อมูลอย่างน้อย 3 วัน เพื่อให้ระบบ AI คำนวณได้แม่นยำ',
confidence: 'ต่ำ',
recommendations: ['บันทึกข้อมูลอย่างต่อเนื่อง', 'สังเกตแพทเทิร์นการขาย', 'วิเคราะห์ปัจจัยแวดล้อม']
};
}

// คำนวณเฉลี่ยและแนวโน้ม
const avgSold = salesHistory.reduce((sum, day) => sum + day.sold, 0) / salesHistory.length;
const avgPrepared = salesHistory.reduce((sum, day) => sum + day.prepared, 0) / salesHistory.length;
const avgRevenue = salesHistory.reduce((sum, day) => sum + (day.revenue || 0), 0) / salesHistory.length;

// วิเคราะห์แพทเทิร์นวันในสัปดาห์
const tomorrow = new Date();
tomorrow.setDate(tomorrow.getDate() + 1);
const dayOfWeek = tomorrow.getDay(); // 0=อาทิทย์, 6=เสาร์

let prediction = Math.round(avgSold);
let reasonParts = [];
let recommendations = [];

// ปรับตามวันในสัปดาห์
if (dayOfWeek === 0 || dayOfWeek === 6) {
prediction = Math.round(avgSold * 0.75); // วันหยุดลด 25%
reasonParts.push('วันหยุด (ลด 25%)');
recommendations.push('เตรียมโปรโมชั่นสำหรับวันหยุด');
} else if (dayOfWeek === 5) {
prediction = Math.round(avgSold * 1.15); // วันศุกร์เพิ่ม 15%
reasonParts.push('วันศุกร์ (เพิ่ม 15%)');
recommendations.push('เตรียมของให้เพียงพอสำหรับความต้องการที่เพิ่มขึ้น');
} else if (dayOfWeek >= 1 && dayOfWeek <= 4) {
prediction = Math.round(avgSold * 1.05); // วันจันทร์-พฤหัส
reasonParts.push('วันทำงาน (เพิ่ม 5%)');
}

// วิเคราะห์เทรนด์ 3 วันล่าสุด
if (salesHistory.length >= 3) {
const last3Days = salesHistory.slice(0, 3);
const trend = (last3Days[0].sold - last3Days[2].sold) / 2;

if (Math.abs(trend) > 10) {
prediction += Math.round(trend * 0.7); // ให้น้ำหนักเทรนด์ 70%
if (trend > 0) {
reasonParts.push('เทรนด์เพิ่มขึ้น');
recommendations.push('พิจารณาเพิ่มการผลิต');
} else {
reasonParts.push('เทรนด์ลดลง');
recommendations.push('ปรับกลยุทธ์การขายหรือลดต้นทุน');
}
}
}

// วิเคราะห์สภาพอากาศ (ถ้ามีข้อมูล)
const weatherPattern = salesHistory.reduce((acc, day) => {
acc[day.weather] = (acc[day.weather] || 0) + day.sold;
return acc;
}, {});

// เผื่อไว้ 15% เพื่อไม่ให้ขาดแคลน
const recommendedAmount = Math.max(Math.round(prediction * 1.15), Math.round(avgSold * 0.6));

// คำนวณความเชื่อมั่น
const avgSellThrough = salesHistory.reduce((sum, day) => sum + day.sellThroughRate, 0) / salesHistory.length;
let confidence = 'ปานกลาง';

if (salesHistory.length >= 7 && avgSellThrough >= 85) {
confidence = 'สูง';
recommendations.push('แพทเทิร์นการขายมีความสม่ำเสมอ');
} else if (avgSellThrough < 60) {
confidence = 'ต่ำ';
recommendations.push('ปรับปริมาณการเตรียมให้เหมาะสม');
} else if (salesHistory.length >= 5) {
confidence = 'ปานกลาง';
}

// สร้างเหตุผล
const reason = `จากข้อมูล ${salesHistory.length} วัน เฉลี่ยขาย ${Math.round(avgSold)} ไม้/วัน` +
(reasonParts.length > 0 ? ` (${reasonParts.join(', ')})` : '') +
` รายได้เฉลี่ย ${Math.round(avgRevenue)} บาท/วัน`;

return {
amount: recommendedAmount,
reason: reason,
confidence: confidence,
avgSold: Math.round(avgSold),
avgRevenue: Math.round(avgRevenue),
sellThroughRate: Math.round(avgSellThrough),
recommendations: recommendations
};
},

// สร้างสรุปสำหรับแดชบอร์ด
generateDashboardSummary: function(salesHistory) {
if (salesHistory.length === 0) {
return {
totalDays: 0,
totalSold: 0,
totalRevenue: 0,
avgSold: 0,
avgRevenue: 0,
totalLeftover: 0,
avgSellThrough: 0,
bestDay: null,
worstDay: null,
growthTrend: 0
};
}

const totalSold = salesHistory.reduce((sum, day) => sum + day.sold, 0);
const totalPrepared = salesHistory.reduce((sum, day) => sum + day.prepared, 0);
const totalRevenue = salesHistory.reduce((sum, day) => sum + (day.revenue || 0), 0);
const totalLeftover = salesHistory.reduce((sum, day) => sum + day.leftover, 0);

const avgSold = Math.round(totalSold / salesHistory.length);
const avgRevenue = Math.round(totalRevenue / salesHistory.length);
const avgSellThrough = Math.round((totalSold / totalPrepared) * 100);

const bestDay = salesHistory.reduce((best, day) =>
day.sold > best.sold ? day : best, salesHistory[0]);
const worstDay = salesHistory.reduce((worst, day) =>
day.sold < worst.sold ? day : worst, salesHistory[0]);

// คำนวณแนวโน้มการเติบโต
let growthTrend = 0;
if (salesHistory.length >= 3) {
const firstHalf = salesHistory.slice(Math.floor(salesHistory.length / 2));
const secondHalf = salesHistory.slice(0, Math.floor(salesHistory.length / 2));
const firstAvg = firstHalf.reduce((sum, day) => sum + day.sold, 0) / firstHalf.length;
const secondAvg = secondHalf.reduce((sum, day) => sum + day.sold, 0) / secondHalf.length;
growthTrend = Math.round(((secondAvg - firstAvg) / firstAvg) * 100);
}

return {
totalDays: salesHistory.length,
totalSold: totalSold,
totalRevenue: totalRevenue,
avgSold: avgSold,
avgRevenue: avgRevenue,
totalLeftover: totalLeftover,
avgSellThrough: avgSellThrough,
bestDay: bestDay,
worstDay: worstDay,
growthTrend: growthTrend
};
}
};

// =====================
// Business Intelligence Engine (ใหม่)
// =====================

const BusinessEngine = {
// ข้อมูลต้นทุนแต่ละรูปแบบธุรกิจ
businessModels: {
producer: {
name: 'ผลิตเอง',
description: 'ควบคุมคุณภาพได้ทุกขั้นตอน',
advantages: ['คุณภาพสูง', 'กำไรดี', 'ควบคุมได้ทุกขั้นตอน'],
challenges: ['ต้องลงทุนสูง', 'ต้องมีทักษะ', 'ใช้เวลามาก'],
fixedCosts: ['เครื่องปิ้ง', 'อุปกรณ์', 'ค่าเช่าพื้นที่'],
variableCosts: ['เนื้อหมู', 'เครื่องปรุง', 'ไม้จิ้ม', 'แก๊ส', 'แรงงาน']
},
reseller: {
name: 'ซื้อมาขาย',
description: 'เริ่มง่าย ลงทุนน้อย',
advantages: ['ลงทุนน้อย', 'เริ่มง่าย', 'ความเสี่ยงต่ำ'],
challenges: ['กำไรน้อย', 'ขึ้นกับซัพพลายเออร์', 'แข่งขันสูง'],
fixedCosts: ['อุปกรณ์อุ่น', 'ค่าเช่าพื้นที่'],
variableCosts: ['ต้นทุนซื้อ', 'ขนส่ง', 'เก็บรักษา', 'แก๊สอุ่น']
},
franchise: {
name: 'แฟรนไชส์',
description: 'มีระบบสนับสนุน แบรนด์ที่รู้จัก',
advantages: ['แบรนด์ที่รู้จัก', 'ระบบสนับสนุน', 'การตลาดร่วม'],
challenges: ['ค่าแฟรนไชส์', 'ต้องตามมาตรฐาน', 'กำไรถูกแบ่ง'],
fixedCosts: ['ค่าแฟรนไชส์เริ่มต้น', 'อุปกรณ์ตามมาตรฐาน', 'ค่าเช่า'],
variableCosts: ['ต้นทุนสินค้า', 'ค่าแฟรนไชส์', 'ค่าการตลาด', 'ค่าสนับสนุน']
}
},

// คำนวณต้นทุนตามรูปแบบธุรกิจ
calculateCosts: function(businessType, formData, marketData) {
let costs = { breakdown: [], total: 0 };

switch (businessType) {
case 'producer':
const meatCost = (formData.meatPrice / 1000) * formData.meatWeight;
costs.breakdown = [
{ item: 'เนื้อหมู', cost: meatCost, note: `${formData.meatWeight}g × ${formData.meatPrice}/kg` },
{ item: 'เครื่องปรุงรส', cost: formData.seasoningCost, note: 'น้ำตาล ซีอิ๊ว กระเทียม' },
{ item: 'ไม้จิ้ม', cost: formData.stickCost, note: 'ไม้ไผ่หรือไม้สน' },
{ item: 'ค่าแก๊ส', cost: formData.gasCost, note: 'สำหรับปิ้ง' },
{ item: 'ค่าแรงงาน', cost: formData.laborCost, note: 'เตรียม ปิ้ง ขาย' }
];
break;

case 'reseller':
costs.breakdown = [
{ item: 'ต้นทุนซื้อ', cost: formData.buyPrice, note: 'จากผู้ผลิต' },
{ item: 'ค่าขนส่ง', cost: formData.transportCost, note: 'เบนซิน ค่าส่ง' },
{ item: 'ค่าเก็บรักษา', cost: formData.storageCost, note: 'ตู้เย็น น้ำแข็ง' },
{ item: 'ค่าแก๊สอุ่น', cost: formData.gasCost, note: 'อุ่นให้ร้อน' }
];
break;

case 'franchise':
costs.breakdown = [
{ item: 'ต้นทุนสินค้า', cost: formData.productCost, note: 'จากศูนย์กลาง' },
{ item: 'ค่าแฟรนไชส์', cost: formData.royalty, note: 'ตามสัญญา' },
{ item: 'ค่าการตลาด', cost: formData.marketing, note: 'โฆษณาร่วม' },
{ item: 'ค่าสนับสนุน', cost: formData.support, note: 'ระบบ IT, อบรม' }
];
break;
}

costs.total = costs.breakdown.reduce((sum, item) => sum + item.cost, 0);
return costs;
},

// วิเคราะห์ราคาแนะนำ
analyzePricing: function(costs, marketData, businessType) {
const baseCost = costs.total;

// ปัจจัยปรับราคา
const locationMultiplier = {
'market': 1.0,
'street': 1.1,
'community': 1.05,
'school': 1.15,
'office': 1.2,
'mall': 1.3
};

const weatherMultiplier = {
'sunny': 1.0,
'cloudy': 0.98,
'rainy': 0.92
};

const economyMultiplier = {
'excellent': 1.15,
'good': 1.05,
'normal': 1.0,
'bad': 0.95
};

const businessTypeMultiplier = {
'producer': 1.0,    // ควบคุมต้นทุนได้
'reseller': 0.95,   // แข่งขันสูง
'franchise': 1.1    // แบรนด์เนม
};

// คำนวณราคาแนะนำ
const locationFactor = locationMultiplier[marketData.location] || 1.0;
const weatherFactor = weatherMultiplier[marketData.weather] || 1.0;
const economyFactor = economyMultiplier[marketData.economy] || 1.0;
const businessFactor = businessTypeMultiplier[businessType] || 1.0;

// ราคาต่างๆ
const conservativePrice = Math.ceil(baseCost * 1.3 * locationFactor * weatherFactor * economyFactor * businessFactor);
const recommendedPrice = Math.ceil(baseCost * 1.6 * locationFactor * weatherFactor * economyFactor * businessFactor);
const aggressivePrice = Math.ceil(baseCost * 1.9 * locationFactor * weatherFactor * economyFactor * businessFactor);

// คำนวณกำไรต่อวัน
const dailyVolume = parseInt(marketData.dailyVolume) || 200;

return {
conservative: {
price: conservativePrice,
profit: conservativePrice - baseCost,
dailyProfit: (conservativePrice - baseCost) * dailyVolume,
margin: Math.round(((conservativePrice - baseCost) / conservativePrice) * 100)
},
recommended: {
price: recommendedPrice,
profit: recommendedPrice - baseCost,
dailyProfit: (recommendedPrice - baseCost) * dailyVolume,
margin: Math.round(((recommendedPrice - baseCost) / recommendedPrice) * 100)
},
aggressive: {
price: aggressivePrice,
profit: aggressivePrice - baseCost,
dailyProfit: (aggressivePrice - baseCost) * dailyVolume,
margin: Math.round(((aggressivePrice - baseCost) / aggressivePrice) * 100)
},
breakeven: Math.ceil(baseCost * 1.05), // 5% กำไรขั้นต้น
factors: {
location: locationFactor,
weather: weatherFactor,
economy: economyFactor,
business: businessFactor
}
};
},

// วิเคราะห์ตำแหน่งในตลาด
analyzeMarketPosition: function(pricing, businessType) {
const marketPrices = {
low: 8,
medium: 12,
high: 16,
premium: 20
};

let position = 'กลาง';
let competitive = 'ปานกลาง';

if (pricing.recommended.price <= marketPrices.low) {
position = 'ต่ำ';
competitive = 'สูงมาก';
} else if (pricing.recommended.price <= marketPrices.medium) {
position = 'กลาง-ต่ำ';
competitive = 'สูง';
} else if (pricing.recommended.price <= marketPrices.high) {
position = 'กลาง-สูง';
competitive = 'ปานกลาง';
} else {
position = 'สูง';
competitive = 'ต่ำ';
}

const advantages = this.businessModels[businessType].advantages;
const challenges = this.businessModels[businessType].challenges;

return {
position: position,
competitive: competitive,
advantages: advantages,
challenges: challenges,
recommendations: this.getStrategicRecommendations(position, competitive, businessType)
};
},

// คำแนะนำกลยุทธ์
getStrategicRecommendations: function(position, competitive, businessType) {
let recommendations = [];

// กลยุทธ์ตามตำแหน่งราคา
if (position === 'ต่ำ') {
recommendations.push('เน้นปริมาณและความคุ้มค่า');
recommendations.push('หาจุดขายที่มีคนเดินผ่านมาก');
recommendations.push('ทำโปรโมชั่นแบบ "ซื้อมากได้มาก"');
} else if (position === 'สูง') {
recommendations.push('เน้นคุณภาพและบริการพิเศษ');
recommendations.push('สร้างประสบการณ์ที่ดีให้ลูกค้า');
recommendations.push('หาจุดขายในพื้นที่ที่มีกำลังซื้อสูง');
}

// กลยุทธ์ตามรูปแบบธุรกิจ
switch (businessType) {
case 'producer':
recommendations.push('พัฒนาสูตรเฉพาะตัวให้โดดเด่น');
recommendations.push('ควบคุมคุณภาพอย่างเข้มงวด');
recommendations.push('สร้างความน่าเชื่อถือด้านความสะอาด');
break;
case 'reseller':
recommendations.push('เลือกผู้ผลิตที่มีคุณภาพและราคาดี');
recommendations.push('เน้นการบริการและความสะดวก');
recommendations.push('หาจุดขายที่เหมาะสมกับราคา');
break;
case 'franchise':
recommendations.push('ใช้ประโยชน์จากแบรนด์และการตลาดร่วม');
recommendations.push('ปฏิบัติตามมาตรฐานอย่างเคร่งครัด');
recommendations.push('เรียนรู้และใช้ระบบสนับสนุนอย่างเต็มที่');
break;
}

return recommendations;
},

// สร้างรายงานการวิเคราะห์ธุรกิจ
generateBusinessReport: function(businessType, costs, pricing, market, dailyVolume) {
const monthlyRevenue = pricing.recommended.dailyProfit * 30;
const yearlyRevenue = pricing.recommended.dailyProfit * 365;

return {
businessType: businessType,
costs: costs,
pricing: pricing,
market: market,
projections: {
daily: {
volume: dailyVolume,
revenue: pricing.recommended.price * dailyVolume,
cost: costs.total * dailyVolume,
profit: pricing.recommended.dailyProfit
},
monthly: {
revenue: pricing.recommended.price * dailyVolume * 30,
cost: costs.total * dailyVolume * 30,
profit: monthlyRevenue
},
yearly: {
revenue: pricing.recommended.price * dailyVolume * 365,
cost: costs.total * dailyVolume * 365,
profit: yearlyRevenue
}
},
roi: Math.round((yearlyRevenue / (costs.total * dailyVolume * 365)) * 100),
paybackPeriod: this.calculatePaybackPeriod(businessType, pricing.recommended.dailyProfit)
};
},

calculatePaybackPeriod: function(businessType, dailyProfit) {
// ประมาณการลงทุนเริ่มต้น
const initialInvestment = {
producer: 50000,    // เครื่องปิ้ง อุปกรณ์
reseller: 20000,    // อุปกรณ์อุ่น ตู้แสดง
franchise: 100000   // ค่าแฟรนไชส์ อุปกรณ์
};

const investment = initialInvestment[businessType] || 30000;
const monthsToPayback = Math.ceil(investment / (dailyProfit * 30));
return monthsToPayback;
}
};

// =====================
// AI Engine Service (ปรับปรุงใหม่)
// =====================

const AIEngine = {
mockResponses: {
priceRecommendation: [
"จากการวิเคราะห์ต้นทุนและสภาพตลาดของธุรกิจ{businessType} แนะนำให้ตั้งราคาที่ {price} บาทต่อไม้ ซึ่งจะทำให้คุณมีกำไรประมาณ {margin}% และยังแข่งขันในตลาดได้",
"เนื่องจากสภาพอากาศ{weather} และที่ตั้งอยู่{location} รูปแบบธุรกิจ{businessType} แนะนำให้ตั้งราคาที่ {price} บาทต่อไม้ คุณสามารถทำกำไรได้ดีและมีความแข่งขันที่เหมาะสม",
"ด้วยต้นทุนรวม {cost} บาทต่อไม้ สำหรับธุรกิจ{businessType} แนะนำให้ตั้งราคาที่ {price} บาทต่อไม้ ให้กำไร {profit} บาทต่อไม้ เพื่อความยั่งยืนของธุรกิจ",
"ในสถานการณ์เศรษฐกิจ{economy} รูปแบบธุรกิจ{businessType} ควรตั้งราคาที่ {price} บาทต่อไม้ พร้อมกลยุทธ์เสริมเพื่อดึงดูดลูกค้าและรักษาฐานลูกค้าเดิม"
],

businessTips: {
producer: [
"พัฒนาสูตรหมักเฉพาะตัวด้วยสมุนไพรไทย เช่น ใบมะกรูด ตะไคร้ เพื่อสร้างเอกลักษณ์",
"ใช้เนื้อหมูส่วนคอหรือสันในนอก จะได้เนื้อที่นุ่มและหวาน",
"ปิ้งด้วยไฟแรงแป๊บแรก แล้วลดไฟให้สุกทั่ว เพื่อให้ได้ผิวกรอบนอกนุ่มใน",
"เตรียมน้ำจิ้มหลากหลายรส เช่น แจ่วบอง น้ำจิ้มไก่ เพิ่มมูลค่าสินค้า",
"คุมคุณภาพการเก็บรักษาเนื้อหมูให้เย็นตลอด รักษาความสด",
"สร้างจุดขายที่สะอาด มีการจัดแสดงกระบวนการปิ้งให้ลูกค้าเห็น"
],
reseller: [
"เลือกซื้อจากผู้ผลิตที่มีใบรับรอง อย. และรักษามาตรฐานความสะอาด",
"ต่อรองราคาซื้อให้ได้ดีที่สุด และขอเครดิตเทอมถ้าทำได้",
"ลงทุนในอุปกรณ์อุ่นที่ดี เพื่อรักษาอุณหภูมิและความอร่อย",
"หาจุดขายที่มีการเดินทางสะดวก จอดรถง่าย",
"สร้างความสัมพันธ์ที่ดีกับซัพพลายเออร์ เพื่อได้ราคาและบริการที่ดี",
"เน้นการบริการที่รวดเร็วและเป็นมิตร เพื่อดึงดูดลูกค้าประจำ"
],
franchise: [
"ปฏิบัติตามมาตรฐานของแบรนด์อย่างเคร่งครัด เพื่อรักษาคุณภาพ",
"ใช้ประโยชน์จากระบบการตลาดและโปรโมชั่นของแบรนด์",
"เข้าร่วมการอบรมและกิจกรรมที่แบรนด์จัดให้อย่างสม่ำเสมอ",
"สร้างความสัมพันธ์ที่ดีกับแฟรนไชส์เซอร์และเจ้าของสาขาอื่น",
"ปรับปรุงร้านให้ตรงตามมาตรฐานและอัพเดทตามที่แบรนด์กำหนด",
"ติดตามยอดขายและเทียบกับเป้าหมายที่แบรนด์กำหนด"
]
},

weatherStrategies: {
sunny: [
"จัดพื้นที่นั่งร่มรื่น หรือติดตั้งร่มบังแดดให้ลูกค้า",
"เสิร์ฟน้ำดื่มเย็นฟรี หรือเพิ่มเมนูเครื่องดื่มเย็น",
"ปิ้งหมูแบบสดใหม่ตลอด เพราะอากาศร้อนทำให้อาหารเสียง่าย",
"เพิ่มเวลาขายช่วงเย็น เพราะคนจะออกมาซื้อของมากขึ้น"
],
cloudy: [
"อากาศเย็นสบาย เหมาะแก่การขาย เตรียมของให้เพียงพอ",
"เน้นกลิ่นหอมของหมูปิ้งเพื่อดึงดูดลูกค้า",
"เตรียมพร้อมสำหรับฝนที่อาจตกได้",
"เพิ่มพื้นที่นั่งเพราะลูกค้าจะนั่งทานนานขึ้น"
],
rainy: [
"ติดตั้งกันฝนหรือเต็นท์เล็กๆ ให้ลูกค้า",
"มีบริการแพ็คกลับบ้าน พร้อมถุงกันน้ำ",
"ลดราคาหรือทำโปรโมชั่นพิเศษช่วงฝนตก",
"เน้นการขายแบบเดลิเวอรี่หรือสั่งล่วงหน้า"
]
},

economyStrategies: {
excellent: [
"เพิ่มเมนูพรีเมียมหรือเซ็ตหรูหรา",
"ขยายพื้นที่ขายหรือเพิ่มจุดขาย",
"ลงทุนในอุปกรณ์ที่ดีขึ้น",
"เพิ่มบริการเสริม เช่น เดลิเวอรี่ จองล่วงหน้า"
],
good: [
"รักษาคุณภาพและบริการให้ดีต่อเนื่อง",
"ขยายฐานลูกค้าด้วยการแนะนำเพื่อน",
"เพิ่มช่วงเวลาขายหรือวันขาย",
"พัฒนาเมนูใหม่ๆ เป็นระยะ"
],
normal: [
"เน้นความคุ้มค่าและรักษาคุณภาพ",
"สร้างความสัมพันธ์กับลูกค้าประจำ",
"ทำโปรโมชั่นเล็กๆ น้อยๆ สม่ำเสมอ",
"ควบคุมต้นทุนให้เหมาะสม"
],
bad: [
"ลดขนาดสินค้าแต่รักษาราคา หรือลดราคาเล็กน้อย",
"เน้นคำว่า 'คุ้ม' 'ประหยัด' ในการตลาด",
"ทำเซ็ตคอมโบที่ประหยัดกว่า",
"หาวิธีลดต้นทุนโดยไม่กระทบคุณภาพ"
]
},

marketingTips: [
"ใช้ Social Media โพสต์รูปหมูปิ้งสวยๆ พร้อมเวลาและสถานที่ขาย",
"สร้างกลุ่มลูกค้าใน LINE หรือ Facebook เพื่อแจ้งข่าวสาร",
"ทำบัตรสะสมแต้ม 'ซื้อครบ 10 ครั้ง รับฟรี 5 ไม้'",
"จัดโปรโมชั่นวันเกิดลูกค้า หรือวันสำคัญ",
"ให้ลูกค้าเก่าแนะนำลูกค้าใหม่ได้ส่วนลด",
"ร่วมกิจกรรมชุมชนหรือเทศกาลท้องถิ่น",
"ใช้ป้ายหรือแบนเนอร์ที่สะดุดตาและอ่านง่าย"
],

chatResponses: [
"จากประสบการณ์ ช่วงเย็นหลังเลิกงาน 17.00-19.00 น. และช่วงกลางคืน 20.00-22.00 น. มักจะขายดีที่สุด โดยเฉพาะบริเวณที่มีคนเดินผ่านไปมา",
"การเลือกเนื้อหมูควรเป็นส่วนที่มีไขมันพอสมควร เช่น คอหมู สันคอ จะทำให้หมูปิ้งนุ่มและหวาน ไม่แข็งเหนียว",
"สูตรหมักพื้นฐาน: ซีอิ๊วขาว น้ำตาล กระเทียม พริกไทย หอมแดง และส่วนลับของแต่ละร้าน เช่น ใบมะกรูด หรือซีอิ๊วดำเล็กน้อย",
"คุณสามารถเพิ่มกำไรได้โดยขายเครื่องเคียง เช่น ข้าวเหนียว น้ำจิ้ม หรือเครื่องดื่ม ซึ่งมักมีอัตรากำไรสูงกว่าหมูปิ้ง",
"การรักษาความสะอาดสำคัญมาก ควรสวมถุงมือ หน้ากาก และล้างมือบ่อยๆ จะสร้างความเชื่อมั่นให้ลูกค้า",
"การเลือกตำแหน่งขายต้องพิจารณา: การจราจร จำนวนคนเดิน ที่จอดรถ กฎหมาย และค่าเช่าพื้นที่",
"ถ้าขายประจำที่เดิม การสร้างความสัมพันธ์กับลูกค้าประจำ จำชื่อและความชอบ จะทำให้เขากลับมาซื้อซ้ำ",
"สำหรับมือใหม่ แนะนำให้เริ่มจากการซื้อมาขายก่อน เพื่อเรียนรู้ตลาดและสร้างฐานลูกค้า แล้วค่อยไปเป็นการผลิตเอง"
]
},

getRandomElement: function(array) {
return array[Math.floor(Math.random() * array.length)];
},

// ฟังก์ชันวิเคราะห์ธุรกิจแบบครบถ้วน
getBusinessAnalysis: async function(businessType, formData, marketData) {
return new Promise(async (resolve) => {
try {
// ดึงราคาหมูจริง
const realPorkPrice = await fetchRealPorkPrice();
if (businessType === 'producer' && formData.meatPrice) {
formData.meatPrice = realPorkPrice;
}

// คำนวณต้นทุน
const costs = BusinessEngine.calculateCosts(businessType, formData, marketData);

// วิเคราะห์ราคา
const pricing = BusinessEngine.analyzePricing(costs, marketData, businessType);

// วิเคราะห์ตำแหน่งในตลาด
const marketPosition = BusinessEngine.analyzeMarketPosition(pricing, businessType);

// สร้างรายงาน
const report = BusinessEngine.generateBusinessReport(
businessType, 
costs, 
pricing, 
marketPosition, 
parseInt(marketData.dailyVolume) || 200
);

// สร้างข้อความวิเคราะห์
let analysisText = this.getRandomElement(this.mockResponses.priceRecommendation);
analysisText = analysisText
.replace('{businessType}', BusinessEngine.businessModels[businessType].name)
.replace('{price}', pricing.recommended.price)
.replace('{margin}', pricing.recommended.margin)
.replace('{cost}', costs.total.toFixed(2))
.replace('{profit}', pricing.recommended.profit.toFixed(2))
.replace('{weather}', this.getWeatherText(marketData.weather))
.replace('{location}', this.getLocationText(marketData.location))
.replace('{economy}', this.getEconomyText(marketData.economy));

// รวบรวมเทคนิคและคำแนะนำ
const tips = [];

// เทคนิคเฉพาะรูปแบบธุรกิจ
const businessTips = this.businessTips[businessType] || [];
tips.push(...businessTips.slice(0, 3));

// เทคนิคตามสภาพอากาศ
const weatherTips = this.weatherStrategies[marketData.weather] || [];
if (weatherTips.length > 0) {
tips.push(...weatherTips.slice(0, 2));
}

// เทคนิคตามสถานการณ์เศรษฐกิจ
const economyTips = this.economyStrategies[marketData.economy] || [];
if (economyTips.length > 0) {
tips.push(...economyTips.slice(0, 2));
}

// เทคนิคการตลาด
tips.push(...this.marketingTips.slice(0, 2));

setTimeout(() => {
resolve({
businessType: businessType,
costs: costs,
pricing: pricing,
marketPosition: marketPosition,
report: report,
analysisText: analysisText,
tips: tips,
recommendations: marketPosition.recommendations
});
}, 1200);

} catch(error) {
console.error('เกิดข้อผิดพลาดในการวิเคราะห์ธุรกิจ:', error);
setTimeout(() => {
resolve({
businessType: businessType,
analysisText: "เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ แต่เราให้ข้อมูลพื้นฐานสำหรับธุรกิจของคุณ",
tips: this.businessTips[businessType] || this.businessTips.producer,
error: true
});
}, 1000);
}
});
},

getChatResponse: async function(message) {
return new Promise(resolve => {
setTimeout(() => {
let response = this.getRandomElement(this.chatResponses);

// ปรับ response ตามคำถาม
if (message.toLowerCase().includes('ราคา')) {
response = "การตั้งราคาควรพิจารณาต้นทุน กำไรที่ต้องการ และราคาในตลาด แนะนำให้ใช้เครื่องมือ 'วิเคราะห์ธุรกิจ' ในแอปนี้เพื่อคำนวณราคาที่เหมาะสม";
} else if (message.toLowerCase().includes('ต้นทุน')) {
response = "ต้นทุนหลักของหมูปิ้งคือ เนื้อหมู (60-70%) เครื่องปรุง (10-15%) ไม้จิ้ม ค่าแก๊ส และค่าแรงงาน ควรคำนวณให้ละเอียดเพื่อตั้งราคาที่ถูกต้อง";
} else if (message.toLowerCase().includes('การตลาด')) {
response = "การตลาดหมูปิ้งควรเน้น: กลิ่นหอม รูปลักษณ์ที่น่าเชื่อถือ การบริการที่เป็นมิตร และการใช้ Social Media โชว์ผลงาน";
}

resolve(response);
}, 800 + Math.random() * 800);
});
},

getWeatherText: function(weather) {
const texts = {
sunny: 'แดดออก',
cloudy: 'มีเมฆ',
rainy: 'ฝนตก'
};
return texts[weather] || 'ปกติ';
},

getLocationText: function(location) {
const texts = {
market: 'ในตลาด',
street: 'ริมถนน',
community: 'ในชุมชน',
school: 'ใกล้สถานศึกษา',
office: 'ย่านออฟฟิศ',
mall: 'ในห้างสรรพสินค้า'
};
return texts[location] || 'ในพื้นที่';
},

getEconomyText: function(economy) {
const texts = {
excellent: 'ดีเยี่ยม',
good: 'ดี',
normal: 'ปกติ',
bad: 'แย่'
};
return texts[economy] || 'ปกติ';
}
};

// =====================
// ฟังก์ชันแสดงวันที่ปัจจุบันในรูปแบบไทย
// =====================

function setThaiDate() {
const now = new Date();
const thaiDay = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];
const thaiMonth = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];

const day = thaiDay[now.getDay()];
const date = now.getDate();
const month = thaiMonth[now.getMonth()];
const year = now.getFullYear() + 543; // แปลงเป็นปี พ.ศ.

document.getElementById('current-date').textContent = `วัน${day}ที่ ${date} ${month} ${year}`;
}

// =====================
// ฟังก์ชันดึงราคาหมูจริงจากแหล่งข้อมูล
// =====================

async function fetchRealPorkPrice() {
try {
// สำหรับ Demo - ในความเป็นจริงควรเชื่อมต่อกับ API จริง
const currentPrice = 185 + Math.floor(Math.random() * 20); // 185-205 บาท
const now = new Date();
const formattedDate = now.toLocaleString('th-TH', {
year: 'numeric',
month: 'long',
day: 'numeric',
hour: '2-digit',
minute: '2-digit'
});

document.getElementById('price-update-time').textContent = `อัปเดตเมื่อ: ${formattedDate}`;
document.getElementById('market-price').textContent = `${currentPrice} บาท`;

return currentPrice;
} catch (error) {
console.error('ไม่สามารถดึงข้อมูลราคาหมูได้:', error);
const fallbackPrice = 190;
document.getElementById('market-price').textContent = `${fallbackPrice} บาท (offline)`;
return fallbackPrice;
}
}

// =====================
// ระบบแท็บ (ปรับปรุง)
// =====================

function setupTabs() {
document.querySelectorAll('.tab').forEach(tab => {
tab.addEventListener('click', function() {
// ลบคลาส active จากทุกแท็บ
document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

// เพิ่มคลาส active ให้แท็บที่คลิก
this.classList.add('active');

// แสดงเนื้อหาที่ตรงกับแท็บ
const tabId = this.getAttribute('data-tab');
const tabContent = document.getElementById(`${tabId}-tab`);

if (tabContent) {
tabContent.classList.add('active');

// เพิ่มเอฟเฟกต์ animation
tabContent.style.animation = 'none';
setTimeout(() => {
tabContent.style.animation = 'fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
}, 10);

// อัปเดตข้อมูลเมื่อสวิตช์แท็บ
if (tabId === 'sales') {
updateSalesDisplay();
} else if (tabId === 'dashboard') {
updateDashboardSummary();
} else if (tabId === 'business-tools') {
// รีเซ็ตฟอร์มเมื่อกลับมาที่แท็บ
resetBusinessTools();
}
}
});
});
}

// =====================
// ระบบเครื่องมือธุรกิจ (ใหม่)
// =====================

function setupBusinessTools() {
// การเลือกรูปแบบธุรกิจ
document.querySelectorAll('.business-type-card').forEach(card => {
card.addEventListener('click', function() {
// ลบการเลือกเก่า
document.querySelectorAll('.business-type-card').forEach(c => c.classList.remove('selected'));

// เลือกใหม่
this.classList.add('selected');

const businessType = this.getAttribute('data-type');

// แสดงฟอร์มที่เหมาะสม
showBusinessForm(businessType);
});
});

// ปุ่มคำนวณ
const calculateBtn = document.getElementById('calculate-business-btn');
if (calculateBtn) {
calculateBtn.addEventListener('click', async function() {
await calculateBusinessAnalysis();
});
}
}

function showBusinessForm(businessType) {
// ซ่อนฟอร์มทั้งหมด
document.querySelectorAll('.business-form').forEach(form => {
form.style.display = 'none';
});

// แสดงฟอร์มที่เลือก
const selectedForm = document.getElementById(`${businessType}-form`);
if (selectedForm) {
selectedForm.style.display = 'block';
}

// แสดงส่วนคำนวณ
const calculationSection = document.getElementById('cost-calculation-section');
if (calculationSection) {
calculationSection.style.display = 'block';
calculationSection.scrollIntoView({ behavior: 'smooth' });
}

// อัปเดต placeholder และค่าเริ่มต้นตามประเภทธุรกิจ
updateFormDefaults(businessType);
}

function updateFormDefaults(businessType) {
const defaults = {
producer: {
'producer-meat-price': 190,
'producer-meat-weight': 25,
'producer-seasoning-cost': 0.5,
'producer-stick-cost': 0.3,
'producer-gas-cost': 0.2,
'producer-labor-cost': 1.0
},
reseller: {
'reseller-buy-price': 8,
'reseller-transport-cost': 0.5,
'reseller-storage-cost': 0.2,
'reseller-gas-cost': 0.3
},
franchise: {
'franchise-product-cost': 9,
'franchise-royalty': 0.5,
'franchise-marketing': 0.3,
'franchise-support': 0.2
}
};

const businessDefaults = defaults[businessType];
if (businessDefaults) {
Object.entries(businessDefaults).forEach(([id, value]) => {
const element = document.getElementById(id);
if (element) {
element.value = value;
}
});
}
}

async function calculateBusinessAnalysis() {
const selectedCard = document.querySelector('.business-type-card.selected');
if (!selectedCard) {
alert('กรุณาเลือกรูปแบบธุรกิจก่อน');
return;
}

const businessType = selectedCard.getAttribute('data-type');
const calculateBtn = document.getElementById('calculate-business-btn');
const originalText = calculateBtn.textContent;

calculateBtn.textContent = "🧮 กำลังวิเคราะห์...";
calculateBtn.style.background = "linear-gradient(145deg, #FFA726, #FF9800)";
calculateBtn.disabled = true;

// รวบรวมข้อมูลจากฟอร์ม
const formData = collectFormData(businessType);
const marketData = collectMarketData();

try {
// เรียกใช้ AI Engine
const analysis = await AIEngine.getBusinessAnalysis(businessType, formData, marketData);

// แสดงผลลัพธ์
displayBusinessAnalysis(analysis);

// บันทึกข้อมูลการคำนวณ
await UserDataManager.updateBusinessData(businessType, analysis);

// อัปเดตแดชบอร์ด
updateDashboardWithBusinessData(analysis);

} catch (error) {
console.error('เกิดข้อผิดพลาดในการวิเคราะห์:', error);
alert('เกิดข้อผิดพลาดในการวิเคราะห์ โปรดลองใหม่อีกครั้ง');
} finally {
calculateBtn.textContent = originalText;
calculateBtn.style.background = "";
calculateBtn.disabled = false;
}
}

function collectFormData(businessType) {
const data = {};

const form = document.getElementById(`${businessType}-form`);
if (!form) return data;

const inputs = form.querySelectorAll('input[type="number"]');
inputs.forEach(input => {
const key = input.id.replace(`${businessType}-`, '');
data[key] = parseFloat(input.value) || 0;
});

return data;
}

function collectMarketData() {
return {
location: document.getElementById('location').value,
dailyVolume: document.getElementById('daily-volume').value,
weather: document.querySelector('.option-group:nth-of-type(1) .option-button.selected')?.getAttribute('data-value') || 'sunny',
economy: document.querySelector('.option-group:nth-of-type(2) .option-button.selected')?.getAttribute('data-value') || 'normal'
};
}

function displayBusinessAnalysis(analysis) {
// แสดงการวิเคราะห์ต้นทุน
const costBreakdown = document.getElementById('cost-breakdown');
if (costBreakdown && analysis.costs) {
costBreakdown.innerHTML = '';
analysis.costs.breakdown.forEach(item => {
const li = document.createElement('li');

li.className = 'cost-item';
li.innerHTML = `
<span>${item.item}</span>
<span>${item.cost.toFixed(2)} บาท</span>
`;
costBreakdown.appendChild(li);
});

// เพิ่มรวมท้ายสุด
const totalLi = document.createElement('li');
totalLi.className = 'cost-item';
totalLi.innerHTML = `
<span><strong>รวมต้นทุนต่อไม้</strong></span>
<span><strong>${analysis.costs.total.toFixed(2)} บาท</strong></span>
`;
costBreakdown.appendChild(totalLi);
}

// แสดงการวิเคราะห์จุดคุ้มทุน
const breakevenAnalysis = document.getElementById('breakeven-analysis');
if (breakevenAnalysis && analysis.pricing) {
breakevenAnalysis.innerHTML = `
<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-radius: 10px;">
<div style="font-size: 1.8rem; font-weight: bold; color: #1976D2; margin-bottom: 8px;">
${analysis.pricing.breakeven} บาท/ไม้
</div>
<div style="font-size: 0.9rem; color: #424242;">
ราคาขั้นต่ำที่ควรขาย (กำไร 5%)
</div>
<div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
ขายต่ำกว่านี้ = ขาดทุน
</div>
</div>
`;
}

// แสดงตำแหน่งในตลาด
const marketPosition = document.getElementById('market-position');
if (marketPosition && analysis.marketPosition) {
marketPosition.innerHTML = `
<div style="padding: 15px;">
<div style="margin-bottom: 10px;">
<strong>🎯 ตำแหน่ง:</strong> ราคา${analysis.marketPosition.position}
</div>
<div style="margin-bottom: 10px;">
<strong>⚔️ การแข่งขัน:</strong> ${analysis.marketPosition.competitive}
</div>
<div style="margin-bottom: 15px;">
<strong>💪 จุดแข็ง:</strong>
<ul style="margin-left: 20px; margin-top: 5px;">
${analysis.marketPosition.advantages.map(adv => `<li>${adv}</li>`).join('')}
</ul>
</div>
<div>
<strong>⚠️ ความท้าทาย:</strong>
<ul style="margin-left: 20px; margin-top: 5px;">
${analysis.marketPosition.challenges.map(ch => `<li>${ch}</li>`).join('')}
</ul>
</div>
</div>
`;
}

// แสดงสถานการณ์ราคา
if (analysis.pricing) {
const conservativePrice = document.getElementById('conservative-price');
const conservativeProfit = document.getElementById('conservative-profit');
const recommendedPrice = document.getElementById('recommended-price');
const recommendedProfit = document.getElementById('recommended-profit');
const aggressivePrice = document.getElementById('aggressive-price');
const aggressiveProfit = document.getElementById('aggressive-profit');

if (conservativePrice) conservativePrice.textContent = `${analysis.pricing.conservative.price} บาท`;
if (conservativeProfit) conservativeProfit.textContent = `กำไร: ${analysis.pricing.conservative.dailyProfit} บาท/วัน`;
if (recommendedPrice) recommendedPrice.textContent = `${analysis.pricing.recommended.price} บาท`;
if (recommendedProfit) recommendedProfit.textContent = `กำไร: ${analysis.pricing.recommended.dailyProfit} บาท/วัน`;
if (aggressivePrice) aggressivePrice.textContent = `${analysis.pricing.aggressive.price} บาท`;
if (aggressiveProfit) aggressiveProfit.textContent = `กำไร: ${analysis.pricing.aggressive.dailyProfit} บาท/วัน`;
}

// แสดงกลยุทธ์
const strategyContent = document.getElementById('strategy-content');
if (strategyContent && analysis.tips) {
strategyContent.innerHTML = `
<div style="margin-bottom: 20px;">
<p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 15px;">
${analysis.analysisText}
</p>
</div>
<div>
<h5 style="color: var(--primary-color); margin-bottom: 15px;">📋 คำแนะนำเฉพาะสำหรับคุณ:</h5>
<ul style="list-style: none; padding: 0;">
${analysis.tips.map(tip => `
<li style="padding: 8px 0; border-bottom: 1px solid #eee; position: relative; padding-left: 25px;">
<span style="position: absolute; left: 0; color: var(--primary-color);">🎯</span>
${tip}
</li>
`).join('')}
</ul>
</div>
${analysis.recommendations ? `
<div style="margin-top: 20px;">
<h5 style="color: var(--business-color); margin-bottom: 15px;">💡 กลยุทธ์เชิงธุรกิจ:</h5>
<ul style="list-style: none; padding: 0;">
${analysis.recommendations.map(rec => `
<li style="padding: 8px 0; border-bottom: 1px solid #eee; position: relative; padding-left: 25px;">
<span style="position: absolute; left: 0; color: var(--business-color);">💼</span>
${rec}
</li>
`).join('')}
</ul>
</div>
` : ''}
`;
}

// แสดงส่วนผลลัพธ์
const resultSection = document.getElementById('business-analysis-result');
if (resultSection) {
resultSection.style.display = 'block';
resultSection.scrollIntoView({ behavior: 'smooth', block: 'center' });

// เพิ่มเอฟเฟกต์
resultSection.classList.add('fade-scale');
setTimeout(() => {
resultSection.classList.remove('fade-scale');
}, 600);
}
}

function updateDashboardWithBusinessData(analysis) {
if (analysis && analysis.pricing) {
document.getElementById('today-price').textContent = `${analysis.pricing.recommended.price} บาท`;
document.getElementById('estimated-profit').textContent = `${analysis.pricing.recommended.dailyProfit} บาท`;
}
}

function resetBusinessTools() {
// รีเซ็ตการเลือกรูปแบบธุรกิจ
document.querySelectorAll('.business-type-card').forEach(card => {
card.classList.remove('selected');
});

// ซ่อนฟอร์มและผลลัพธ์
document.getElementById('cost-calculation-section').style.display = 'none';
document.getElementById('business-analysis-result').style.display = 'none';

// ซ่อนฟอร์มทั้งหมด
document.querySelectorAll('.business-form').forEach(form => {
form.style.display = 'none';
});
}

// =====================
// ระบบเลือกออปชั่น (ปรับปรุง)
// =====================

function setupOptionButtons() {
document.querySelectorAll('.option-button').forEach(button => {
button.addEventListener('click', function() {
// เพิ่มเอฟเฟกต์คลิก
this.classList.add('pulse');
setTimeout(() => {
this.classList.remove('pulse');
}, 500);

// หา option-group ที่เป็นพาเรนต์
const parent = this.closest('.option-group');

// ลบคลาส selected จากทุกปุ่มในกลุ่มเดียวกัน
parent.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));

// เพิ่มคลาส selected ให้ปุ่มที่คลิก
this.classList.add('selected');
});
});
}

// =====================
// ระบบบันทึกยอดขาย (ปรับปรุง)
// =====================

function setupSalesTracking() {
const saveSalesBtn = document.getElementById('save-sales-btn');

// ตั้งวันที่เป็นวันนี้
const today = new Date().toISOString().split('T')[0];
document.getElementById('sale-date').value = today;

if (saveSalesBtn) {
saveSalesBtn.addEventListener('click', async function() {
const salesData = {
date: document.getElementById('sale-date').value,
prepared: parseInt(document.getElementById('prepared-amount').value) || 0,
sold: parseInt(document.getElementById('sold-amount').value) || 0,
averagePrice: parseFloat(document.getElementById('average-price').value) || 0,
weather: document.getElementById('weather-condition').value,
notes: document.getElementById('sale-notes').value
};

// ตรวจสอบข้อมูล
if (salesData.prepared === 0 || salesData.sold === 0 || salesData.averagePrice === 0) {
alert('กรุณากรอกข้อมูลให้ครบถ้วน (จำนวนที่เตรียม, ขายได้, และราคาเฉลี่ย)');
return;
}

if (salesData.sold > salesData.prepared) {
alert('จำนวนที่ขายได้ไม่ควรมากกว่าจำนวนที่เตรียมไป');
return;
}

if (salesData.averagePrice < 5 || salesData.averagePrice > 50) {
alert('ราคาเฉลี่ยดูผิดปกติ กรุณาตรวจสอบอีกครั้ง');
return;
}

// แสดงสถานะกำลังบันทึก
const originalText = this.textContent;
this.textContent = "💾 กำลังบันทึก...";
this.disabled = true;

const success = await SalesManager.saveDailySales(salesData);

if (success) {
this.textContent = "✅ บันทึกเรียบร้อย";
this.style.background = "linear-gradient(145deg, #4CAF50, #388E3C)";

// ล้างฟอร์ม
document.getElementById('prepared-amount').value = '';
document.getElementById('sold-amount').value = '';
document.getElementById('average-price').value = '';
document.getElementById('sale-notes').value = '';

// อัปเดตแสดงผล
await updateSalesDisplay();
await updateDashboardSummary();

// รีเซ็ตปุ่มหลังจาก 3 วินาที
setTimeout(() => {
this.textContent = originalText;
this.style.background = "";
this.disabled = false;
}, 3000);

} else {
alert('เกิดข้อผิดพลาดในการบันทึก กรุณาลองใหม่อีกครั้ง');
this.textContent = originalText;
this.disabled = false;
}
});
}
}

// อัปเดตการแสดงผลข้อมูลยอดขาย (ปรับปรุง)
async function updateSalesDisplay() {
const salesHistory = await SalesManager.getLast7DaysSales();
const historyContainer = document.getElementById('sales-history');

if (!historyContainer) return;

if (salesHistory.length === 0) {
historyContainer.innerHTML = `
<div style="text-align: center; padding: 40px; color: #666;">
<div style="font-size: 3rem; margin-bottom: 15px;">📊</div>
<p>ยังไม่มีข้อมูลการขาย</p>
<p style="font-size: 0.9rem;">กรุณาบันทึกยอดขายเพื่อดูสถิติและการพยากรณ์</p>
</div>
`;
} else {
let html = '<div style="overflow-x: auto;">';
html += '<table class="sales-table">';
html += `
<thead>
<tr>
<th>วันที่</th>
<th>เตรียม</th>
<th>ขาย</th>
<th>เหลือ</th>
<th>% ขาย</th>
<th>ราคาเฉลี่ย</th>
<th>รายได้</th>
<th>อากาศ</th>
</tr>
</thead>
`;
html += '<tbody>';

salesHistory.forEach(sale => {
const weatherIcon = sale.weather === 'sunny' ? '☀️' : 
                  sale.weather === 'cloudy' ? '☁️' : '🌧️';
const sellThroughRate = sale.sellThroughRate || Math.round((sale.sold / sale.prepared) * 100);
const revenue = sale.revenue || (sale.sold * (sale.averagePrice || 12));

html += `
<tr>
<td>${formatThaiDate(sale.date)}</td>
<td>${sale.prepared}</td>
<td>${sale.sold}</td>
<td>${sale.leftover}</td>
<td style="color: ${sellThroughRate >= 80 ? '#4CAF50' : sellThroughRate >= 60 ? '#FF9800' : '#F44336'}">${sellThroughRate}%</td>
<td>${(sale.averagePrice || 12).toFixed(1)} บาท</td>
<td style="font-weight: bold; color: #2E7D32;">${revenue.toFixed(0)} บาท</td>
<td>${weatherIcon}</td>
</tr>
`;
});

html += '</tbody></table></div>';
historyContainer.innerHTML = html;
}

// อัปเดตการพยากรณ์
const prediction = SalesManager.calculatePrediction(salesHistory);
updatePredictionDisplay(prediction);
}

function updatePredictionDisplay(prediction) {
const predictionAmountEl = document.getElementById('predicted-amount');
const predictionReasonEl = document.getElementById('prediction-reason');

if (predictionAmountEl && predictionReasonEl) {
predictionAmountEl.textContent = prediction.amount > 0 ? `${prediction.amount} ไม้` : '-- ไม้';
predictionReasonEl.innerHTML = `
<div style="margin-bottom: 10px;">${prediction.reason}</div>
${prediction.recommendations ? `
<div style="font-size: 0.9rem; opacity: 0.9;">
<strong>💡 คำแนะนำ:</strong> ${prediction.recommendations.join(' • ')}
</div>
` : ''}
`;

// เปลี่ยนสีตามความเชื่อมั่น
const predictionContainer = predictionAmountEl.closest('.prediction-highlight');
if (predictionContainer) {
if (prediction.confidence === 'สูง') {
predictionContainer.style.background = 'linear-gradient(135deg, #4CAF50, #388E3C)';
} else if (prediction.confidence === 'ต่ำ') {
predictionContainer.style.background = 'linear-gradient(135deg, #FF9800, #F57C00)';
} else {
predictionContainer.style.background = 'linear-gradient(135deg, #2196F3, #1976D2)';
}
}
}
}

// อัปเดตสรุปในแดชบอร์ด (ปรับปรุง)
async function updateDashboardSummary() {
const salesHistory = await SalesManager.getLast7DaysSales();
const summaryContainer = document.getElementById('dashboard-sales-summary');

if (!summaryContainer) return;

if (salesHistory.length === 0) {
summaryContainer.innerHTML = `
<div style="text-align: center; padding: 30px;">
<div style="font-size: 2.5rem; margin-bottom: 15px;">📈</div>
<p style="margin-bottom: 10px;">ยังไม่มีข้อมูลการขาย</p>
<p style="font-size: 0.9rem; color: #666;">เริ่มบันทึกยอดขายเพื่อดูสถิติที่น่าสนใจ</p>
</div>
`;
} else {
const summary = SalesManager.generateDashboardSummary(salesHistory);

let html = '<div class="dashboard-stats" style="grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">';

html += `
<div class="stat-card">
<div class="stat-label">เฉลี่ยขาย/วัน</div>
<div class="stat-value">${summary.avgSold}</div>
<div class="stat-label">ไม้</div>
</div>
<div class="stat-card">
<div class="stat-label">เฉลี่ยรายได้/วัน</div>
<div class="stat-value">${summary.avgRevenue}</div>
<div class="stat-label">บาท</div>
</div>
<div class="stat-card">
<div class="stat-label">% ขายได้</div>
<div class="stat-value" style="color: ${summary.avgSellThrough >= 80 ? '#4CAF50' : summary.avgSellThrough >= 60 ? '#FF9800' : '#F44336'}">${summary.avgSellThrough}%</div>
<div class="stat-label">เฉลี่ย</div>
</div>
<div class="stat-card">
<div class="stat-label">แนวโน้ม</div>
<div class="stat-value" style="color: ${summary.growthTrend > 0 ? '#4CAF50' : summary.growthTrend < 0 ? '#F44336' : '#FF9800'}">
${summary.growthTrend > 0 ? '+' : ''}${summary.growthTrend}%
</div>
<div class="stat-label">การเติบโต</div>
</div>
`;

html += '</div>';

if (summary.bestDay && summary.worstDay) {
html += `
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<div class="success-box" style="text-align: center; padding: 20px;">
<div style="font-size: 0.9rem; margin-bottom: 8px;">🏆 วันที่ขายดีที่สุด</div>
<div style="font-size: 1.8rem; font-weight: bold; color: #2E7D32; margin: 8px 0;">${summary.bestDay.sold} ไม้</div>
<div style="font-size: 0.8rem; color: #666;">${formatThaiDate(summary.bestDay.date)}</div>
<div style="font-size: 0.8rem; color: #2E7D32; margin-top: 5px;">
${(summary.bestDay.revenue || (summary.bestDay.sold * 12)).toFixed(0)} บาท
</div>
</div>
<div class="warning-box" style="text-align: center; padding: 20px;">
<div style="font-size: 0.9rem; margin-bottom: 8px;">📉 วันที่ขายน้อยที่สุด</div>
<div style="font-size: 1.8rem; font-weight: bold; color: #F57C00; margin: 8px 0;">${summary.worstDay.sold} ไม้</div>
<div style="font-size: 0.8rem; color: #666;">${formatThaiDate(summary.worstDay.date)}</div>
<div style="font-size: 0.8rem; color: #F57C00; margin-top: 5px;">
${(summary.worstDay.revenue || (summary.worstDay.sold * 12)).toFixed(0)} บาท
</div>
</div>
</div>
`;
}

summaryContainer.innerHTML = html;
}
}

// ฟังก์ชันแปลงวันที่เป็นภาษาไทย
function formatThaiDate(dateString) {
const date = new Date(dateString);
const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                  'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
return `${date.getDate()} ${thaiMonths[date.getMonth()]}`;
}

// =====================
// ระบบแชทกับ AI (ปรับปรุง)
// =====================

async function setupChatSystem() {
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSendBtn = document.getElementById('chat-send-btn');

if (!chatMessages || !chatInput || !chatSendBtn) {
console.error('Chat elements not found');
return;
}

async function sendMessage() {
const message = chatInput.value.trim();
if (!message) return;

// เพิ่มข้อความของผู้ใช้
addMessage(message, 'user');
chatInput.value = '';

// แสดงว่ากำลังพิมพ์
const typingMessage = addTypingIndicator();

try {
const response = await AIEngine.getChatResponse(message);

// ลบ typing indicator
chatMessages.removeChild(typingMessage);

// เพิ่มข้อความตอบกลับ
addMessage(response, 'ai');

} catch (error) {
console.error('Error getting AI response:', error);
chatMessages.removeChild(typingMessage);
addMessage('ขออภัย เกิดข้อผิดพลาดในการรับคำตอบ โปรดลองใหม่อีกครั้ง 🙏', 'ai');
}
}

function addMessage(text, type) {
const messageElement = document.createElement('div');
messageElement.className = `message ${type}`;
messageElement.innerHTML = `
${text}
<div class="message-time">เมื่อสักครู่</div>
`;
chatMessages.appendChild(messageElement);
chatMessages.scrollTop = chatMessages.scrollHeight;
return messageElement;
}

function addTypingIndicator() {
const typingElement = document.createElement('div');
typingElement.className = 'message ai';
typingElement.innerHTML = `
<div class="typing-indicator">
<span></span>
<span></span>
<span></span>
</div>
`;
chatMessages.appendChild(typingElement);
chatMessages.scrollTop = chatMessages.scrollHeight;
return typingElement;
}

chatSendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', function(event) {
if (event.key === 'Enter' && !event.shiftKey) {
event.preventDefault();
sendMessage();
}
});
}

// =====================
// ระบบการตั้งค่า (ปรับปรุง)
// =====================

function setupSettings() {
const saveApiKeyBtn = document.getElementById('save-api-key');
const saveBusinessInfoBtn = document.getElementById('save-business-info');
const saveAlertSettingsBtn = document.getElementById('save-alert-settings');

function showSaveSuccess(button, message = "บันทึกเรียบร้อย ✅") {
const originalText = button.textContent;
const originalColor = button.style.background;

button.textContent = message;
button.style.background = "linear-gradient(145deg, #4CAF50, #388E3C)";

setTimeout(() => {
button.textContent = originalText;
button.style.background = originalColor;
}, 2500);
}

if (saveApiKeyBtn) {
saveApiKeyBtn.addEventListener('click', async function() {
const provider = document.getElementById('api-provider').value;
const apiKey = document.getElementById('api-key').value;

if (!apiKey.trim()) {
alert('กรุณาใส่ API Key');
return;
}

const success = await UserDataManager.updateApiSettings(provider, apiKey);
if (success) {
showSaveSuccess(this, "API Key บันทึกแล้ว ✅");
}
});
}

if (saveBusinessInfoBtn) {
saveBusinessInfoBtn.addEventListener('click', async function() {
const name = document.getElementById('business-name').value;
const location = document.getElementById('business-location').value;
const businessType = document.getElementById('business-type-setting').value;
const description = document.getElementById('business-description').value;

const success = await UserDataManager.updateBusinessInfo(name, location, description, businessType);
if (success) {
showSaveSuccess(this, "ข้อมูลร้านบันทึกแล้ว ✅");
}
});
}

if (saveAlertSettingsBtn) {
saveAlertSettingsBtn.addEventListener('click', async function() {
const weatherAlert = document.getElementById('weather-alert').checked;
const priceAlert = document.getElementById('price-alert').checked;
const eventAlert = document.getElementById('event-alert').checked;
const salesReminder = document.getElementById('sales-reminder').checked;

const success = await UserDataManager.updateAlertSettings(weatherAlert, priceAlert, eventAlert, salesReminder);
if (success) {
showSaveSuccess(this, "การตั้งค่าบันทึกแล้ว ✅");
}
});
}
}

// =====================
// ระบบแดชบอร์ด (ปรับปรุง)
// =====================

async function setupDashboard() {
const refreshBtn = document.getElementById('refresh-recommendation');

async function refreshRecommendation() {
console.log("กำลังรีเฟรชคำแนะนำ...");
if (!refreshBtn) return;

const originalText = refreshBtn.textContent;
refreshBtn.textContent = "🔄 กำลังโหลด...";
refreshBtn.disabled = true;

try {
const realPorkPrice = await fetchRealPorkPrice();

// สร้างข้อมูลสำหรับคำแนะนำ
const weatherTypes = ['sunny', 'cloudy', 'rainy'];
const weather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];

const weatherDesc = {
'sunny': 'แดดออก ร้อนจัด',
'cloudy': 'มีเมฆมาก อากาศเย็นสบาย',
'rainy': 'ฝนตกเล็กน้อย'
}[weather];

const locations = ['ตลาดสด', 'หน้าโรงเรียน', 'ใกล้ออฟฟิศ', 'ในชุมชน', 'ริมถนนใหญ่'];
const recommendedLocation = locations[Math.floor(Math.random() * locations.length)];

// คำนวณราคาแนะนำตามราคาหมูจริง
const costPerSkewer = (realPorkPrice / 1000) * 25 + 1.5; // 25g เนื้อ + ต้นทุนอื่น
const recommendedPrice = Math.round(costPerSkewer * 1.8); // กำไร 80%

const reasons = [
'ราคาวัตถุดิบปัจจุบันและความต้องการในตลาด',
'สภาพอากาศวันนี้และพฤติกรรมผู้บริโภค',
'การแข่งขันในพื้นที่และต้นทุนการดำเนินงาน',
'กำลังซื้อของผู้บริโภคในช่วงนี้และเทรนด์ตลาด'
];

const reason = reasons[Math.floor(Math.random() * reasons.length)];

// อัปเดตข้อมูลในแดชบอร์ด
document.getElementById('weather-desc').textContent = weatherDesc;
document.getElementById('location-rec').textContent = recommendedLocation;
document.getElementById('price-rec').textContent = recommendedPrice;
document.getElementById('price-reason').textContent = reason;

// อัปเดตสถิติ
document.getElementById('today-price').textContent = `${recommendedPrice} บาท`;
document.getElementById('weather-status').textContent = weatherDesc.split(' ')[0];
document.getElementById('humidity').textContent = 55 + Math.floor(Math.random() * 30);

const estimatedProfit = Math.round((recommendedPrice - costPerSkewer) * 180); // 180 ไม้ต่อวัน
document.getElementById('estimated-profit').textContent = `${estimatedProfit} บาท`;

// อัปเดตเทคนิค
const dailyTips = [];
const businessType = UserDataManager.userData.businessData.selectedType || 'producer';
const tips = AIEngine.businessTips[businessType] || AIEngine.businessTips.producer;

// เลือกเทคนิค 3 อย่างแบบสุ่ม
while (dailyTips.length < 3) {
const tip = AIEngine.getRandomElement(tips);
if (!dailyTips.includes(tip)) {
dailyTips.push(tip);
}
}

// เพิ่มเทคนิคตามสภาพอากาศ
const weatherTips = AIEngine.weatherStrategies[weather] || [];
if (weatherTips.length > 0) {
dailyTips.push(AIEngine.getRandomElement(weatherTips));
}

const tipsList = document.getElementById('daily-tips');
if (tipsList) {
tipsList.innerHTML = '';
dailyTips.forEach((tip, index) => {
const li = document.createElement('li');
li.textContent = tip;
li.style.animationDelay = `${index * 0.1}s`;

li.classList.add('slide-in');
tipsList.appendChild(li);
});
}

} catch (error) {
console.error('Error refreshing recommendation:', error);
// ข้อมูลสำรอง
document.getElementById('weather-desc').textContent = 'แดดออก';
document.getElementById('location-rec').textContent = 'ตลาด';
document.getElementById('price-rec').textContent = '15';
document.getElementById('price-reason').textContent = 'ราคาวัตถุดิบปัจจุบันและความต้องการในตลาด';
} finally {
refreshBtn.textContent = originalText;
refreshBtn.disabled = false;
}
}

if (refreshBtn) {
refreshBtn.addEventListener('click', refreshRecommendation);
}

// โหลดข้อมูลเริ่มต้น
await refreshRecommendation();
await updateDashboardSummary();
}

// =====================
// ตรวจสอบ DOM elements ที่จำเป็น
// =====================

function checkRequiredElements() {
const requiredElements = [
'current-date',
'calculate-business-btn',
'business-analysis-result',
'cost-breakdown',
'breakeven-analysis',
'market-position',
'conservative-price',
'recommended-price',
'aggressive-price',
'strategy-content'
];

const missingElements = [];
requiredElements.forEach(id => {
if (!document.getElementById(id)) {
missingElements.push(id);
console.error(`ไม่พบ element ที่มี id: ${id}`);
}
});

if (missingElements.length > 0) {
console.error('ไม่พบองค์ประกอบที่จำเป็น:', missingElements);
return false;
}

return true;
}

// =====================
// Error Handler (ปรับปรุง)
// =====================

function setupErrorHandling() {
window.addEventListener('error', function(event) {
console.error('JavaScript Error:', event.error);

// แสดงการแจ้งเตือนแบบเป็นมิตร
showNotification('เกิดข้อผิดพลาดเล็กน้อย แต่แอปยังใช้งานได้ปกติ', 'error');
});

// Handle unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
console.error('Unhandled Promise Rejection:', event.reason);
event.preventDefault();
});
}

// ฟังก์ชันแสดงการแจ้งเตือน
function showNotification(message, type = 'info', duration = 5000) {
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.style.position = 'fixed';
notification.style.top = '20px';
notification.style.right = '20px';
notification.style.zIndex = '9999';
notification.style.maxWidth = '350px';
notification.style.animation = 'slideInRight 0.3s ease';

const icons = {
info: '#2196F3',
warning: '#FFC107', 
error: '#F44336',
success: '#4CAF50'
};

notification.innerHTML = `
<svg viewBox="0 0 24 24" fill="none" stroke="${icons[type]}" stroke-width="2">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" y1="8" x2="12" y2="12"></line>
<line x1="12" y1="16" x2="12" y2="16"></line>
</svg>
<div class="notification-content">
<p>${message}</p>
</div>
`;

document.body.appendChild(notification);

// ลบการแจ้งเตือนหลังจากเวลาที่กำหนด
setTimeout(() => {
if (notification.parentNode) {
notification.style.animation = 'slideOutRight 0.3s ease';
setTimeout(() => {
if (notification.parentNode) {
notification.parentNode.removeChild(notification);
}
}, 300);
}
}, duration);
}

// เพิ่ม CSS สำหรับ animation
const animationStyle = document.createElement('style');
animationStyle.textContent = `
@keyframes slideInRight {
from { transform: translateX(100%); opacity: 0; }
to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
from { transform: translateX(0); opacity: 1; }
to { transform: translateX(100%); opacity: 0; }
}
`;
document.head.appendChild(animationStyle);

// =====================
// Performance Monitoring (ปรับปรุง)
// =====================

function setupPerformanceMonitoring() {
// วัดประสิทธิภาพการโหลดหน้า
window.addEventListener('load', function() {
setTimeout(function() {
const perfData = performance.getEntriesByType('navigation')[0];
if (perfData) {
console.log('📊 Performance Stats:');
console.log('- DOM Content Loaded:', Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart), 'ms');
console.log('- Total Load Time:', Math.round(perfData.loadEventEnd - perfData.loadEventStart), 'ms');
console.log('- Page Load Complete:', Math.round(perfData.loadEventEnd - perfData.fetchStart), 'ms');

// แสดงการแจ้งเตือนถ้าโหลดช้า
if (perfData.loadEventEnd - perfData.fetchStart > 5000) {
showNotification('การโหลดหน้าเว็บค่อนข้างช้า อาจเป็นเพราะการเชื่อมต่ออินเทอร์เน็ต', 'warning', 3000);
}
}
}, 100);
});

// ตรวจสอบการใช้หน่วยความจำ
if (performance.memory) {
const checkMemory = () => {
const memory = performance.memory;
if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.9) {
console.warn('🧠 Memory usage is high:', Math.round(memory.usedJSHeapSize / 1024 / 1024), 'MB');
}
};

setInterval(checkMemory, 30000); // ตรวจสอบทุก 30 วินาที
}
}

// =====================
// Service Worker สำหรับ PWA
// =====================

function setupServiceWorker() {
if ('serviceWorker' in navigator) {
window.addEventListener('load', function() {
// สามารถเพิ่ม Service Worker ในอนาคต
// navigator.serviceWorker.register('/sw.js')
// .then(function(registration) {
//     console.log('ServiceWorker registration successful');
//     showNotification('แอปพร้อมใช้งานแบบออฟไลน์', 'success', 3000);
// })
// .catch(function(err) {
//     console.log('ServiceWorker registration failed: ', err);
// });
});
}
}

// =====================
// Auto-save และ Backup
// =====================

function setupAutoSave() {
let autoSaveTimer;

function triggerAutoSave() {
clearTimeout(autoSaveTimer);
autoSaveTimer = setTimeout(async () => {
if (UserDataManager.isInitialized) {
const saved = await UserDataManager.saveUserData();
if (saved) {
console.log('📝 Auto-save completed');
}
}
}, 2000); // บันทึกอัตโนมัติหลังจาก 2 วินาทีของการไม่มีการเปลี่ยนแปลง
}

// ตั้งให้บันทึกอัตโนมัติเมื่อมีการเปลี่ยนแปลงในฟอร์ม
document.addEventListener('input', function(event) {
if (event.target.matches('input, select, textarea')) {
triggerAutoSave();
}
});

// บันทึกก่อนปิดหน้าเว็บ
window.addEventListener('beforeunload', function() {
if (UserDataManager.isInitialized) {
UserDataManager.saveUserData();
}
});
}

// =====================
// Accessibility เสริม
// =====================

function setupAccessibility() {
// เพิ่ม keyboard navigation
document.addEventListener('keydown', function(event) {
// ESC ปิด modal หรือ reset
if (event.key === 'Escape') {
const activeModal = document.querySelector('.modal.active');
if (activeModal) {
activeModal.classList.remove('active');
}
}

// Enter บนปุ่ม
if (event.key === 'Enter' && event.target.classList.contains('tab')) {
event.target.click();
}
});

// เพิ่ม focus indicators ที่ชัดเจน
const style = document.createElement('style');
style.textContent = `
*:focus {
outline: 2px solid var(--primary-color) !important;
outline-offset: 2px !important;
}

.tab:focus,
.option-button:focus,
.business-type-card:focus {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
}
`;
document.head.appendChild(style);
}

// =====================
// เริ่มต้นแอปพลิเคชัน (Main Initialization)
// =====================

document.addEventListener('DOMContentLoaded', async function() {
console.log("🚀 เริ่มต้นแอปพลิเคชัน Smart Pork Skewer Business Advisor AI v4.0...");

// ตั้งค่า Error Handling
setupErrorHandling();

// แสดงวันที่ปัจจุบัน
setThaiDate();

// ตั้งค่า Performance Monitoring
setupPerformanceMonitoring();

// ตั้งค่า Accessibility
setupAccessibility();

// ตั้งค่า Auto-save
setupAutoSave();

// ตั้งค่า Service Worker
setupServiceWorker();

// ตรวจสอบองค์ประกอบที่จำเป็น
if (!checkRequiredElements()) {
console.error("องค์ประกอบบางอย่างไม่พร้อมใช้งาน");
showNotification('บางส่วนของแอปอาจไม่ทำงานอย่างสมบูรณ์ โปรดลองรีเฟรชหน้าเว็บ', 'warning');
}

// รอให้ Firebase พร้อมและเข้าสู่ระบบ
try {
console.log("🔐 กำลังเชื่อมต่อ Firebase...");
await UserDataManager.initAuth();
console.log('✅ Firebase พร้อมใช้งาน - User ID:', UserDataManager.currentUserId);

// แสดงการแจ้งเตือนการเชื่อมต่อสำเร็จ
showNotification('เชื่อมต่อฐานข้อมูลสำเร็จ 🎉', 'success', 3000);

} catch (error) {
console.error('❌ เกิดข้อผิดพลาดใน Firebase:', error);
showNotification('ไม่สามารถเชื่อมต่อฐานข้อมูลได้ แต่คุณยังสามารถใช้งานฟีเจอร์อื่นๆ ได้', 'warning');
}

// ตั้งค่าระบบต่างๆ
console.log("⚙️ กำลังตั้งค่าระบบ...");

try {
setupTabs();
console.log("✅ ระบบแท็บพร้อมใช้งาน");

setupOptionButtons();
console.log("✅ ระบบปุ่มตัวเลือกพร้อมใช้งาน");

setupBusinessTools();
console.log("✅ ระบบเครื่องมือธุรกิจพร้อมใช้งาน");

await setupChatSystem();
console.log("✅ ระบบแชท AI พร้อมใช้งาน");

setupSalesTracking();
console.log("✅ ระบบบันทึกยอดขายพร้อมใช้งาน");

await setupDashboard();
console.log("✅ แดชบอร์ดพร้อมใช้งาน");

setupSettings();
console.log("✅ ระบบการตั้งค่าพร้อมใช้งาน");

} catch (error) {
console.error("❌ เกิดข้อผิดพลาดในการตั้งค่าระบบ:", error);
showNotification('เกิดข้อผิดพลาดในการตั้งค่าบางส่วน แต่แอปยังใช้งานได้', 'warning');
}

// ดึงราคาหมูจริงและอัปเดตค่าเริ่มต้น
try {
console.log("💰 กำลังดึงราคาหมูล่าสุด...");
const realPorkPrice = await fetchRealPorkPrice();

// อัปเดตในฟอร์มผลิตเอง
const meatPriceInput = document.getElementById('producer-meat-price');
if (meatPriceInput) {
meatPriceInput.value = realPorkPrice;
}

console.log("✅ อัปเดตราคาหมูเรียบร้อย:", realPorkPrice, "บาท/กก.");
} catch (error) {
console.error("❌ เกิดข้อผิดพลาดในการดึงราคาหมู:", error);
}

// แสดงการแจ้งเตือนเมื่อโหลดเสร็จ
setTimeout(() => {
showNotification('🎉 Smart Pork Skewer Business AI พร้อมใช้งานแล้ว!', 'success', 4000);
console.log("🎉 เริ่มต้นแอปพลิเคชันเรียบร้อยแล้ว!");

// ตรวจสอบว่าผู้ใช้เคยใช้งานมาก่อนหรือไม่
if (UserDataManager.userData.profile.businessName) {
showNotification(`ยินดีต้อนรับกลับ ${UserDataManager.userData.profile.businessName} 👋`, 'info', 3000);
} else {
// ผู้ใช้ใหม่
setTimeout(() => {
showNotification('💡 เริ่มต้นด้วยการเลือกรูปแบบธุรกิจในแท็บ "เครื่องมือธุรกิจ"', 'info', 5000);
}, 2000);
}
}, 1500);

// ตั้งค่าการอัปเดตข้อมูลตลาดเป็นระยะ
setInterval(async () => {
try {
await fetchRealPorkPrice();
console.log('🔄 อัปเดตราคาตลาดแล้ว');
} catch (error) {
console.error('❌ ไม่สามารถอัปเดตราคาตลาดได้:', error);
}
}, 300000); // อัปเดตทุก 5 นาที

// ตั้งค่าการแจ้งเตือนบันทึกยอดขาย
if (UserDataManager.userData.preferences.salesReminder) {
// แจ้งเตือนในตอนเย็น (18:00)
const now = new Date();
const reminderTime = new Date();
reminderTime.setHours(18, 0, 0, 0);

if (now.getHours() >= 18 && now.getHours() < 22) {
setTimeout(() => {
showNotification('⏰ อย่าลืมบันทึกยอดขายประจำวันในแท็บ "บันทึกยอดขาย"', 'info', 6000);
}, 30000); // แจ้งเตือนหลังโหลดแอป 30 วินาที
}
}
});

// =====================
// เพิ่มฟังก์ชันสนับสนุนเสริม
// =====================

// ฟังก์ชันแชร์ผลลัพธ์
function shareResults(data) {
if (navigator.share) {
navigator.share({
title: 'Smart Pork Skewer Business Analysis',
text: `การวิเคราะห์ธุรกิจหมูปิ้ง: ราคาแนะนำ ${data.price} บาท/ไม้ กำไรประมาณ ${data.profit} บาท/วัน`,
url: window.location.href
}).catch(console.error);
} else {
// Fallback สำหรับเบราว์เซอร์ที่ไม่รองรับ
const text = `การวิเคราะห์ธุรกิจหมูปิ้ง: ราคาแนะนำ ${data.price} บาท/ไม้ กำไรประมาณ ${data.profit} บาท/วัน - ${window.location.href}`;
navigator.clipboard.writeText(text).then(() => {
showNotification('คัดลอกลิงก์แชร์ไปยังคลิปบอร์ดแล้ว 📋', 'success');
}).catch(() => {
showNotification('ไม่สามารถคัดลอกได้ กรุณาคัดลอกลิงก์ด้วยตนเอง', 'warning');
});
}
}

// ฟังก์ชันส่งออกข้อมูล
async function exportData() {
try {
const salesData = await SalesManager.getAllSalesData();
const userData = UserDataManager.userData;

const exportData = {
profile: userData.profile,
businessData: userData.businessData,
salesHistory: salesData,
exportDate: new Date().toISOString(),
appVersion: '4.0'
};

const dataStr = JSON.stringify(exportData, null, 2);
const dataBlob = new Blob([dataStr], {type: 'application/json'});
const url = URL.createObjectURL(dataBlob);

const link = document.createElement('a');
link.href = url;
link.download = `pork-business-data-${new Date().toISOString().split('T')[0]}.json`;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(url);

showNotification('ส่งออกข้อมูลสำเร็จ 📤', 'success');
} catch (error) {
console.error('Error exporting data:', error);
showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
}
}

// เพิ่มปุ่มส่งออกข้อมูลในหน้าการตั้งค่า (ถ้าต้องการ)
function addExportButton() {
const settingsTab = document.getElementById('settings-tab');
if (settingsTab) {
const exportCard = document.createElement('div');
exportCard.className = 'card';
exportCard.innerHTML = `
<div class="card-title">📤 การส่งออกข้อมูล</div>
<div class="highlight-box">
<p style="margin-bottom: 15px;">ส่งออกข้อมูลทั้งหมดของคุณเพื่อสำรองข้อมูลหรือย้ายไปใช้ในอุปกรณ์อื่น</p>
<button class="action-btn" onclick="exportData()">📤 ส่งออกข้อมูลทั้งหมด</button>
</div>
`;
settingsTab.appendChild(exportCard);
}
}

// เรียกใช้เมื่อโหลดเสร็จ
setTimeout(addExportButton, 2000);

console.log("🎯 Smart Pork Skewer Business Advisor AI v4.0 - พร้อมใช้งานแล้ว!");
</script>
</body>
</html>

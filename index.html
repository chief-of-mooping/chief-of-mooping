<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    #export-btn { margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h1>
  <input type="date" id="date-input" />
  <button onclick="loadCheckins()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button id="export-btn" onclick="exportCSV()">üì§ Export CSV</button>
  <table id="checkin-table" style="display:none;">
    <thead>
      <tr>
        <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏¥‡∏™‡∏¥‡∏ï</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>Email</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p id="status"></p>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDeD73Yg2QhPXl0dD40uvCsVejpf38OYeY",
      authDomain: "qr-checkin-up.firebaseapp.com",
      projectId: "qr-checkin-up",
      storageBucket: "qr-checkin-up.firebasestorage.app",
      messagingSenderId: "780428257804",
      appId: "1:780428257804:web:31b68ff043623144679c29"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadCheckins() {
      const date = document.getElementById('date-input').value;
      if (!date) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
        return;
      }

      const tbody = document.querySelector('#checkin-table tbody');
      tbody.innerHTML = '';

      try {
        const snapshot = await db.collection("checkins").doc(date).collection("students").get();
        if (snapshot.empty) {
          document.getElementById('status').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
          document.getElementById('checkin-table').style.display = 'none';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${doc.id}</td>
            <td>${data.name || ''}</td>
            <td>${data.email}</td>
            <td>${data.checkin_time?.toDate().toLocaleString('th-TH') || '-'}</td>
          `;
          tbody.appendChild(row);
        });
        document.getElementById('checkin-table').style.display = 'table';
        document.getElementById('status').textContent = '';
      } catch (err) {
        document.getElementById('status').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
      }
    }

    function exportCSV() {
      const rows = Array.from(document.querySelectorAll('#checkin-table tr'));
      const csv = rows.map(row => Array.from(row.children).map(td => '"' + td.innerText + '"').join(",")).join("\n");
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'checkin_report.csv';
      link.click();
    }
  </script>
</body>
</html>

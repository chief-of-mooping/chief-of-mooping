<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการฟาร์มสุกรอัจฉริยะ</title>
    <meta name="theme-color" content="#059669">
    <meta name="description" content="ระบบจัดการฟาร์มสุกรสำหรับเกษตรกรไทย">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Niramit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #0d7747;
            --secondary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Niramit', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Navigation */
        .nav {
            display: none;
        }

        .nav.active {
            display: block;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--primary);
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .nav-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.15);
        }

        .hamburger {
            display: block;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Main Content */
        main {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid var(--gray-200);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .kpi-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .neutral { color: var(--gray-500); }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-input, .form-select, .form-textarea {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            justify-content: center;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            min-height: 36px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .table th, .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .quick-action {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: var(--gray-700);
        }

        .quick-action:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .quick-action-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .quick-action-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid;
        }

        .alert-success {
            background: #ecfdf5;
            border-color: #10b981;
            color: #065f46;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: #dc2626;
            color: #991b1b;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #2563eb;
            color: #1e40af;
        }

        /* Error state */
        .error {
            border-color: var(--danger) !important;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .hamburger {
                display: none;
            }

            .nav {
                display: block;
                position: static;
                background: transparent;
                padding: 0;
                box-shadow: none;
            }

            .nav-list {
                flex-direction: row;
                gap: 0.25rem;
            }

            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-semibold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .hidden { display: none; }
        .flex { display: flex; }
        .grid { display: grid; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            max-width: 200px;
            z-index: 2000;
        }

        .debug-panel.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel hidden">
        <div>Records: <span id="debugRecords"></span></div>
        <div>LocalStorage: <span id="debugStorage"></span></div>
        <div>Last Action: <span id="debugAction"></span></div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">🐷</div>
                    <span>ระบบจัดการฟาร์มสุกรอัจฉริยะ</span>
                </div>
                <button class="hamburger" onclick="toggleNav()" aria-label="เมนู">☰</button>
                <nav class="nav" id="nav">
                    <ul class="nav-list">
                        <li><a class="nav-link active" onclick="showSection('dashboard')">📊 แผงควบคุม</a></li>
                        <li><a class="nav-link" onclick="showSection('pigs')">🐷 จัดการสุกร</a></li>
                        <li><a class="nav-link" onclick="showSection('feeding')">🥗 การให้อาหาร</a></li>
                        <li><a class="nav-link" onclick="showSection('health')">💊 สุขภาพ</a></li>
                        <li><a class="nav-link" onclick="showSection('stock')">📦 สต็อก</a></li>
                        <li><a class="nav-link" onclick="showSection('sales')">💰 การขาย</a></li>
                        <li><a class="nav-link" onclick="showSection('settings')">⚙️ ตั้งค่า</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="card-title">ภาพรวมฟาร์ม</h2>
                        <span id="current-date" class="text-sm text-gray-500"></span>
                    </div>
                    
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">จำนวนสุกรทั้งหมด</div>
                            <div class="kpi-value" id="total-pigs">0</div>
                            <div class="kpi-change neutral">
                                <span>ตัว</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">พร้อมขาย</div>
                            <div class="kpi-value" id="ready-for-sale">0</div>
                            <div class="kpi-change positive">
                                <span>ตัว (≥110กก.)</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">FCR เฉลี่ย</div>
                            <div class="kpi-value" id="avg-fcr">0.00</div>
                            <div class="kpi-change" id="fcr-change">
                                <span>เป้า: 2.35</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">ADG เฉลี่ย</div>
                            <div class="kpi-value" id="avg-adg">0</div>
                            <div class="kpi-change" id="adg-change">
                                <span>กรัม/วัน (เป้า: 700)</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">สต็อกอาหาร</div>
                            <div class="kpi-value" id="feed-stock">0</div>
                            <div class="kpi-change neutral">
                                <span id="feed-days">กก. (0 วัน)</span>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">รายได้เดือนนี้</div>
                            <div class="kpi-value" id="monthly-income">0</div>
                            <div class="kpi-change positive">
                                <span>บาท</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">⚡ งานด่วน</h3>
                        <button class="btn btn-warning btn-sm" onclick="toggleDebug()">Debug</button>
                    </div>
                    <div class="quick-actions">
                        <a href="#" class="quick-action" onclick="openModal('addPigModal')">
                            <div class="quick-action-icon">➕</div>
                            <div class="quick-action-label">เพิ่มสุกร</div>
                        </a>
                        <a href="#" class="quick-action" onclick="openModal('feedingModal')">
                            <div class="quick-action-icon">🥗</div>
                            <div class="quick-action-label">บันทึกอาหาร</div>
                        </a>
                        <a href="#" class="quick-action" onclick="openModal('healthModal')">
                            <div class="quick-action-icon">💊</div>
                            <div class="quick-action-label">บันทึกวัคซีน</div>
                        </a>
                        <a href="#" class="quick-action" onclick="openModal('stockModal')">
                            <div class="quick-action-icon">📦</div>
                            <div class="quick-action-label">อัพเดทสต็อก</div>
                        </a>
                        <a href="#" class="quick-action" onclick="openModal('salesModal')">
                            <div class="quick-action-icon">💰</div>
                            <div class="quick-action-label">บันทึกการขาย</div>
                        </a>
                        <a href="#" class="quick-action" onclick="exportData()">
                            <div class="quick-action-icon">💾</div>
                            <div class="quick-action-label">สำรองข้อมูล</div>
                        </a>
                    </div>
                </div>

                <div id="alerts-container">
                    <!-- Alerts will be inserted here -->
                </div>
            </section>

            <!-- Pigs Management Section -->
            <section id="pigs" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">จัดการสุกร</h2>
                        <button class="btn btn-primary" onclick="openModal('addPigModal')">
                            ➕ เพิ่มสุกร
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="table" id="pigsTable">
                            <thead>
                                <tr>
                                    <th>รหัส</th>
                                    <th>กลุ่ม</th>
                                    <th>น้ำหนัก (กก.)</th>
                                    <th>อายุ (วัน)</th>
                                    <th>เพศ</th>
                                    <th>FCR</th>
                                    <th>ADG</th>
                                    <th>สถานะ</th>
                                    <th>การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="pigsTableBody">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Feeding Section -->
            <section id="feeding" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">การให้อาหาร</h2>
                        <button class="btn btn-primary" onclick="openModal('feedingModal')">
                            🥗 บันทึกการให้อาหาร
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">ประวัติการให้อาหาร</h3>
                        <div class="table-container">
                            <table class="table" id="feedingTable">
                                <thead>
                                    <tr>
                                        <th>วันที่</th>
                                        <th>กลุ่ม</th>
                                        <th>ประเภทอาหาร</th>
                                        <th>ปริมาณ (กก.)</th>
                                        <th>ต้นทุน (บาท)</th>
                                        <th>การจัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="feedingTableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Health Section -->
            <section id="health" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">การจัดการสุขภาพสุกร</h2>
                        <button class="btn btn-primary" onclick="openModal('healthModal')">
                            💊 บันทึกการรักษา/วัคซีน
                        </button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ประวัติสุขภาพสุกร</h3>
                        <div class="table-container">
                            <table class="table" id="healthTable">
                                <thead>
                                    <tr>
                                        <th>วันที่</th>
                                        <th>รหัสสุกร</th>
                                        <th>ประเภท</th>
                                        <th>รายละเอียด</th>
                                        <th>ค่าใช้จ่าย</th>
                                        <th>การจัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="healthTableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Stock Section -->
            <section id="stock" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">จัดการสต็อก</h2>
                        <button class="btn btn-primary" onclick="openModal('stockModal')">
                            📦 อัพเดทสต็อก
                        </button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">รายการสต็อก</h3>
                        <div class="table-container">
                            <table class="table" id="stockTable">
                                <thead>
                                    <tr>
                                        <th>รายการ</th>
                                        <th>ประเภท</th>
                                        <th>จำนวน</th>
                                        <th>หน่วย</th>
                                        <th>ราคา/หน่วย</th>
                                        <th>มูลค่ารวม</th>
                                        <th>การจัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sales Section -->
            <section id="sales" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">การขายสุกร</h2>
                        <button class="btn btn-primary" onclick="openModal('salesModal')">
                            💰 บันทึกการขาย
                        </button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">ประวัติการขาย</h3>
                        <div class="table-container">
                            <table class="table" id="salesTable">
                                <thead>
                                    <tr>
                                        <th>วันที่</th>
                                        <th>รหัสสุกร</th>
                                        <th>น้ำหนัก (กก.)</th>
                                        <th>ราคา/กก.</th>
                                        <th>รายได้</th>
                                        <th>ผู้ซื้อ</th>
                                        <th>การจัดการ</th>
                                    </tr>
                                    </thead>
                               <tbody id="salesTableBody">
                                   <!-- Data will be inserted here -->
                               </tbody>
                           </table>
                       </div>
                   </div>
               </div>
           </section>

           <!-- Settings Section -->
           <section id="settings" class="section">
               <div class="card">
                   <div class="card-header">
                       <h2 class="card-title">ตั้งค่าระบบ</h2>
                   </div>
                   
                   <div class="space-y-4">
                       <div class="alert alert-info">
                           <strong>ข้อมูลระบบ:</strong> ข้อมูลทั้งหมด <span id="total-records">0</span> รายการ
                       </div>
                       
                       <div class="flex gap-2">
                           <button class="btn btn-secondary" onclick="loadDemoData()">
                               📋 โหลดข้อมูลตัวอย่าง
                           </button>
                           <button class="btn btn-warning" onclick="exportData()">
                               💾 สำรองข้อมูล
                           </button>
                           <button class="btn btn-danger" onclick="clearAllData()">
                               🗑️ ล้างข้อมูลทั้งหมด
                           </button>
                       </div>
                       
                       <div class="card">
                           <h3 class="card-title">นำเข้าข้อมูล</h3>
                           <div class="form-group">
                               <label class="form-label">เลือกไฟล์ JSON</label>
                               <input type="file" class="form-input" accept=".json" id="importFile" onchange="importData(this)">
                           </div>
                       </div>
                       
                       <div class="card">
                           <h3 class="card-title">สถานะระบบ</h3>
                           <div class="space-y-3">
                               <div>LocalStorage Support: <span id="storage-support" class="font-semibold"></span></div>
                               <div>ข้อมูลสุกร: <span id="pigs-count" class="font-semibold">0</span> รายการ</div>
                               <div>ข้อมูลอาหาร: <span id="feeding-count" class="font-semibold">0</span> รายการ</div>
                               <div>ข้อมูลสุขภาพ: <span id="health-count" class="font-semibold">0</span> รายการ</div>
                               <div>ข้อมูลสต็อก: <span id="stock-count" class="font-semibold">0</span> รายการ</div>
                               <div>ข้อมูลการขาย: <span id="sales-count" class="font-semibold">0</span> รายการ</div>
                           </div>
                       </div>
                   </div>
               </div>
           </section>
       </div>
   </main>

   <!-- Modals -->
   
   <!-- Add Pig Modal -->
   <div id="addPigModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">เพิ่มสุกร</h3>
               <button class="modal-close" onclick="closeModal('addPigModal')">&times;</button>
           </div>
           <form id="addPigForm">
               <div class="form-grid">
                   <div class="form-group">
                       <label class="form-label">รหัสสุกร <span style="color: red;">*</span></label>
                       <input type="text" class="form-input" name="pigId" required>
                       <span class="error-message hidden"></span>
                   </div>
                   <div class="form-group">
                       <label class="form-label">กลุ่ม <span style="color: red;">*</span></label>
                       <select class="form-select" name="group" required>
                           <option value="">เลือกกลุ่ม</option>
                           <option value="อนุบาล">อนุบาล</option>
                           <option value="รุ่น">รุ่น</option>
                           <option value="ขุน">ขุน</option>
                           <option value="พันธุ์">พันธุ์</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">น้ำหนักเริ่มต้น (กก.) <span style="color: red;">*</span></label>
                       <input type="number" class="form-input" name="initialWeight" step="0.1" required min="0">
                   </div>
                   <div class="form-group">
                       <label class="form-label">น้ำหนักปัจจุบัน (กก.) <span style="color: red;">*</span></label>
                       <input type="number" class="form-input" name="currentWeight" step="0.1" required min="0">
                   </div>
                   <div class="form-group">
                       <label class="form-label">เพศ <span style="color: red;">*</span></label>
                       <select class="form-select" name="gender" required>
                           <option value="">เลือกเพศ</option>
                           <option value="เมีย">เมีย</option>
                           <option value="ผู้">ผู้</option>
                           <option value="ขุน">ขุน</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">สายพันธุ์</label>
                       <input type="text" class="form-input" name="breed" placeholder="เช่น ลูกผสม, ยอร์คเชียร์">
                   </div>
                   <div class="form-group">
                       <label class="form-label">วันที่เข้าฟาร์ม <span style="color: red;">*</span></label>
                       <input type="date" class="form-input" name="entryDate" required>
                   </div>
               </div>
               <div class="flex gap-2 mt-4">
                   <button type="submit" class="btn btn-primary">บันทึก</button>
                   <button type="button" class="btn btn-secondary" onclick="closeModal('addPigModal')">ยกเลิก</button>
               </div>
           </form>
       </div>
   </div>

   <!-- Edit Pig Modal -->
   <div id="editPigModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">แก้ไขข้อมูลสุกร</h3>
               <button class="modal-close" onclick="closeModal('editPigModal')">&times;</button>
           </div>
           <form id="editPigForm">
               <input type="hidden" name="pigId" id="editPigId">
               <div class="form-grid">
                   <div class="form-group">
                       <label class="form-label">รหัสสุกร</label>
                       <input type="text" class="form-input" name="displayPigId" readonly>
                   </div>
                   <div class="form-group">
                       <label class="form-label">กลุ่ม <span style="color: red;">*</span></label>
                       <select class="form-select" name="group" required>
                           <option value="">เลือกกลุ่ม</option>
                           <option value="อนุบาล">อนุบาล</option>
                           <option value="รุ่น">รุ่น</option>
                           <option value="ขุน">ขุน</option>
                           <option value="พันธุ์">พันธุ์</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">น้ำหนักปัจจุบัน (กก.) <span style="color: red;">*</span></label>
                       <input type="number" class="form-input" name="currentWeight" step="0.1" required min="0">
                   </div>
                   <div class="form-group">
                       <label class="form-label">สายพันธุ์</label>
                       <input type="text" class="form-input" name="breed">
                   </div>
               </div>
               <div class="flex gap-2 mt-4">
                   <button type="submit" class="btn btn-primary">บันทึก</button>
                   <button type="button" class="btn btn-secondary" onclick="closeModal('editPigModal')">ยกเลิก</button>
               </div>
           </form>
       </div>
   </div>

   <!-- Feeding Modal -->
   <div id="feedingModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">บันทึกการให้อาหาร</h3>
               <button class="modal-close" onclick="closeModal('feedingModal')">&times;</button>
           </div>
           <form id="feedingForm">
               <div class="form-grid">
                   <div class="form-group">
                       <label class="form-label">วันที่ <span style="color: red;">*</span></label>
                       <input type="date" class="form-input" name="date" required>
                   </div>
                   <div class="form-group">
                       <label class="form-label">กลุ่มสุกร <span style="color: red;">*</span></label>
                       <select class="form-select" name="group" required>
                           <option value="">เลือกกลุ่ม</option>
                           <option value="อนุบาล">อนุบาล</option>
                           <option value="รุ่น">รุ่น</option>
                           <option value="ขุน">ขุน</option>
                           <option value="พันธุ์">พันธุ์</option>
                           <option value="ทั้งหมด">ทั้งหมด</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ประเภทอาหาร <span style="color: red;">*</span></label>
                       <select class="form-select" name="feedType" required>
                           <option value="">เลือกประเภท</option>
                           <option value="หมูเล็ก">หมูเล็ก (20 บาท/กก.)</option>
                           <option value="หมูรุ่น">หมูรุ่น (18 บาท/กก.)</option>
                           <option value="หมูขุน">หมูขุน (16 บาท/กก.)</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ปริมาณ (กก.) <span style="color: red;">*</span></label>
                       <input type="number" class="form-input" name="amount" step="0.1" required min="0">
                   </div>
                   <div class="form-group">
                       <label class="form-label">หมายเหตุ</label>
                       <textarea class="form-textarea" name="notes" rows="2"></textarea>
                   </div>
               </div>
               <div class="flex gap-2 mt-4">
                   <button type="submit" class="btn btn-primary">บันทึก</button>
                   <button type="button" class="btn btn-secondary" onclick="closeModal('feedingModal')">ยกเลิก</button>
               </div>
           </form>
       </div>
   </div>

   <!-- Health Modal -->
   <div id="healthModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">บันทึกสุขภาพสุกร/วัคซีน</h3>
               <button class="modal-close" onclick="closeModal('healthModal')">&times;</button>
           </div>
           <form id="healthForm">
               <div class="form-grid">
                   <div class="form-group">
                       <label class="form-label">วันที่ <span style="color: red;">*</span></label>
                       <input type="date" class="form-input" name="date" required>
                   </div>
                   <div class="form-group">
                       <label class="form-label">รหัสสุกร <span style="color: red;">*</span></label>
                       <select class="form-select" name="pigId" required>
                           <option value="">เลือกสุกร</option>
                           <option value="ทั้งหมด">ทั้งหมด</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ประเภท <span style="color: red;">*</span></label>
                       <select class="form-select" name="type" required>
                           <option value="">เลือกประเภท</option>
                           <option value="วัคซีน">วัคซีน</option>
                           <option value="รักษา">รักษา</option>
                           <option value="ตรวจสุขภาพ">ตรวจสุขภาพ</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ชื่อวัคซีน/ยา</label>
                       <select class="form-select" name="vaccine">
                           <option value="">เลือกวัคซีน/ยา</option>
                           <option value="PRRS">PRRS (Porcine Reproductive and Respiratory Syndrome)</option>
                           <option value="MHFD">MHFD (Mycoplasma hyopneumoniae + FMD)</option>
                           <option value="PCV2">PCV2 (Porcine Circovirus Type 2)</option>
                           <option value="กาฬโรค">กาฬโรค (Classical Swine Fever)</option>
                           <option value="อื่นๆ">อื่นๆ</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ค่าใช้จ่าย (บาท)</label>
                       <input type="number" class="form-input" name="cost" step="0.01" min="0">
                   </div>
                   <div class="form-group">
                       <label class="form-label">หมายเหตุ</label>
                       <textarea class="form-textarea" name="notes" rows="2"></textarea>
                   </div>
               </div>
               <div class="flex gap-2 mt-4">
                   <button type="submit" class="btn btn-primary">บันทึก</button>
                   <button type="button" class="btn btn-secondary" onclick="closeModal('healthModal')">ยกเลิก</button>
               </div>
           </form>
       </div>
   </div>

   <!-- Stock Modal -->
   <div id="stockModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">อัพเดทสต็อก</h3>
               <button class="modal-close" onclick="closeModal('stockModal')">&times;</button>
           </div>
           <form id="stockForm">
               <div class="form-grid">
                   <div class="form-group">
                       <label class="form-label">วันที่ <span style="color: red;">*</span></label>
                       <input type="date" class="form-input" name="date" required>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ประเภท <span style="color: red;">*</span></label>
                       <select class="form-select" name="type" required>
                           <option value="">เลือกประเภท</option>
                           <option value="อาหาร">อาหาร</option>
                           <option value="ยา">ยา</option>
                           <option value="วัคซีน">วัคซีน</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">รายการ <span style="color: red;">*</span></label>
                       <input type="text" class="form-input" name="item" required placeholder="เช่น อาหารหมูเล็ก, วัคซีน PRRS">
                   </div>
                   <div class="form-group">
                       <label class="form-label">จำนวน <span style="color: red;">*</span></label>
                       <input type="number" class="form-input" name="quantity" step="0.1" required min="0">
                   </div>
                   <div class="form-group">
                       <label class="form-label">หน่วย <span style="color: red;">*</span></label>
                       <select class="form-select" name="unit" required>
                           <option value="">เลือกหน่วย</option>
                           <option value="กก.">กก.</option>
                           <option value="โดส">โดส</option>
                           <option value="ขวด">ขวด</option>
                           <option value="ถุง">ถุง</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ราคาต่อหน่วย (บาท)</label>
                       <input type="number" class="form-input" name="unitPrice" step="0.01" min="0">
                   </div>
               </div>
               <div class="flex gap-2 mt-4">
                   <button type="submit" class="btn btn-primary">บันทึก</button>
                   <button type="button" class="btn btn-secondary" onclick="closeModal('stockModal')">ยกเลิก</button>
               </div>
           </form>
       </div>
   </div>

   <!-- Sales Modal -->
   <div id="salesModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">บันทึกการขายสุกร</h3>
               <button class="modal-close" onclick="closeModal('salesModal')">&times;</button>
           </div>
           <form id="salesForm">
               <div class="form-grid">
                   <div class="form-group">
                       <label class="form-label">วันที่ขาย <span style="color: red;">*</span></label>
                       <input type="date" class="form-input" name="date" required>
                   </div>
                   <div class="form-group">
                       <label class="form-label">รหัสสุกร <span style="color: red;">*</span></label>
                       <select class="form-select" name="pigId" required onchange="updateSaleWeight()">
                           <option value="">เลือกสุกร</option>
                       </select>
                   </div>
                   <div class="form-group">
                       <label class="form-label">น้ำหนักขาย (กก.)</label>
                       <input type="number" class="form-input" name="weight" step="0.1" readonly>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ราคา/กก. <span style="color: red;">*</span></label>
                       <input type="number" class="form-input" name="pricePerKg" step="0.01" required min="0" onchange="calculateTotalPrice()">
                   </div>
                   <div class="form-group">
                       <label class="form-label">รายได้รวม</label>
                       <input type="number" class="form-input" name="totalPrice" readonly>
                   </div>
                   <div class="form-group">
                       <label class="form-label">ผู้ซื้อ</label>
                       <input type="text" class="form-input" name="buyer" placeholder="ชื่อผู้ซื้อ/บริษัท">
                   </div>
                   <div class="form-group">
                       <label class="form-label">หมายเหตุ</label>
                       <textarea class="form-textarea" name="notes" rows="2"></textarea>
                   </div>
               </div>
               <div class="flex gap-2 mt-4">
                   <button type="submit" class="btn btn-primary">บันทึก</button>
                   <button type="button" class="btn btn-secondary" onclick="closeModal('salesModal')">ยกเลิก</button>
               </div>
           </form>
       </div>
   </div>

   <script>
       // ==================== DATA MANAGEMENT ====================
       
       // Storage Keys - ใช้ prefix เพื่อป้องกัน conflict
       const STORAGE_KEYS = {
           pigs: 'farmSystem_pigs',
           feeding: 'farmSystem_feeding', 
           health: 'farmSystem_health',
           stock: 'farmSystem_stock',
           sales: 'farmSystem_sales',
           settings: 'farmSystem_settings'
       };

       // Global Farm Data Object
       let farmData = {
           pigs: [],
           feeding: [],
           health: [],
           stock: [],
           sales: [],
           settings: {}
       };

       // Debug flag
       let debugMode = false;

       // ==================== UTILITY FUNCTIONS ====================
       
       // Generate unique ID
       function generateId() {
           return Date.now().toString(36) + Math.random().toString(36).substr(2);
       }

       // Safe localStorage operations
       function safeSetItem(key, value) {
           try {
               const jsonString = JSON.stringify(value);
               localStorage.setItem(key, jsonString);
               debugLog(`✅ Saved ${key}: ${jsonString.length} chars`);
               return true;
           } catch (error) {
               console.error(`❌ Error saving ${key}:`, error);
               showNotification(`เกิดข้อผิดพลาดในการบันทึก: ${error.message}`, 'error');
               return false;
           }
       }

       function safeGetItem(key, defaultValue = null) {
           try {
               const item = localStorage.getItem(key);
               if (item === null) return defaultValue;
               const parsed = JSON.parse(item);
               debugLog(`📖 Loaded ${key}: ${Array.isArray(parsed) ? parsed.length : 'object'} items`);
               return parsed;
           } catch (error) {
               console.error(`❌ Error loading ${key}:`, error);
               return defaultValue;
           }
       }

       // Debug logging
       function debugLog(message) {
           if (debugMode) {
               console.log(`[DEBUG] ${message}`);
           }
       }

       // Update debug panel
       function updateDebugPanel() {
           if (!debugMode) return;
           
           const totalRecords = farmData.pigs.length + farmData.feeding.length + 
                              farmData.health.length + farmData.stock.length + farmData.sales.length;
           
           document.getElementById('debugRecords').textContent = totalRecords;
           document.getElementById('debugStorage').textContent = 
               typeof(Storage) !== "undefined" ? "✅" : "❌";
       }

       // ==================== DATA PERSISTENCE ====================
       
       // Load all data from localStorage
       function loadData() {
           debugLog('Loading data from localStorage...');
           
           farmData.pigs = safeGetItem(STORAGE_KEYS.pigs, []);
           farmData.feeding = safeGetItem(STORAGE_KEYS.feeding, []);
           farmData.health = safeGetItem(STORAGE_KEYS.health, []);
           farmData.stock = safeGetItem(STORAGE_KEYS.stock, []);
           farmData.sales = safeGetItem(STORAGE_KEYS.sales, []);
           farmData.settings = safeGetItem(STORAGE_KEYS.settings, {});
           
           debugLog(`Loaded: ${farmData.pigs.length} pigs, ${farmData.feeding.length} feeding records`);
           updateDebugPanel();
       }

       // Save all data to localStorage
       function saveData() {
           debugLog('Saving data to localStorage...');
           
           const success = 
               safeSetItem(STORAGE_KEYS.pigs, farmData.pigs) &&
               safeSetItem(STORAGE_KEYS.feeding, farmData.feeding) &&
               safeSetItem(STORAGE_KEYS.health, farmData.health) &&
               safeSetItem(STORAGE_KEYS.stock, farmData.stock) &&
               safeSetItem(STORAGE_KEYS.sales, farmData.sales) &&
               safeSetItem(STORAGE_KEYS.settings, farmData.settings);
           
           if (success) {
               debugLog('✅ All data saved successfully');
               updateDebugPanel();
               if (debugMode) {
                   document.getElementById('debugAction').textContent = 'Saved at ' + new Date().toLocaleTimeString();
               }
           }
           
           return success;
       }

       // ==================== CRUD OPERATIONS ====================
       
       // Add new pig
       function addPig(pigData) {
           debugLog(`Adding pig: ${pigData.pigId}`);
           
           // Check if pig ID already exists
           if (farmData.pigs.find(p => p.pigId === pigData.pigId)) {
               throw new Error('รหัสสุกรนี้มีอยู่แล้ว');
           }
           
           const newPig = {
               id: generateId(),
               pigId: pigData.pigId,
               group: pigData.group,
               initialWeight: parseFloat(pigData.initialWeight),
               currentWeight: parseFloat(pigData.currentWeight),
               gender: pigData.gender,
               breed: pigData.breed || 'ไม่ระบุ',
               entryDate: pigData.entryDate,
               createdAt: new Date().toISOString(),
               updatedAt: new Date().toISOString()
           };
           
           farmData.pigs.push(newPig);
           saveData();
           debugLog(`✅ Added pig ${newPig.pigId} with ID ${newPig.id}`);
           return newPig;
       }

       // Update pig
       function updatePig(pigId, updateData) {
           debugLog(`Updating pig: ${pigId}`);
           
           const index = farmData.pigs.findIndex(p => p.id === pigId);
           if (index === -1) {
               throw new Error('ไม่พบข้อมูลสุกร');
           }
           
           farmData.pigs[index] = {
               ...farmData.pigs[index],
               ...updateData,
               updatedAt: new Date().toISOString()
           };
           
           saveData();
           debugLog(`✅ Updated pig ${pigId}`);
           return farmData.pigs[index];
       }

       // Delete pig by ID
       function deletePig(pigId) {
           debugLog(`Deleting pig: ${pigId}`);
           
           const index = farmData.pigs.findIndex(p => p.id === pigId);
           if (index === -1) {
               throw new Error('ไม่พบข้อมูลสุกร');
           }
           
           const pig = farmData.pigs[index];
           farmData.pigs.splice(index, 1);
           saveData();
           debugLog(`✅ Deleted pig ${pig.pigId} (ID: ${pigId})`);
           return pig;
       }

       // Generic CRUD functions for other data types
       function addRecord(type, data) {
           debugLog(`Adding ${type} record`);
           
           const record = {
               id: generateId(),
               ...data,
               createdAt: new Date().toISOString()
           };
           
           farmData[type].push(record);
           saveData();
           debugLog(`✅ Added ${type} record with ID ${record.id}`);
           return record;
       }

       function deleteRecord(type, recordId) {
           debugLog(`Deleting ${type} record: ${recordId}`);
           
           const index = farmData[type].findIndex(r => r.id === recordId);
           if (index === -1) {
               throw new Error('ไม่พบข้อมูล');
           }
           
           const record = farmData[type][index];
           farmData[type].splice(index, 1);
           saveData();
           debugLog(`✅ Deleted ${type} record ${recordId}`);
           return record;
       }

       // ==================== CALCULATIONS ====================
       
       // Calculate FCR for individual pig
       function calculateFCR(pig) {
           // Get feeding records for this pig's group since entry date
           const entryDate = new Date(pig.entryDate);
           const feedingRecords = farmData.feeding.filter(record => {
               const recordDate = new Date(record.date);
               return recordDate >= entryDate && (record.group === pig.group || record.group === 'ทั้งหมด');
           });

           // Calculate total feed consumed by this pig
           let totalFeed = 0;
           feedingRecords.forEach(record => {
               // Estimate individual pig's share based on group size at time of feeding
               const pigsInGroup = farmData.pigs.filter(p => 
                   p.group === record.group && new Date(p.entryDate) <= new Date(record.date)
               ).length || 1;
               
               totalFeed += record.amount / pigsInGroup;
           });
           const weightGain = pig.currentWeight - pig.initialWeight;
           
           if (weightGain <= 0) return '0.00';
           
           const fcr = totalFeed / weightGain;
           return fcr.toFixed(2);
       }

       // Calculate ADG (Average Daily Gain) for individual pig
       function calculateADG(pig) {
           const entryDate = new Date(pig.entryDate);
           const today = new Date();
           const daysInFarm = Math.floor((today - entryDate) / (1000 * 60 * 60 * 24)) || 1;
           const weightGain = pig.currentWeight - pig.initialWeight;
           
           return Math.round((weightGain * 1000) / daysInFarm); // in grams
       }

       // Calculate age in days
       function calculateAge(entryDate) {
           const entry = new Date(entryDate);
           const today = new Date();
           return Math.floor((today - entry) / (1000 * 60 * 60 * 24));
       }

       // ==================== UI UPDATES ====================
       
       // Update dashboard KPIs
       function updateKPIs() {
           const totalPigs = farmData.pigs.length;
           const readyForSale = farmData.pigs.filter(p => p.currentWeight >= 110).length;
           
           // Calculate averages safely
           let avgFCR = 0;
           let avgADG = 0;
           
           if (totalPigs > 0) {
               const fcrValues = farmData.pigs.map(pig => parseFloat(calculateFCR(pig))).filter(fcr => fcr > 0);
               avgFCR = fcrValues.length > 0 ? fcrValues.reduce((sum, fcr) => sum + fcr, 0) / fcrValues.length : 0;
               avgADG = farmData.pigs.reduce((sum, pig) => sum + calculateADG(pig), 0) / totalPigs;
           }

           // Calculate feed stock
           const totalFeedStock = farmData.stock
               .filter(s => s.type === 'อาหาร')
               .reduce((sum, s) => sum + s.quantity, 0);

           // Calculate daily consumption
           const last7Days = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
           const recentFeeding = farmData.feeding.filter(f => new Date(f.date) >= last7Days);
           const dailyConsumption = recentFeeding.length > 0 ?
               recentFeeding.reduce((sum, f) => sum + f.amount, 0) / 7 : 50;
           
           const feedDays = dailyConsumption > 0 ? Math.floor(totalFeedStock / dailyConsumption) : 0;

           // Calculate monthly income
           const currentMonth = new Date().toISOString().slice(0, 7);
           const monthlyIncome = farmData.sales
               .filter(s => s.date.startsWith(currentMonth))
               .reduce((sum, s) => sum + s.totalPrice, 0);

           // Update DOM
           document.getElementById('total-pigs').textContent = totalPigs;
           document.getElementById('ready-for-sale').textContent = readyForSale;
           document.getElementById('avg-fcr').textContent = avgFCR.toFixed(2);
           document.getElementById('avg-adg').textContent = Math.round(avgADG);
           document.getElementById('feed-stock').textContent = Math.round(totalFeedStock);
           document.getElementById('feed-days').textContent = `กก. (${feedDays} วัน)`;
           document.getElementById('monthly-income').textContent = monthlyIncome.toLocaleString();

           // Update indicators
           const fcrChange = document.getElementById('fcr-change');
           if (avgFCR > 0) {
               const fcrDiff = ((avgFCR - 2.35) / 2.35) * 100;
               fcrChange.className = fcrDiff <= 0 ? 'kpi-change positive' : 'kpi-change negative';
               fcrChange.innerHTML = `<span>${fcrDiff > 0 ? '+' : ''}${fcrDiff.toFixed(1)}% จากเป้า</span>`;
           }

           const adgChange = document.getElementById('adg-change');
           if (avgADG > 0) {
               const adgDiff = ((avgADG - 700) / 700) * 100;
               adgChange.className = adgDiff >= 0 ? 'kpi-change positive' : 'kpi-change negative';
               adgChange.innerHTML = `<span>${adgDiff > 0 ? '+' : ''}${adgDiff.toFixed(1)}% จากเป้า</span>`;
           }
       }

       // Update pigs table
       function updatePigsTable() {
           const tbody = document.getElementById('pigsTableBody');
           tbody.innerHTML = '';

           if (farmData.pigs.length === 0) {
               tbody.innerHTML = '<tr><td colspan="9" class="text-center">ไม่พบข้อมูลสุกร</td></tr>';
               return;
           }

           farmData.pigs.forEach(pig => {
               const fcr = calculateFCR(pig);
               const adg = calculateADG(pig);
               const age = calculateAge(pig.entryDate);
               const status = pig.currentWeight >= 110 ? 'พร้อมขาย' : 'เลี้ยงต่อ';
               const statusClass = pig.currentWeight >= 110 ? 'positive' : 'neutral';

               tbody.innerHTML += `
                   <tr>
                       <td>${pig.pigId}</td>
                       <td>${pig.group}</td>
                       <td>${pig.currentWeight}</td>
                       <td>${age}</td>
                       <td>${pig.gender}</td>
                       <td>${fcr}</td>
                       <td>${adg}</td>
                       <td><span class="${statusClass}">${status}</span></td>
                       <td>
                           <button class="btn btn-secondary btn-sm" onclick="editPig('${pig.id}')">แก้ไข</button>
                           <button class="btn btn-danger btn-sm" onclick="confirmDeletePig('${pig.id}')">ลบ</button>
                       </td>
                   </tr>
               `;
           });
       }

       // Update other tables
       function updateFeedingTable() {
           const tbody = document.getElementById('feedingTableBody');
           tbody.innerHTML = '';

           if (farmData.feeding.length === 0) {
               tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่พบข้อมูลการให้อาหาร</td></tr>';
               return;
           }

           // Show latest 20 records
           const recentFeeding = farmData.feeding.slice(-20).reverse();
           
           recentFeeding.forEach(record => {
               tbody.innerHTML += `
                   <tr>
                       <td>${new Date(record.date).toLocaleDateString('th-TH')}</td>
                       <td>${record.group}</td>
                       <td>${record.feedType}</td>
                       <td>${record.amount}</td>
                       <td>${record.cost.toLocaleString()}</td>
                       <td>
                           <button class="btn btn-danger btn-sm" onclick="confirmDeleteRecord('feeding', '${record.id}')">ลบ</button>
                       </td>
                   </tr>
               `;
           });
       }

       function updateHealthTable() {
           const tbody = document.getElementById('healthTableBody');
           tbody.innerHTML = '';

           if (farmData.health.length === 0) {
               tbody.innerHTML = '<tr><td colspan="6" class="text-center">ไม่พบข้อมูลสุขภาพ</td></tr>';
               return;
           }

           const recentHealth = farmData.health.slice(-20).reverse();
           
           recentHealth.forEach(record => {
               tbody.innerHTML += `
                   <tr>
                       <td>${new Date(record.date).toLocaleDateString('th-TH')}</td>
                       <td>${record.pigId}</td>
                       <td>${record.type}</td>
                       <td>${record.vaccine || record.notes || '-'}</td>
                       <td>${(record.cost || 0).toLocaleString()}</td>
                       <td>
                           <button class="btn btn-danger btn-sm" onclick="confirmDeleteRecord('health', '${record.id}')">ลบ</button>
                       </td>
                   </tr>
               `;
           });
       }

       function updateStockTable() {
           const tbody = document.getElementById('stockTableBody');
           tbody.innerHTML = '';

           if (farmData.stock.length === 0) {
               tbody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่พบข้อมูลสต็อก</td></tr>';
               return;
           }

           farmData.stock.forEach(item => {
               const totalValue = item.quantity * (item.unitPrice || 0);
               tbody.innerHTML += `
                   <tr>
                       <td>${item.item}</td>
                       <td>${item.type}</td>
                       <td>${item.quantity}</td>
                       <td>${item.unit}</td>
                       <td>${(item.unitPrice || 0).toLocaleString()}</td>
                       <td>${totalValue.toLocaleString()}</td>
                       <td>
                           <button class="btn btn-danger btn-sm" onclick="confirmDeleteRecord('stock', '${item.id}')">ลบ</button>
                       </td>
                   </tr>
               `;
           });
       }

       function updateSalesTable() {
           const tbody = document.getElementById('salesTableBody');
           tbody.innerHTML = '';

           if (farmData.sales.length === 0) {
               tbody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่พบข้อมูลการขาย</td></tr>';
               return;
           }

           const recentSales = farmData.sales.slice(-20).reverse();
           
           recentSales.forEach(record => {
               tbody.innerHTML += `
                   <tr>
                       <td>${new Date(record.date).toLocaleDateString('th-TH')}</td>
                       <td>${record.pigId}</td>
                       <td>${record.weight}</td>
                       <td>${record.pricePerKg}</td>
                       <td>${record.totalPrice.toLocaleString()}</td>
                       <td>${record.buyer || '-'}</td>
                       <td>
                           <button class="btn btn-danger btn-sm" onclick="confirmDeleteRecord('sales', '${record.id}')">ลบ</button>
                       </td>
                   </tr>
               `;
           });
       }

       // Update settings page
       function updateSettingsPage() {
           const totalRecords = farmData.pigs.length + farmData.feeding.length + 
                              farmData.health.length + farmData.stock.length + farmData.sales.length;
           
           document.getElementById('total-records').textContent = totalRecords;
           document.getElementById('storage-support').textContent = 
               typeof(Storage) !== "undefined" ? "✅ รองรับ" : "❌ ไม่รองรับ";
           
           document.getElementById('pigs-count').textContent = farmData.pigs.length;
           document.getElementById('feeding-count').textContent = farmData.feeding.length;
           document.getElementById('health-count').textContent = farmData.health.length;
           document.getElementById('stock-count').textContent = farmData.stock.length;
           document.getElementById('sales-count').textContent = farmData.sales.length;
       }

       // Update alerts
       function updateAlerts() {
           const alertsContainer = document.getElementById('alerts-container');
           alertsContainer.innerHTML = '';

           const alerts = [];

           // Check for pigs ready for sale
           const readyForSale = farmData.pigs.filter(p => p.currentWeight >= 110);
           if (readyForSale.length > 0) {
               alerts.push({
                   type: 'success',
                   message: `✅ มีสุกรพร้อมขาย ${readyForSale.length} ตัว: ${readyForSale.map(p => p.pigId).join(', ')}`
               });
           }

           // Check for low feed stock
           const lowStockFeeds = farmData.stock.filter(s => s.type === 'อาหาร' && s.quantity <= 100);
           lowStockFeeds.forEach(item => {
               alerts.push({
                   type: 'warning',
                   message: `⚠️ ${item.item} เหลือน้อย: ${item.quantity} ${item.unit}`
               });
           });

           // Display alerts
           if (alerts.length === 0) {
               alertsContainer.innerHTML = '<div class="alert alert-info">ℹ️ ไม่มีการแจ้งเตือนในขณะนี้</div>';
           } else {
               alerts.forEach(alert => {
                   alertsContainer.innerHTML += `<div class="alert alert-${alert.type}">${alert.message}</div>`;
               });
           }
       }

       // ==================== NAVIGATION ====================
       
       function showSection(sectionId) {
           debugLog(`Showing section: ${sectionId}`);
           
           // Hide all sections
           document.querySelectorAll('.section').forEach(section => {
               section.classList.remove('active');
           });
           
           // Show selected section
           document.getElementById(sectionId).classList.add('active');
           
           // Update navigation
           document.querySelectorAll('.nav-link').forEach(link => {
               link.classList.remove('active');
           });
           event.target.classList.add('active');
           
           // Close mobile menu
           document.getElementById('nav').classList.remove('active');
           
           // Update section-specific content
           switch(sectionId) {
               case 'dashboard':
                   updateKPIs();
                   updateAlerts();
                   break;
               case 'pigs':
                   updatePigsTable();
                   break;
               case 'feeding':
                   updateFeedingTable();
                   break;
               case 'health':
                   updateHealthTable();
                   updatePigSelectOptions();
                   break;
               case 'stock':
                   updateStockTable();
                   break;
               case 'sales':
                   updateSalesTable();
                   updateSalesPigOptions();
                   break;
               case 'settings':
                   updateSettingsPage();
                   break;
           }
       }

       function toggleNav() {
           document.getElementById('nav').classList.toggle('active');
       }

       // ==================== MODAL MANAGEMENT ====================
       
       function openModal(modalId) {
           debugLog(`Opening modal: ${modalId}`);
           document.getElementById(modalId).classList.add('active');
           
           // Setup form defaults
           const today = new Date().toISOString().split('T')[0];
           
           switch(modalId) {
               case 'feedingModal':
                   document.querySelector('#feedingForm [name="date"]').value = today;
                   break;
               case 'healthModal':
                   document.querySelector('#healthForm [name="date"]').value = today;
                   updatePigSelectOptions();
                   break;
               case 'stockModal':
                   document.querySelector('#stockForm [name="date"]').value = today;
                   break;
               case 'salesModal':
                   document.querySelector('#salesForm [name="date"]').value = today;
                   updateSalesPigOptions();
                   break;
               case 'addPigModal':
                   document.querySelector('#addPigForm [name="entryDate"]').value = today;
                   break;
           }
       }

       function closeModal(modalId) {
           debugLog(`Closing modal: ${modalId}`);
           document.getElementById(modalId).classList.remove('active');
           
           // Clear form
           const form = document.querySelector(`#${modalId} form`);
           if (form) {
               form.reset();
               clearFormErrors(form);
           }
       }

       // ==================== FORM HANDLING ====================
       
       // Form validation
       function validatePigForm(formData) {
           const errors = {};

           if (!formData.pigId || formData.pigId.trim() === '') {
               errors.pigId = 'กรุณากรอกรหัสสุกร';
           } else if (farmData.pigs.find(p => p.pigId === formData.pigId)) {
               errors.pigId = 'รหัสสุกรนี้มีอยู่แล้ว';
           }
           
           if (parseFloat(formData.currentWeight) < parseFloat(formData.initialWeight)) {
               errors.currentWeight = 'น้ำหนักปัจจุบันต้องมากกว่าหรือเท่ากับน้ำหนักเริ่มต้น';
           }

           return errors;
       }

       function showFormErrors(form, errors) {
           // Clear previous errors
           clearFormErrors(form);

           // Show new errors
           Object.entries(errors).forEach(([field, message]) => {
               const input = form.querySelector(`[name="${field}"]`);
               if (input) {
                   input.classList.add('error');
                   
                   // Add error message
                   let errorEl = input.parentElement.querySelector('.error-message');
                   if (!errorEl) {
                       errorEl = document.createElement('span');
                       errorEl.className = 'error-message';
                       input.parentElement.appendChild(errorEl);
                   }
                   errorEl.textContent = message;
                   errorEl.classList.remove('hidden');
               }
           });
       }

       function clearFormErrors(form) {
           form.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
           form.querySelectorAll('.error-message').forEach(el => {
               el.textContent = '';
               el.classList.add('hidden');
           });
       }

       // ==================== FORM HANDLERS ====================
       
       // Add Pig Form
       document.addEventListener('DOMContentLoaded', function() {
           document.getElementById('addPigForm').addEventListener('submit', function(e) {
               e.preventDefault();
               
               try {
                   const formData = new FormData(e.target);
                   const pigData = {
                       pigId: formData.get('pigId'),
                       group: formData.get('group'),
                       initialWeight: formData.get('initialWeight'),
                       currentWeight: formData.get('currentWeight'),
                       gender: formData.get('gender'),
                       breed: formData.get('breed'),
                       entryDate: formData.get('entryDate')
                   };

                   // Validate
                   const errors = validatePigForm(pigData);
                   if (Object.keys(errors).length > 0) {
                       showFormErrors(e.target, errors);
                       return;
                   }

                   addPig(pigData);
                   closeModal('addPigModal');
                   updatePigsTable();
                   updateKPIs();
                   showNotification('บันทึกข้อมูลสุกรเรียบร้อยแล้ว', 'success');
                   
               } catch (error) {
                   console.error('Error adding pig:', error);
                   showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
               }
           });

           // Edit Pig Form
           document.getElementById('editPigForm').addEventListener('submit', function(e) {
               e.preventDefault();
               
               try {
                   const formData = new FormData(e.target);
                   const pigId = formData.get('pigId');
                   const updateData = {
                       group: formData.get('group'),
                       currentWeight: parseFloat(formData.get('currentWeight')),
                       breed: formData.get('breed')
                   };

                   updatePig(pigId, updateData);
                   closeModal('editPigModal');
                   updatePigsTable();
                   updateKPIs();
                   showNotification('แก้ไขข้อมูลสุกรเรียบร้อยแล้ว', 'success');
                   
               } catch (error) {
                   console.error('Error updating pig:', error);
                   showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
               }
           });

           // Feeding Form
           document.getElementById('feedingForm').addEventListener('submit', function(e) {
               e.preventDefault();
               
               try {
                   const formData = new FormData(e.target);
                   const feedType = formData.get('feedType');
                   const amount = parseFloat(formData.get('amount'));
                   
                   // Calculate cost based on feed type
                   let cost = 0;
                   switch(feedType) {
                       case 'หมูเล็ก': cost = amount * 20; break;
                       case 'หมูรุ่น': cost = amount * 18; break;
                       case 'หมูขุน': cost = amount * 16; break;
                   }

                   const feedingData = {
                       date: formData.get('date'),
                       group: formData.get('group'),
                       feedType: feedType,
                       amount: amount,
                       cost: cost,
                       notes: formData.get('notes')
                   };

                   addRecord('feeding', feedingData);
                   closeModal('feedingModal');
                   updateFeedingTable();
                   updateKPIs();
                   showNotification('บันทึกการให้อาหารเรียบร้อยแล้ว', 'success');
                   
               } catch (error) {
                   console.error('Error adding feeding record:', error);
                   showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
               }
           });

           // Health Form
           document.getElementById('healthForm').addEventListener('submit', function(e) {
               e.preventDefault();
               
               try {
                   const formData = new FormData(e.target);
                   const healthData = {
                       date: formData.get('date'),
                       pigId: formData.get('pigId'),
                       type: formData.get('type'),
                       vaccine: formData.get('vaccine'),
                       cost: parseFloat(formData.get('cost')) || 0,
                       notes: formData.get('notes')
                   };

                   addRecord('health', healthData);
                   closeModal('healthModal');
                   updateHealthTable();
                   showNotification('บันทึกข้อมูลสุขภาพเรียบร้อยแล้ว', 'success');
                   
               } catch (error) {
                   console.error('Error adding health record:', error);
                   showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
               }
           });

           // Stock Form
           document.getElementById('stockForm').addEventListener('submit', function(e) {
               e.preventDefault();
               
               try {
                   const formData = new FormData(e.target);
                   const stockData = {
                       date: formData.get('date'),
                       type: formData.get('type'),
                       item: formData.get('item'),
                       quantity: parseFloat(formData.get('quantity')),
                       unit: formData.get('unit'),
                       unitPrice: parseFloat(formData.get('unitPrice')) || 0
                   };

                   addRecord('stock', stockData);
                   closeModal('stockModal');
                   updateStockTable();
                   showNotification('อัพเดทสต็อกเรียบร้อยแล้ว', 'success');
                   
               } catch (error) {
                   console.error('Error adding stock record:', error);
                   showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
               }
           });

           // Sales Form
           document.getElementById('salesForm').addEventListener('submit', function(e) {
               e.preventDefault();
               
               try {
                   const formData = new FormData(e.target);
                   const pigId = formData.get('pigId');
                   
                   const salesData = {
                       date: formData.get('date'),
                       pigId: pigId,
                       weight: parseFloat(formData.get('weight')),
                       pricePerKg: parseFloat(formData.get('pricePerKg')),
                       totalPrice: parseFloat(formData.get('totalPrice')),
                       buyer: formData.get('buyer') || 'ไม่ระบุ',
                       notes: formData.get('notes')
                   };

                   // Add to sales records
                   addRecord('sales', salesData);
                   
                   // Remove pig from active pigs (move to sold)
                   const pig = farmData.pigs.find(p => p.pigId === pigId);
                   if (pig) {
                       deletePig(pig.id);
                   }

                   closeModal('salesModal');
                   updateSalesTable();
                   updatePigsTable();
                   updateKPIs();
                   showNotification('บันทึกการขายเรียบร้อยแล้ว', 'success');
                   
               } catch (error) {
                   console.error('Error adding sales record:', error);
                   showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
               }
           });
       });

       // ==================== HELPER FUNCTIONS ====================
       
       function updatePigSelectOptions() {
           const select = document.querySelector('#healthForm [name="pigId"]');
           select.innerHTML = '<option value="">เลือกสุกร</option><option value="ทั้งหมด">ทั้งหมด</option>';
           
           farmData.pigs.forEach(pig => {
               select.innerHTML += `<option value="${pig.pigId}">${pig.pigId} (${pig.group})</option>`;
           });
       }

       function updateSalesPigOptions() {
           const select = document.querySelector('#salesForm [name="pigId"]');
           select.innerHTML = '<option value="">เลือกสุกร</option>';
           
           // Only show pigs ready for sale (>=110kg)
           farmData.pigs.filter(p => p.currentWeight >= 110).forEach(pig => {
               select.innerHTML += `<option value="${pig.pigId}">${pig.pigId} - ${pig.currentWeight} กก.</option>`;
           });
       }

       function updateSaleWeight() {
           const pigId = document.querySelector('#salesForm [name="pigId"]').value;
           const weightInput = document.querySelector('#salesForm [name="weight"]');
           
           if (pigId) {
               const pig = farmData.pigs.find(p => p.pigId === pigId);
               if (pig) {
                   weightInput.value = pig.currentWeight;
                   calculateTotalPrice();
               }
           }
       }

       function calculateTotalPrice() {
           const weight = parseFloat(document.querySelector('#salesForm [name="weight"]').value) || 0;
           const pricePerKg = parseFloat(document.querySelector('#salesForm [name="pricePerKg"]').value) || 0;
           const totalPrice = weight * pricePerKg;
           
           document.querySelector('#salesForm [name="totalPrice"]').value = totalPrice.toFixed(2);
       }

       // ==================== DELETE FUNCTIONS ====================
       
       function editPig(pigId) {
           const pig = farmData.pigs.find(p => p.id === pigId);
           if (!pig) {
               showNotification('ไม่พบข้อมูลสุกร', 'error');
               return;
           }
           
           const form = document.getElementById('editPigForm');
           form.querySelector('[name="pigId"]').value = pig.id;
           form.querySelector('[name="displayPigId"]').value = pig.pigId;
           form.querySelector('[name="group"]').value = pig.group;
           form.querySelector('[name="currentWeight"]').value = pig.currentWeight;
           form.querySelector('[name="breed"]').value = pig.breed;
           
           openModal('editPigModal');
       }

       function confirmDeletePig(pigId) {
           const pig = farmData.pigs.find(p => p.id === pigId);
           if (!pig) {
               showNotification('ไม่พบข้อมูลสุกร', 'error');
               return;
           }
           
           if (confirm(`คุณแน่ใจหรือไม่ที่จะลบสุกร ${pig.pigId}?`)) {
               try {
                   deletePig(pigId);
                   updatePigsTable();
                   updateKPIs();
                   showNotification('ลบข้อมูลสุกรเรียบร้อยแล้ว', 'success');
               } catch (error) {
                   console.error('Error deleting pig:', error);
                   showNotification('เกิดข้อผิดพลาดในการลบ: ' + error.message, 'error');
               }
           }
       }

       function confirmDeleteRecord(type, recordId) {
           if (confirm('คุณแน่ใจหรือไม่ที่จะลบข้อมูลนี้?')) {
               try {
                   deleteRecord(type, recordId);
                   
                   // Update corresponding table
                   switch(type) {
                       case 'feeding':
                           updateFeedingTable();
                           break;
                       case 'health':
                           updateHealthTable();
                           break;
                       case 'stock':
                           updateStockTable();
                           break;
                       case 'sales':
                           updateSalesTable();
                           break;
                   }
                   
                   updateKPIs();
                   showNotification('ลบข้อมูลเรียบร้อยแล้ว', 'success');
               } catch (error) {
                   console.error(`Error deleting ${type} record:`, error);
                   showNotification('เกิดข้อผิดพลาดในการลบ: ' + error.message, 'error');
               }
           }
       }

       // ==================== DEMO DATA & UTILITIES ====================
       
       function loadDemoData() {
           if (!confirm('โหลดข้อมูลตัวอย่างจะเป็นการเพิ่มข้อมูลเข้าไปในระบบ คุณต้องการดำเนินการต่อหรือไม่?')) {
               return;
           }
           
           try {
               debugLog('Loading demo data...');
               
               // Add demo pigs (only 3 records)
               const demoPigs = [
                   {
                       pigId: 'DEMO001',
                       group: 'ขุน',
                       initialWeight: 25,
                       currentWeight: 95,
                       gender: 'ขุน',
                       breed: 'ลูกผสม',
                       entryDate: '2025-03-01'
                   },
                   {
                       pigId: 'DEMO002',
                       group: 'ขุน',
                       initialWeight: 28,
                       currentWeight: 115,
                       gender: 'ขุน',
                       breed: 'ยอร์คเชียร์',
                       entryDate: '2025-02-15'
                   },
                   {
                       pigId: 'DEMO003',
                       group: 'รุ่น',
                       initialWeight: 16,
                       currentWeight: 45,
                       gender: 'เมีย',
                       breed: 'ลูกผสม',
                       entryDate: '2025-04-01'
                   }
               ];

               demoPigs.forEach(pig => {
                   // Check if pig already exists
                   if (!farmData.pigs.find(p => p.pigId === pig.pigId)) {
                       addPig(pig);
                   }
               });

               // Add demo feeding records (last 7 days)
               const today = new Date();
               for (let i = 6; i >= 0; i--) {
                   const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                   const dateStr = date.toISOString().split('T')[0];
                   
                   addRecord('feeding', {
                       date: dateStr,
                       group: 'ขุน',
                       feedType: 'หมูขุน',
                       amount: 45 + Math.random() * 5,
                       cost: (45 + Math.random() * 5) * 16,
                       notes: 'ข้อมูลตัวอย่าง'
                   });
               }

               // Add demo health record
               addRecord('health', {
                   date: '2025-05-15',
                   pigId: 'DEMO001',
                   type: 'วัคซีน',
                   vaccine: 'PRRS',
                   cost: 150,
                   notes: 'วัคซีนตามกำหนด'
               });

               // Add demo stock
               addRecord('stock', {
                   date: '2025-06-01',
                   type: 'อาหาร',
                   item: 'อาหารหมูขุน',
                   quantity: 500,
                   unit: 'กก.',
                   unitPrice: 16
               });

               updateAllTables();
               updateKPIs();
               showNotification('โหลดข้อมูลตัวอย่างเรียบร้อยแล้ว', 'success');
               
           } catch (error) {
               console.error('Error loading demo data:', error);
               showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูลตัวอย่าง: ' + error.message, 'error');
           }
       }

       function clearAllData() {
           if (!confirm('คุณแน่ใจหรือไม่ที่จะล้างข้อมูลทั้งหมด?\n\nการดำเนินการนี้ไม่สามารถยกเลิกได้!')) {
               return;
           }
           
           if (!confirm('ยืนยันอีกครั้ง: ลบข้อมูลทั้งหมดในระบบ?')) {
               return;
           }
           
           try {
               debugLog('Clearing all data...');
               
               // Clear all data
               farmData.pigs = [];
               farmData.feeding = [];
               farmData.health = [];
               farmData.stock = [];
               farmData.sales = [];
               farmData.settings = {};
               
               // Clear localStorage
               Object.values(STORAGE_KEYS).forEach(key => {
                   localStorage.removeItem(key);
               });
               
               updateAllTables();
               updateKPIs();
               updateSettingsPage();
               showNotification('ล้างข้อมูลทั้งหมดเรียบร้อยแล้ว', 'success');
               
           } catch (error) {
               console.error('Error clearing data:', error);
               showNotification('เกิดข้อผิดพลาดในการล้างข้อมูล: ' + error.message, 'error');
           }
       }

       function exportData() {
           try {
               const dataToExport = {
                   pigs: farmData.pigs,
                   feeding: farmData.feeding,
                   health: farmData.health,
                   stock: farmData.stock,
                   sales: farmData.sales,
                   exportDate: new Date().toISOString(),
                   version: '2.0'
               };

               const dataStr = JSON.stringify(dataToExport, null, 2);
               const dataBlob = new Blob([dataStr], {type: 'application/json'});
               
               const link = document.createElement('a');
               link.href = URL.createObjectURL(dataBlob);
               link.download = `farm-data-backup-${new Date().toISOString().split('T')[0]}.json`;
               link.click();
               
               showNotification('สำรองข้อมูลเรียบร้อยแล้ว', 'success');
               
           } catch (error) {
               console.error('Error exporting data:', error);
               showNotification('เกิดข้อผิดพลาดในการสำรองข้อมูล: ' + error.message, 'error');
           }
       }

       function importData(fileInput) {
           const file = fileInput.files[0];
           if (!file) return;
           
           const reader = new FileReader();
           reader.onload = function(event) {
               try {
                   const importedData = JSON.parse(event.target.result);
                   
                   // Validate imported data structure
                   const requiredKeys = ['pigs', 'feeding', 'health', 'stock'];
                   const missingKeys = requiredKeys.filter(key => !importedData.hasOwnProperty(key));
                   
                   if (missingKeys.length > 0) {
                       throw new Error(`รูปแบบไฟล์ไม่ถูกต้อง: ไม่พบข้อมูล ${missingKeys.join(', ')}`);
                   }
                   
                   if (!confirm('การนำเข้าข้อมูลจะแทนที่ข้อมูลทั้งหมดที่มีอยู่ คุณต้องการดำเนินการต่อหรือไม่?')) {
                       return;
                   }
                   
                   // Import data
                   farmData.pigs = Array.isArray(importedData.pigs) ? importedData.pigs : [];
                   farmData.feeding = Array.isArray(importedData.feeding) ? importedData.feeding : [];
                   farmData.health = Array.isArray(importedData.health) ? importedData.health : [];
                   farmData.stock = Array.isArray(importedData.stock) ? importedData.stock : [];
                   farmData.sales = Array.isArray(importedData.sales) ? importedData.sales : [];
                   farmData.settings = importedData.settings || {};
                   
                   // Ensure all records have IDs
                   [farmData.pigs, farmData.feeding, farmData.health, farmData.stock, farmData.sales].forEach(collection => {
                       collection.forEach(record => {
                           if (!record.id) {
                               record.id = generateId();
                           }
                       });
                   });
                   
                   saveData();
                   updateAllTables();
                   updateKPIs();
                   updateSettingsPage();
                   
                   showNotification('นำเข้าข้อมูลเรียบร้อยแล้ว', 'success');
                   
               } catch (error) {
                   console.error('Error importing data:', error);
                   showNotification('เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message, 'error');
               }
           };
           
           reader.readAsText(file);
           fileInput.value = ''; // Clear file input
       }

       // ==================== NOTIFICATION SYSTEM ====================
       
       function showNotification(message, type = 'info') {
           const notification = document.createElement('div');
           notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'warning'}`;
           notification.style.cssText = `
               position: fixed;
               top: 20px;
               right: 20px;
               z-index: 2000;
               min-width: 250px;
               max-width: 400px;
               animation: slideIn 0.3s ease-out;
           `;
           notification.textContent = message;
           
           document.body.appendChild(notification);
           
           // Auto remove after 4 seconds
           setTimeout(() => {
               notification.style.animation = 'slideOut 0.3s ease-in';
               setTimeout(() => {
                   if (notification.parentNode) {
                       notification.remove();
                   }
               }, 300);
           }, 4000);
       }

       // ==================== DEBUG FUNCTIONS ====================
       
       function toggleDebug() {
           debugMode = !debugMode;
           const panel = document.getElementById('debugPanel');
           
           if (debugMode) {
               panel.classList.remove('hidden');
               updateDebugPanel();
               showNotification('Debug mode: ON', 'info');
           } else {
               panel.classList.add('hidden');
               showNotification('Debug mode: OFF', 'info');
           }
       }

       // ==================== UPDATE ALL TABLES ====================
       
       function updateAllTables() {
           updatePigsTable();
           updateFeedingTable();
           updateHealthTable();
           updateStockTable();
           updateSalesTable();
       }

       // ==================== INITIALIZATION ====================
       
       function initApp() {
           debugLog('Initializing application...');
           
           try {
               // Load data from localStorage
               loadData();
               
               // Set current date
               document.getElementById('current-date').textContent = 
                   new Date().toLocaleDateString('th-TH', { 
                       year: 'numeric', 
                       month: 'long', 
                       day: 'numeric' 
                   });

               // Set default dates for forms
               const today = new Date().toISOString().split('T')[0];
               document.querySelectorAll('input[type="date"]').forEach(input => {
                   if (!input.value) {
                       input.value = today;
                   }
               });

               // Update dashboard
               updateKPIs();
               updateAlerts();
               updateSettingsPage();
               
               debugLog('✅ Application initialized successfully');
               
               // Show welcome message only if no data exists
               if (farmData.pigs.length === 0 && farmData.feeding.length === 0) {
                   showNotification('ยินดีต้อนรับ! ระบบพร้อมใช้งาน', 'info');
               }
               
           } catch (error) {
               console.error('Error initializing app:', error);
               showNotification('เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ' + error.message, 'error');
           }
       }

       // ==================== EVENT LISTENERS ====================
       
       document.addEventListener('DOMContentLoaded', function() {
           initApp();
           
           // Handle modal clicks outside content
           document.querySelectorAll('.modal').forEach(modal => {
               modal.addEventListener('click', function(e) {
                   if (e.target === modal) {
                       modal.classList.remove('active');
                   }
               });
           });

           // Handle escape key for modals
           document.addEventListener('keydown', function(e) {
               if (e.key === 'Escape') {
                   document.querySelectorAll('.modal.active').forEach(modal => {
                       modal.classList.remove('active');
                   });
               }
           });

           // Auto-save periodically (every 30 seconds)
           setInterval(function() {
               if (farmData.pigs.length > 0 || farmData.feeding.length > 0) {
                   saveData();
                   debugLog('Auto-save completed');
               }
           }, 30000);

           // Handle online/offline status
           window.addEventListener('online', function() {
               showNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
           });

           window.addEventListener('offline', function() {
               showNotification('ใช้งานออฟไลน์', 'warning');
           });
       });

       // Error handling
       window.addEventListener('error', function(e) {
           console.error('Global error:', e.error);
           showNotification('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'error');
       });

       window.addEventListener('unhandledrejection', function(e) {
           console.error('Unhandled promise rejection:', e.reason);
           showNotification('เกิดข้อผิดพลาดในระบบ', 'error');
       });

       // ==================== GLOBAL FUNCTIONS ====================
       
       // Export functions for external use
       window.FarmManager = {
           data: farmData,
           exportData,
           loadDemoData,
           clearAllData,
           toggleDebug,
           updateKPIs,
           saveData,
           loadData
       };

       // Add CSS animations
       const style = document.createElement('style');
       style.textContent = `
           @keyframes slideIn {
               from {
                   transform: translateX(100%);
                   opacity: 0;
               }
               to {
                   transform: translateX(0);
                   opacity: 1;
               }
           }

           @keyframes slideOut {
               from {
                   transform: translateX(0);
                   opacity: 1;
               }
               to {
                   transform: translateX(100%);
                   opacity: 0;
               }
           }

           .error {
               border-color: var(--danger) !important;
               background-color: #fef2f2 !important;
           }

           .error-message {
               color: var(--danger);
               font-size: 0.875rem;
               margin-top: 0.25rem;
               display: block;
           }

           .error-message.hidden {
               display: none;
           }

           @media (max-width: 767px) {
               .table-container {
                   font-size: 0.875rem;
               }
               
               .btn {
                   font-size: 0.875rem;
                   padding: 0.5rem 0.75rem;
               }
               
               .kpi-grid {
                   grid-template-columns: repeat(2, 1fr);
               }
               
               .dashboard-grid {
                   grid-template-columns: 1fr;
               }
               
               .modal-content {
                   margin: 0.5rem;
                   max-height: calc(100vh - 1rem);
               }
               
               .quick-actions {
                   grid-template-columns: repeat(2, 1fr);
               }
           }
       `;
       document.head.appendChild(style);

   </script>
</body>
</html>

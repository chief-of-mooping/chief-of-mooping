// Load settings (default values only)
        function loadSettings() {
            // Just set default values to form fields
            document.getElementById('businessName').value = businessSettings.name;
            document.getElementById('targetProfit').value = businessSettings.targetProfit;
            document.getElementById('businessLocation').value = businessSettings.location;
            document.getElementById('workingHours').value = businessSettings.workingHours;
        }

        // Save settings (in memory only)
        function saveSettings() {
            businessSettings = {
                name: document.getElementById('businessName').value,
                targetProfit: parseFloat(document.getElementById('targetProfit').value),
                location: document.getElementById('businessLocation').value,
                workingHours: parseFloat(document.getElementById('workingHours').value)
            };
            alert('บันทึกการตั้งค่าเรียบร้อยแล้ว! (เก็บไว้ในเซสชันปัจจุบันเท่านั้น)');
            closeSettings();
        }

        // Modal functions
        function openSettings() {
            document.getElementById('settingsPanel').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        // History functions
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                displayHistory();
            }
        }

        function displayHistory() {
            const content = document.getElementById('historyContent');
            if (calculationHistory.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #666;">ยังไม่มีประวัติการคำนวณ</p>';
                return;
            }

            content.innerHTML = calculationHistory.map((item, index) => `
                <div class="history-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>การคำนวณครั้งที่ ${calculationHistory.length - index}</strong>
                        <span style="color: #666; font-size: 0.9rem;">${item.timestamp}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div><strong>ต้นทุน:</strong> ${item.cost} บาท</div>
                        <div><strong>ราคาแนะนำ:</strong> ${item.price} บาท</div>
                        <div><strong>กำไร:</strong> ${item.profit} บาท</div>
                        <div><strong>ความเสี่ยง:</strong> ${item.risk}</div>
                    </div>
                </div>
            `).reverse().join('');
        }

        // ========== ORIGINAL AI ANALYSIS FUNCTIONS ========== //

        // Analyze 6 key factors
        function analyzeFactors(inputs) {
            const factors = {};

            // 1. Pork Price Analysis (ราคาเนื้อหมู)
            if (inputs.porkPrice < 150) {
                factors.porkPrice = { score: 0.8, impact: 'positive', description: 'ราคาเนื้อหมูต่ำ เหมาะสำหรับเพิ่มกำไร' };
            } else if (inputs.porkPrice > 200) {
                factors.porkPrice = { score: 0.3, impact: 'negative', description: 'ราคาเนื้อหมูสูง ควรปรับราคาขายหรือหาซัพพลายเออร์ใหม่' };
            } else {
                factors.porkPrice = { score: 0.6, impact: 'neutral', description: 'ราคาเนื้อหมูในระดับปกติ' };
            }

            // 2. Fuel Cost Analysis (ค่าแก๊ส/ถ่าน)
            if (inputs.fuelCost < 100) {
                factors.fuelCost = { score: 0.7, impact: 'positive', description: 'ค่าเชื้อเพลิงต่ำ ช่วยลดต้นทุน' };
            } else if (inputs.fuelCost > 200) {
                factors.fuelCost = { score: 0.4, impact: 'negative', description: 'ค่าเชื้อเพลิงสูง พิจารณาเปลี่ยนประเภทเชื้อเพลิง' };
            } else {
                factors.fuelCost = { score: 0.6, impact: 'neutral', description: 'ค่าเชื้อเพลิงในระดับปกติ' };
            }

            // 3. Weather Analysis (สภาพอากาศ)
            switch (inputs.weather) {
                case 'sunny':
                    factors.weather = { score: 0.8, impact: 'positive', description: 'อากาศแดดจัด เพิ่มความต้องการหมูปิ้ง' };
                    break;
                case 'rainy':
                    factors.weather = { score: 0.3, impact: 'negative', description: 'ฝนตก ลูกค้าลดลง ควรมีแผนป้องกัน' };
                    break;
                case 'cold':
                    factors.weather = { score: 0.7, impact: 'positive', description: 'อากาศหนาว เพิ่มความต้องการอาหารร้อน' };
                    break;
                default:
                    factors.weather = { score: 0.5, impact: 'neutral', description: 'สภาพอากาศปกติ' };
            }

            // 4. Economic Analysis (สภาพเศรษฐกิจ)
            switch (inputs.economic) {
                case 'good':
                    factors.economic = { score: 0.8, impact: 'positive', description: 'เศรษฐกิจดี กำลังซื้อสูง สามารถขายราคาดี' };
                    break;
                case 'poor':
                    factors.economic = { score: 0.3, impact: 'negative', description: 'เศรษฐกิจไม่ดี ลูกค้าซื้อน้อยลง ควรปรับราคาให้เข้าถึงได้' };
                    break;
                default:
                    factors.economic = { score: 0.6, impact: 'neutral', description: 'สภาพเศรษฐกิจปกติ' };
            }

            // 5. Season Analysis (ฤดูกาล)
            switch (inputs.season) {
                case 'hot':
                    factors.season = { score: 0.4, impact: 'negative', description: 'หน้าร้อน ความต้องการลดลง ควรโปรโมท' };
                    break;
                case 'cool':
                    factors.season = { score: 0.8, impact: 'positive', description: 'หน้าหนาว ความต้องการสูง เพิ่มราคาได้' };
                    break;
                default:
                    factors.season = { score: 0.6, impact: 'neutral', description: 'ฤดูกาลปกติ' };
            }

            // 6. Political Analysis (สถานการณ์การเมือง)
            switch (inputs.political) {
                case 'stable':
                    factors.political = { score: 0.7, impact: 'positive', description: 'การเมืองมั่นคง ธุรกิจเติบโตได้' };
                    break;
                case 'crisis':
                    factors.political = { score: 0.3, impact: 'negative', description: 'การเมืองไม่มั่นคง ควรระวังการลงทุน' };
                    break;
                default:
                    factors.political = { score: 0.5, impact: 'neutral', description: 'สถานการณ์การเมืองไม่แน่นอน' };
            }

            return factors;
        }

        // Calculate risk assessment
        function calculateRisk(inputs, factors) {
            const scores = Object.values(factors).map(f => f.score);
            const averageScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            
            // Additional risk factors
            let riskScore = averageScore;
            
            // High cost risks
            if (inputs.porkPrice > 220) riskScore -= 0.1;
            if (inputs.fuelCost > 250) riskScore -= 0.1;
            
            // Market risks
            if (inputs.dailySticks < 100) riskScore -= 0.1; // Low volume risk
            if (businessSettings.location === 'street') riskScore -= 0.05; // Street vendor risk
            
            // Determine risk level
            let level, color;
            if (riskScore >= 0.7) {
                level = 'ต่ำ';
                color = '#228B22';
            } else if (riskScore >= 0.5) {
                level = 'ปานกลาง';
                color = '#FFD700';
            } else {
                level = 'สูง';
                color = '#FF6347';
            }

            return { score: riskScore, level: level, color: color };
        }

        // Calculate demand multiplier based on factors
        function calculateDemandMultiplier(inputs, factors) {
            let multiplier = 1.0;

            // Weather impact
            if (inputs.weather === 'sunny' || inputs.weather === 'cold') multiplier += 0.1;
            if (inputs.weather === 'rainy') multiplier -= 0.2;

            // Economic impact
            if (inputs.economic === 'good') multiplier += 0.15;
            if (inputs.economic === 'poor') multiplier -= 0.15;

            // Season impact
            if (inputs.season === 'cool') multiplier += 0.1;
            if (inputs.season === 'hot') multiplier -= 0.1;

            // Location impact
            switch (businessSettings.location) {
                case 'university':
                    multiplier += 0.05;
                    break;
                case 'mall':
                    multiplier += 0.1;
                    break;
                case 'street':
                    multiplier -= 0.05;
                    break;
            }

            return Math.max(0.7, Math.min(1.3, multiplier));
        }

        // Calculate price adjustment factors
        function calculatePriceAdjustment(inputs, factors) {
            let costMultiplier = 1.0;
            let volumeMultiplier = 1.0;

            // High input costs require adjustment
            if (inputs.porkPrice > 200) costMultiplier += 0.05;
            if (inputs.fuelCost > 200) costMultiplier += 0.03;

            // Political instability increases costs
            if (inputs.political === 'crisis') costMultiplier += 0.02;

            // Weather affects volume
            if (inputs.weather === 'rainy') volumeMultiplier -= 0.15;
            if (inputs.weather === 'sunny') volumeMultiplier += 0.05;

            return { costMultiplier, volumeMultiplier };
        }

        // Round price to appropriate point
        function roundToAppropriatePrice(price) {
            if (price <= 10) return Math.round(price * 2) / 2; // Round to 0.5
            if (price <= 50) return Math.round(price); // Round to 1
            return Math.round(price / 5) * 5; // Round to 5
        }

        // Generate marketing strategies based on customer journey
        function generateMarketingStrategies(inputs, factors) {
            const strategies = [];

            // Awareness Stage
            strategies.push({
                stage: 'Awareness (รับรู้)',
                strategy: 'Social Media Marketing',
                description: 'โพสต์รูปหมูปิ้งสวยๆ บน Facebook/Instagram พร้อมแฮชแท็กท้องถิ่น',
                recommendation: inputs.weather === 'sunny' ? 'เน้นโพสต์เวลา 16:00-19:00' : 'โพสต์คลิป Live การปิ้ง'
            });

            // Interest Stage
            if (factors.economic.score >= 0.6) {
                strategies.push({
                    stage: 'Interest (สนใจ)',
                    strategy: 'Content Marketing',
                    description: 'สร้างคอนเทนต์เรื่องความอร่อย วัตถุดิบคุณภาพ',
                    recommendation: 'ทำคลิป Behind the scenes การเลือกเนื้อหมู และวิธีการปิ้ง'
                });
            }

            // Consideration Stage
            strategies.push({
                stage: 'Consideration (พิจารณา)',
                strategy: 'Promotional Offers',
                description: inputs.season === 'hot' ? 'โปรโมชั่นซื้อ 10 แถม 1' : 'เซ็ตคู่กับเครื่องดื่มร้อน',
                recommendation: inputs.economic.score < 0.5 ? 'เน้นราคาสุดคุ้ม' : 'เน้นคุณภาพพรีเมียม'
            });

            // Purchase Stage
            strategies.push({
                stage: 'Purchase (ซื้อ)',
                strategy: 'Point of Sale',
                description: 'ตกแต่งร้านให้น่าสนใจ มีป้ายราคาชัดเจน',
                recommendation: inputs.weather === 'rainy' ? 'เพิ่มที่นั่งมีหลังคา' : 'จัดโปรโมชั่น Take away'
            });

            // Retention Stage
            strategies.push({
                stage: 'Retention (รักษาลูกค้า)',
                strategy: 'Loyalty Program',
                description: 'ระบบสะสมแสตมป์ หรือ Line Official Account',
                recommendation: 'ส่งข้อความแจ้งโปรโมชั่นพิเศษแก่ลูกค้าประจำ'
            });

            // Advocacy Stage
            if (factors.economic.score >= 0.7) {
                strategies.push({
                    stage: 'Advocacy (ประกาศเซลส์)',
                    strategy: 'Referral Program',
                    description: 'แนะนำเพื่อนมาซื้อ ได้ส่วนลด',
                    recommendation: 'ให้ลูกค้าถ่ายรูป Review บน Social Media รับฟรี 1 ไม้'
                });
            }

            return strategies;
        }

        // Generate AI reasoning
        function generateAIReasoning(inputs, factors, riskAssessment) {
            let reasoning = `<strong>AI วิเคราะห์แล้วพบว่า:</strong><br><br>`;

            // Risk assessment summary
            reasoning += `📊 <strong>ระดับความเสี่ยงโดยรวม: ${riskAssessment.level}</strong><br>`;

            // Key insights
            const positiveFactors = Object.entries(factors).filter(([key, factor]) => factor.impact === 'positive');
            const negativeFactors = Object.entries(factors).filter(([key, factor]) => factor.impact === 'negative');

            if (positiveFactors.length > 0) {
                reasoning += `<br>✅ <strong>ปัจจัยบวก:</strong><br>`;
                positiveFactors.forEach(([key, factor]) => {
                    reasoning += `• ${factor.description}<br>`;
                });
            }

            if (negativeFactors.length > 0) {
                reasoning += `<br>⚠️ <strong>ปัจจัยที่ต้องระวัง:</strong><br>`;
                negativeFactors.forEach(([key, factor]) => {
                    reasoning += `• ${factor.description}<br>`;
                });
            }

            // Strategic recommendations
            reasoning += `<br>💡 <strong>คำแนะนำเชิงกลยุทธ์:</strong><br>`;
            
            if (inputs.porkPrice > 200) {
                reasoning += `• พิจารณาหาซัพพลายเออร์เนื้อหมูราคาดีกว่า<br>`;
            }
            
            if (inputs.weather === 'rainy') {
                reasoning += `• เตรียมพื้นที่ในร่มหรือเต็นท์สำหรับลูกค้า<br>`;
            }
            
            if (factors.economic.score < 0.5) {
                reasoning += `• ปรับเมนูให้มีตัวเลือกราคาประหยัด<br>`;
            }
            
            if (inputs.dailySticks < 150) {
                reasoning += `• เพิ่มช่องทางการตลาดออนไลน์เพื่อเพิ่มยอดขาย<br>`;
            }

            reasoning += `<br>🎯 <strong>เป้าหมายระยะสั้น:</strong> เพิ่มยอดขายให้ได้ ${Math.ceil(inputs.dailySticks * 1.2)} ไม้/วัน<br>`;
            reasoning += `🚀 <strong>เป้าหมายระยะยาว:</strong> สร้างฐานลูกค้าประจำและเพิ่มความได้เปรียบทางการแข่งขัน`;

            return reasoning;
        }

        // AI Analysis Engine (Original)
        function performAIAnalysis(inputs) {
            // Calculate basic costs
            const meatCostPerStick = (inputs.porkPrice * inputs.meatWeight) / 1000;
            const stickCostPerStick = inputs.stickCost / 100;
            const overheadCostPerStick = inputs.overheadCost / inputs.dailySticks;
            const laborCostPerStick = (inputs.laborCost * businessSettings.workingHours) / inputs.dailySticks;
            
            const baseCostPerStick = meatCostPerStick + stickCostPerStick + 
                                   inputs.seasoningCost + overheadCostPerStick + 
                                   laborCostPerStick + (inputs.fuelCost / inputs.dailySticks);

            // AI Factor Analysis
            const factors = analyzeFactors(inputs);
            const riskAssessment = calculateRisk(inputs, factors);
            const demandMultiplier = calculateDemandMultiplier(inputs, factors);
            const priceAdjustment = calculatePriceAdjustment(inputs, factors);

            // Calculate suggested price with AI adjustments
            const targetProfitMultiplier = 1 + (businessSettings.targetProfit / 100);
            const adjustedCost = baseCostPerStick * priceAdjustment.costMultiplier;
            const suggestedPrice = adjustedCost * targetProfitMultiplier * demandMultiplier;

            // Round to appropriate price point
            const finalPrice = roundToAppropriatePrice(suggestedPrice);
            const actualProfit = finalPrice - adjustedCost;
            const dailyProfit = actualProfit * inputs.dailySticks * priceAdjustment.volumeMultiplier;

            return {
                costPerStick: adjustedCost,
                suggestedPrice: finalPrice,
                profitMargin: actualProfit,
                dailyProfit: dailyProfit,
                factors: factors,
                riskLevel: riskAssessment.level,
                riskScore: riskAssessment.score,
                marketingStrategies: generateMarketingStrategies(inputs, factors),
                aiReasoning: generateAIReasoning(inputs, factors, riskAssessment)
            };
        }

        // Display results (Original)
        function displayResults(result) {
            document.getElementById('costPerStick').textContent = result.costPerStick.toFixed(2);
            document.getElementById('suggestedPrice').textContent = result.suggestedPrice.toFixed(2);
            document.getElementById('profitMargin').textContent = result.profitMargin.toFixed(2);
            document.getElementById('dailyProfit').textContent = result.dailyProfit.toFixed(0);

            // Update risk indicator
            const riskIndicator = document.getElementById('riskIndicator');
            const riskLevel = document.getElementById('riskLevel');
            const riskPosition = result.riskScore * 100;
            
            riskIndicator.style.left = `${riskPosition}%`;
            riskIndicator.style.backgroundColor = result.riskLevel === 'ต่ำ' ? '#228B22' : 
                                                 result.riskLevel === 'ปานกลาง' ? '#FFD700' : '#FF6347';
            riskLevel.textContent = `ความเสี่ยง: ${result.riskLevel} (${(result.riskScore * 100).toFixed(0)}%)`;

            // Display factor analysis
            const factorAnalysis = document.getElementById('factorAnalysis');
            factorAnalysis.innerHTML = Object.entries(result.factors).map(([key, factor]) => `
                <div class="factor-item">
                    <strong>${getFactorName(key)}:</strong><br>
                    <span style="color: ${factor.impact === 'positive' ? '#228B22' : factor.impact === 'negative' ? '#DC143C' : '#666'}">
                        ${factor.description}
                    </span>
                </div>
            `).join('');

            // Display AI reasoning
            document.getElementById('aiReasoning').innerHTML = result.aiReasoning;

            // Display marketing strategies
            const marketingStrategies = document.getElementById('marketingStrategies');
            marketingStrategies.innerHTML = result.marketingStrategies.map(strategy => `
                <div class="strategy-item">
                    <strong>${strategy.stage}: ${strategy.strategy}</strong><br>
                    <span style="color: #666; font-size: 0.9rem;">${strategy.description}</span><br>
                    <span style="color: #8B4513; font-weight: 500;">💡 ${strategy.recommendation}</span>
                </div>
            `).join('');
        }

        // Helper function to get factor display names
        function getFactorName(key) {
            const names = {
                porkPrice: 'ราคาเนื้อหมู',
                fuelCost: 'ค่าแก๊ส/ถ่าน',
                weather: 'สภาพอากาศ',
                economic: 'สภาพเศรษฐกิจ',
                season: 'ฤดูกาล',
                political: 'สถานการณ์การเมือง'
            };
            return names[key] || key;
        }

        // ========== REALTIME FEATURES (Original) ========== //
        
        // ตัวแปรสำหรับ realtime
        let realtimeInterval;
        let isRealtimeActive = false;
        
        // ฟังก์ชันสร้างราคาจำลองที่เหมือนจริง
        function generateRealisticPrice(currentPrice, type) {
            const variation = (Math.random() - 0.5) * 10; // เปลี่ยนแปลง ±5
            let newPrice;
            
            if (type === 'pork') {
                newPrice = Math.max(120, Math.min(280, currentPrice + variation));
            } else if (type === 'fuel') {
                newPrice = Math.max(80, Math.min(350, currentPrice + variation));
            }
            
            return Math.round(newPrice * 100) / 100; // ปัดเศษ 2 ตำแหน่ง
        }
        
        // ฟังก์ชันอัพเดตราคาแบบ realtime
        function updateRealtimePrices() {
            const porkInput = document.getElementById('porkPrice');
            const fuelInput = document.getElementById('fuelCost');
            
            // เก็บราคาเก่า
            const oldPorkPrice = parseFloat(porkInput.value);
            const oldFuelPrice = parseFloat(fuelInput.value);
            
            // สร้างราคาใหม่
            const newPorkPrice = generateRealisticPrice(oldPorkPrice, 'pork');
            const newFuelPrice = generateRealisticPrice(oldFuelPrice, 'fuel');
            
            // อัพเดตถ้าเปลี่ยนแปลงมากกว่า 0.5 บาท
            if (Math.abs(newPorkPrice - oldPorkPrice) > 0.5) {
                animatePriceChange(porkInput, oldPorkPrice, newPorkPrice, 'หมู');
            }
            
            if (Math.abs(newFuelPrice - oldFuelPrice) > 0.5) {
                animatePriceChange(fuelInput, oldFuelPrice, newFuelPrice, 'เชื้อเพลิง');
            }
        }
        
        // ฟังก์ชันทำเอฟเฟคเมื่อราคาเปลี่ยน
        function animatePriceChange(input, oldPrice, newPrice, itemName) {
            // เปลี่ยนสีตามการขึ้น/ลงราคา
            if (newPrice > oldPrice) {
                input.style.borderColor = '#ff6b6b';
                input.style.backgroundColor = '#ffebee';
                showPriceAlert(itemName, 'เพิ่มขึ้น', newPrice - oldPrice, 'up');
            } else {
                input.style.borderColor = '#4caf50';
                input.style.backgroundColor = '#e8f5e9';
                showPriceAlert(itemName, 'ลดลง', oldPrice - newPrice, 'down');
            }
            
            // อัพเดตราคา
            input.value = newPrice;
            
            // ล้างสีหลัง 3 วินาที
            setTimeout(() => {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            }, 3000);
            
            // คำนวณใหม่อัตโนมัติ
            calculatePricing();
        }
        
        // ฟังก์ชันแสดงการแจ้งเตือน
        function showPriceAlert(itemName, direction, amount, type) {
            // สร้าง div สำหรับแจ้งเตือน
            const alertDiv = document.createElement('div');
            alertDiv.className = 'price-alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
                max-width: 300px;
                ${type === 'up' ? 
                    'background: #ffebee; border-left: 4px solid #ff6b6b; color: #c62828;' : 
                    'background: #e8f5e9; border-left: 4px solid #4caf50; color: #2e7d32;'}
            `;
            
            alertDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>ราคา${itemName}${direction}</strong><br>
                        <small>${amount.toFixed(1)} บาท</small>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // ลบแจ้งเตือนอัตโนมัติหลัง 5 วินาที
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // ฟังก์ชันเริ่ม realtime
        function startRealtime() {
            if (!isRealtimeActive) {
                isRealtimeActive = true;
                realtimeInterval = setInterval(updateRealtimePrices, 15000); // ทุก 15 วินาที
                
                // อัพเดตปุ่ม
                const button = document.getElementById('realtimeToggle');
                if (button) {
                    button.innerHTML = '⏸️ หยุด Realtime';
                    button.style.background = '#f44336';
                }
                
                console.log('🔄 Realtime started!');
            }
        }
        
        // ฟังก์ชันหยุด realtime
        function stopRealtime() {
            if (isRealtimeActive) {
                isRealtimeActive = false;
                clearInterval(realtimeInterval);
                
                // อัพเดตปุ่ม
                const button = document.getElementById('realtimeToggle');
                if (button) {
                    button.innerHTML = '🔄 เริ่ม Realtime';
                    button.style.background = '#4CAF50';
                }
                
                console.log('⏸️ Realtime stopped!');
            }
        }
        
        // ฟังก์ชันสลับ realtime
        function toggleRealtime() {
            if (isRealtimeActive) {
                stopRealtime();
            } else {
                startRealtime();
            }
        }
        
        // สร้างปุ่ม realtime
        function createRealtimeButton() {
            const button = document.createElement('button');
            button.id = 'realtimeToggle';
            button.innerHTML = '🔄 เริ่ม Realtime';
            button.onclick = toggleRealtime;
            button.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1000;
                padding: 12px 18px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            `;
            
            // เอฟเฟค hover
            button.addEventListener('mouseenter', () => {
                button.style.transform = 'scale(1.05)';
            });
            
            button.addEventListener('mouseleave', () => {
                button.style.transform = 'scale(1)';
            });
            
            document.body.appendChild(button);
        }
        
        // สร้างสไตล์ CSS สำหรับ animation
        function addRealtimeStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { 
                        transform: translateX(100%); 
                        opacity: 0; 
                    }
                    to { 
                        transform: translateX(0); 
                        opacity: 1; 
                    }
                }
                
                @keyframes bounceIn {
                    from { 
                        transform: translateX(-50%) scale(0.3); 
                        opacity: 0; 
                    }
                    50% { 
                        transform: translateX(-50%) scale(1.05); 
                    }
                    to { 
                        transform: translateX(-50%) scale(1); 
                        opacity: 1; 
                    }
                }
                
                @keyframes fadeOut {
                    from { 
                        opacity: 1; 
                        transform: translateX(-50%) scale(1); 
                    }
                    to { 
                        opacity: 0; 
                        transform: translateX(-50%) scale(0.8); 
                    }
                }
                
                @keyframes bounce {
                    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                    40% { transform: translateY(-10px); }
                    60% { transform: translateY(-5px); }
                }
                
                .price-alert {
                    animation: slideIn 0.3s ease;
                }
                
                input[type="number"] {
                    transition: all 0.3s ease;
                }
            `;
            document.head.appendChild(style);
        }

        // ========== INITIALIZATION ========== //

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Load default settings
            loadSettings();
            
            // Initialize profile and AI display
            loadProfileForm();
            updateAIDisplay();
            updateChatTitle();
            
            // Initialize chat system
            initializeChat();

            // Add realtime styles and button
            addRealtimeStyles();
            createRealtimeButton();

            // Add smooth scrolling to results
            window.addEventListener('scroll', function() {
                const cards = document.querySelectorAll('.card, .result-section');
                cards.forEach(card => {
                    const cardTop = card.getBoundingClientRect().top;
                    const cardBottom = card.getBoundingClientRect().bottom;
                    const isVisible = cardTop < window.innerHeight && cardBottom > 0;
                    
                    if (isVisible && !card.classList.contains('animate-slide-up')) {
                        card.classList.add('animate-slide-up');
                    }
                });
            });

            // Close modal when clicking outside
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsPanel) {
                settingsPanel.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeSettings();
                    }
                });
            }

            // Real-time input validation and formatting
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (this.value < 0) this.value = 0;
                    if (this.hasAttribute('max') && parseFloat(this.value) > parseFloat(this.getAttribute('max'))) {
                        this.value = this.getAttribute('max');
                    }
                });
            });

            console.log('🍖 AI ระบบตั้งราคาหมูปิ้งอัจฉริยะ พร้อมระบบ Chat เริ่มต้นแล้ว!');
        });

        // ปิด realtime เมื่อออกจากหน้า
        window.addEventListener('beforeunload', () => {
            stopRealtime();
        });

        // Performance optimization
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Layout recalculation happens silently
            }, 250);
        });

        // Export/Import functionality (optional)
        function exportData() {
            try {
                const data = {
                    settings: businessSettings,
                    history: calculationHistory,
                    aiMemory: {
                        profile: aiMemory.profile,
                        usage: aiMemory.usage,
                        patterns: aiMemory.patterns,
                        learning: aiMemory.learning,
                        chatHistory: aiMemory.chatHistory
                    },
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `moo-ping-ai-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showFeedback('ส่งออกข้อมูล AI เรียบร้อย!', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showFeedback('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Import business settings
                    if (data.settings) businessSettings = data.settings;
                    
                    // Import calculation history
                    if (data.history) calculationHistory = data.history;
                    
                    // Import AI Memory
                    if (data.aiMemory) {
                        if (data.aiMemory.profile) {
                            localStorage.setItem(MEMORY_KEYS.profile, JSON.stringify(data.aiMemory.profile));
                        }
                        if (data.aiMemory.usage) {
                            localStorage.setItem(MEMORY_KEYS.usage, JSON.stringify(data.aiMemory.usage));
                        }
                        if (data.aiMemory.patterns) {
                            localStorage.setItem(MEMORY_KEYS.patterns, JSON.stringify(data.aiMemory.patterns));
                        }
                        if (data.aiMemory.learning) {
                            localStorage.setItem(MEMORY_KEYS.learning, JSON.stringify(data.aiMemory.learning));
                        }
                        if (data.aiMemory.chatHistory) {
                            localStorage.setItem(MEMORY_KEYS.chatHistory, JSON.stringify(data.aiMemory.chatHistory));
                        }
                    }
                    
                    // Reload AI Memory
                    aiMemory = new AIMemory();
                    conversationalAI = new ConversationalAI(aiMemory);
                    
                    // Update UI
                    loadSettings();
                    loadProfileForm();
                    updateAIDisplay();
                    loadChatHistory();
                    
                    showFeedback('นำเข้าข้อมูล AI สำเร็จ!', 'success');
                } catch (error) {
                    console.error('Import failed:', error);
                    showFeedback('ไฟล์ไม่ถูกต้อง กรุณาตรวจสอบและลองใหม่', 'error');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <i class="fas fa-robot" style="margin-right: 8px;"></i>
                    AI กำลังคิด...
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function handleSuggestion(suggestion) {
            // Handle different types of suggestions
            switch (suggestion.action) {
                case 'scrollToCalculator':
                    setTimeout(() => {
                        document.querySelector('.button').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 2000);
                    break;
                case 'scrollToProfile':
                    setTimeout(() => {
                        document.getElementById('userName').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 2000);
                    break;
            }
        }

        function showChatNotification() {
            const notification = document.getElementById('chatNotification');
            if (notification) {
                notification.style.display = 'flex';
            }
        }

        function hideChatNotification() {
            const notification = document.getElementById('chatNotification');
            if (notification) {
                notification.style.display = 'none';
            }
        }

        // ========== PROFILE FUNCTIONS ========== //

        function saveProfile() {
            const profileData = {
                userName: document.getElementById('userName').value.trim(),
                businessGoal: document.getElementById('businessGoal').value,
                experienceLevel: document.getElementById('experienceLevel').value,
                riskTolerance: document.getElementById('riskTolerance').value
            };

            // Validation
            if (!profileData.userName) {
                alert('กรุณากรอกชื่อที่ต้องการให้ AI เรียก');
                return;
            }

            if (aiMemory.saveProfile(profileData)) {
                updateAIDisplay();
                showFeedback('บันทึกข้อมูลแล้ว! AI จะจำคุณต่อจากนี้ ✨', 'success');
                
                // Update chat title
                updateChatTitle();
            } else {
                showFeedback('เกิดข้อผิดพลาดในการบันทึก กรุณาลองใหม่', 'error');
            }
        }

        function resetAIMemory() {
            if (confirm('ต้องการลบความทรงจำของ AI ทั้งหมดหรือไม่?\n(จะไม่สามารถย้อนกลับได้)')) {
                aiMemory.resetMemory();
                updateAIDisplay();
                clearProfileForm();
                
                // Clear chat
                document.getElementById('chatMessages').innerHTML = '';
                updateChatTitle();
                
                showFeedback('รีเซ็ต AI Memory แล้ว เริ่มต้นใหม่!', 'info');
                
                // Add new welcome message
                setTimeout(() => {
                    addWelcomeMessage();
                }, 1000);
            }
        }

        function clearProfileForm() {
            document.getElementById('userName').value = '';
            document.getElementById('businessGoal').value = '';
            document.getElementById('experienceLevel').value = '';
            document.getElementById('riskTolerance').value = '';
        }

        function loadProfileForm() {
            const profile = aiMemory.profile;
            document.getElementById('userName').value = profile.userName || '';
            document.getElementById('businessGoal').value = profile.businessGoal || '';
            document.getElementById('experienceLevel').value = profile.experienceLevel || '';
            document.getElementById('riskTolerance').value = profile.riskTolerance || '';
        }

        function updateAIDisplay() {
            // Update greeting
            document.getElementById('aiGreeting').innerHTML = 
                `<i class="fas fa-robot"></i> ${aiMemory.getPersonalizedGreeting()}`;
            
            // Update insight
            document.getElementById('aiInsight').textContent = aiMemory.getPersonalizedInsight();
            
            // Update statistics
            document.getElementById('usageCount').textContent = aiMemory.usage.totalCalculations || 0;
            document.getElementById('dataPoints').textContent = 
                (aiMemory.patterns.pricePatterns.length + Object.keys(aiMemory.profile).filter(k => aiMemory.profile[k]).length + aiMemory.usage.chatInteractions);
            
            // Update learning progress
            aiMemory.updateLearning();
            const progress = aiMemory.learning.learningProgress;
            document.getElementById('learningPercent').textContent = `${progress}%`;
            document.getElementById('learningBar').style.width = `${progress}%`;
            
            // Update accuracy (simulated based on usage)
            const accuracy = Math.min(95, 60 + (aiMemory.usage.totalCalculations * 2) + (aiMemory.usage.chatInteractions));
            document.getElementById('aiAccuracy').textContent = `${accuracy}%`;
            
            // Update personality
            if (aiMemory.learning.personalityType) {
                document.getElementById('personalityText').textContent = 
                    `คุณเป็นประเภท: ${aiMemory.learning.personalityType}`;
                    
                if (aiMemory.learning.chatPersonality) {
                    document.getElementById('personalityText').textContent += 
                        ` • สไตล์คุย: ${aiMemory.learning.chatPersonality}`;
                }
            }
        }

        function updateChatTitle() {
            const chatTitle = document.getElementById('chatTitle');
            const userName = aiMemory.profile.userName;
            
            if (userName) {
                chatTitle.textContent = `AI ที่ปรึกษา${userName}`;
            } else {
                chatTitle.textContent = 'AI ที่ปรึกษาหมูปิ้ง';
            }
        }

        function showFeedback(message, type = 'info') {
            // Create feedback element
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 2000;
                padding: 20px 30px;
                border-radius: 10px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                animation: feedbackShow 0.3s ease;
                font-weight: 500;
                text-align: center;
                max-width: 400px;
            `;

            // Set colors based on type
            const colors = {
                success: 'background: #e8f5e9; color: #2e7d32; border: 2px solid #4caf50;',
                error: 'background: #ffebee; color: #c62828; border: 2px solid #f44336;',
                info: 'background: #e3f2fd; color: #1565c0; border: 2px solid #2196f3;'
            };

            feedback.style.cssText += colors[type] || colors.info;
            feedback.textContent = message;

            document.body.appendChild(feedback);

            // Auto remove after 3 seconds
            setTimeout(() => {
                feedback.style.animation = 'feedbackHide 0.3s ease';
                setTimeout(() => feedback.remove(), 300);
            }, 3000);
        }

        // Add CSS for feedback animation
        const feedbackStyle = document.createElement('style');
        feedbackStyle.textContent = `
            @keyframes feedbackShow {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            @keyframes feedbackHide {
                from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            }
        `;
        document.head.appendChild(feedbackStyle);

        // ========== ENHANCED CALCULATION FUNCTIONS ========== //

        // Main calculation function (แทนที่ function เดิม)
        function calculatePricing() {
            // Show loading state
            const resultsSection = document.getElementById('results');
            resultsSection.style.display = 'block';
            resultsSection.classList.add('animate-slide-up');

            // Get input values
            const inputs = {
                porkPrice: parseFloat(document.getElementById('porkPrice').value),
                fuelCost: parseFloat(document.getElementById('fuelCost').value),
                weather: document.getElementById('weather').value,
                economic: document.getElementById('economic').value,
                season: document.getElementById('season').value,
                political: document.getElementById('political').value,
                meatWeight: parseFloat(document.getElementById('meatWeight').value),
                stickCost: parseFloat(document.getElementById('stickCost').value),
                seasoningCost: parseFloat(document.getElementById('seasoningCost').value),
                laborCost: parseFloat(document.getElementById('laborCost').value),
                overheadCost: parseFloat(document.getElementById('overheadCost').value),
                dailySticks: parseFloat(document.getElementById('dailySticks').value)
            };

            // Record usage in AI Memory
            aiMemory.recordUsage(inputs);

            // Use AI Memory for personalized analysis
            const personalizedFactors = getPersonalizedFactors(inputs);
            
            // Simulate AI processing delay with personalized message
            const userName = aiMemory.profile.userName || 'คุณ';
            showAIThinking(userName);

            setTimeout(() => {
                // Perform analysis with memory-enhanced AI
                const result = performEnhancedAIAnalysis(inputs, personalizedFactors);
                
                // Record pattern for learning
                aiMemory.recordPattern(inputs, result);
                
                // Display results with personalization
                displayPersonalizedResults(result);
                
                // Update AI display
                updateAIDisplay();
                
                // Save to history (existing functionality)
                calculationHistory.push({
                    timestamp: new Date().toLocaleString('th-TH'),
                    cost: result.costPerStick.toFixed(2),
                    price: result.suggestedPrice.toFixed(2),
                    profit: result.profitMargin.toFixed(2),
                    risk: result.riskLevel,
                    inputs: inputs,
                    aiPersonalization: result.personalizedInsights // ข้อมูลใหม่
                });

                // Show completion feedback
                showFeedback(`${userName} คำนวณเสร็จแล้ว! AI ได้เรียนรู้เพิ่มเติมจากข้อมูลนี้`, 'success');
                
                // Auto-suggest chat if user never used it
                if (aiMemory.usage.chatInteractions === 0) {
                    setTimeout(() => {
                        showChatNotification();
                        const suggestion = document.createElement('div');
                        suggestion.style.cssText = `
                            position: fixed;
                            top: 20px;
                            left: 50%;
                            transform: translateX(-50%);
                            z-index: 1500;
                            padding: 15px 20px;
                            background: rgba(255, 215, 0, 0.95);
                            color: #1a1a1a;
                            border-radius: 25px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                            animation: bounceIn 0.5s ease;
                            backdrop-filter: blur(10px);
                            text-align: center;
                            font-weight: 500;
                        `;
                        suggestion.innerHTML = `
                            <i class="fas fa-robot" style="margin-right: 8px;"></i>
                            ลองคุยกับ AI เพื่อถามรายละเอียดเพิ่มเติมได้นะครับ! 
                            <i class="fas fa-arrow-down" style="margin-left: 8px;"></i>
                        `;
                        document.body.appendChild(suggestion);
                        
                        setTimeout(() => {
                            suggestion.style.animation = 'fadeOut 0.5s ease';
                            setTimeout(() => suggestion.remove(), 500);
                        }, 4000);
                    }, 3000);
                }
            }, 1500);
        }

        // Enhanced AI Analysis with Memory
        function performEnhancedAIAnalysis(inputs, personalizedFactors) {
            // Get base analysis (existing function - ต้องแก้ไขจาก code เดิม)
            const baseResult = performAIAnalysis(inputs);
            
            // Add personalized enhancements
            const personalizedResult = {
                ...baseResult,
                personalizedInsights: generatePersonalizedInsights(inputs, baseResult),
                memoryBasedRecommendations: getMemoryBasedRecommendations(inputs),
                riskAdjustment: calculatePersonalizedRisk(inputs, baseResult),
                experienceModifier: getExperienceModifier()
            };

            // Adjust pricing based on user's profile
            const profileAdjustment = getProfileBasedAdjustment();
            personalizedResult.suggestedPrice *= profileAdjustment.priceMultiplier;
            personalizedResult.marketingStrategies = enhanceMarketingStrategies(
                personalizedResult.marketingStrategies, 
                aiMemory.profile
            );

            return personalizedResult;
        }

        // Get personalized factors based on memory
        function getPersonalizedFactors(inputs) {
            const factors = {};
            
            // Use historical preferences
            const favorites = aiMemory.usage.favoriteSettings;
            
            // Adjust factors based on user patterns
            if (favorites.weather && favorites.weather[inputs.weather] > 2) {
                factors.weatherComfort = 0.1; // User familiar with this weather
            }
            
            if (favorites.economic && favorites.economic[inputs.economic] > 2) {
                factors.economicFamiliarity = 0.1; // User experienced with this situation
            }
            
            return factors;
        }

        // Generate personalized insights
        function generatePersonalizedInsights(inputs, result) {
            const insights = [];
            const profile = aiMemory.profile;
            const patterns = aiMemory.patterns.pricePatterns;
            
            // Experience-based insights
            if (profile.experienceLevel === 'newbie') {
                insights.push('🎓 สำหรับมือใหม่: ราคาที่แนะนำอยู่ในระดับปลอดภัย เน้นเสถียรภาพก่อน');
                if (result.riskScore > 0.7) {
                    insights.push('⚠️ แนะนำลดความเสี่ยงลง เน้นการสร้างฐานลูกค้าก่อน');
                }
            } else if (profile.experienceLevel === 'expert') {
                insights.push('🏆 สำหรับเซียน: คุณสามารถเพิ่มกำไรได้อีก 5-10% จากราคาที่แนะนำ');
                if (result.profitMargin > result.costPerStick * 0.5) {
                    insights.push('💰 กำไรดี! พิจารณาขยายธุรกิจหรือปรับปรุงคุณภาพ');
                }
            }
            
            // Risk tolerance insights
            if (profile.riskTolerance === 'conservative') {
                insights.push('🛡️ ตามบุคลิกคุณ: เน้นความมั่นคง ลดราคาลง 5% เพื่อเพิ่มยอดขาย');
            } else if (profile.riskTolerance === 'aggressive') {
                insights.push('🚀 ตามบุคลิกคุณ: ลองเพิ่มราคา 8-12% ทดสอบตลาด');
            }
            
            // Pattern-based insights
            if (patterns.length >= 3) {
                const recentPatterns = patterns.slice(-3);
                const avgProfit = recentPatterns.reduce((sum, p) => sum + p.outputs.profitMargin, 0) / 3;
                
                if (result.profitMargin > avgProfit * 1.2) {
                    insights.push('📈 กำไรครั้งนี้สูงกว่าเฉลี่ย 20%! สภาพตลาดดี');
                } else if (result.profitMargin < avgProfit * 0.8) {
                    insights.push('📉 กำไรต่ำกว่าปกติ ลองปรับกลยุทธ์ตลาด');
                }
            }
            
            // Goal-based insights
            if (profile.businessGoal === 'survival') {
                insights.push('🎯 ตามเป้าหมาย: ลองหาวิธีลดต้นทุนแทนการเพิ่มราคา');
            } else if (profile.businessGoal === 'growth') {
                insights.push('🎯 ตามเป้าหมาย: พิจารณาเพิ่มเมนูเสริมหรือจัดโปรโมชั่น');
            } else if (profile.businessGoal === 'franchise') {
                insights.push('🎯 ตามเป้าหมาย: ราคานี้เหมาะสำหรับ standardization ข้ามสาขา');
            }
            
            return insights;
        }

        // Memory-based recommendations
        function getMemoryBasedRecommendations(inputs) {
            const recommendations = [];
            const favorites = aiMemory.usage.favoriteSettings;
            
            // Weather pattern recommendations
            if (favorites.weather) {
                const mostUsedWeather = Object.keys(favorites.weather).reduce((a, b) => 
                    favorites.weather[a] > favorites.weather[b] ? a : b);
                
                if (inputs.weather !== mostUsedWeather) {
                    const weatherTexts = {
                        sunny: 'แดดจัด',
                        rainy: 'ฝนตก', 
                        cloudy: 'ครึ้ม',
                        cold: 'หนาว'
                    };
                    recommendations.push(
                        `🌤️ คุณมักคำนวณในสภาพ${weatherTexts[mostUsedWeather]} ลองเปรียบเทียบผลต่าง`
                    );
                }
            }
            
            // Price pattern recommendations
            const patterns = aiMemory.patterns.pricePatterns;
            if (patterns.length >= 5) {
                const successfulPatterns = patterns.filter(p => p.success);
                const successRate = (successfulPatterns.length / patterns.length) * 100;
                
                if (successRate < 60) {
                    recommendations.push(
                        `📊 อัตราความสำเร็จ ${successRate.toFixed(0)}% ลองปรับกลยุทธ์ใหม่`
                    );
                } else if (successRate > 80) {
                    recommendations.push(
                        `✨ อัตราความสำเร็จ ${successRate.toFixed(0)}% คุณทำได้ดีมาก!`
                    );
                }
            }
            
            return recommendations;
        }

        // Calculate personalized risk
        function calculatePersonalizedRisk(inputs, result) {
            let riskAdjustment = 0;
            const profile = aiMemory.profile;
            
            // Experience level adjustment
            if (profile.experienceLevel === 'expert') {
                riskAdjustment += 0.1; // Experts can handle more risk
            } else if (profile.experienceLevel === 'newbie') {
                riskAdjustment -= 0.1; // Newbies need lower risk
            }
            
            // Risk tolerance adjustment
            if (profile.riskTolerance === 'aggressive') {
                riskAdjustment += 0.15;
            } else if (profile.riskTolerance === 'conservative') {
                riskAdjustment -= 0.15;
            }
            
            return Math.max(0.1, Math.min(0.9, result.riskScore + riskAdjustment));
        }

        // Experience modifier for pricing
        function getExperienceModifier() {
            const profile = aiMemory.profile;
            const modifiers = {
                newbie: 0.95,    // 5% discount for safety
                learning: 0.98,  // 2% discount
                experienced: 1.02, // 2% premium
                expert: 1.05     // 5% premium
            };
            
            return modifiers[profile.experienceLevel] || 1.0;
        }

        // Profile-based pricing adjustment
        function getProfileBasedAdjustment() {
            const profile = aiMemory.profile;
            let priceMultiplier = 1.0;
            
            // Risk tolerance impact
            if (profile.riskTolerance === 'conservative') {
                priceMultiplier *= 0.95; // Lower prices for safety
            } else if (profile.riskTolerance === 'aggressive') {
                priceMultiplier *= 1.08; // Higher prices for more profit
            }
            
            // Experience impact
            priceMultiplier *= getExperienceModifier();
            
            // Goal impact
            if (profile.businessGoal === 'survival') {
                priceMultiplier *= 0.92; // Competitive pricing
            } else if (profile.businessGoal === 'growth') {
                priceMultiplier *= 1.05; // Growth-oriented pricing
            }
            
            return { priceMultiplier };
        }

        // Enhance marketing strategies with personality
        function enhanceMarketingStrategies(strategies, profile) {
            const enhanced = strategies.map(strategy => {
                let enhancement = '';
                
                // Add personality-specific tactics
                if (profile.experienceLevel === 'newbie') {
                    enhancement = ' (เน้นง่ายๆ เริ่มต้นได้)';
                } else if (profile.experienceLevel === 'expert') {
                    enhancement = ' (ขั้นสูง ใช้ประสบการณ์เต็มที่)';
                }
                
                // Add goal-specific modifications
                if (profile.businessGoal === 'franchise') {
                    enhancement += ' [เตรียมสำหรับ franchise]';
                }
                
                return {
                    ...strategy,
                    description: strategy.description + enhancement,
                    personalizedTip: getPersonalizedMarketingTip(strategy.stage, profile)
                };
            });
            
            return enhanced;
        }

        // Get personalized marketing tip
        function getPersonalizedMarketingTip(stage, profile) {
            const tips = {
                newbie: {
                    'Awareness': 'เริ่มจาก Facebook ครอบครัว/เพื่อนก่อน',
                    'Interest': 'โพสต์ภาพง่ายๆ ไม่ซับซ้อน',
                    'Consideration': 'ให้ลองชิมฟรี สร้างความมั่นใจ',
                    'Purchase': 'รับเงินครบก่อนส่งสินค้า',
                    'Retention': 'จำใบหน้าลูกค้า ทักทายเป็นกันเอง'
                },
                expert: {
                    'Awareness': 'ใช้ Influencer ร่วมกันทำการตลาด',
                    'Interest': 'สร้าง brand story ที่แข็งแกร่ง',
                    'Consideration': 'เปรียบเทียบคู่แข่ง แสดงจุดเด่น',
                    'Purchase': 'ระบบสั่งออนไลน์แบบ seamless',
                    'Retention': 'CRM system ดูแลลูกค้าแบบ VIP'
                }
            };
            
            const userTips = tips[profile.experienceLevel] || tips.newbie;
            return userTips[stage.split(' ')[0]] || 'ปรับให้เหมาะกับสไตล์คุณ';
        }

        // Show AI thinking animation
        function showAIThinking(userName) {
            const thinkingMessages = [
                `${userName} รอสักครู่นะ AI กำลังคิด...`,
                'วิเคราะห์ข้อมูลตลาด...',
                'คำนวณความเสี่ยง...',
                'ปรับแต่งตามบุคลิกคุณ...',
                'เกือบเสร็จแล้ว!'
            ];
            
            let messageIndex = 0;
            const thinkingElement = document.createElement('div');
            thinkingElement.id = 'aiThinking';
            thinkingElement.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1500;
                padding: 15px 20px;
                background: rgba(74, 144, 226, 0.95);
                color: white;
                border-radius: 25px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                animation: bounce 1s infinite;
                backdrop-filter: blur(10px);
            `;
            
            function updateMessage() {
                if (messageIndex < thinkingMessages.length) {
                    thinkingElement.innerHTML = `
                        <i class="fas fa-robot" style="margin-right: 8px;"></i>
                        ${thinkingMessages[messageIndex]}
                        <span class="loading" style="margin-left: 8px;"></span>
                    `;
                    messageIndex++;
                    setTimeout(updateMessage, 300);
                } else {
                    setTimeout(() => {
                        thinkingElement.remove();
                    }, 200);
                }
            }
            
            document.body.appendChild(thinkingElement);
            updateMessage();
        }

        // Display personalized results
        function displayPersonalizedResults(result) {
            // Display base results (existing function - เรียกใช้ function เดิม)
            displayResults(result);
            
            // Add personalized insights section
            const aiAnalysis = document.querySelector('.ai-analysis');
            if (aiAnalysis && result.personalizedInsights) {
                const personalizedSection = document.createElement('div');
                personalizedSection.className = 'ai-analysis';
                personalizedSection.style.background = 'linear-gradient(135deg, #FFF8E1, #FFFDE7)';
                personalizedSection.style.borderLeft = '5px solid #FF8F00';
                
                personalizedSection.innerHTML = `
                    <h3 style="color: #E65100;">
                        <i class="fas fa-user-cog"></i> คำแนะนำเฉพาะคุณ
                    </h3>
                    <div style="color: #2c1810;">
                        ${result.personalizedInsights.map(insight => 
                            `<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                                ${insight}
                            </div>`
                        ).join('')}
                    </div>
                `;
                
                // Insert after AI analysis
                aiAnalysis.parentNode.insertBefore(personalizedSection, aiAnalysis.nextSibling);
            }
            
            // Add memory-based recommendations
            if (result.memoryBasedRecommendations && result.memoryBasedRecommendations.length > 0) {
                const recommendationSection = document.createElement('div');
                recommendationSection.className = 'ai-analysis';
                recommendationSection.style.background = 'linear-gradient(135deg, #F3E5F5, #FCE4EC)';
                recommendationSection.style.borderLeft = '5px solid #9C27B0';
                
                recommendationSection.innerHTML = `
                    <h3 style="color: #7B1FA2;">
                        <i class="fas fa-lightbulb"></i> AI สังเกตเห็นว่า...
                    </h3>
                    <div style="color: #2c1810;">
                        ${result.memoryBasedRecommendations.map(rec => 
                            `<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                                ${rec}
                            </div>`
                        ).join('')}
                    </div>
                `;
                
                document.querySelector('.result-section').appendChild(recommendationSection);
            }
        }

        // ========== ORIGINAL FUNCTIONS (ต้องคงไว้) ========== //

        // Global variables
        let calculationHistory = [];
        let businessSettings = {
            name: 'หมูปิ้งจัมโบ้',
            targetProfit: 40,
            location: 'market',
            workingHours: 10
        };

        // Load settings        </div>

        <div class="main-grid">
            <!-- Input Factors Section -->
            <div class="card animate-slide-up">
                <h2><i class="fas fa-chart-line"></i> ปัจจัยตลาด</h2>
                
                <div class="input-group">
                    <label for="porkPrice">ราคาเนื้อหมูภาคเหนือ (บาท/กก.) 
                        <span class="tooltip" data-tooltip="ราคาเนื้อหมูสดในตลาดท้องถิ่น">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </label>
                    <input type="number" id="porkPrice" value="180" min="100" max="500">
                </div>

                <div class="input-group">
                    <label for="fuelCost">ค่าแก๊ส/ถ่าน (บาท/วัน)</label>
                    <input type="number" id="fuelCost" value="150" min="50" max="500">
                </div>

                <div class="input-group">
                    <label for="weather">สภาพอากาศ</label>
                    <select id="weather">
                        <option value="sunny">แดดจัด</option>
                        <option value="rainy">ฝนตก</option>
                        <option value="cloudy">ครึ้ม</option>
                        <option value="cold">หนาว</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="economic">สภาพเศรษฐกิจ</label>
                    <select id="economic">
                        <option value="good">ดี</option>
                        <option value="normal">ปกติ</option>
                        <option value="poor">ไม่ดี</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="season">ฤดูกาล</label>
                    <select id="season">
                        <option value="hot">ร้อน</option>
                        <option value="rainy">ฝน</option>
                        <option value="cool">หนาว</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="political">สถานการณ์การเมือง</label>
                    <select id="political">
                        <option value="stable">มั่นคง</option>
                        <option value="uncertain">ไม่แน่นอน</option>
                        <option value="crisis">วิกฤติ</option>
                    </select>
                </div>
            </div>

            <!-- Cost Calculation Section -->
            <div class="card animate-slide-up">
                <h2><i class="fas fa-calculator"></i> คำนวณต้นทุน</h2>
                
                <div class="input-group">
                    <label for="meatWeight">น้ำหนักเนื้อหมู (กรัม/ไม้)</label>
                    <input type="number" id="meatWeight" value="80" min="50" max="150">
                </div>

                <div class="input-group">
                    <label for="stickCost">ค่าไม้ไผ่ (บาท/100 ไม้)</label>
                    <input type="number" id="stickCost" value="50" min="20" max="100">
                </div>

                <div class="input-group">
                    <label for="seasoningCost">ค่าเครื่องปรุง (บาท/ไม้)</label>
                    <input type="number" id="seasoningCost" value="5" min="2" max="15">
                </div>

                <div class="input-group">
                    <label for="laborCost">ค่าแรงงาน (บาท/ชั่วโมง)</label>
                    <input type="number" id="laborCost" value="80" min="50" max="200">
                </div>

                <div class="input-group">
                    <label for="overheadCost">ค่าใช้จ่ายคงที่ (บาท/วัน)</label>
                    <input type="number" id="overheadCost" value="500" min="200" max="2000">
                </div>

                <div class="input-group">
                    <label for="dailySticks">ยอดขายต่อวัน (ไม้)</label>
                    <input type="number" id="dailySticks" value="200" min="50" max="1000">
                </div>

                <button class="button" onclick="calculatePricing()">
                    <i class="fas fa-brain"></i> คำนวณด้วยผู้ช่วยอัจฉริยะ
                </button>
            </div>
        </div>

        <!-- Profile Grid -->
        <div class="main-grid">
            <!-- AI Profile & Memory Section -->
            <div class="card animate-slide-up">
                <h2><i class="fas fa-user-robot"></i> โปรไฟล์ผู้ใช้ AI</h2>
                
                <div class="input-group">
                    <label for="userName">ชื่อเรียก (ให้ AI เรียก)</label>
                    <input type="text" id="userName" placeholder="คุณอยากให้ AI เรียกยังไง?">
                </div>

                <div class="input-group">
                    <label for="businessGoal">เป้าหมายธุรกิจ</label>
                    <select id="businessGoal">
                        <option value="">เลือกเป้าหมาย...</option>
                        <option value="survival">รอดพอมีกิน</option>
                        <option value="stable">รายได้มั่นคง</option>
                        <option value="growth">ขยายธุรกิจ</option>
                        <option value="franchise">เปิดสาขา</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="experienceLevel">ประสบการณ์การค้า</label>
                    <select id="experienceLevel">
                        <option value="">เลือกระดับ...</option>
                        <option value="newbie">มือใหม่ (< 6 เดือน)</option>
                        <option value="learning">กำลังเรียนรู้ (6เดือน-2ปี)</option>
                        <option value="experienced">มีประสบการณ์ (2-5ปี)</option>
                        <option value="expert">เซียน (5+ ปี)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="riskTolerance">ระดับความเสี่ยงที่รับได้</label>
                    <select id="riskTolerance">
                        <option value="">เลือกระดับ...</option>
                        <option value="conservative">อนุรักษ์นิยม (เสี่ยงน้อย)</option>
                        <option value="moderate">ปานกลาง</option>
                        <option value="aggressive">เสี่ยงได้ (กำไรสูง)</option>
                    </select>
                </div>

                <button class="button" onclick="saveProfile()">
                    <i class="fas fa-save"></i> บันทึกข้อมูล AI จะจำ
                </button>

                <!-- AI Status -->
                <div id="aiStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; background: rgba(74, 144, 226, 0.1); border-left: 4px solid #4a90e2;">
                    <div id="aiGreeting" style="font-weight: 500; color: #4a90e2;">
                        <i class="fas fa-robot"></i> AI พร้อมทำความรู้จักกับคุณ...
                    </div>
                    <div id="aiInsight" style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                        กรอกข้อมูลเพื่อให้ AI เข้าใจและช่วยคุณได้ดีขึ้น
                    </div>
                </div>
            </div>

            <!-- AI Statistics & Learning -->
            <div class="card animate-slide-up">
                <h2><i class="fas fa-chart-area"></i> AI กำลังเรียนรู้คุณ</h2>
                
                <!-- การใช้งาน -->
                <div class="stat-item">
                    <div class="stat-label">การใช้งานทั้งหมด</div>
                    <div class="stat-value" id="usageCount">-</div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">คะแนน AI Accuracy</div>
                    <div class="stat-value" id="aiAccuracy">-</div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">ข้อมูลที่ AI จำได้</div>
                    <div class="stat-value" id="dataPoints">-</div>
                </div>

                <!-- AI Learning Progress -->
                <div class="learning-progress" style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-size: 0.9rem; color: #666;">AI Learning Progress</span>
                        <span id="learningPercent" style="font-size: 0.9rem; color: #4a90e2;">0%</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div id="learningBar" style="height: 100%; background: linear-gradient(90deg, #4a90e2, #6ab7ff); width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>

                <!-- Personality Insights -->
                <div id="personalityInsights" style="margin-top: 15px; padding: 10px; border-radius: 8px; background: rgba(0, 200, 83, 0.1); border-left: 4px solid #00c853;">
                    <div style="font-weight: 500; color: #00c853; margin-bottom: 5px;">
                        <i class="fas fa-lightbulb"></i> AI Personality Match
                    </div>
                    <div id="personalityText" style="font-size: 0.9rem; color: #666;">
                        ใช้งานเพิ่มเติมเพื่อให้ AI วิเคราะห์บุคลิกการค้าของคุณ
                    </div>
                </div>

                <button class="button secondary" onclick="resetAIMemory()">
                    <i class="fas fa-brain"></i> รีเซ็ต AI Memory
                </button>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="main-grid">
            <button class="button secondary" onclick="openSettings()">
                <i class="fas fa-cog"></i> ตั้งค่าธุรกิจ
            </button>
            <button class="button secondary" onclick="toggleHistory()">
                <i class="fas fa-history"></i> ประวัติการตัดสินใจด้วยผู้ช่วยอัจฉริยะ
            </button>
        </div>

        <!-- Results Section -->
        <div class="result-section" id="results" style="display: none;">
            <h2><i class="fas fa-chart-pie"></i> ผลการวิเคราะห์ด้วยผู้ช่วยอัจฉริยะ</h2>
            
            <div class="result-grid">
                <div class="result-card">
                    <div class="result-value" id="costPerStick">-</div>
                    <div class="result-label">ต้นทุนต่อไม้ (บาท)</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="suggestedPrice">-</div>
                    <div class="result-label">ราคาแนะนำ (บาท)</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="profitMargin">-</div>
                    <div class="result-label">กำไรต่อไม้ (บาท)</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="dailyProfit">-</div>
                    <div class="result-label">กำไรต่อวัน (บาท)</div>
                </div>
            </div>

            <!-- Risk Assessment -->
            <div class="ai-analysis">
                <h3><i class="fas fa-shield-alt"></i> การประเมินความเสี่ยง</h3>
                <div class="risk-meter">
                    <div class="risk-bar">
                        <div class="risk-indicator" id="riskIndicator"></div>
                    </div>
                    <p id="riskLevel">กำลังประเมิน...</p>
                </div>
            </div>

            <!-- AI Analysis -->
            <div class="ai-analysis">
                <h3><i class="fas fa-robot"></i> ปัจจัยวิเคราะห์ 6 ด้าน</h3>
                <div class="factor-analysis" id="factorAnalysis">
                    <!-- จะถูกใส่ข้อมูลโดย JavaScript -->
                </div>
                <div id="aiReasoning" style="margin-top: 15px;">
                    <!-- คำแนะนำจาก AGENT AI -->
                </div>
            </div>

            <!-- Marketing Strategies -->
            <div class="ai-analysis">
                <h3><i class="fas fa-bullhorn"></i> กลยุทธ์การตลาดดิจิทัล </h3>
                <div class="marketing-strategies" id="marketingStrategies">
                    <!-- จะถูกใส่ข้อมูลโดย JavaScript -->
                </div>
            </div>
        </div>

        <!-- History Panel -->
        <div class="history-panel" id="historyPanel" style="display: none;">
            <h2><i class="fas fa-history"></i> ประวัติการตัดสินใจกับผู้ช่วยอัจฉริยะ</h2>
            <div id="historyContent">
                <p style="text-align: center; color: #666;">ยังไม่มีประวัติการคำนวณ</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <h2><i class="fas fa-cog"></i> ตั้งค่าธุรกิจ</h2>
            
            <div class="input-group">
                <label for="businessName">ชื่อร้าน</label>
                <input type="text" id="businessName" value="หมูปิ้งจัมโบ้">
            </div>

            <div class="input-group">
                <label for="targetProfit">เป้าหมายกำไร (%)</label>
                <input type="number" id="targetProfit" value="40" min="10" max="100">
            </div>

            <div class="input-group">
                <label for="businessLocation">ที่ตั้งร้าน</label>
                <select id="businessLocation">
                    <option value="market">ตลาด</option>
                    <option value="street">ริมถนน</option>
                    <option value="mall">ห้างสรรพสินค้า</option>
                    <option value="university">มหาวิทยาลัย</option>
                </select>
            </div>

            <div class="input-group">
                <label for="workingHours">ชั่วโมงทำงาน/วัน</label>
                <input type="number" id="workingHours" value="10" min="6" max="16">
            </div>

            <button class="button" onclick="saveSettings()">
                <i class="fas fa-save"></i> บันทึกการตั้งค่า
            </button>
            <button class="button danger" onclick="closeSettings()">
                <i class="fas fa-times"></i> ปิด
            </button>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-robot"></i>
                <span id="chatTitle">AI ที่ปรึกษาหมูปิ้ง</span>
            </div>
            <button class="chat-close" onclick="toggleChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="chatInput" 
                       placeholder="พิมพ์คำถามเกี่ยวกับหมูปิ้ง..." 
                       onkeypress="handleChatKeyPress(event)">
                <button class="chat-send" id="chatSend" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
        <div class="chat-notification" id="chatNotification" style="display: none;">!</div>
    </button>

    <script>
        // ========== AI MEMORY & PROFILE SYSTEM ========== //

        // Memory storage keys
        const MEMORY_KEYS = {
            profile: 'aiMooPing_profile',
            usage: 'aiMooPing_usage',
            history: 'aiMooPing_memory_history',
            patterns: 'aiMooPing_patterns',
            learning: 'aiMooPing_learning',
            chatHistory: 'aiMooPing_chat_history'
        };

        // AI Memory Class
        class AIMemory {
            constructor() {
                this.profile = this.loadProfile();
                this.usage = this.loadUsage();
                this.patterns = this.loadPatterns();
                this.learning = this.loadLearning();
                this.chatHistory = this.loadChatHistory();
            }

            // Profile Management
            loadProfile() {
                try {
                    const saved = localStorage.getItem(MEMORY_KEYS.profile);
                    return saved ? JSON.parse(saved) : {
                        userName: '',
                        businessGoal: '',
                        experienceLevel: '',
                        riskTolerance: '',
                        createdAt: null,
                        lastActive: null
                    };
                } catch (e) {
                    console.warn('Profile loading failed:', e);
                    return {};
                }
            }

            saveProfile(profileData) {
                try {
                    const profile = {
                        ...this.profile,
                        ...profileData,
                        lastActive: new Date().toISOString()
                    };
                    
                    if (!profile.createdAt) {
                        profile.createdAt = new Date().toISOString();
                    }

                    localStorage.setItem(MEMORY_KEYS.profile, JSON.stringify(profile));
                    this.profile = profile;
                    return true;
                } catch (e) {
                    console.error('Profile saving failed:', e);
                    return false;
                }
            }

            // Usage Tracking
            loadUsage() {
                try {
                    const saved = localStorage.getItem(MEMORY_KEYS.usage);
                    return saved ? JSON.parse(saved) : {
                        totalCalculations: 0,
                        totalSessions: 0,
                        accuratePredictions: 0,
                        lastCalculation: null,
                        favoriteSettings: {},
                        chatInteractions: 0
                    };
                } catch (e) {
                    return {};
                }
            }

            recordUsage(calculationData) {
                this.usage.totalCalculations++;
                this.usage.lastCalculation = new Date().toISOString();
                
                // Track favorite settings
                const settings = {
                    porkPrice: calculationData.porkPrice,
                    weather: calculationData.weather,
                    economic: calculationData.economic
                };

                Object.keys(settings).forEach(key => {
                    if (!this.usage.favoriteSettings[key]) {
                        this.usage.favoriteSettings[key] = {};
                    }
                    const value = settings[key];
                    this.usage.favoriteSettings[key][value] = 
                        (this.usage.favoriteSettings[key][value] || 0) + 1;
                });

                localStorage.setItem(MEMORY_KEYS.usage, JSON.stringify(this.usage));
            }

            // Chat History Management
            loadChatHistory() {
                try {
                    const saved = localStorage.getItem(MEMORY_KEYS.chatHistory);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            }

            saveChatMessage(message) {
                this.chatHistory.push({
                    ...message,
                    timestamp: new Date().toISOString()
                });

                // Keep only last 100 messages
                if (this.chatHistory.length > 100) {
                    this.chatHistory = this.chatHistory.slice(-100);
                }

                localStorage.setItem(MEMORY_KEYS.chatHistory, JSON.stringify(this.chatHistory));

                // Update usage
                if (message.sender === 'user') {
                    this.usage.chatInteractions++;
                    localStorage.setItem(MEMORY_KEYS.usage, JSON.stringify(this.usage));
                }
            }

            // Pattern Recognition
            loadPatterns() {
                try {
                    const saved = localStorage.getItem(MEMORY_KEYS.patterns);
                    return saved ? JSON.parse(saved) : {
                        pricePatterns: [],
                        behaviorPatterns: {},
                        successfulStrategies: [],
                        chatPatterns: {}
                    };
                } catch (e) {
                    return {};
                }
            }

            recordPattern(calculationData, result) {
                // Record price pattern
                this.patterns.pricePatterns.push({
                    timestamp: new Date().toISOString(),
                    inputs: calculationData,
                    outputs: result,
                    success: result.profitMargin > (result.costPerStick * 0.3) // 30% profit threshold
                });

                // Keep only last 50 patterns
                if (this.patterns.pricePatterns.length > 50) {
                    this.patterns.pricePatterns.shift();
                }

                localStorage.setItem(MEMORY_KEYS.patterns, JSON.stringify(this.patterns));
            }

            recordChatPattern(userMessage, aiResponse) {
                const category = this.categorizeChatMessage(userMessage);
                
                if (!this.patterns.chatPatterns[category]) {
                    this.patterns.chatPatterns[category] = [];
                }

                this.patterns.chatPatterns[category].push({
                    userMessage,
                    aiResponse: aiResponse.text,
                    timestamp: new Date().toISOString()
                });

                // Keep only last 20 per category
                if (this.patterns.chatPatterns[category].length > 20) {
                    this.patterns.chatPatterns[category].shift();
                }

                localStorage.setItem(MEMORY_KEYS.patterns, JSON.stringify(this.patterns));
            }

            categorizeChatMessage(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('ราคา') || lowerMessage.includes('price')) return 'pricing';
                if (lowerMessage.includes('ตลาด') || lowerMessage.includes('market')) return 'market';
                if (lowerMessage.includes('กำไร') || lowerMessage.includes('profit')) return 'profit';
                if (lowerMessage.includes('ความเสี่ยง') || lowerMessage.includes('risk')) return 'risk';
                if (lowerMessage.includes('การตลาด') || lowerMessage.includes('marketing')) return 'marketing';
                if (lowerMessage.includes('ต้นทุน') || lowerMessage.includes('cost')) return 'cost';
                
                return 'general';
            }

            // Learning Simulation
            loadLearning() {
                try {
                    const saved = localStorage.getItem(MEMORY_KEYS.learning);
                    return saved ? JSON.parse(saved) : {
                        learningProgress: 0,
                        personalityType: '',
                        insights: [],
                        recommendations: [],
                        chatPersonality: ''
                    };
                } catch (e) {
                    return {};
                }
            }

            updateLearning() {
                // Simulate learning based on usage
                const dataPoints = [
                    this.profile.userName ? 10 : 0,
                    this.profile.businessGoal ? 15 : 0,
                    this.profile.experienceLevel ? 15 : 0,
                    this.profile.riskTolerance ? 10 : 0,
                    Math.min(this.usage.totalCalculations * 2, 30),
                    Math.min(this.patterns.pricePatterns.length, 20),
                    Math.min(this.usage.chatInteractions, 20)
                ];

                this.learning.learningProgress = Math.min(100, dataPoints.reduce((a, b) => a + b, 0));

                // Personality analysis
                if (this.usage.totalCalculations >= 3) {
                    this.learning.personalityType = this.analyzePersonality();
                }

                // Chat personality analysis
                if (this.usage.chatInteractions >= 5) {
                    this.learning.chatPersonality = this.analyzeChatPersonality();
                }

                localStorage.setItem(MEMORY_KEYS.learning, JSON.stringify(this.learning));
            }

            analyzePersonality() {
                const favorites = this.usage.favoriteSettings;
                let personality = '';

                // Risk analysis
                if (favorites.economic && favorites.economic.poor > (favorites.economic.good || 0)) {
                    personality += 'ระมัดระวัง ';
                } else if (favorites.economic && favorites.economic.good > (favorites.economic.poor || 0)) {
                    personality += 'มั่นใจ ';
                }

                // Weather preference analysis  
                if (favorites.weather && favorites.weather.sunny > (favorites.weather.rainy || 0)) {
                    personality += 'เชิงรุก ';
                }

                // Experience level impact
                if (this.profile.experienceLevel === 'newbie') {
                    personality += 'กำลังเรียนรู้';
                } else if (this.profile.experienceLevel === 'expert') {
                    personality += 'เซียนการค้า';
                }

                return personality || 'ยังวิเคราะห์ไม่ได้';
            }

            analyzeChatPersonality() {
                const chatPatterns = this.patterns.chatPatterns;
                const totalInteractions = Object.values(chatPatterns).reduce((sum, arr) => sum + arr.length, 0);
                
                if (totalInteractions < 5) return '';

                let traits = [];

                // Analyze question types
                if (chatPatterns.pricing && chatPatterns.pricing.length > totalInteractions * 0.3) {
                    traits.push('มุ่งเน้นราคา');
                }
                if (chatPatterns.marketing && chatPatterns.marketing.length > totalInteractions * 0.3) {
                    traits.push('สนใจการตลาด');
                }
                if (chatPatterns.risk && chatPatterns.risk.length > totalInteractions * 0.2) {
                    traits.push('ระมัดระวัง');
                }

                return traits.join(', ') || 'สนใจในหลายด้าน';
            }

            // Get personalized greeting
            getPersonalizedGreeting() {
                const name = this.profile.userName || 'คุณลูกค้า';
                const hour = new Date().getHours();
                let timeGreeting = '';

                if (hour < 12) timeGreeting = 'สวัสดีตอนเช้า';
                else if (hour < 18) timeGreeting = 'สวัสดีตอนบ่าย';
                else timeGreeting = 'สวัสดีตอนเย็น';

                if (this.usage.totalCalculations === 0) {
                    return `${timeGreeting} ${name}! ยินดีต้อนรับสู่ระบบ AI ครั้งแรก 🎉`;
                } else if (this.usage.totalCalculations < 5) {
                    return `${timeGreeting} ${name}! AI กำลังเรียนรู้คุณ... (${this.usage.totalCalculations}/5)`;
                } else {
                    return `${timeGreeting} ${name}! AI จำคุณได้แล้ว ✨ (ใช้งาน ${this.usage.totalCalculations} ครั้ง)`;
                }
            }

            // Get personalized insights
            getPersonalizedInsight() {
                if (this.usage.totalCalculations === 0) {
                    return 'เริ่มต้นด้วยการกรอกข้อมูลและคำนวณครั้งแรกเพื่อให้ AI เข้าใจคุณ';
                }

                const insights = [];

                // Pattern-based insights
                if (this.patterns.pricePatterns.length >= 3) {
                    const recentPatterns = this.patterns.pricePatterns.slice(-3);
                    const avgProfit = recentPatterns.reduce((sum, p) => sum + p.outputs.profitMargin, 0) / 3;
                    insights.push(`กำไรเฉลี่ย 3 ครั้งล่าสุด: ${avgProfit.toFixed(2)} บาท`);
                }

                // Personality insights
                if (this.learning.personalityType) {
                    insights.push(`บุคลิกการค้า: ${this.learning.personalityType}`);
                }

                // Chat insights
                if (this.learning.chatPersonality) {
                    insights.push(`รูปแบบการสนทนา: ${this.learning.chatPersonality}`);
                }

                // Goal-based insights
                if (this.profile.businessGoal) {
                    const goalTexts = {
                        'survival': 'เป้าหมาย: เน้นความมั่นคงและลดความเสี่ยง',
                        'stable': 'เป้าหมาย: สร้างรายได้สม่ำเสมอ',
                        'growth': 'เป้าหมาย: ขยายธุรกิจและเพิ่มกำไร',
                        'franchise': 'เป้าหมาย: เตรียมความพร้อมเปิดสาขา'
                    };
                    insights.push(goalTexts[this.profile.businessGoal]);
                }

                return insights.length > 0 ? insights.join(' • ') : 'AI กำลังสังเกตรูปแบบการใช้งานของคุณ...';
            }

            // Reset all memory
            resetMemory() {
                Object.values(MEMORY_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Reinitialize
                this.profile = this.loadProfile();
                this.usage = this.loadUsage();
                this.patterns = this.loadPatterns();
                this.learning = this.loadLearning();
                this.chatHistory = this.loadChatHistory();
                
                return true;
            }
        }

        // Global AI Memory instance
        let aiMemory = new AIMemory();

        // ========== CONVERSATIONAL AI SYSTEM ========== //

        class ConversationalAI {
            constructor(memory) {
                this.memory = memory;
                this.responses = this.initializeResponses();
                this.contextKeywords = this.initializeContextKeywords();
                this.isTyping = false;
            }

            initializeResponses() {
                return {
                    greeting: [
                        "สวัสดีครับ! ผมเป็น AI ที่ปรึกษาหมูปิ้งของคุณ 🐷",
                        "ยินดีที่ได้ช่วยเหลือคุณในเรื่องธุรกิจหมูปิ้งครับ!",
                        "สวัสดีครับ! พร้อมช่วยวิเคราะห์ราคาหมูปิ้งให้คุณแล้ว 🍢"
                    ],
                    pricing: [
                        "เรื่องราคาเป็นเรื่องสำคัญมากในการทำธุรกิจหมูปิ้งครับ! คุณอยากให้ผมช่วยคำนวณราคาให้ไหม?",
                        "ราคาหมูปิ้งขึ้นอยู่กับปัจจัยหลายอย่าง เช่น ราคาเนื้อหมู, ต้นทุนการผลิต, และสภาพตลาด ลองใช้ระบบคำนวณของเราดูครับ",
                        "การตั้งราคาที่เหมาะสมเป็นกุญแจสำคัญของความสำเร็จ ผมสามารถวิเคราะห์ราคาที่เหมาะสมให้คุณได้ครับ"
                    ],
                    market: [
                        "ตลาดหมูปิ้งในไทยค่อนข้างแข่งขันสูงครับ แต่ยังมีโอกาสให้ผู้ประกอบการใหม่เข้ามา",
                        "สภาพตลาดขึ้นอยู่กับหลายปัจจัย เช่น ฤดูกาล, สภาพเศรษฐกิจ, และพฤติกรรมผู้บริโภค",
                        "การเข้าใจตลาดเป็นสิ่งสำคัญ ผมสามารถช่วยวิเคราะห์ปัจจัยตลาดให้คุณได้"
                    ],
                    cost: [
                        "ต้นทุนหลักของหมูปิ้งได้แก่ เนื้อหมู, ไม้ไผ่, เครื่องปรุง, ค่าแรงงาน และค่าใช้จ่ายคงที่",
                        "การควบคุมต้นทุนเป็นสิ่งสำคัญ ลองดูว่าส่วนไหนที่คุณสามารถลดได้ครับ",
                        "ต้นทุนต่อไม้จะกำหนดราคาขายขั้นต่ำของคุณ ผมสามารถช่วยคำนวณให้ได้ครับ"
                    ],
                    profit: [
                        "กำไรที่เหมาะสมสำหรับธุรกิจหมูปิ้งอยู่ที่ประมาณ 30-50% ขึ้นอยู่กับตำแหน่งและคุณภาพ",
                        "การเพิ่มกำไรสามารถทำได้หลายวิธี เช่น ลดต้นทุน, เพิ่มมูลค่า, หรือปรับกลยุทธ์การตลาด",
                        "กำไรที่ยั่งยืนต้องคำนึงถึงความพอใจของลูกค้าด้วยครับ"
                    ],
                    risk: [
                        "ความเสี่ยงในธุรกิจหมูปิ้งมีหลายด้าน เช่น ราคาวัตถุดิบผันผวน, การแข่งขัน, และสภาพอากาศ",
                        "การบริหารความเสี่ยงที่ดีจะช่วยให้ธุรกิจอยู่รอดได้ในระยะยาว",
                        "ผมสามารถช่วยประเมินและแนะนำวิธีลดความเสี่ยงให้คุณได้ครับ"
                    ],
                    marketing: [
                        "การตลาดออนไลน์เป็นช่องทางสำคัญในยุคดิจิทัล ลองใช้ Facebook, Instagram หรือ TikTok ดูครับ",
                        "การสร้างฐานลูกค้าประจำเป็นสิ่งสำคัญ ลองทำโปรโมชั่นหรือระบบสะสมแต้มดู",
                        "คุณภาพและรสชาติยังคงเป็นปัจจัยหลักในการดึงดูดลูกค้า อย่าลืมพัฒนาผลิตภัณฑ์ด้วยครับ"
                    ],
                    weather: [
                        "สภาพอากาศมีผลกับยอดขายหมูปิ้งมากครับ วันฝนจะขายได้น้อยกว่าวันแดด",
                        "หน้าหนาวจะขายดีกว่าหน้าร้อน เพราะคนชอบกินของร้อนๆ",
                        "แนะนำให้มีแผนรองรับสภาพอากาศต่างๆ เช่น เต็นท์ในวันฝน หรือเครื่องดื่มเย็นในหน้าร้อน"
                    ],
                    experience: [
                        "ประสบการณ์เป็นครูที่ดีที่สุดครับ แต่การเรียนรู้จากคนอื่นจะช่วยลดเวลาลองผิดลองถูก",
                        "สำหรับมือใหม่ แนะนำให้เริ่มจากเล็กๆ และค่อยๆ ขยายเมื่อมีประสบการณ์มากขึ้น",
                        "คนที่มีประสบการณ์ก็ยังต้องปรับตัวตามสภาพตลาดที่เปลี่ยนแปลงอยู่เสมอ"
                    ],
                    compliment: [
                        "ขอบคุณครับ! ผมดีใจที่ได้ช่วยเหลือคุณ 😊",
                        "ไม่เป็นไรครับ นั่นคือหน้าที่ของผม!",
                        "ยินดีครับ! หวังว่าจะช่วยให้ธุรกิจของคุณประสบความสำเร็จ"
                    ],
                    unclear: [
                        "ขอโทษครับ ผมไม่เข้าใจคำถามของคุณชัดเจน คุณช่วยถามใหม่ได้ไหม?",
                        "คุณสามารถถามเกี่ยวกับเรื่องราคา, ตลาด, ต้นทุน, กำไร, หรือการตลาดหมูปิ้งได้ครับ",
                        "ลองใช้คำง่ายๆ หรือถามทีละเรื่องดูครับ ผมจะพยายามตอบให้ดีที่สุด"
                    ],
                    goodbye: [
                        "ขอบคุณที่มาปรึกษาครับ! หวังว่าข้อมูลที่ให้จะเป็นประโยชน์",
                        "โชคดีกับธุรกิจของคุณครับ! มีอะไรถามอีกก็แวะมาเจอกันได้",
                        "ลาก่อนครับ! หวังว่าหมูปิ้งของคุณจะขายดี 🍢"
                    ],
                    help: [
                        "ผมสามารถช่วยคุณในเรื่องต่างๆ เหล่านี้ได้:\n• วิเคราะห์ราคาขาย\n• คำนวณต้นทุน\n• ประเมินความเสี่ยง\n• แนะนำกลยุทธ์การตลาด\n• ให้คำปรึกษาทั่วไป",
                        "คุณสามารถถามผมเรื่องไหนก็ได้ที่เกี่ยวกับธุรกิจหมูปิ้ง เช่น:\n- ราคาเนื้อหมูแพงมากจะทำยังไง?\n- ยอดขายลดลงในหน้าฝนจะแก้ไขอย่างไร?\n- ต้องการเพิ่มกำไรมีวิธีไหนบ้าง?",
                        "ลองใช้ระบบคำนวณอัตโนมัติของเราด้วยครับ จะได้คำแนะนำที่ละเอียดมากขึ้น!"
                    ]
                };
            }

            initializeContextKeywords() {
                return {
                    greeting: ['สวัสดี', 'หวัดดี', 'hello', 'hi', 'hey'],
                    pricing: ['ราคา', 'price', 'ขาย', 'เท่าไหร่', 'บาท', 'ตั้งราคา', 'กำหนดราคา'],
                    market: ['ตลาด', 'market', 'แข่งขัน', 'competitor', 'ลูกค้า', 'customer', 'ยอดขาย', 'sale'],
                    cost: ['ต้นทุน', 'cost', 'ค่าใช้จ่าย', 'expense', 'เนื้อหมู', 'วัตถุดิบ', 'ingredient'],
                    profit: ['กำไร', 'profit', 'รายได้', 'income', 'เงิน', 'money', 'รวย', 'ได้เท่าไหร่'],
                    risk: ['ความเสี่ยง', 'risk', 'อันตราย', 'danger', 'ปัญหา', 'problem', 'เสี่ยง'],
                    marketing: ['การตลาด', 'marketing', 'โฆษณา', 'advertisement', 'โปรโมชั่น', 'promotion', 'ขาย', 'facebook', 'instagram'],
                    weather: ['อากาศ', 'weather', 'ฝน', 'rain', 'แดด', 'sun', 'หนาว', 'cold', 'ร้อน', 'hot'],
                    experience: ['ประสบการณ์', 'experience', 'มือใหม่', 'beginner', 'เซียน', 'expert', 'เริ่มต้น', 'start'],
                    compliment: ['ขอบคุณ', 'thank', 'ดี', 'good', 'เยี่ยม', 'excellent', 'เก่ง', 'smart'],
                    goodbye: ['บาย', 'bye', 'ลาก่อน', 'goodbye', 'แล้วเจอกัน', 'see you'],
                    help: ['ช่วย', 'help', 'ไม่รู้', 'ไม่เข้าใจ', 'อธิบาย', 'explain', 'บอก', 'tell']
                };
            }

            analyzeMessage(message) {
                const lowerMessage = message.toLowerCase();
                const scores = {};

                // Calculate relevance scores for each category
                Object.keys(this.contextKeywords).forEach(category => {
                    scores[category] = 0;
                    this.contextKeywords[category].forEach(keyword => {
                        if (lowerMessage.includes(keyword)) {
                            scores[category] += 1;
                        }
                    });
                });

                // Find the category with highest score
                const maxScore = Math.max(...Object.values(scores));
                if (maxScore === 0) return 'unclear';

                const bestCategory = Object.keys(scores).find(key => scores[key] === maxScore);
                return bestCategory;
            }

            generateResponse(message, category) {
                let response = {
                    text: '',
                    quickActions: [],
                    suggestion: null
                };

                // Get base response
                const responses = this.responses[category] || this.responses.unclear;
                response.text = responses[Math.floor(Math.random() * responses.length)];

                // Add personalization based on memory
                if (this.memory.profile.userName) {
                    response.text = response.text.replace('คุณ', this.memory.profile.userName);
                }

                // Add experience-based personalization
                if (category === 'pricing' && this.memory.profile.experienceLevel) {
                    if (this.memory.profile.experienceLevel === 'newbie') {
                        response.text += " สำหรับมือใหม่ แนะนำให้เริ่มจากราคาที่ปลอดภัยก่อนครับ";
                    } else if (this.memory.profile.experienceLevel === 'expert') {
                        response.text += " ด้วยประสบการณ์ของคุณ น่าจะสามารถทดลองกลยุทธ์ราคาที่หลากหลายได้ครับ";
                    }
                }

                // Add quick actions based on category
                this.addQuickActions(response, category);

                // Add contextual suggestions
                this.addSuggestions(response, category, message);

                return response;
            }

            addQuickActions(response, category) {
                switch (category) {
                    case 'pricing':
                        response.quickActions = [
                            'คำนวณราคาให้หน่อย',
                            'ราคาหมูปิ้งตอนนี้เท่าไหร่?',
                            'ต้นทุนสูงจะแก้ไขยังไง?'
                        ];
                        break;
                    case 'market':
                        response.quickActions = [
                            'ตลาดเป็นยังไงบ้าง?',
                            'คู่แข่งขันเยอะไหม?',
                            'ยอดขายลดลงจะทำยังไง?'
                        ];
                        break;
                    case 'profit':
                        response.quickActions = [
                            'จะเพิ่มกำไรได้ยังไง?',
                            'กำไรเท่าไหร่ถึงจะดี?',
                            'ลดต้นทุนได้ตรงไหนบ้าง?'
                        ];
                        break;
                    case 'help':
                        response.quickActions = [
                            'คำนวณราคาให้หน่อย',
                            'ดูประวัติการคำนวณ',
                            'ตั้งค่าโปรไฟล์'
                        ];
                        break;
                    default:
                        response.quickActions = [
                            'คำนวณราคาหมูปิ้ง',
                            'ถามเรื่องอื่น',
                            'ดูคำแนะนำ'
                        ];
                }
            }

            addSuggestions(response, category, message) {
                // Check if user hasn't used calculator yet
                if (this.memory.usage.totalCalculations === 0 && category !== 'greeting') {
                    response.suggestion = {
                        type: 'calculation',
                        text: 'ลองใช้ระบบคำนวณราคาอัตโนมัติดูไหมครับ? จะได้คำแนะนำที่ละเอียดมากขึ้น',
                        action: 'scrollToCalculator'
                    };
                }

                // Check if profile is incomplete
                if (!this.memory.profile.userName && category !== 'greeting') {
                    response.suggestion = {
                        type: 'profile',
                        text: 'หากบอกชื่อและข้อมูลให้ผมฟัง จะสามารถให้คำแนะนำที่เหมาะสมกับคุณได้มากขึ้นครับ',
                        action: 'scrollToProfile'
                    };
                }

                // Add memory-based insights
                if (this.memory.patterns.pricePatterns.length > 0) {
                    const lastPattern = this.memory.patterns.pricePatterns[this.memory.patterns.pricePatterns.length - 1];
                    if (category === 'profit' && lastPattern.outputs) {
                        response.text += ` \n\nจากการคำนวณล่าสุดของคุณ กำไรอยู่ที่ ${lastPattern.outputs.profitMargin.toFixed(2)} บาทต่อไม้ครับ`;
                    }
                }
            }

            async processMessage(message) {
                // Record user message
                this.memory.saveChatMessage({
                    sender: 'user',
                    message: message,
                    timestamp: new Date().toISOString()
                });

                // Analyze message and generate response
                const category = this.analyzeMessage(message);
                const response = this.generateResponse(message, category);

                // Record AI response and pattern
                this.memory.saveChatMessage({
                    sender: 'ai',
                    message: response.text,
                    category: category,
                    timestamp: new Date().toISOString()
                });

                this.memory.recordChatPattern(message, response);

                return response;
            }
        }

        // Global Conversational AI instance
        let conversationalAI = new ConversationalAI(aiMemory);

        // ========== CHAT INTERFACE FUNCTIONS ========== //

        function initializeChat() {
            const chatContainer = document.getElementById('chatContainer');
            const chatMessages = document.getElementById('chatMessages');

            // Load chat history
            loadChatHistory();

            // Add welcome message if no history
            if (aiMemory.chatHistory.length === 0) {
                setTimeout(() => {
                    addWelcomeMessage();
                }, 1000);
            }
        }

        function loadChatHistory() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            // Load last 20 messages
            const recentHistory = aiMemory.chatHistory.slice(-20);
            
            recentHistory.forEach(msg => {
                addMessageToChat(msg.message, msg.sender, msg.timestamp, false);
            });

            scrollToBottom();
        }

        function addWelcomeMessage() {
            const userName = aiMemory.profile.userName || '';
            const welcomeText = userName 
                ? `สวัสดี ${userName}! ผมพร้อมช่วยเหลือเรื่องหมูปิ้งของคุณครับ 🐷`
                : 'สวัสดีครับ! ผมเป็น AI ที่ปรึกษาหมูปิ้ง พร้อมช่วยเหลือคุณ 🍢';

            const response = {
                text: welcomeText,
                quickActions: ['คำนวณราคาหมูปิ้ง', 'ช่วยเหลือด้านอื่นๆ', 'ตั้งค่าโปรไฟล์']
            };

            addMessageToChat(response.text, 'ai', new Date().toISOString(), true);
            addQuickActionsToChat(response.quickActions);

            // Show notification
            showChatNotification();
        }

        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const chatToggle = document.getElementById('chatToggle');
            const isOpen = chatContainer.classList.contains('active');

            if (isOpen) {
                chatContainer.classList.remove('active');
                chatToggle.classList.remove('active');
                chatToggle.innerHTML = '<i class="fas fa-comments"></i>';
            } else {
                chatContainer.classList.add('active');
                chatToggle.classList.add('active');
                chatToggle.innerHTML = '<i class="fas fa-times"></i>';
                document.getElementById('chatInput').focus();
                hideChatNotification();
            }
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (message === '') return;

            // Add user message to chat
            addMessageToChat(message, 'user', new Date().toISOString(), true);
            chatInput.value = '';

            // Show typing indicator
            showTypingIndicator();

            // Process message with AI
            setTimeout(async () => {
                try {
                    const response = await conversationalAI.processMessage(message);
                    hideTypingIndicator();
                    
                    // Add AI response
                    addMessageToChat(response.text, 'ai', new Date().toISOString(), true);
                    
                    // Add quick actions if any
                    if (response.quickActions && response.quickActions.length > 0) {
                        addQuickActionsToChat(response.quickActions);
                    }
                    
                    // Handle suggestions
                    if (response.suggestion) {
                        handleSuggestion(response.suggestion);
                    }
                    
                } catch (error) {
                    hideTypingIndicator();
                    addMessageToChat('ขอโทษครับ เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'ai', new Date().toISOString(), true);
                }
            }, 1000 + Math.random() * 2000); // Random delay for natural feel
        }

        function addMessageToChat(message, sender, timestamp, animate = true) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            if (animate) messageDiv.style.opacity = '0';

            const time = new Date(timestamp).toLocaleTimeString('th-TH', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            messageDiv.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);

            if (animate) {
                setTimeout(() => {
                    messageDiv.style.opacity = '1';
                    messageDiv.classList.add('animate-slide-up');
                }, 100);
            }

            scrollToBottom();
        }

        function addQuickActionsToChat(actions) {
            const chatMessages = document.getElementById('chatMessages');
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'quick-actions';
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'quick-action';
                button.textContent = action;
                button.onclick = () => {
                    // Remove quick actions after click
                    actionsDiv.remove();
                    // Send as user message
                    document.getElementById('chatInput').value = action;
                    sendChatMessage();
                };
                actionsDiv.appendChild(button);
            });

            chatMessages.appendChild(actionsDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="<!-- เพิ่มใน main-grid หลัง card ที่ 2 -->
</div>

<!-- เพิ่ม Profile Grid ใหม่ -->
<div class="main-grid">
    <!-- AI Profile & Memory Section -->
    <div class="card animate-slide-up">
        <h2><i class="fas fa-user-robot"></i> โปรไฟล์ผู้ใช้ AI</h2>
        
        <div class="input-group">
            <label for="userName">ชื่อเรียก (ให้ AI เรียก)</label>
            <input type="text" id="userName" placeholder="คุณอยากให้ AI เรียกยังไง?">
        </div>

        <div class="input-group">
            <label for="businessGoal">เป้าหมายธุรกิจ</label>
            <select id="businessGoal">
                <option value="">เลือกเป้าหมาย...</option>
                <option value="survival">รอดพอมีกิน</option>
                <option value="stable">รายได้มั่นคง</option>
                <option value="growth">ขยายธุรกิจ</option>
                <option value="franchise">เปิดสาขา</option>
            </select>
        </div>

        <div class="input-group">
            <label for="experienceLevel">ประสบการณ์การค้า</label>
            <select id="experienceLevel">
                <option value="">เลือกระดับ...</option>
                <option value="newbie">มือใหม่ (< 6 เดือน)</option>
                <option value="learning">กำลังเรียนรู้ (6เดือน-2ปี)</option>
                <option value="experienced">มีประสบการณ์ (2-5ปี)</option>
                <option value="expert">เซียน (5+ ปี)</option>
            </select>
        </div>

        <div class="input-group">
            <label for="riskTolerance">ระดับความเสี่ยงที่รับได้</label>
            <select id="riskTolerance">
                <option value="">เลือกระดับ...</option>
                <option value="conservative">อนุรักษ์นิยม (เสี่ยงน้อย)</option>
                <option value="moderate">ปานกลาง</option>
                <option value="aggressive">เสี่ยงได้ (กำไรสูง)</option>
            </select>
        </div>

        <button class="button" onclick="saveProfile()">
            <i class="fas fa-save"></i> บันทึกข้อมูล AI จะจำ
        </button>

        <!-- AI Status -->
        <div id="aiStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; background: rgba(74, 144, 226, 0.1); border-left: 4px solid #4a90e2;">
            <div id="aiGreeting" style="font-weight: 500; color: #4a90e2;">
                <i class="fas fa-robot"></i> AI พร้อมทำความรู้จักกับคุณ...
            </div>
            <div id="aiInsight" style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                กรอกข้อมูลเพื่อให้ AI เข้าใจและช่วยคุณได้ดีขึ้น
            </div>
        </div>
    </div>

    <!-- AI Statistics & Learning -->
    <div class="card animate-slide-up">
        <h2><i class="fas fa-chart-area"></i> AI กำลังเรียนรู้คุณ</h2>
        
        <!-- การใช้งาน -->
        <div class="stat-item">
            <div class="stat-label">การใช้งานทั้งหมด</div>
            <div class="stat-value" id="usageCount">-</div>
        </div>

        <div class="stat-item">
            <div class="stat-label">คะแนน AI Accuracy</div>
            <div class="stat-value" id="aiAccuracy">-</div>
        </div>

        <div class="stat-item">
            <div class="stat-label">ข้อมูลที่ AI จำได้</div>
            <div class="stat-value" id="dataPoints">-</div>
        </div>

        <!-- AI Learning Progress -->
        <div class="learning-progress" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-size: 0.9rem; color: #666;">AI Learning Progress</span>
                <span id="learningPercent" style="font-size: 0.9rem; color: #4a90e2;">0%</span>
            </div>
            <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                <div id="learningBar" style="height: 100%; background: linear-gradient(90deg, #4a90e2, #6ab7ff); width: 0%; transition: width 0.5s ease;"></div>
            </div>
        </div>

        <!-- Personality Insights -->
        <div id="personalityInsights" style="margin-top: 15px; padding: 10px; border-radius: 8px; background: rgba(0, 200, 83, 0.1); border-left: 4px solid #00c853;">
            <div style="font-weight: 500; color: #00c853; margin-bottom: 5px;">
                <i class="fas fa-lightbulb"></i> AI Personality Match
            </div>
            <div id="personalityText" style="font-size: 0.9rem; color: #666;">
                ใช้งานเพิ่มเติมเพื่อให้ AI วิเคราะห์บุคลิกการค้าของคุณ
            </div>
        </div>

        <button class="button secondary" onclick="resetAIMemory()">
            <i class="fas fa-brain"></i> รีเซ็ต AI Memory
        </button>
    </div>
</div>

<style>
/* เพิ่ม CSS สำหรับ Profile Section */
.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(139, 69, 19, 0.2);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    font-weight: 500;
}

.stat-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: #8B4513;
}

#aiStatus, #personalityInsights {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Robot icon animation */
.fa-user-robot, .fa-robot {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>

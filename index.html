
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- Mobile Optimization -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏Å‡∏£">
    <meta name="application-name" content="‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏Å‡∏£">
    <meta name="theme-color" content="#2c3e50">
    <meta name="msapplication-TileColor" content="#2c3e50">
    
    <!-- Enhanced PWA Manifest -->
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,eyJuYW1lIjoi4Lij4Liw4Lia4Lia4LiH4LiH4Liy4Lij4LiU4Lix4LiU4LiB4Liy4Lij4Lil4Liy4Lij4LjM4LiZ4Li44LiB4Lij4LjMIiwic2hvcnRfbmFtZSI6IuC4pOC4suC4o+C5jOC4oeC4lOC4iOC4seC4lOC4hOC4quC4uOC4geC4o+C5jCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmOWZhIiwidGhlbWVfY29sb3IiOiIjMmMzZTUwIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1Ua3lJaUJvWldsbmFIUTlJakU1TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJREU1TWlBeE9USWlJR1pwYkd3OUltNXZibVVpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEdKbFkyc2dkMmxrZEdnOUlqRTVNaUlnYUdWcFoyaDBQU0l4T1RJaUlHWnBiR3c5SWpKak0yVTFNQ0l2UGp4MFpYaDBJSGc5SWprMklpQjVQU0l4TURVaUlHWnZiblF0Wm1GdGFXeDVQU0pCY21saGJDSWdabTl1ZEMxemFYcGxQU0k0TUNJZ1ptbHNiRDBpZDJocGRHVWlJSFJsZUhRdFlXNWphRzl5UFNKdGFXUmtiR1VpUG5BblUwdEhiamM4TDNSbGVIUStQQzl6ZG1jKyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlOVEV5SWlCb1pXbG5hSFE5SWpVeE1pSWdkbWxsZDBKdmVEMGlNQ0F3SURREFJETTJJR1pwYkd3OUltNXZibVVpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEdKbFkyc2dkMmxrZEdnOUlqVXhNaUlnYUdWcFoyaDBQU0kxTVRJaUlHWnBiR3c5SWpKak0yVTFNQ0l2UGp4MFpYaDBJSGc5SWpJMU5pSWdlVDBpTWpjd0lpQm1iMjUwTFdaaGJXbHNlVDBpUVhKcFlXd2lJR1p2Ym5RdGMybDZaVDBpTVRZd0lpQm1hV3hzUFNKM2FHbDBaU0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK2NGUTBrTGIzUEM5MFpYaDBQand2YzNabktnIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    
    <!-- Enhanced Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGJlY2sgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMyYzNlNTAiLz48dGV4dCB4PSI5NiIgeT0iMTA1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iODAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wkJC3PC90ZXh0Pjwvc3ZnPg==">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGJlY2sgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMyYzNlNTAiLz48dGV4dCB4PSI5NiIgeT0iMTA1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iODAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wkJC3PC90ZXh0Pjwvc3ZnPg==">
    <link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGJlY2sgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMyYzNlNTAiLz48dGV4dCB4PSI5NiIgeT0iMTA1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iODAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wkJC3PC90ZXh0Pjwvc3ZnPg==">
    
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏Å‡∏£</title>
    <style>
/* Modern CSS Reset */
*, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

/* Root Variables for Consistent Design */
:root {
    --primary-color: #2c3e50;
    --primary-light: #34495e;
    --accent-color: #3498db;
    --accent-hover: #2980b9;
    --success-color: #27ae60;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --secondary-color: #95a5a6;
    
    --bg-primary: #f8f9fa;
    --bg-card: #ffffff;
    --bg-hover: #f1f3f4;
    
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --text-light: #95a5a6;
    
    --border-color: #e0e6ed;
    --border-radius: 12px;
    --border-radius-large: 16px;
    
    --shadow-small: 0 2px 8px rgba(0,0,0,0.06);
    --shadow-medium: 0 4px 16px rgba(0,0,0,0.08);
    --shadow-large: 0 8px 32px rgba(0,0,0,0.12);
    
    --transition-fast: 0.15s ease;
    --transition-medium: 0.3s ease;
    
    --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    
    /* Navigation Variables */
    --nav-gap-mobile: 4px;
    --nav-gap-desktop: 8px;
    --nav-padding-mobile: 12px 16px;
    --nav-padding-desktop: 16px 20px;
    --nav-font-size-mobile: 13px;
    --nav-font-size-desktop: 15px;
}

/* Base Body Styles */
body {
    font-family: var(--font-family);
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-text-size-adjust: 100%;
    touch-action: manipulation;
    overflow-x: hidden;
    min-height: 100vh;
}

/* Container */
.container {
    max-width: 100%;
    margin: 0 auto;
    padding: 12px;
    min-height: 100vh;
}

@media (min-width: 768px) {
    .container {
        padding: 20px;
        max-width: 1200px;
    }
}

@media (min-width: 1024px) {
    .container {
        padding: 24px;
    }
}

/* Enhanced Header */
.header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
    padding: 20px 16px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    text-align: center;
    box-shadow: var(--shadow-medium);
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

.header h1 {
    font-size: 22px;
    margin-bottom: 8px;
    font-weight: 700;
    position: relative;
    z-index: 1;
}

.header p {
    font-size: 14px;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

@media (min-width: 768px) {
    .header {
        padding: 32px 24px;
    }
    
    .header h1 {
        font-size: 28px;
        margin-bottom: 12px;
    }
    
    .header p {
        font-size: 16px;
    }
}
/* RESPONSIVE NAVIGATION SYSTEM */
.nav-tabs {
    display: flex;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow-medium);
    padding: 8px;
    position: relative;
    overflow: hidden;
}

/* Mobile First - Horizontal Scroll Navigation */
@media (max-width: 767px) {
    .nav-tabs {
        overflow-x: auto;
        overflow-y: hidden;
        gap: var(--nav-gap-mobile);
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .nav-tabs::-webkit-scrollbar {
        display: none;
    }
    
    .nav-tab {
        flex: 0 0 auto;
        padding: var(--nav-padding-mobile);
        font-size: var(--nav-font-size-mobile);
        white-space: nowrap;
        min-width: 80px;
    }
}

/* Tablet Navigation - Balanced Distribution */
@media (min-width: 768px) and (max-width: 1023px) {
    .nav-tabs {
        gap: var(--nav-gap-desktop);
    }
    
    .nav-tab {
        flex: 1;
        padding: var(--nav-padding-desktop);
        font-size: var(--nav-font-size-desktop);
        text-align: center;
        min-width: 0;
    }
}

/* Desktop Navigation - Full Width Distribution */
@media (min-width: 1024px) {
    .nav-tabs {
        gap: 12px;
        padding: 10px;
    }
    
    .nav-tab {
        flex: 1;
        padding: 18px 24px;
        font-size: 16px;
        text-align: center;
        min-width: 0;
        font-weight: 600;
    }
}

/* Navigation Tab Base Styles */
.nav-tab {
    cursor: pointer;
    border: none;
    background: transparent;
    font-weight: 600;
    transition: all var(--transition-medium);
    border-radius: 10px;
    color: var(--text-secondary);
    position: relative;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    overflow: hidden;
}

/* Hover Effects for Desktop */
@media (min-width: 768px) {
    .nav-tab:hover:not(.active) {
        background: var(--bg-hover);
        color: var(--text-primary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-small);
    }
}

/* Active Tab Styles */
.nav-tab.active {
    background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
    color: white;
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    transform: translateY(-1px);
}

/* Touch Feedback */
.nav-tab:active {
    transform: scale(0.98);
}

/* Tab Content Indicator */
.nav-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 3px;
    background: rgba(255,255,255,0.8);
    border-radius: 2px;
}

/* Responsive Tab Text */
@media (max-width: 480px) {
    .nav-tab {
        font-size: 12px;
        padding: 10px 12px;
    }
    
    /* Hide text on very small screens, show only emoji */
    .nav-tab .tab-text {
        display: none;
    }
    
    .nav-tab .tab-emoji {
        font-size: 18px;
    }
}

@media (min-width: 481px) {
    .nav-tab .tab-emoji {
        margin-right: 6px;
    }
}

/* Navigation Animations */
.content-section {
    display: none;
    animation: fadeInUp 0.4s ease-out;
}

.content-section.active {
    display: block;
}

@keyframes fadeInUp {
    from { 
        opacity: 0; 
        transform: translateY(20px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0);
    }
}

/* Navigation Scroll Indicators for Mobile */
@media (max-width: 767px) {
    .nav-tabs::before,
    .nav-tabs::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        width: 20px;
        pointer-events: none;
        z-index: 2;
    }
    
    .nav-tabs::before {
        left: 0;
        background: linear-gradient(to right, var(--bg-card), transparent);
    }
    
    .nav-tabs::after {
        right: 0;
        background: linear-gradient(to left, var(--bg-card), transparent);
    }
}
/* Enhanced Card Styles */
.card {
    background: var(--bg-card);
    border-radius: var(--border-radius-large);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-medium);
    border: 1px solid rgba(0,0,0,0.04);
    transition: box-shadow var(--transition-medium);
    position: relative;
    overflow: hidden;
}

.card:hover {
    box-shadow: var(--shadow-large);
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent-color), var(--success-color), var(--warning-color));
}

@media (min-width: 768px) {
    .card {
        padding: 28px;
        margin-bottom: 24px;
    }
}

.card-title {
    font-size: 18px;
    margin-bottom: 20px;
    color: var(--text-primary);
    font-weight: 700;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 12px;
    position: relative;
}

@media (min-width: 768px) {
    .card-title {
        font-size: 20px;
        margin-bottom: 24px;
        padding-bottom: 16px;
    }
}

/* Enhanced Form Grid */
.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}

@media (min-width: 768px) {
    .form-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
}

@media (min-width: 1024px) {
    .form-grid {
        gap: 24px;
    }
}

/* Form Elements */
.form-group {
    margin-bottom: 16px;
}

@media (min-width: 768px) {
    .form-group {
        margin-bottom: 20px;
    }
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
    transition: color var(--transition-fast);
}

@media (min-width: 768px) {
    .form-label {
        font-size: 15px;
        margin-bottom: 10px;
    }
}

.form-label.required::after {
    content: " *";
    color: var(--danger-color);
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: all var(--transition-medium);
    background: var(--bg-primary);
    appearance: none;
    -webkit-appearance: none;
    font-family: inherit;
}

@media (min-width: 768px) {
    .form-input, .form-select, .form-textarea {
        padding: 16px 18px;
        font-size: 16px;
    }
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--accent-color);
    background: var(--bg-card);
    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
    transform: translateY(-1px);
}

/* Enhanced Button System */
.btn {
    padding: 14px 20px;
    border: none;
    border-radius: var(--border-radius);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-medium);
    margin-right: 8px;
    margin-bottom: 8px;
    text-align: center;
    position: relative;
    overflow: hidden;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 44px;
    font-family: inherit;
}

@media (min-width: 768px) {
    .btn {
        padding: 16px 24px;
        font-size: 16px;
        min-height: 48px;
    }
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:active {
    transform: translateY(1px);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Button Variants */
.btn-primary {
    background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
    color: white;
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.btn-primary:hover {
    box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
    transform: translateY(-2px);
}

.btn-success {
    background: linear-gradient(135deg, var(--success-color), #229954);
    color: white;
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.btn-success:hover {
    box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    transform: translateY(-2px);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger-color), #c0392b);
    color: white;
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.btn-danger:hover {
    box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
    transform: translateY(-2px);
}

.btn-warning {
    background: linear-gradient(135deg, var(--warning-color), #e67e22);
    color: white;
    box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
}

.btn-warning:hover {
    box-shadow: 0 6px 16px rgba(243, 156, 18, 0.4);
    transform: translateY(-2px);
}

.btn-secondary {
    background: linear-gradient(135deg, var(--secondary-color), #7f8c8d);
    color: white;
    box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
}

.btn-secondary:hover {
    box-shadow: 0 6px 16px rgba(149, 165, 166, 0.4);
    transform: translateY(-2px);
}

.btn-small {
    padding: 8px 12px;
    font-size: 13px;
    border-radius: 8px;
    min-height: 36px;
}

@media (min-width: 768px) {
    .btn-small {
        padding: 10px 16px;
        font-size: 14px;
        min-height: 40px;
    }
}
/* Enhanced Alert System */
.alert {
    padding: 16px 20px;
    border-radius: var(--border-radius);
    margin-bottom: 16px;
    font-weight: 500;
    border-left: 4px solid;
    position: relative;
    animation: slideInDown 0.3s ease-out;
}

@keyframes slideInDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.alert-success {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    border-left-color: var(--success-color);
}

.alert-error {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    border-left-color: var(--danger-color);
}

.alert-warning {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    color: #856404;
    border-left-color: var(--warning-color);
}

.hidden {
    display: none;
}

/* Enhanced Stock Management */
.stock-item {
    display: flex;
    flex-direction: column;
    padding: 20px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 16px;
    transition: all var(--transition-medium);
    background: var(--bg-card);
    position: relative;
    overflow: hidden;
}

@media (min-width: 768px) {
    .stock-item {
        padding: 24px;
        margin-bottom: 20px;
    }
}

.stock-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--accent-color);
}

.stock-item:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

.stock-item.low-stock {
    border-color: var(--warning-color);
    background: linear-gradient(135deg, #fef9e7, #fff3cd);
}

.stock-item.low-stock::before {
    background: var(--warning-color);
}

.stock-item.out-of-stock {
    border-color: var(--danger-color);
    background: linear-gradient(135deg, #fdedec, #f8d7da);
}

.stock-item.out-of-stock::before {
    background: var(--danger-color);
}

.stock-info {
    margin-bottom: 16px;
}

@media (min-width: 768px) {
   .stock-info {
       margin-bottom: 20px;
   }
}

.stock-name {
   font-weight: 700;
   font-size: 16px;
   margin-bottom: 8px;
   color: var(--text-primary);
}

@media (min-width: 768px) {
   .stock-name {
       font-size: 18px;
       margin-bottom: 10px;
   }
}

.stock-details {
   font-size: 13px;
   color: var(--text-secondary);
   margin-bottom: 4px;
   line-height: 1.4;
}

@media (min-width: 768px) {
   .stock-details {
       font-size: 14px;
       margin-bottom: 6px;
   }
}

.stock-status {
   font-size: 12px;
   font-weight: 600;
   padding: 6px 12px;
   border-radius: 20px;
   display: inline-block;
   margin-top: 8px;
   text-transform: uppercase;
   letter-spacing: 0.5px;
}

@media (min-width: 768px) {
   .stock-status {
       font-size: 13px;
       padding: 8px 16px;
       margin-top: 10px;
   }
}

.stock-status.normal {
   background: linear-gradient(135deg, #d4edda, #c3e6cb);
   color: var(--success-color);
}

.stock-status.low {
   background: linear-gradient(135deg, #fff3cd, #ffeaa7);
   color: var(--warning-color);
}

.stock-status.empty {
   background: linear-gradient(135deg, #f8d7da, #f5c6cb);
   color: var(--danger-color);
}

.stock-actions {
   display: flex;
   gap: 8px;
   flex-wrap: wrap;
}

@media (min-width: 768px) {
   .stock-actions {
       gap: 12px;
   }
}

.stock-actions .btn {
   flex: 1;
   margin: 0;
   min-width: 120px;
}

@media (min-width: 768px) {
   .stock-actions .btn {
       min-width: 140px;
   }
}

/* Enhanced Statistics Grid */
.stats-grid {
   display: grid;
   grid-template-columns: repeat(2, 1fr);
   gap: 12px;
   margin-bottom: 20px;
}

@media (min-width: 768px) {
   .stats-grid {
       grid-template-columns: repeat(4, 1fr);
       gap: 16px;
       margin-bottom: 24px;
   }
}

@media (min-width: 1024px) {
   .stats-grid {
       gap: 20px;
   }
}

.stat-card {
   background: linear-gradient(135deg, var(--bg-card), var(--bg-primary));
   padding: 20px;
   border-radius: var(--border-radius-large);
   text-align: center;
   box-shadow: var(--shadow-medium);
   border: 1px solid rgba(0,0,0,0.04);
   transition: all var(--transition-medium);
   position: relative;
   overflow: hidden;
}

@media (min-width: 768px) {
   .stat-card {
       padding: 24px;
   }
}

.stat-card:hover {
   transform: translateY(-4px);
   box-shadow: var(--shadow-large);
}

.stat-card::before {
   content: '';
   position: absolute;
   top: 0;
   left: 0;
   right: 0;
   height: 3px;
   background: linear-gradient(90deg, var(--accent-color), var(--success-color));
}

.stat-number {
   font-size: 24px;
   font-weight: 800;
   color: var(--accent-color);
   margin-bottom: 8px;
   line-height: 1;
}

@media (min-width: 768px) {
   .stat-number {
       font-size: 28px;
       margin-bottom: 10px;
   }
}

.stat-label {
   font-size: 12px;
   color: var(--text-secondary);
   font-weight: 500;
   text-transform: uppercase;
   letter-spacing: 0.5px;
}

@media (min-width: 768px) {
   .stat-label {
       font-size: 13px;
   }
}

/* Enhanced Table Styles */
.table-container {
   overflow-x: auto;
   -webkit-overflow-scrolling: touch;
   border-radius: var(--border-radius);
   box-shadow: var(--shadow-medium);
   background: var(--bg-card);
}

.table {
   width: 100%;
   border-collapse: collapse;
   font-size: 14px;
   background: var(--bg-card);
}

@media (min-width: 768px) {
   .table {
       font-size: 15px;
   }
}

.table th {
   background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
   color: white;
   padding: 16px 12px;
   text-align: left;
   font-weight: 600;
   font-size: 13px;
   position: sticky;
   top: 0;
   z-index: 10;
}

@media (min-width: 768px) {
   .table th {
       padding: 18px 16px;
       font-size: 14px;
   }
}

.table td {
   padding: 14px 12px;
   border-bottom: 1px solid var(--border-color);
   font-size: 13px;
   transition: background-color var(--transition-fast);
}

@media (min-width: 768px) {
   .table td {
       padding: 16px 16px;
       font-size: 14px;
   }
}

.table tr:hover {
   background: var(--bg-hover);
}

.table tr:last-child td {
   border-bottom: none;
}

/* Usage Form Styles */
.usage-form {
   background: linear-gradient(135deg, var(--bg-primary), #e9ecef);
   padding: 20px;
   border-radius: var(--border-radius);
   margin-top: 16px;
   border: 1px solid var(--border-color);
   position: relative;
}

@media (min-width: 768px) {
   .usage-form {
       padding: 24px;
       margin-top: 20px;
   }
}

.usage-form h3 {
   color: var(--text-primary);
   margin-bottom: 16px;
   font-size: 16px;
   font-weight: 700;
}

@media (min-width: 768px) {
   .usage-form h3 {
       font-size: 18px;
       margin-bottom: 20px;
   }
}

.usage-history {
   background: var(--bg-card);
   border-radius: var(--border-radius);
   padding: 20px;
   margin-top: 16px;
   box-shadow: var(--shadow-medium);
}

@media (min-width: 768px) {
   .usage-history {
       padding: 24px;
       margin-top: 20px;
   }
}

/* Mobile Optimizations */
@media (max-width: 767px) {
   .table {
       min-width: 600px;
   }
   
   .form-grid {
       grid-template-columns: 1fr;
   }
   
   .stock-actions {
       flex-direction: column;
   }
   
   .stock-actions .btn {
       flex: none;
       width: 100%;
   }
}

/* Loading Animation */
.loading {
   display: inline-block;
   width: 20px;
   height: 20px;
   border: 3px solid rgba(255,255,255,.3);
   border-radius: 50%;
   border-top-color: #fff;
   animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
   to { transform: rotate(360deg); }
}

/* Safe Area Support for Modern Mobile Devices */
@supports (padding-top: constant(safe-area-inset-top)) {
   .header {
       padding-top: calc(20px + constant(safe-area-inset-top));
   }
}

@supports (padding-top: env(safe-area-inset-top)) {
   .header {
       padding-top: calc(20px + env(safe-area-inset-top));
   }
}

/* Enhanced Install Button */
.manual-install {
   position: fixed;
   bottom: 20px;
   right: 20px;
   background: linear-gradient(135deg, var(--danger-color), #c0392b);
   color: white;
   padding: 12px 16px;
   border-radius: 50px;
   box-shadow: 0 4px 20px rgba(231, 76, 60, 0.4);
   z-index: 999999;
   border: none;
   font-weight: 600;
   font-size: 14px;
   cursor: pointer;
   transition: all var(--transition-medium);
   display: flex;
   align-items: center;
   gap: 8px;
   text-decoration: none;
}

@media (min-width: 768px) {
   .manual-install {
       bottom: 24px;
       right: 24px;
       padding: 14px 20px;
       font-size: 15px;
   }
}

.manual-install:hover {
   transform: scale(1.05);
   box-shadow: 0 6px 25px rgba(231, 76, 60, 0.5);
}

.manual-install:active {
   transform: scale(0.95);
}

/* Hide install button in standalone mode */
@media (display-mode: standalone) {
   .manual-install {
       display: none !important;
   }
}

/* Enhanced Scrollbar Styles */
::-webkit-scrollbar {
   width: 8px;
   height: 8px;
}

::-webkit-scrollbar-track {
   background: var(--bg-primary);
   border-radius: 4px;
}

::-webkit-scrollbar-thumb {
   background: var(--text-light);
   border-radius: 4px;
   transition: background var(--transition-fast);
}

::-webkit-scrollbar-thumb:hover {
   background: var(--text-secondary);
}

/* Focus Styles for Accessibility */
.nav-tab:focus,
.btn:focus,
.form-input:focus,
.form-select:focus,
.form-textarea:focus {
   outline: 2px solid var(--accent-color);
   outline-offset: 2px;
}

/* Print Styles */
@media print {
   .nav-tabs,
   .manual-install,
   .btn {
       display: none !important;
   }
   
   .container {
       padding: 0;
   }
   
   .card {
       box-shadow: none;
       border: 1px solid #ddd;
       break-inside: avoid;
   }
}
</style>
</head>
<body>
    <!-- Enhanced Install Button -->
    <button id="manualInstall" class="manual-install" onclick="showInstallInstructions()">
        üì± ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ
    </button>

    <div class="container">
        <!-- Enhanced Header -->
        <div class="header">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏Å‡∏£</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏¢‡∏≤ ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
        </div>

        <!-- Alert Messages -->
        <div id="alertMessage" class="alert hidden"></div>

        <!-- Low Stock Warnings -->
        <div id="stockWarnings"></div>

        <!-- Enhanced Responsive Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('overview')">
                <span class="tab-emoji">üè†</span>
                <span class="tab-text">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
            </button>
            <button class="nav-tab" onclick="showSection('pigs')">
                <span class="tab-emoji">üê∑</span>
                <span class="tab-text">‡∏™‡∏∏‡∏Å‡∏£</span>
            </button>
            <button class="nav-tab" onclick="showSection('feeds')">
                <span class="tab-emoji">üåæ</span>
                <span class="tab-text">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
            </button>
            <button class="nav-tab" onclick="showSection('medical')">
                <span class="tab-emoji">üíä</span>
                <span class="tab-text">‡∏¢‡∏≤</span>
            </button>
            <button class="nav-tab" onclick="showSection('usage')">
                <span class="tab-emoji">üìù</span>
                <span class="tab-text">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </button>
            <button class="nav-tab" onclick="showSection('sales')">
                <span class="tab-emoji">üí∞</span>
                <span class="tab-text">‡∏Ç‡∏≤‡∏¢</span>
            </button>
            <button class="nav-tab" onclick="showSection('reports')">
                <span class="tab-emoji">üìä</span>
                <span class="tab-text">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
            </button>
        </div>

        <!-- Overview Section -->
        <div id="overview" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPigs">-</div>
                    <div class="stat-label">‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="feedItems">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="medicalItems">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lowStockItems">-</div>
                    <div class="stat-label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div id="stockSummary">
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
            </div>
        </div>

        <!-- Pigs Management Section -->
        <div id="pigs" class="content-section">
            <div class="card">
                <div class="card-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Å‡∏£</div>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label class="form-label required">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏∏‡∏Å‡∏£</label>
                            <select class="form-select" id="pigType">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                <option value="sow">‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                                <option value="boar">‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                                <option value="piglet">‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£</option>
                                <option value="grower">‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô</option>
                                <option value="finisher">‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                            <input type="number" class="form-input" id="pigQuantity" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≤‡∏£‡πå‡∏°</label>
                            <input type="date" class="form-input" id="pigEntryDate">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</label>
                            <input type="number" class="form-input" id="pigWeight" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ß‡∏±‡∏ô)</label>
                            <input type="number" class="form-input" id="pigAge">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <input type="text" class="form-input" id="pigNotes">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="addPig()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button class="btn btn-secondary" onclick="clearPigForm()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏Å‡∏£‡πÉ‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°</div>
                <div id="pigsList">
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Å‡∏£</p>
                </div>
            </div>
        </div>

        <!-- Feeds Section -->
        <div id="feeds" class="content-section">
            <div class="card">
                <div class="card-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label class="form-label required">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                            <select class="form-select" id="feedType">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                <option value="prestarter">Pre-Starter (‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£‡πÅ‡∏£‡∏Å‡πÄ‡∏Å‡∏¥‡∏î)</option>
                                <option value="starter">Starter (‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£ 1-2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                                <option value="grower">Grower (‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô 2-4 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                                <option value="finisher">Finisher (‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Ç‡∏≤‡∏¢)</option>
                                <option value="sow">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                                <option value="boar">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</label>
                            <input type="text" class="form-input" id="feedBrand">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</label>
                            <input type="number" class="form-input" id="feedQuantity" step="0.1">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label required">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="feedPrice" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
                            <input type="date" class="form-input" id="feedPurchaseDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
                            <input type="date" class="form-input" id="feedExpiryDate">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="addFeed()">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                    <button class="btn btn-secondary" onclick="clearFeedForm()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
                <div id="feedStock">
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                </div>
            </div>
        </div>
        <!-- Medical Section -->
        <div id="medical" class="content-section">
            <div class="card">
                <div class="card-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label class="form-label required">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                            <select class="form-select" id="medicalType">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                <option value="vaccine">‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</option>
                                <option value="antibiotic">‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞</option>
                                <option value="vitamin">‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô</option>
                                <option value="deworming">‡∏¢‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ò‡∏¥</option>
                                <option value="hormone">‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô</option>
                                <option value="supplement">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
                                <option value="disinfectant">‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</label>
                            <input type="text" class="form-input" id="medicalName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏•‡∏¥‡∏ï</label>
                            <input type="text" class="form-input" id="medicalBrand">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                            <input type="number" class="form-input" id="medicalQuantity" step="1">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label required">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <select class="form-select" id="medicalUnit">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
                                <option value="dose">‡πÇ‡∏î‡∏™</option>
                                <option value="ml">‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏•‡∏¥‡∏ï‡∏£</option>
                                <option value="tablet">‡πÄ‡∏°‡πá‡∏î</option>
                                <option value="bottle">‡∏Ç‡∏ß‡∏î</option>
                                <option value="vial">‡∏´‡∏•‡∏≠‡∏î</option>
                                <option value="kg">‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</option>
                                <option value="gram">‡∏Å‡∏£‡∏±‡∏°</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="medicalPrice" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
                            <input type="date" class="form-input" id="medicalPurchaseDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
                            <input type="date" class="form-input" id="medicalExpiryDate">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="addMedical()">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                    <button class="btn btn-secondary" onclick="clearMedicalForm()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üíä ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</div>
                <div id="medicalStock">
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</p>
                </div>
            </div>
        </div>

        <!-- Daily Usage Section -->
        <div id="usage" class="content-section">
            <div class="card">
                <div class="card-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</div>
                <div class="usage-form">
                    <h3>üåæ ‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                            <select class="form-select" id="useFeedSelect">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</label>
                            <input type="number" class="form-input" id="useFeedAmount" step="0.1">
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="useFeed()">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                </div>

                <div class="usage-form">
                    <h3>üíä ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</label>
                            <select class="form-select" id="useMedicalSelect">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
                            <input type="number" class="form-input" id="useMedicalAmount" step="0.1">
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="useMedical()">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</button>
                </div>
            </div>

            <div class="usage-history">
                <h3>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <div id="todayUsage">
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                </div>
            </div>
        </div>

        <!-- Sales Section -->
        <div id="sales" class="content-section">
            <div class="card">
                <div class="card-title">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label class="form-label required">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</label>
                            <input type="date" class="form-input" id="saleDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</label>
                            <select class="form-select" id="saleType">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                <option value="piglet">‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£</option>
                                <option value="grower">‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô</option>
                                <option value="finisher">‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô</option>
                                <option value="sow">‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                                <option value="boar">‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (‡∏ï‡∏±‡∏ß)</label>
                            <input type="number" class="form-input" id="saleQuantity" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</label>
                            <input type="number" class="form-input" id="saleWeight" step="0.1">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label required">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="salePricePerKg" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" class="form-input" id="saleTransportCost" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label>
                            <input type="text" class="form-input" id="saleBuyer">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <input type="text" class="form-input" id="saleNotes">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="addSale()">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                    <button class="btn btn-secondary" onclick="clearSaleForm()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                <div class="table-container">
                    <div id="salesHistory">
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section">
            <div class="card">
                <div class="card-title">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</div>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <select class="form-select" id="reportType">
                                <option value="overview">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°</option>
                                <option value="stock">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</option>
                                <option value="usage">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                <option value="financial">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>
                                <option value="livestock">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Å‡∏£</option>
                                <option value="sales">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateReport()" style="margin-top: 30px;">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                        <button class="btn btn-secondary" onclick="exportReport()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>
                <div id="reportResults" style="margin-top: 30px;">
                    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
                </div>
            </div>
        </div>

    </div>
    <script>
// === Enhanced PWA ‡πÅ‡∏•‡∏∞ Mobile App Functionality ===
let deferredPrompt;
let isStandalone = false;

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô PWA standalone mode ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
    isStandalone = true;
}
if (window.navigator && window.navigator.standalone === true) {
    isStandalone = true;
}

// Enhanced PWA Install Prompt
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log('PWA install prompt ready');
});

function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
                showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ...', 'success');
            }
            deferredPrompt = null;
        });
    }
}

// Enhanced Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swCode = `
const CACHE_NAME = 'pig-farm-app-v3.0.0';
const urlsToCache = [
    '/',
    '/offline.html'
];

self.addEventListener('install', event => {
    console.log('Service Worker installing...');
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => {
                console.log('Cache opened');
                return cache.addAll(urlsToCache);
            })
    );
});

self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request)
            .then(response => {
                if (response) {
                    return response;
                }
                return fetch(event.request).catch(() => {
                    if (event.request.destination === 'document') {
                        return caches.match('/offline.html');
                    }
                });
            })
    );
});

self.addEventListener('activate', event => {
    console.log('Service Worker activating...');
    event.waitUntil(
        caches.keys().then(cacheNames => {
            return Promise.all(
                cacheNames.map(cacheName => {
                    if (cacheName !== CACHE_NAME) {
                        console.log('Deleting old cache:', cacheName);
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
});
        `;

        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);

        navigator.serviceWorker.register(swUrl)
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// === Enhanced System Version ‡πÅ‡∏•‡∏∞ Data Management ===
const SYSTEM_VERSION = "3.0.0";
const STORAGE_KEY = "pigFarmManagementSystem";

// Enhanced Default Data Structure
const DEFAULT_DATA_STRUCTURE = {
    version: SYSTEM_VERSION,
    lastUpdate: new Date().toISOString(),
    settings: {
        lowStockThreshold: {
            feeds: 50,
            medical: 5
        },
        currency: "‡∏ö‡∏≤‡∏ó",
        language: "th",
        notifications: {
            lowStock: true,
            dailyReminder: true
        },
        theme: "default"
    },
    farmData: {
        pigs: [],
        feeds: [],
        medical: [],
        sales: [],
        usage: []
    },
    statistics: {
        totalPigsAdded: 0,
        totalFeedUsed: 0,
        totalMedicalUsed: 0,
        totalSales: 0,
        totalRevenue: 0
    }
};

// Enhanced Mobile Optimizations
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);

// Enhanced Viewport Handling
function handleViewportChange() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    
    // Handle keyboard appearance on mobile
    if (window.innerHeight < 500) {
        document.body.classList.add('keyboard-open');
    } else {
        document.body.classList.remove('keyboard-open');
    }
}

window.addEventListener('resize', handleViewportChange);
window.addEventListener('orientationchange', handleViewportChange);
handleViewportChange();

// Enhanced Touch Feedback
document.addEventListener('touchstart', function(e) {
    if (e.target.classList.contains('btn') || e.target.classList.contains('nav-tab')) {
        e.target.style.transform = 'scale(0.98)';
        
        // Haptic feedback
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
    }
});

document.addEventListener('touchend', function(e) {
    if (e.target.classList.contains('btn') || e.target.classList.contains('nav-tab')) {
        setTimeout(() => {
            e.target.style.transform = '';
        }, 100);
    }
});

// === Enhanced Data Management System ===
let farmSystemData = JSON.parse(JSON.stringify(DEFAULT_DATA_STRUCTURE));
let farmData = farmSystemData.farmData;

// Low stock thresholds
const LOW_STOCK_THRESHOLD = {
    feeds: 50,
    medical: 5
};

// Enhanced Data Migration System
function migrateData(savedData) {
    try {
        // Handle legacy data without version
        if (!savedData.version) {
            console.log('üîÑ Migrating from legacy format...');
            if (savedData.pigs || savedData.feeds || savedData.medical) {
                return {
                    ...DEFAULT_DATA_STRUCTURE,
                    farmData: {
                        pigs: savedData.pigs || [],
                        feeds: savedData.feeds || [],
                        medical: savedData.medical || [],
                        sales: savedData.sales || [],
                        usage: savedData.usage || []
                    }
                };
            }
        }

        // Handle version differences
        if (savedData.version !== SYSTEM_VERSION) {
            console.log(`üîÑ Migrating from version ${savedData.version} to ${SYSTEM_VERSION}...`);
            const migratedData = {
                ...DEFAULT_DATA_STRUCTURE,
                farmData: savedData.farmData || savedData,
                version: SYSTEM_VERSION,
                lastUpdate: new Date().toISOString(),
                previousVersion: savedData.version || "1.0.0"
            };

            // Preserve settings if they exist
            if (savedData.settings) {
                migratedData.settings = { ...DEFAULT_DATA_STRUCTURE.settings, ...savedData.settings };
            }

            // Preserve statistics if they exist
            if (savedData.statistics) {
                migratedData.statistics = { ...DEFAULT_DATA_STRUCTURE.statistics, ...savedData.statistics };
            }

            return performVersionMigration(migratedData, savedData.version || "1.0.0");
        }

        return {
            ...savedData,
            lastUpdate: new Date().toISOString()
        };

    } catch (error) {
        console.error('‚ùå Migration error:', error);
        backupOldData(savedData);
        return DEFAULT_DATA_STRUCTURE;
    }
}

function performVersionMigration(data, fromVersion) {
    console.log(`üîß Performing migration from ${fromVersion} to ${SYSTEM_VERSION}`);
    
    // Add originalQuantity to feeds and medical if missing
    if (fromVersion.startsWith("1.") || fromVersion.startsWith("2.")) {
        data.farmData.feeds = data.farmData.feeds.map(feed => ({
            ...feed,
            originalQuantity: feed.originalQuantity || feed.quantity
        }));

        data.farmData.medical = data.farmData.medical.map(med => ({
            ...med,
            originalQuantity: med.originalQuantity || med.quantity
        }));
    }

    // Calculate statistics from existing data
    if (data.farmData.pigs) {
        data.statistics.totalPigsAdded = data.farmData.pigs.reduce((sum, pig) => sum + pig.quantity, 0);
    }
    
    if (data.farmData.sales) {
        data.statistics.totalSales = data.farmData.sales.length;
        data.statistics.totalRevenue = data.farmData.sales.reduce((sum, sale) => sum + sale.netRevenue, 0);
    }

    return data;
}

function backupOldData(oldData) {
    const timestamp = new Date().toISOString().replace(/[:.\]/g, '-');
    const backupKey = `${STORAGE_KEY}_backup_${timestamp}`;
    
    try {
        localStorage.setItem(backupKey, JSON.stringify(oldData));
        console.log(`üíæ Backup created: ${backupKey}`);
        
        // Create downloadable backup
        const blob = new Blob([JSON.stringify(oldData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pig-farm-backup-${timestamp.split('T')[0]}.json`;
        
        setTimeout(() => {
            if (confirm('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                a.click();
            }
            URL.revokeObjectURL(url);
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Backup failed:', error);
    }
}

// Enhanced Data Save/Load Functions
function saveAllData() {
    try {
        farmSystemData.farmData = farmData;
        farmSystemData.lastUpdate = new Date().toISOString();
        
        // Update statistics
        updateStatistics();
        
        const dataToSave = JSON.stringify(farmSystemData);
        localStorage.setItem(STORAGE_KEY, dataToSave);
        
        console.log(`üíæ Data saved successfully (v${SYSTEM_VERSION})`);
        
        // Show save indicator
        showSaveIndicator();
        
    } catch (error) {
        console.error('‚ùå Save error:', error);
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
    }
}

function loadAllData() {
    try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            farmSystemData = migrateData(parsedData);
            farmData = farmSystemData.farmData;
            
            console.log(`‚úÖ Data loaded successfully (v${farmSystemData.version})`);
            
            if (farmSystemData.previousVersion) {
                showAlert(`‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô ${farmSystemData.previousVersion} ‡πÄ‡∏õ‡πá‡∏ô ${SYSTEM_VERSION} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            }
        } else {
            console.log('‚ÑπÔ∏è No saved data found, initializing...');
            farmSystemData = JSON.parse(JSON.stringify(DEFAULT_DATA_STRUCTURE));
            farmData = farmSystemData.farmData;
        }
        
    } catch (error) {
        console.error('‚ùå Load error:', error);
        
        // Try to backup corrupted data
        if (localStorage.getItem(STORAGE_KEY)) {
            backupOldData(localStorage.getItem(STORAGE_KEY));
        }
        
        farmSystemData = JSON.parse(JSON.stringify(DEFAULT_DATA_STRUCTURE));
        farmData = farmSystemData.farmData;
        
        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ', 'error');
    }
}

function updateStatistics() {
    farmSystemData.statistics.totalPigsAdded = farmData.pigs.reduce((sum, pig) => sum + pig.quantity, 0);
    farmSystemData.statistics.totalSales = farmData.sales.length;
    farmSystemData.statistics.totalRevenue = farmData.sales.reduce((sum, sale) => sum + sale.netRevenue, 0);
    farmSystemData.statistics.totalFeedUsed = farmData.usage.filter(u => u.type === 'feed').reduce((sum, u) => sum + u.amount, 0);
    farmSystemData.statistics.totalMedicalUsed = farmData.usage.filter(u => u.type === 'medical').reduce((sum, u) => sum + u.amount, 0);
}

function showSaveIndicator() {
    const indicator = document.createElement('div');
    indicator.innerHTML = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
    indicator.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        animation: fadeInOut 2s ease-in-out;
    `;
    
    document.body.appendChild(indicator);
    
    setTimeout(() => {
        document.body.removeChild(indicator);
    }, 2000);
}
// === Enhanced Navigation System ===
function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionName);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Add active class to clicked tab
    event.target.classList.add('active');
    
    // Smooth scroll to top
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
    
    // Section-specific updates
    switch(sectionName) {
        case 'overview':
            updateOverview();
            checkStockLevels();
            break;
        case 'pigs':
            displayPigs();
            break;
        case 'feeds':
            displayFeeds();
            break;
        case 'medical':
            displayMedical();
            break;
        case 'usage':
            updateUsageSelects();
            displayTodayUsage();
            break;
        case 'sales':
            displaySales();
            break;
        case 'reports':
            // Initialize reports if needed
            break;
    }
    
    // Analytics tracking (if needed)
    console.log(`üìä Section viewed: ${sectionName}`);
}

// Enhanced Alert System
function showAlert(message, type = 'success') {
    const alertEl = document.getElementById('alertMessage');
    alertEl.textContent = message;
    alertEl.className = `alert alert-${type}`;
    alertEl.classList.remove('hidden');
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        alertEl.classList.add('hidden');
    }, 5000);
    
    // Smooth scroll to alert
    alertEl.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'nearest' 
    });
    
    // Log alert for debugging
    console.log(`üîî Alert: ${type} - ${message}`);
}

// === Enhanced Pig Management ===
function addPig() {
    const pigType = document.getElementById('pigType').value;
    const quantity = parseInt(document.getElementById('pigQuantity').value);
    const entryDate = document.getElementById('pigEntryDate').value;
    const weight = parseFloat(document.getElementById('pigWeight').value) || 0;
    const age = parseInt(document.getElementById('pigAge').value) || 0;
    const notes = document.getElementById('pigNotes').value;

    // Enhanced validation
    if (!pigType || !quantity || !entryDate) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
    }

    if (quantity <= 0) {
        showAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
        return;
    }

    if (weight < 0) {
        showAlert('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ', 'error');
        return;
    }

    if (age < 0) {
        showAlert('‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ', 'error');
        return;
    }

    const newPig = {
        id: Date.now(),
        type: pigType,
        quantity: quantity,
        entryDate: entryDate,
        weight: weight,
        age: age,
        notes: notes,
        createdDate: new Date().toISOString(),
        lastUpdated: new Date().toISOString()
    };

    farmData.pigs.push(newPig);
    saveAllData();
    displayPigs();
    updateOverview();
    clearPigForm();
    
    showAlert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Å‡∏£ ${quantity} ‡∏ï‡∏±‡∏ß ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

function clearPigForm() {
    document.getElementById('pigType').value = '';
    document.getElementById('pigQuantity').value = '';
    document.getElementById('pigWeight').value = '';
    document.getElementById('pigAge').value = '';
    document.getElementById('pigNotes').value = '';
    document.getElementById('pigEntryDate').value = new Date().toISOString().split('T')[0];
}

function displayPigs() {
    const container = document.getElementById('pigsList');
    
    if (farmData.pigs.length === 0) {
        container.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Å‡∏£</p>';
        return;
    }

    const typeNames = {
        'sow': '‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
        'boar': '‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
        'piglet': '‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£',
        'grower': '‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô',
        'finisher': '‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô'
    };

    let html = `
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
                        <th>‡∏≠‡∏≤‡∏¢‡∏∏</th>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≤‡∏£‡πå‡∏°</th>
                        <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody>
    `;

    farmData.pigs.forEach(pig => {
        const daysSinceEntry = Math.floor((new Date() - new Date(pig.entryDate)) / (1000 * 60 * 60 * 24));
        
        html += `
            <tr>
                <td>${typeNames[pig.type]}</td>
                <td>${pig.quantity} ‡∏ï‡∏±‡∏ß</td>
                <td>${pig.weight > 0 ? pig.weight + ' ‡∏Å‡∏Å.' : '-'}</td>
                <td>${pig.age > 0 ? pig.age + ' ‡∏ß‡∏±‡∏ô' : '-'}</td>
                <td>
                    ${new Date(pig.entryDate).toLocaleDateString('th-TH')}
                    <br><small style="color: #666;">(${daysSinceEntry} ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</small>
                </td>
                <td>
                    <button class="btn btn-small btn-warning" onclick="editPig(${pig.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-small btn-danger" onclick="deletePig(${pig.id})">üóëÔ∏è ‡∏•‡∏ö</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function editPig(id) {
    const pig = farmData.pigs.find(p => p.id === id);
    if (pig) {
        document.getElementById('pigType').value = pig.type;
        document.getElementById('pigQuantity').value = pig.quantity;
        document.getElementById('pigWeight').value = pig.weight;
        document.getElementById('pigAge').value = pig.age;
        document.getElementById('pigNotes').value = pig.notes;
        document.getElementById('pigEntryDate').value = pig.entryDate;
        
        // Remove old pig and let user save as new
        farmData.pigs = farmData.pigs.filter(p => p.id !== id);
        saveAllData();
        displayPigs();
        updateOverview();
        
        showAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà', 'warning');
        
        // Scroll to form
        document.querySelector('#pigs .card').scrollIntoView({ behavior: 'smooth' });
    }
}

function deletePig(id) {
    const pig = farmData.pigs.find(p => p.id === id);
    if (pig && confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Å‡∏£ ${pig.quantity} ‡∏ï‡∏±‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        farmData.pigs = farmData.pigs.filter(p => p.id !== id);
        saveAllData();
        displayPigs();
        updateOverview();
        showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }
}

// === Enhanced Feed Management ===
function addFeed() {
    const feedType = document.getElementById('feedType').value;
    const brand = document.getElementById('feedBrand').value;
    const quantity = parseFloat(document.getElementById('feedQuantity').value);
    const price = parseFloat(document.getElementById('feedPrice').value);
    const purchaseDate = document.getElementById('feedPurchaseDate').value;
    const expiryDate = document.getElementById('feedExpiryDate').value;

    // Enhanced validation
    if (!feedType || !brand || !quantity || !price || !purchaseDate) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
    }

    if (quantity <= 0) {
        showAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
        return;
    }

    if (price <= 0) {
        showAlert('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
        return;
    }

    // Check expiry date
    if (expiryDate && new Date(expiryDate) <= new Date()) {
        if (!confirm('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }
    }

    const newFeed = {
        id: Date.now(),
        type: feedType,
        brand: brand,
        quantity: quantity,
        originalQuantity: quantity,
        price: price,
        purchaseDate: purchaseDate,
        expiryDate: expiryDate,
        createdDate: new Date().toISOString(),
        lastUpdated: new Date().toISOString()
    };

    farmData.feeds.push(newFeed);
    saveAllData();
    displayFeeds();
    updateUsageSelects();
    checkStockLevels();
    clearFeedForm();
    
    showAlert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${brand} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${quantity} ‡∏Å‡∏Å. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

function clearFeedForm() {
    document.getElementById('feedType').value = '';
    document.getElementById('feedBrand').value = '';
    document.getElementById('feedQuantity').value = '';
    document.getElementById('feedPrice').value = '';
    document.getElementById('feedExpiryDate').value = '';
    document.getElementById('feedPurchaseDate').value = new Date().toISOString().split('T')[0];
}

function displayFeeds() {
    const container = document.getElementById('feedStock');
    
    if (farmData.feeds.length === 0) {
        container.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>';
        return;
    }

    const feedTypes = {
        'prestarter': 'Pre-Starter',
        'starter': 'Starter',
        'grower': 'Grower',
        'finisher': 'Finisher',
        'sow': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
        'boar': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå'
    };

    let html = '';

    // Sort feeds by quantity (low stock first)
    const sortedFeeds = [...farmData.feeds].sort((a, b) => a.quantity - b.quantity);

    sortedFeeds.forEach(feed => {
        const totalValue = feed.quantity * feed.price;
        const stockStatus = getStockStatus(feed.quantity, 'feed');
        const daysRemaining = calculateDaysRemaining(feed.quantity, 'feed');
        const usagePercentage = ((feed.originalQuantity - feed.quantity) / feed.originalQuantity * 100).toFixed(1);

        // Check if expired
        const isExpired = feed.expiryDate && new Date(feed.expiryDate) <= new Date();
        const daysToExpiry = feed.expiryDate ? Math.ceil((new Date(feed.expiryDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

        html += `
            <div class="stock-item ${stockStatus === 'empty' ? 'out-of-stock' : stockStatus === 'low' ? 'low-stock' : ''}">
                <div class="stock-info">
                    <div class="stock-name">üåæ ${feedTypes[feed.type]} - ${feed.brand}</div>
                    <div class="stock-details">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${feed.quantity} ‡∏Å‡∏Å. ‡∏à‡∏≤‡∏Å ${feed.originalQuantity} ‡∏Å‡∏Å. (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${usagePercentage}%)</div>
                    <div class="stock-details">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤: ${feed.price} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å. | ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${totalValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                    <div class="stock-details">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${new Date(feed.purchaseDate).toLocaleDateString('th-TH')} 
                        ${feed.expiryDate ? `| ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${new Date(feed.expiryDate).toLocaleDateString('th-TH')}` : ''}
                        ${daysToExpiry !== null ? `(${isExpired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `‡∏≠‡∏µ‡∏Å ${daysToExpiry} ‡∏ß‡∏±‡∏ô`})` : ''}
                    </div>
                    <div class="stock-status ${stockStatus}${isExpired ? ' expired' : ''}">${getStockStatusText(stockStatus, daysRemaining, isExpired)}</div>
                </div>
                <div class="stock-actions">
                    <button class="btn btn-small btn-warning" onclick="restockFeed(${feed.id})">‚ûï ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                    <button class="btn btn-small btn-secondary" onclick="editFeed(${feed.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-small btn-danger" onclick="deleteFeed(${feed.id})">üóëÔ∏è ‡∏•‡∏ö</button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function editFeed(id) {
    const feed = farmData.feeds.find(f => f.id === id);
    if (feed) {
        document.getElementById('feedType').value = feed.type;
        document.getElementById('feedBrand').value = feed.brand;
        document.getElementById('feedQuantity').value = feed.quantity;
        document.getElementById('feedPrice').value = feed.price;
        document.getElementById('feedPurchaseDate').value = feed.purchaseDate;
        document.getElementById('feedExpiryDate').value = feed.expiryDate || '';
        
        // Remove old feed and let user save as new
        farmData.feeds = farmData.feeds.filter(f => f.id !== id);
        saveAllData();
        displayFeeds();
        updateUsageSelects();
        checkStockLevels();
        
        showAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà', 'warning');
        
        // Scroll to form
        document.querySelector('#feeds .card').scrollIntoView({ behavior: 'smooth' });
    }
}

function restockFeed(id) {
    const feed = farmData.feeds.find(f => f.id === id);
    if (feed) {
        const additionalStock = prompt('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)?');
        if (additionalStock && !isNaN(additionalStock) && parseFloat(additionalStock) > 0) {
            const additional = parseFloat(additionalStock);
            feed.quantity += additional;
            feed.originalQuantity += additional;
            feed.lastUpdated = new Date().toISOString();
            
            saveAllData();
            displayFeeds();
            checkStockLevels();
            
            showAlert(`‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${additional} ‡∏Å‡∏Å. ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }
    }
}

function deleteFeed(id) {
    const feed = farmData.feeds.find(f => f.id === id);
    if (feed && confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${feed.brand} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        farmData.feeds = farmData.feeds.filter(f => f.id !== id);
        saveAllData();
        displayFeeds();
        updateUsageSelects();
        checkStockLevels();
        showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }
}

// === Enhanced Medical Management ===
function addMedical() {
    const type = document.getElementById('medicalType').value;
    const name = document.getElementById('medicalName').value;
    const brand = document.getElementById('medicalBrand').value;
    const quantity = parseInt(document.getElementById('medicalQuantity').value);
    const unit = document.getElementById('medicalUnit').value;
    const price = parseFloat(document.getElementById('medicalPrice').value);
    const purchaseDate = document.getElementById('medicalPurchaseDate').value;
    const expiryDate = document.getElementById('medicalExpiryDate').value;

    // Enhanced validation
    if (!type || !name || !quantity || !unit || !price || !purchaseDate) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
    }

    if (quantity <= 0) {
        showAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
        return;
    }

    if (price <= 0) {
        showAlert('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
        return;
    }

    // Check expiry date
    if (expiryDate && new Date(expiryDate) <= new Date()) {
        if (!confirm('‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }
    }

    const newMedical = {
        id: Date.now(),
        type: type,
        name: name,
        brand: brand,
        quantity: quantity,
        originalQuantity: quantity,
        unit: unit,
        price: price,
        purchaseDate: purchaseDate,
        expiryDate: expiryDate,
        createdDate: new Date().toISOString(),
        lastUpdated: new Date().toISOString()
    };

    farmData.medical.push(newMedical);
    saveAllData();
    displayMedical();
    updateUsageSelects();
    checkStockLevels();
    clearMedicalForm();
    
    showAlert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô ${name} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${quantity} ${unit} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

function clearMedicalForm() {
    document.getElementById('medicalType').value = '';
    document.getElementById('medicalName').value = '';
    document.getElementById('medicalBrand').value = '';
    document.getElementById('medicalQuantity').value = '';
    document.getElementById('medicalUnit').value = '';
    document.getElementById('medicalPrice').value = '';
    document.getElementById('medicalExpiryDate').value = '';
    document.getElementById('medicalPurchaseDate').value = new Date().toISOString().split('T')[0];
}
function displayMedical() {
    const container = document.getElementById('medicalStock');
    
    if (farmData.medical.length === 0) {
        container.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</p>';
        return;
    }

    const medicalTypes = {
        'vaccine': '‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô',
        'antibiotic': '‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞',
        'vitamin': '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô',
        'deworming': '‡∏¢‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ò‡∏¥',
        'hormone': '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô',
        'supplement': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°',
        'disinfectant': '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠'
    };

    let html = '';

    // Sort medical by quantity (low stock first)
    const sortedMedical = [...farmData.medical].sort((a, b) => a.quantity - b.quantity);

    sortedMedical.forEach(med => {
        const totalValue = med.quantity * med.price;
        const stockStatus = getStockStatus(med.quantity, 'medical');
        const daysRemaining = calculateDaysRemaining(med.quantity, 'medical');
        const usagePercentage = ((med.originalQuantity - med.quantity) / med.originalQuantity * 100).toFixed(1);

        // Check if expired
        const isExpired = med.expiryDate && new Date(med.expiryDate) <= new Date();
        const daysToExpiry = med.expiryDate ? Math.ceil((new Date(med.expiryDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

        html += `
            <div class="stock-item ${stockStatus === 'empty' ? 'out-of-stock' : stockStatus === 'low' ? 'low-stock' : ''}">
                <div class="stock-info">
                    <div class="stock-name">üíä ${medicalTypes[med.type]} - ${med.name}</div>
                    <div class="stock-details">${med.brand ? '‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠: ' + med.brand + ' | ' : ''}‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${med.quantity} ${med.unit} ‡∏à‡∏≤‡∏Å ${med.originalQuantity} ${med.unit} (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${usagePercentage}%)</div>
                    <div class="stock-details">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤: ${med.price} ‡∏ö‡∏≤‡∏ó/${med.unit} | ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${totalValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
                    <div class="stock-details">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${new Date(med.purchaseDate).toLocaleDateString('th-TH')} 
                        ${med.expiryDate ? `| ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${new Date(med.expiryDate).toLocaleDateString('th-TH')}` : ''}
                        ${daysToExpiry !== null ? `(${isExpired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `‡∏≠‡∏µ‡∏Å ${daysToExpiry} ‡∏ß‡∏±‡∏ô`})` : ''}
                    </div>
                    <div class="stock-status ${stockStatus}${isExpired ? ' expired' : ''}">${getStockStatusText(stockStatus, daysRemaining, isExpired)}</div>
                </div>
                <div class="stock-actions">
                    <button class="btn btn-small btn-warning" onclick="restockMedical(${med.id})">‚ûï ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                    <button class="btn btn-small btn-secondary" onclick="editMedical(${med.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-small btn-danger" onclick="deleteMedical(${med.id})">üóëÔ∏è ‡∏•‡∏ö</button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function editMedical(id) {
    const medical = farmData.medical.find(m => m.id === id);
    if (medical) {
        document.getElementById('medicalType').value = medical.type;
        document.getElementById('medicalName').value = medical.name;
        document.getElementById('medicalBrand').value = medical.brand || '';
        document.getElementById('medicalQuantity').value = medical.quantity;
        document.getElementById('medicalUnit').value = medical.unit;
        document.getElementById('medicalPrice').value = medical.price;
        document.getElementById('medicalPurchaseDate').value = medical.purchaseDate;
        document.getElementById('medicalExpiryDate').value = medical.expiryDate || '';
        
        // Remove old medical and let user save as new
        farmData.medical = farmData.medical.filter(m => m.id !== id);
        saveAllData();
        displayMedical();
        updateUsageSelects();
        checkStockLevels();
        
        showAlert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà', 'warning');
        
        // Scroll to form
        document.querySelector('#medical .card').scrollIntoView({ behavior: 'smooth' });
    }
}

function restockMedical(id) {
    const medical = farmData.medical.find(m => m.id === id);
    if (medical) {
        const additionalStock = prompt(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà (${medical.unit})?`);
        if (additionalStock && !isNaN(additionalStock) && parseFloat(additionalStock) > 0) {
            const additional = parseFloat(additionalStock);
            medical.quantity += additional;
            medical.originalQuantity += additional;
            medical.lastUpdated = new Date().toISOString();
            
            saveAllData();
            displayMedical();
            checkStockLevels();
            
            showAlert(`‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô ${additional} ${medical.unit} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }
    }
}

function deleteMedical(id) {
    const medical = farmData.medical.find(m => m.id === id);
    if (medical && confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô ${medical.name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        farmData.medical = farmData.medical.filter(m => m.id !== id);
        saveAllData();
        displayMedical();
        updateUsageSelects();
        checkStockLevels();
        showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }
}

// === Enhanced Usage Management ===
function updateUsageSelects() {
    const feedSelect = document.getElementById('useFeedSelect');
    feedSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</option>';

    farmData.feeds.forEach(feed => {
        if (feed.quantity > 0) {
            const feedTypes = {
                'prestarter': 'Pre-Starter',
                'starter': 'Starter',
                'grower': 'Grower',
                'finisher': 'Finisher',
                'sow': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
                'boar': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå'
            };

            const isExpired = feed.expiryDate && new Date(feed.expiryDate) <= new Date();
            const expiredText = isExpired ? ' ‚ö†Ô∏è ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '';
            
            feedSelect.innerHTML += `<option value="${feed.id}">${feedTypes[feed.type]} - ${feed.brand} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${feed.quantity} ‡∏Å‡∏Å.)${expiredText}</option>`;
        }
    });

    const medicalSelect = document.getElementById('useMedicalSelect');
    medicalSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</option>';

    farmData.medical.forEach(med => {
        if (med.quantity > 0) {
            const medicalTypes = {
                'vaccine': '‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô',
                'antibiotic': '‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞',
                'vitamin': '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô',
                'deworming': '‡∏¢‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ò‡∏¥',
                'hormone': '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô',
                'supplement': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°',
                'disinfectant': '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠'
            };

            const isExpired = med.expiryDate && new Date(med.expiryDate) <= new Date();
            const expiredText = isExpired ? ' ‚ö†Ô∏è ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '';

            medicalSelect.innerHTML += `<option value="${med.id}">${medicalTypes[med.type]} - ${med.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${med.quantity} ${med.unit})${expiredText}</option>`;
        }
    });
}

function useFeed() {
    const feedId = document.getElementById('useFeedSelect').value;
    const amount = parseFloat(document.getElementById('useFeedAmount').value);

    if (!feedId || !amount || amount <= 0) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    const feed = farmData.feeds.find(f => f.id == feedId);
    if (!feed) {
        showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
        return;
    }

    if (amount > feed.quantity) {
        showAlert(`‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${feed.quantity} ‡∏Å‡∏Å.)`, 'error');
        return;
    }

    // Check if expired
    const isExpired = feed.expiryDate && new Date(feed.expiryDate) <= new Date();
    if (isExpired) {
        if (!confirm('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }
    }

    const usage = {
        id: Date.now(),
        type: 'feed',
        itemId: feedId,
        itemName: `${feed.type} - ${feed.brand}`,
        amount: amount,
        unit: '‡∏Å‡∏Å.',
        date: new Date().toISOString().split('T')[0],
        time: new Date().toISOString(),
        notes: isExpired ? '‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : ''
    };

    farmData.usage.push(usage);
    feed.quantity -= amount;
    feed.lastUpdated = new Date().toISOString();

    saveAllData();
    updateUsageSelects();
    displayFeeds();
    displayTodayUsage();
    checkStockLevels();

    document.getElementById('useFeedSelect').value = '';
    document.getElementById('useFeedAmount').value = '';

    showAlert(`‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ${amount} ‡∏Å‡∏Å. ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß${isExpired ? ' (‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)' : ''}`);
}

function useMedical() {
    const medicalId = document.getElementById('useMedicalSelect').value;
    const amount = parseFloat(document.getElementById('useMedicalAmount').value);

    if (!medicalId || !amount || amount <= 0) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        return;
    }

    const medical = farmData.medical.find(m => m.id == medicalId);
    if (!medical) {
        showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
        return;
    }

    if (amount > medical.quantity) {
        showAlert(`‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${medical.quantity} ${medical.unit})`, 'error');
        return;
    }

    // Check if expired
    const isExpired = medical.expiryDate && new Date(medical.expiryDate) <= new Date();
    if (isExpired) {
        if (!confirm('‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            return;
        }
    }

    const usage = {
        id: Date.now(),
        type: 'medical',
        itemId: medicalId,
        itemName: `${medical.type} - ${medical.name}`,
        amount: amount,
        unit: medical.unit,
        date: new Date().toISOString().split('T')[0],
        time: new Date().toISOString(),
        notes: isExpired ? '‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : ''
    };

    farmData.usage.push(usage);
    medical.quantity -= amount;
    medical.lastUpdated = new Date().toISOString();

    saveAllData();
    updateUsageSelects();
    displayMedical();
    displayTodayUsage();
    checkStockLevels();

    document.getElementById('useMedicalSelect').value = '';
    document.getElementById('useMedicalAmount').value = '';

    showAlert(`‡πÉ‡∏ä‡πâ‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô ${amount} ${medical.unit} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß${isExpired ? ' (‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)' : ''}`);
}

function displayTodayUsage() {
    const container = document.getElementById('todayUsage');
    const today = new Date().toISOString().split('T')[0];
    const todayUsage = farmData.usage.filter(usage => usage.date === today);

    if (todayUsage.length === 0) {
        container.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
        return;
    }

    // Sort by time (newest first)
    todayUsage.sort((a, b) => new Date(b.time) - new Date(a.time));

    let html = `
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                        <th>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        <th>üîß ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody>
    `;

    todayUsage.forEach(usage => {
        const time = new Date(usage.time).toLocaleTimeString('th-TH');
        const typeText = usage.type === 'feed' ? 'üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£' : 'üíä ‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô';

        html += `
            <tr>
                <td>${time}</td>
                <td>${typeText}</td>
                <td>${usage.itemName}</td>
                <td>${usage.amount} ${usage.unit}</td>
                <td>${usage.notes || '-'}</td>
                <td>
                    <button class="btn btn-small btn-danger" onclick="deleteUsage(${usage.id})">üóëÔ∏è ‡∏•‡∏ö</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';

    // Add summary
    const feedUsageToday = todayUsage.filter(u => u.type === 'feed').reduce((sum, u) => sum + u.amount, 0);
    const medicalUsageToday = todayUsage.filter(u => u.type === 'medical').length;

    html += `
        <div style="margin-top: 16px; padding: 16px; background: var(--bg-primary); border-radius: var(--border-radius);">
            <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
            <p><strong>üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${feedUsageToday.toLocaleString()} ‡∏Å‡∏Å.</p>
            <p><strong>üíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${medicalUsageToday} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
            <p><strong>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${todayUsage.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
        </div>
    `;

    container.innerHTML = html;
}

function deleteUsage(id) {
    if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        const usage = farmData.usage.find(u => u.id === id);
        if (usage) {
            // Return the amount back to stock
            if (usage.type === 'feed') {
                const feed = farmData.feeds.find(f => f.id == usage.itemId);
                if (feed) {
                    feed.quantity += usage.amount;
                    feed.lastUpdated = new Date().toISOString();
                }
            } else if (usage.type === 'medical') {
                const medical = farmData.medical.find(m => m.id == usage.itemId);
                if (medical) {
                    medical.quantity += usage.amount;
                    medical.lastUpdated = new Date().toISOString();
                }
            }

            // Remove usage record
            farmData.usage = farmData.usage.filter(u => u.id !== id);
            
            saveAllData();
            updateUsageSelects();
            displayFeeds();
            displayMedical();
            displayTodayUsage();
            checkStockLevels();
            
            showAlert('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
    }
}

// === Stock Management Helper Functions ===
function getStockStatus(quantity, type) {
    const threshold = LOW_STOCK_THRESHOLD[type === 'feed' ? 'feeds' : 'medical'];
    
    if (quantity <= 0) return 'empty';
    if (quantity <= threshold) return 'low';
    return 'normal';
}

function getStockStatusText(status, daysRemaining, isExpired = false) {
    if (isExpired) {
        return 'üî¥ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
    }
    
    switch(status) {
        case 'empty':
            return 'üî¥ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î';
        case 'low':
            return `üü° ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ ${daysRemaining ? '(‡∏û‡∏≠‡πÉ‡∏ä‡πâ ' + daysRemaining + ' ‡∏ß‡∏±‡∏ô)' : ''}`;
        case 'normal':
            return `üü¢ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ ${daysRemaining ? '(‡∏û‡∏≠‡πÉ‡∏ä‡πâ ' + daysRemaining + ' ‡∏ß‡∏±‡∏ô)' : ''}`;
        default:
            return '‚ùì ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
    }
}

function calculateDaysRemaining(quantity, type) {
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

    const recentUsage = farmData.usage.filter(usage =>
        usage.type === type && usage.date >= sevenDaysAgoStr
    );

    const totalUsed = recentUsage.reduce((sum, usage) => sum + usage.amount, 0);
    const dailyAverage = totalUsed / 7;

    if (dailyAverage <= 0) return null;

    return Math.floor(quantity / dailyAverage);
}

function checkStockLevels() {
    const warnings = [];

    // Check feeds
    farmData.feeds.forEach(feed => {
        const status = getStockStatus(feed.quantity, 'feed');
        const isExpired = feed.expiryDate && new Date(feed.expiryDate) <= new Date();
        
        if (status === 'low' || status === 'empty' || isExpired) {
            const feedTypes = {
                'prestarter': 'Pre-Starter',
                'starter': 'Starter',
                'grower': 'Grower',
                'finisher': 'Finisher',
                'sow': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
                'boar': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå'
            };

            let message = `üåæ ${feedTypes[feed.type]} - ${feed.brand}`;
            if (isExpired) {
                message += ' ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
            } else if (status === 'empty') {
                message += ' ‡∏´‡∏°‡∏î';
            } else {
                message += ' ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢';
            }
            message += ` (${feed.quantity} ‡∏Å‡∏Å.)`;

            warnings.push({
                type: isExpired ? 'error' : 'warning',
                message: message
            });
        }
    });

    // Check medical
    farmData.medical.forEach(med => {
        const status = getStockStatus(med.quantity, 'medical');
        const isExpired = med.expiryDate && new Date(med.expiryDate) <= new Date();
        
        if (status === 'low' || status === 'empty' || isExpired) {
            const medicalTypes = {
                'vaccine': '‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô',
                'antibiotic': '‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞',
                'vitamin': '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô',
                'deworming': '‡∏¢‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ò‡∏¥',
                'hormone': '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô',
                'supplement': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°',
                'disinfectant': '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠'
            };

            let message = `üíä ${medicalTypes[med.type]} - ${med.name}`;
            if (isExpired) {
                message += ' ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
            } else if (status === 'empty') {
                message += ' ‡∏´‡∏°‡∏î';
            } else {
                message += ' ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢';
            }
            message += ` (${med.quantity} ${med.unit})`;

            warnings.push({
                type: isExpired ? 'error' : 'warning',
                message: message
            });
        }
    });

    // Display warnings
    const warningsContainer = document.getElementById('stockWarnings');
    if (warnings.length > 0) {
        const errorWarnings = warnings.filter(w => w.type === 'error');
        const normalWarnings = warnings.filter(w => w.type === 'warning');

        let html = '';

        if (errorWarnings.length > 0) {
            html += `<div class="alert alert-error"><strong>üö® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong><ul style="margin: 10px 0; padding-left: 20px;">`;
            errorWarnings.forEach(warning => {
                html += `<li>${warning.message}</li>`;
            });
            html += '</ul></div>';
        }

        if (normalWarnings.length > 0) {
            html += `<div class="alert alert-warning"><strong>‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å:</strong><ul style="margin: 10px 0; padding-left: 20px;">`;
            normalWarnings.forEach(warning => {
                html += `<li>${warning.message}</li>`;
            });
            html += '</ul></div>';
        }

        warningsContainer.innerHTML = html;
    } else {
        warningsContainer.innerHTML = '';
    }
}
        // === Enhanced Sales Management ===
function addSale() {
    const date = document.getElementById('saleDate').value;
    const type = document.getElementById('saleType').value;
    const quantity = parseInt(document.getElementById('saleQuantity').value);
    const weight = parseFloat(document.getElementById('saleWeight').value) || 0;
    const pricePerKg = parseFloat(document.getElementById('salePricePerKg').value);
    const transportCost = parseFloat(document.getElementById('saleTransportCost').value) || 0;
    const buyer = document.getElementById('saleBuyer').value;
    const notes = document.getElementById('saleNotes').value;

    // Enhanced validation
    if (!date || !type || !quantity || !pricePerKg) {
        showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
    }

    if (quantity <= 0) {
        showAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
        return;
    }

    if (pricePerKg <= 0) {
        showAlert('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
        return;
    }

    if (weight <= 0) {
        const estimatedWeight = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Cancel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢');
        if (estimatedWeight && !isNaN(estimatedWeight) && parseFloat(estimatedWeight) > 0) {
            document.getElementById('saleWeight').value = estimatedWeight;
            return addSale(); // Retry with weight
        } else if (estimatedWeight === null) {
            // Use average weight based on pig type
            const avgWeights = {
                'piglet': 20,
                'grower': 50,
                'finisher': 100,
                'sow': 150,
                'boar': 200
            };
            weight = (avgWeights[type] || 80) * quantity;
            showAlert(`‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${weight} ‡∏Å‡∏Å.`, 'warning');
        } else {
            showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
        }
    }

    const totalRevenue = weight * pricePerKg;
    const netRevenue = totalRevenue - transportCost;

    const newSale = {
        id: Date.now(),
        date: date,
        type: type,
        quantity: quantity,
        weight: weight,
        pricePerKg: pricePerKg,
        transportCost: transportCost,
        totalRevenue: totalRevenue,
        netRevenue: netRevenue,
        buyer: buyer,
        notes: notes,
        createdDate: new Date().toISOString(),
        profitMargin: netRevenue > 0 ? ((netRevenue / totalRevenue) * 100).toFixed(2) : 0
    };

    farmData.sales.push(newSale);
    saveAllData();
    displaySales();
    updateOverview();
    clearSaleForm();
    
    showAlert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ${quantity} ‡∏ï‡∏±‡∏ß ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ${netRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
}

function clearSaleForm() {
    document.getElementById('saleType').value = '';
    document.getElementById('saleQuantity').value = '';
    document.getElementById('saleWeight').value = '';
    document.getElementById('salePricePerKg').value = '';
    document.getElementById('saleTransportCost').value = '';
    document.getElementById('saleBuyer').value = '';
    document.getElementById('saleNotes').value = '';
    document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
}

function displaySales() {
    const container = document.getElementById('salesHistory');
    
    if (farmData.sales.length === 0) {
        container.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>';
        return;
    }

    const saleTypes = {
        'piglet': '‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£',
        'grower': '‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô',
        'finisher': '‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô',
        'sow': '‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
        'boar': '‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå'
    };

    // Sort sales by date (newest first)
    const sortedSales = [...farmData.sales].sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = `
        <table class="table">
            <thead>
                <tr>
                    <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>üê∑ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
                    <th>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
                    <th>üíµ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                    <th>üë§ ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</th>
                    <th>üîß ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody>
    `;

    sortedSales.forEach(sale => {
        const avgPricePerPig = sale.quantity > 0 ? (sale.netRevenue / sale.quantity).toFixed(0) : 0;
        
        html += `
            <tr>
                <td>${new Date(sale.date).toLocaleDateString('th-TH')}</td>
                <td>${saleTypes[sale.type]}</td>
                <td>${sale.quantity} ‡∏ï‡∏±‡∏ß</td>
                <td>${sale.weight > 0 ? sale.weight + ' ‡∏Å‡∏Å.' : '-'}</td>
                <td>${sale.pricePerKg} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.</td>
                <td>
                    ${sale.netRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó
                    <br><small style="color: #666;">(${avgPricePerPig} ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ß)</small>
                </td>
                <td>${sale.buyer || '-'}</td>
                <td>
                    <button class="btn btn-small btn-secondary" onclick="viewSaleDetails(${sale.id})">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                    <button class="btn btn-small btn-danger" onclick="deleteSale(${sale.id})">üóëÔ∏è ‡∏•‡∏ö</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';

    // Add summary
    const totalSales = sortedSales.length;
    const totalQuantity = sortedSales.reduce((sum, sale) => sum + sale.quantity, 0);
    const totalRevenue = sortedSales.reduce((sum, sale) => sum + sale.netRevenue, 0);
    const avgPricePerKg = sortedSales.length > 0 ? 
        (sortedSales.reduce((sum, sale) => sum + sale.pricePerKg, 0) / sortedSales.length).toFixed(2) : 0;

    html += `
        <div style="margin-top: 20px; padding: 20px; background: var(--bg-primary); border-radius: var(--border-radius);">
            <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <div class="form-grid">
                <div>
                    <p><strong>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°:</strong> ${totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üê∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</strong> ${totalQuantity} ‡∏ï‡∏±‡∏ß</p>
                </div>
                <div>
                    <p><strong>üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</strong> ${totalSales} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <p><strong>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</strong> ${avgPricePerKg} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.</p>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = html;
}

function viewSaleDetails(id) {
    const sale = farmData.sales.find(s => s.id === id);
    if (sale) {
        const saleTypes = {
            'piglet': '‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£',
            'grower': '‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô',
            'finisher': '‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô',
            'sow': '‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
            'boar': '‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå'
        };

        const details = `
‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢

üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(sale.date).toLocaleDateString('th-TH')}
üê∑ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${saleTypes[sale.type]}
üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${sale.quantity} ‡∏ï‡∏±‡∏ß
‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${sale.weight} ‡∏Å‡∏Å.
üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤: ${sale.pricePerKg} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.
üöö ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á: ${sale.transportCost} ‡∏ö‡∏≤‡∏ó
üíµ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°: ${sale.totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó
üíé ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${sale.netRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó
üë§ ‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠: ${sale.buyer || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${sale.notes || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}

üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:
- ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß: ${(sale.netRevenue / sale.quantity).toFixed(0)} ‡∏ö‡∏≤‡∏ó
- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß: ${(sale.weight / sale.quantity).toFixed(1)} ‡∏Å‡∏Å.
- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£: ${sale.profitMargin}%
        `;

        alert(details);
    }
}

function deleteSale(id) {
    const sale = farmData.sales.find(s => s.id === id);
    if (sale && confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ${sale.quantity} ‡∏ï‡∏±‡∏ß ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ${sale.netRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        farmData.sales = farmData.sales.filter(s => s.id !== id);
        saveAllData();
        displaySales();
        updateOverview();
        showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }
}

// === Enhanced Overview Management ===
function updateOverview() {
    const totalPigs = farmData.pigs.reduce((sum, pig) => sum + pig.quantity, 0);
    const feedItems = farmData.feeds.length;
    const medicalItems = farmData.medical.length;
    
    const lowStockFeeds = farmData.feeds.filter(feed => getStockStatus(feed.quantity, 'feed') !== 'normal');
    const lowStockMedical = farmData.medical.filter(med => getStockStatus(med.quantity, 'medical') !== 'normal');
    const expiredFeeds = farmData.feeds.filter(feed => feed.expiryDate && new Date(feed.expiryDate) <= new Date());
    const expiredMedical = farmData.medical.filter(med => med.expiryDate && new Date(med.expiryDate) <= new Date());
    
    const lowStockTotal = lowStockFeeds.length + lowStockMedical.length + expiredFeeds.length + expiredMedical.length;

    // Update stat cards
    document.getElementById('totalPigs').textContent = totalPigs || '-';
    document.getElementById('feedItems').textContent = feedItems || '-';
    document.getElementById('medicalItems').textContent = medicalItems || '-';
    document.getElementById('lowStockItems').textContent = lowStockTotal || '-';

    // Update summary
    const summaryContainer = document.getElementById('stockSummary');
    
    if (farmData.feeds.length > 0 || farmData.medical.length > 0 || farmData.usage.length > 0) {
        const totalFeedValue = farmData.feeds.reduce((sum, feed) => sum + (feed.quantity * feed.price), 0);
        const totalMedicalValue = farmData.medical.reduce((sum, med) => sum + (med.quantity * med.price), 0);
        const totalSales = farmData.sales.reduce((sum, sale) => sum + sale.netRevenue, 0);

        const today = new Date().toISOString().split('T')[0];
        const todayUsage = farmData.usage.filter(usage => usage.date === today);
        const todayFeedUsage = todayUsage.filter(u => u.type === 'feed').reduce((sum, u) => sum + u.amount, 0);
        const todayMedicalUsage = todayUsage.filter(u => u.type === 'medical').reduce((sum, u) => sum + u.amount, 0);

        // Calculate monthly statistics
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const monthlyUsage = farmData.usage.filter(usage => new Date(usage.time) >= thirtyDaysAgo);
        const monthlyFeedUsage = monthlyUsage.filter(u => u.type === 'feed').reduce((sum, u) => sum + u.amount, 0);
        const monthlySales = farmData.sales.filter(sale => new Date(sale.date) >= thirtyDaysAgo);
        const monthlyRevenue = monthlySales.reduce((sum, sale) => sum + sale.netRevenue, 0);

        summaryContainer.innerHTML = `
            <div class="form-grid">
                <div>
                    <h4>üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
                    <p><strong>üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</strong> ${totalFeedValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üíä ‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô:</strong> ${totalMedicalValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üíµ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${(totalFeedValue + totalMedicalValue).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div>
                    <h4>üìä ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
                    <p><strong>üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${todayFeedUsage.toLocaleString()} ‡∏Å‡∏Å.</p>
                    <p><strong>üíä ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${todayMedicalUsage} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <p><strong>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°:</strong> ${totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ 30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                <div class="form-grid">
                    <div>
                        <p><strong>üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${monthlyFeedUsage.toLocaleString()} ‡∏Å‡∏Å.</p>
                        <p><strong>üìù ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${monthlyUsage.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    </div>
                    <div>
                        <p><strong>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ 30 ‡∏ß‡∏±‡∏ô:</strong> ${monthlyRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                        <p><strong>üê∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</strong> ${monthlySales.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h4>üìã ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h4>
                <div class="form-grid">
                    <div>
                        <p><strong>üìù ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${farmData.usage.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                        <p><strong>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å:</strong> ${lowStockTotal} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                    <div>
                        <p><strong>üïê ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${new Date().toLocaleString('th-TH')}</p>
                        <p><strong>üì± ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:</strong> ${SYSTEM_VERSION}</p>
                    </div>
                </div>
            </div>
        `;
    } else {
        summaryContainer.innerHTML = '<p>üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    }
}

// === Enhanced Report Generation System ===
function generateReport() {
    const type = document.getElementById('reportType').value;
    const container = document.getElementById('reportResults');

    switch(type) {
        case 'overview':
            generateOverviewReport(container);
            break;
        case 'stock':
            generateStockReport(container);
            break;
        case 'usage':
            generateUsageReport(container);
            break;
        case 'financial':
            generateFinancialReport(container);
            break;
        case 'livestock':
            generateLivestockReport(container);
            break;
        case 'sales':
            generateSalesReport(container);
            break;
    }
}

function generateOverviewReport(container) {
    const totalPigs = farmData.pigs.reduce((sum, pig) => sum + pig.quantity, 0);
    const totalSales = farmData.sales.reduce((sum, sale) => sum + sale.netRevenue, 0);
    const totalStockValue = farmData.feeds.reduce((sum, feed) => sum + (feed.quantity * feed.price), 0) +
                           farmData.medical.reduce((sum, med) => sum + (med.quantity * med.price), 0);

    const totalCosts = farmData.feeds.reduce((sum, feed) => sum + (feed.originalQuantity * feed.price), 0) +
                      farmData.medical.reduce((sum, med) => sum + (med.originalQuantity * med.price), 0);

    const profitLoss = totalSales - totalCosts;
    const roi = totalCosts > 0 ? ((profitLoss / totalCosts) * 100).toFixed(2) : 0;

    container.innerHTML = `
        <div class="card">
            <div class="card-title">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°</div>
            <div class="form-grid">
                <div>
                    <h4>üê∑ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏∏‡∏Å‡∏£</h4>
                    <p><strong>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${totalPigs} ‡∏ï‡∏±‡∏ß</p>
                    <p><strong>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°:</strong> ${farmData.pigs.length} ‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
                    <p><strong>üè≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô:</strong> ${farmData.pigs.length > 0 ? (totalPigs / farmData.pigs.length).toFixed(1) : 0} ‡∏ï‡∏±‡∏ß/‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
                </div>
                <div>
                    <h4>üí∞ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h4>
                    <p><strong>üíµ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°:</strong> ${totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üí∏ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°:</strong> ${totalCosts.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üíé ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô:</strong> <span style="color: ${profitLoss >= 0 ? 'green' : 'red'}">${profitLoss.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></p>
                    <p><strong>üìà ROI:</strong> <span style="color: ${roi >= 0 ? 'green' : 'red'}">${roi}%</span></p>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>üì¶ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
                <div class="form-grid">
                    <div>
                        <p><strong>üåæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</strong> ${farmData.feeds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <p><strong>üíä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤:</strong> ${farmData.medical.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <p><strong>üì¶ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å:</strong> ${totalStockValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                    <div>
                        <p><strong>üìù ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${farmData.usage.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                        <p><strong>üí∞ ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${farmData.sales.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                        <p><strong>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å:</strong> ${getWarningItems().length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getWarningItems() {
    const warnings = [];
    
    farmData.feeds.forEach(feed => {
        const status = getStockStatus(feed.quantity, 'feed');
        const isExpired = feed.expiryDate && new Date(feed.expiryDate) <= new Date();
        if (status !== 'normal' || isExpired) {
            warnings.push(feed);
        }
    });
    
    farmData.medical.forEach(med => {
        const status = getStockStatus(med.quantity, 'medical');
        const isExpired = med.expiryDate && new Date(med.expiryDate) <= new Date();
        if (status !== 'normal' || isExpired) {
            warnings.push(med);
        }
    });
    
    return warnings;
}
        function generateStockReport(container) {
    const totalFeedValue = farmData.feeds.reduce((sum, feed) => sum + (feed.quantity * feed.price), 0);
    const totalMedicalValue = farmData.medical.reduce((sum, med) => sum + (med.quantity * med.price), 0);
    const lowStockItems = getWarningItems();

    container.innerHTML = `
        <div class="card">
            <div class="card-title">üì¶ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏±‡∏á</div>
            <div class="form-grid">
                <div>
                    <h4>üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</h4>
                    <p><strong>üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</strong> ${totalFeedValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üíä ‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô:</strong> ${totalMedicalValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üíµ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${(totalFeedValue + totalMedicalValue).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div>
                    <h4>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å</h4>
                    <p><strong>üåæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</strong> ${farmData.feeds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    <p><strong>üíä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤:</strong> ${farmData.medical.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    <p><strong>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°:</strong> ${lowStockItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
            </div>

            ${lowStockItems.length > 0 ? generateStockWarningTable(lowStockItems) : ''}
            ${generateStockDetailTable()}
        </div>
    `;
}

function generateStockWarningTable(items) {
    let html = `
        <div style="margin-top: 20px;">
            <h4>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</h4>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>üì¶ ‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th>üî¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th>‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    items.forEach(item => {
        const isFood = item.hasOwnProperty('brand');
        const status = getStockStatus(item.quantity, isFood ? 'feed' : 'medical');
        const isExpired = item.expiryDate && new Date(item.expiryDate) <= new Date();
        const statusText = isExpired ? 'üî¥ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : (status === 'empty' ? 'üî¥ ‡∏´‡∏°‡∏î' : 'üü° ‡∏ï‡πà‡∏≥');
        const typeIcon = isFood ? 'üåæ' : 'üíä';
        const expiryText = item.expiryDate ? new Date(item.expiryDate).toLocaleDateString('th-TH') : '-';

        html += `
            <tr>
                <td>${typeIcon} ${isFood ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£' : '‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô'}</td>
                <td>${isFood ? item.brand : item.name}</td>
                <td>${item.quantity} ${isFood ? '‡∏Å‡∏Å.' : item.unit}</td>
                <td>${statusText}</td>
                <td>${expiryText}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div></div>';
    return html;
}

function generateStockDetailTable() {
    return `
        <div style="margin-top: 20px;">
            <h4>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <h5>üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h5>
            ${generateFeedStockTable()}
            
            <h5 style="margin-top: 20px;">üíä ‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h5>
            ${generateMedicalStockTable()}
        </div>
    `;
}

function generateFeedStockTable() {
    if (farmData.feeds.length === 0) {
        return '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>';
    }

    const feedTypes = {
        'prestarter': 'Pre-Starter',
        'starter': 'Starter',
        'grower': 'Grower',
        'finisher': 'Finisher',
        'sow': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
        'boar': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå'
    };

    let html = `
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th>
                        <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
                        <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th>
                        <th>% ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody>
    `;

    farmData.feeds.forEach(feed => {
        const usagePercentage = ((feed.originalQuantity - feed.quantity) / feed.originalQuantity * 100).toFixed(1);
        const value = feed.quantity * feed.price;
        const status = getStockStatus(feed.quantity, 'feed');
        const statusText = status === 'empty' ? 'üî¥ ‡∏´‡∏°‡∏î' : (status === 'low' ? 'üü° ‡∏ï‡πà‡∏≥' : 'üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥');

        html += `
            <tr>
                <td>${feedTypes[feed.type]}</td>
                <td>${feed.brand}</td>
                <td>${feed.quantity} ‡∏Å‡∏Å.</td>
                <td>${feed.price} ‡∏ö‡∏≤‡∏ó</td>
                <td>${value.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                <td>${usagePercentage}%</td>
                <td>${statusText}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    return html;
}

function generateMedicalStockTable() {
    if (farmData.medical.length === 0) {
        return '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</p>';
    }

    const medicalTypes = {
        'vaccine': '‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô',
        'antibiotic': '‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞',
        'vitamin': '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô',
        'deworming': '‡∏¢‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ò‡∏¥',
        'hormone': '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô',
        'supplement': '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°',
        'disinfectant': '‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠'
    };

    let html = `
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th>
                        <th>% ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody>
    `;

    farmData.medical.forEach(med => {
        const usagePercentage = ((med.originalQuantity - med.quantity) / med.originalQuantity * 100).toFixed(1);
        const value = med.quantity * med.price;
        const status = getStockStatus(med.quantity, 'medical');
        const statusText = status === 'empty' ? 'üî¥ ‡∏´‡∏°‡∏î' : (status === 'low' ? 'üü° ‡∏ï‡πà‡∏≥' : 'üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥');

        html += `
            <tr>
                <td>${medicalTypes[med.type]}</td>
                <td>${med.name}</td>
                <td>${med.quantity} ${med.unit}</td>
                <td>${med.price} ‡∏ö‡∏≤‡∏ó</td>
                <td>${value.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                <td>${usagePercentage}%</td>
                <td>${statusText}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    return html;
}

function generateUsageReport(container) {
    const last30Days = new Date();
    last30Days.setDate(last30Days.getDate() - 30);
    const last30DaysStr = last30Days.toISOString().split('T')[0];

    const recentUsage = farmData.usage.filter(usage => usage.date >= last30DaysStr);
    const feedUsage = recentUsage.filter(u => u.type === 'feed');
    const medicalUsage = recentUsage.filter(u => u.type === 'medical');

    const totalFeedUsed = feedUsage.reduce((sum, u) => sum + u.amount, 0);
    const totalMedicalUsed = medicalUsage.reduce((sum, u) => sum + u.amount, 0);
    const avgFeedPerDay = totalFeedUsed / 30;

    // Group usage by date
    const usageByDate = {};
    recentUsage.forEach(usage => {
        if (!usageByDate[usage.date]) {
            usageByDate[usage.date] = { feed: 0, medical: 0, items: [] };
        }
        if (usage.type === 'feed') {
            usageByDate[usage.date].feed += usage.amount;
        } else {
            usageByDate[usage.date].medical += usage.amount;
        }
        usageByDate[usage.date].items.push(usage);
    });

    const sortedDates = Object.keys(usageByDate).sort().reverse();

    container.innerHTML = `
        <div class="card">
            <div class="card-title">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div>
            <div class="form-grid" style="margin-bottom: 30px;">
                <div>
                    <h4>üåæ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h4>
                    <p><strong>‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°:</strong> ${totalFeedUsed.toLocaleString()} ‡∏Å‡∏Å.</p>
                    <p><strong>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô:</strong> ${avgFeedPerDay.toFixed(1)} ‡∏Å‡∏Å.</p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${feedUsage.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                </div>
                <div>
                    <h4>üíä ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h4>
                    <p><strong>‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°:</strong> ${totalMedicalUsed.toLocaleString()} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                    <p><strong>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô:</strong> ${(totalMedicalUsed / 30).toFixed(1)} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${medicalUsage.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                </div>
            </div>

            ${generateUsageChart(usageByDate, sortedDates)}
            ${generateDetailedUsageTable(sortedDates, usageByDate)}
        </div>
    `;
}

function generateUsageChart(usageByDate, sortedDates) {
    // Simple text-based chart for recent 7 days
    const recent7Days = sortedDates.slice(0, 7);
    let chartHtml = `
        <div style="margin-top: 20px;">
            <h4>üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
            <div style="background: var(--bg-primary); padding: 20px; border-radius: var(--border-radius); margin-top: 15px;">
    `;

    recent7Days.forEach(date => {
        const data = usageByDate[date];
        const feedPercent = Math.min((data.feed / 100) * 100, 100); // Scale to max 100kg
        const dateStr = new Date(date).toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
        
        chartHtml += `
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 600;">${dateStr}</span>
                    <span>${data.feed.toFixed(1)} ‡∏Å‡∏Å. | ${data.medical} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                </div>
                <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, var(--accent-color), var(--success-color)); height: 100%; width: ${feedPercent}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    });

    chartHtml += '</div></div>';
    return chartHtml;
}

function generateDetailedUsageTable(sortedDates, usageByDate) {
    if (sortedDates.length === 0) {
        return '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>';
    }

    let html = `
        <div style="margin-top: 30px;">
            <h4>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</h4>
            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏Å‡∏Å.)</th>
                            <th>üíä ‡∏¢‡∏≤ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th>
                            <th>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                            <th>üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    sortedDates.forEach(date => {
        const data = usageByDate[date];
        const formattedDate = new Date(date).toLocaleDateString('th-TH');

        html += `
            <tr>
                <td>${formattedDate}</td>
                <td>${data.feed.toFixed(1)} ‡∏Å‡∏Å.</td>
                <td>${data.medical} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
                <td>${data.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                <td>
                    <button class="btn btn-small btn-secondary" onclick="showDayDetails('${date}')">üìÑ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div></div>';
    return html;
}

function showDayDetails(date) {
    const dayUsage = farmData.usage.filter(usage => usage.date === date);
    const formattedDate = new Date(date).toLocaleDateString('th-TH');
    
    let details = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate}\n\n`;
    
    dayUsage.forEach((usage, index) => {
        const time = new Date(usage.time).toLocaleTimeString('th-TH');
        const typeText = usage.type === 'feed' ? 'üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£' : 'üíä ‡∏¢‡∏≤/‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô';
        
        details += `${index + 1}. ${time} - ${typeText}\n`;
        details += `   ${usage.itemName}\n`;
        details += `   ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${usage.amount} ${usage.unit}\n`;
        if (usage.notes) {
            details += `   ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${usage.notes}\n`;
        }
        details += '\n';
    });
    
    const totalFeed = dayUsage.filter(u => u.type === 'feed').reduce((sum, u) => sum + u.amount, 0);
    const totalMedical = dayUsage.filter(u => u.type === 'medical').length;
    
    details += `‡∏™‡∏£‡∏∏‡∏õ:\n`;
    details += `üåæ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡∏ß‡∏°: ${totalFeed} ‡∏Å‡∏Å.\n`;
    details += `üíä ‡∏¢‡∏≤‡∏£‡∏ß‡∏°: ${totalMedical} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n`;
    details += `üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${dayUsage.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    
    alert(details);
}

function generateFinancialReport(container) {
    const totalSales = farmData.sales.reduce((sum, sale) => sum + sale.netRevenue, 0);
    const feedCosts = farmData.feeds.reduce((sum, feed) => sum + (feed.originalQuantity * feed.price), 0);
    const medicalCosts = farmData.medical.reduce((sum, med) => sum + (med.originalQuantity * med.price), 0);
    const totalCosts = feedCosts + medicalCosts;
    const profit = totalSales - totalCosts;
    const profitMargin = totalSales > 0 ? (profit / totalSales * 100).toFixed(2) : 0;
    const roi = totalCosts > 0 ? (profit / totalCosts * 100).toFixed(2) : 0;

    // Monthly breakdown
    const monthlyData = calculateMonthlyFinancials();

    container.innerHTML = `
        <div class="card">
            <div class="card-title">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
            <div class="form-grid">
                <div>
                    <h4>üíµ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h4>
                    <p><strong>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</strong> ${totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</strong> ${farmData.sales.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    <p><strong>üíµ ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</strong> ${farmData.sales.length > 0 ? (totalSales / farmData.sales.length).toLocaleString() : 0} ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div>
                    <h4>üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h4>
                    <p><strong>üåæ ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</strong> ${feedCosts.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üíä ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô:</strong> ${medicalCosts.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p><strong>üí≥ ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢:</strong> ${totalCosts.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</h4>
                <div class="form-grid">
                    <div>
                        <p><strong>üíé ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong> <span style="color: ${profit >= 0 ? 'green' : 'red'}">${profit.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></p>
                        <p><strong>üìä ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£:</strong> <span style="color: ${profitMargin >= 0 ? 'green' : 'red'}">${profitMargin}%</span></p>
                    </div>
                    <div>
                        <p><strong>üìà ROI:</strong> <span style="color: ${roi >= 0 ? 'green' : 'red'}">${roi}%</span></p>
                        <p><strong>üìã ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</strong> ${totalSales > 0 ? (totalCosts / totalSales * 100).toFixed(2) : 0}%</p>
                    </div>
                </div>
            </div>

            ${generateMonthlyFinancialTable(monthlyData)}
        </div>
    `;
}

function calculateMonthlyFinancials() {
    const monthlyData = {};
    
    // Process sales by month
    farmData.sales.forEach(sale => {
        const monthKey = sale.date.substring(0, 7); // YYYY-MM
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { revenue: 0, feedCost: 0, medicalCost: 0, sales: 0 };
        }
        monthlyData[monthKey].revenue += sale.netRevenue;
        monthlyData[monthKey].sales++;
    });
    
    // Note: For simplicity, we'll distribute costs evenly across months
    // In a real system, you'd want to track purchase dates more precisely
    const months = Object.keys(monthlyData).sort();
    if (months.length > 0) {
        const totalFeedCost = farmData.feeds.reduce((sum, feed) => sum + (feed.originalQuantity * feed.price), 0);
        const totalMedicalCost = farmData.medical.reduce((sum, med) => sum + (med.originalQuantity * med.price), 0);
        const feedCostPerMonth = totalFeedCost / months.length;
        const medicalCostPerMonth = totalMedicalCost / months.length;
        
        months.forEach(month => {
            monthlyData[month].feedCost = feedCostPerMonth;
            monthlyData[month].medicalCost = medicalCostPerMonth;
        });
    }
    
    return monthlyData;
}

function generateMonthlyFinancialTable(monthlyData) {
    const months = Object.keys(monthlyData).sort().reverse();
    
    if (months.length === 0) {
        return '<p style="margin-top: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>';
    }

    let html = `
        <div style="margin-top: 20px;">
            <h4>üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                            <th>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                            <th>üåæ ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                            <th>üíä ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤</th>
                            <th>üíé ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
                            <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    months.forEach(month => {
        const data = monthlyData[month];
        const totalCost = data.feedCost + data.medicalCost;
        const profit = data.revenue - totalCost;
        const monthName = new Date(month + '-01').toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });

        html += `
            <tr>
                <td>${monthName}</td>
                <td>${data.revenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                <td>${data.feedCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                <td>${data.medicalCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                <td style="color: ${profit >= 0 ? 'green' : 'red'}">${profit.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                <td>${data.sales} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
            </tr>
        `;
    });

    html += '</tbody></table></div></div>';
    return html;
}

function generateLivestockReport(container) {
    const totalPigs = farmData.pigs.reduce((sum, pig) => sum + pig.quantity, 0);
    const pigsByType = {};
    
    farmData.pigs.forEach(pig => {
        if (!pigsByType[pig.type]) {
            pigsByType[pig.type] = { count: 0, total: 0, avgWeight: 0, avgAge: 0 };
        }
        pigsByType[pig.type].count++;
        pigsByType[pig.type].total += pig.quantity;
        pigsByType[pig.type].avgWeight += pig.weight || 0;
        pigsByType[pig.type].avgAge += pig.age || 0;
    });

    // Calculate averages
    Object.keys(pigsByType).forEach(type => {
        const data = pigsByType[type];
        data.avgWeight = data.count > 0 ? (data.avgWeight / data.count).toFixed(1) : 0;
        data.avgAge = data.count > 0 ? (data.avgAge / data.count).toFixed(0) : 0;
    });

    const typeNames = {
        'sow': 'üê∑ ‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
        'boar': 'üêó ‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
        'piglet': 'üêΩ ‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£',
        'grower': 'üê∑ ‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô',
        'finisher': 'ü•© ‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô'
    };

    container.innerHTML = `
        <div class="card">
            <div class="card-title">üê∑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Å‡∏£</div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>üê∑ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏∏‡∏Å‡∏£</th>
                            <th>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
                            <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</th>
                            <th>üìä ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                            <th>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                            <th>üìÖ ‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    Object.keys(pigsByType).forEach(type => {
        const data = pigsByType[type];
        const percentage = totalPigs > 0 ? (data.total / totalPigs * 100).toFixed(1) : 0;

        html += `
            <tr>
                <td>${typeNames[type]}</td>
                <td>${data.count}</td>
                <td>${data.total}</td>
                <td>${percentage}%</td>
                <td>${data.avgWeight} ‡∏Å‡∏Å.</td>
                <td>${data.avgAge} ‡∏ß‡∏±‡∏ô</td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 20px;">
        <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏∏‡∏Å‡∏£</h4>
        <div class="form-grid">
            <div>
                <p><strong>üê∑ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${totalPigs} ‡∏ï‡∏±‡∏ß</p>
                <p><strong>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${farmData.pigs.length} ‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
                <p><strong>üè≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</strong> ${farmData.pigs.length > 0 ? (totalPigs / farmData.pigs.length).toFixed(1) : 0} ‡∏ï‡∏±‡∏ß/‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
            </div>
            <div>
                <p><strong>üìà ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï:</strong> ${calculateGrowthRate()}%/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                <p><strong>üéØ ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ü‡∏≤‡∏£‡πå‡∏°:</strong> ${calculateFarmEfficiency()}%</p>
                <p><strong>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${calculateTotalWeight()} ‡∏Å‡∏Å.</p>
            </div>
        </div>
    </div>
</div>
    `;
}

function calculateGrowthRate() {
    // Simple calculation based on entry dates
    if (farmData.pigs.length === 0) return 0;
    
    const now = new Date();
    const monthsInFarm = farmData.pigs.map(pig => {
        const entryDate = new Date(pig.entryDate);
        return (now - entryDate) / (1000 * 60 * 60 * 24 * 30); // Convert to months
    });
    
    const avgMonthsInFarm = monthsInFarm.reduce((sum, months) => sum + months, 0) / monthsInFarm.length;
    return avgMonthsInFarm > 0 ? (10 / avgMonthsInFarm).toFixed(1) : 0; // Simplified growth rate
}

function calculateFarmEfficiency() {
    // Based on stock levels, usage patterns, and sales
    let efficiency = 100;
    
    // Penalize for low stock
    const lowStockItems = getWarningItems();
    efficiency -= (lowStockItems.length * 5);
    
    // Penalize for expired items
    const expiredItems = lowStockItems.filter(item => 
        item.expiryDate && new Date(item.expiryDate) <= new Date()
   );
   efficiency -= (expiredItems.length * 10);
   
   // Reward for regular usage
   const recentUsage = farmData.usage.filter(usage => {
       const usageDate = new Date(usage.date);
       const weekAgo = new Date();
       weekAgo.setDate(weekAgo.getDate() - 7);
       return usageDate >= weekAgo;
   });
   
   if (recentUsage.length > 0) efficiency += 5;
   
   // Reward for sales activity
   const recentSales = farmData.sales.filter(sale => {
       const saleDate = new Date(sale.date);
       const monthAgo = new Date();
       monthAgo.setDate(monthAgo.getDate() - 30);
       return saleDate >= monthAgo;
   });
   
   if (recentSales.length > 0) efficiency += 10;
   
   return Math.max(0, Math.min(100, efficiency)).toFixed(1);
}

function calculateTotalWeight() {
   return farmData.pigs.reduce((sum, pig) => {
       const avgWeight = pig.weight || 0;
       return sum + (avgWeight * pig.quantity);
   }, 0).toFixed(1);
}

function generateSalesReport(container) {
   const salesByType = {};
   let totalRevenue = 0;
   let totalQuantity = 0;
   let totalWeight = 0;

   farmData.sales.forEach(sale => {
       if (!salesByType[sale.type]) {
           salesByType[sale.type] = { 
               quantity: 0, 
               revenue: 0, 
               count: 0, 
               weight: 0,
               avgPrice: 0 
           };
       }
       salesByType[sale.type].quantity += sale.quantity;
       salesByType[sale.type].revenue += sale.netRevenue;
       salesByType[sale.type].count++;
       salesByType[sale.type].weight += sale.weight;
       totalRevenue += sale.netRevenue;
       totalQuantity += sale.quantity;
       totalWeight += sale.weight;
   });

   // Calculate average prices
   Object.keys(salesByType).forEach(type => {
       const data = salesByType[type];
       data.avgPrice = data.weight > 0 ? (data.revenue / data.weight).toFixed(2) : 0;
   });

   const saleTypes = {
       'piglet': 'üêΩ ‡∏•‡∏π‡∏Å‡∏™‡∏∏‡∏Å‡∏£',
       'grower': 'üê∑ ‡∏™‡∏∏‡∏Å‡∏£‡∏£‡∏∏‡πà‡∏ô',
       'finisher': 'ü•© ‡∏™‡∏∏‡∏Å‡∏£‡∏Ç‡∏∏‡∏ô',
       'sow': 'üê∑ ‡πÅ‡∏°‡πà‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
       'boar': 'üêó ‡∏û‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå'
   };

   container.innerHTML = `
       <div class="card">
           <div class="card-title">üí∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
           <div class="table-container">
               <table class="table">
                   <thead>
                       <tr>
                           <th>üê∑ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏∏‡∏Å‡∏£</th>
                           <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</th>
                           <th>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°</th>
                           <th>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)</th>
                           <th>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Å‡∏Å.</th>
                           <th>üìä ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                       </tr>
                   </thead>
                   <tbody>
   `;

   Object.keys(salesByType).forEach(type => {
       const data = salesByType[type];
       const percentage = totalRevenue > 0 ? (data.revenue / totalRevenue * 100).toFixed(1) : 0;

       html += `
           <tr>
               <td>${saleTypes[type]}</td>
               <td>${data.quantity}</td>
               <td>${data.weight.toFixed(1)} ‡∏Å‡∏Å.</td>
               <td>${data.revenue.toLocaleString()}</td>
               <td>${data.avgPrice} ‡∏ö‡∏≤‡∏ó</td>
               <td>${percentage}%</td>
           </tr>
       `;
   });

   html += `
           </tbody>
       </table>
   </div>
   
   <div style="margin-top: 20px;">
       <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
       <div class="form-grid">
           <div>
               <p><strong>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°:</strong> ${totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
               <p><strong>üê∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</strong> ${totalQuantity} ‡∏ï‡∏±‡∏ß</p>
               <p><strong>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°:</strong> ${totalWeight.toFixed(1)} ‡∏Å‡∏Å.</p>
           </div>
           <div>
               <p><strong>üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢:</strong> ${farmData.sales.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
               <p><strong>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏Å.:</strong> ${totalWeight > 0 ? (totalRevenue / totalWeight).toFixed(2) : 0} ‡∏ö‡∏≤‡∏ó</p>
               <p><strong>üéØ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß:</strong> ${totalQuantity > 0 ? (totalRevenue / totalQuantity).toFixed(0) : 0} ‡∏ö‡∏≤‡∏ó</p>
           </div>
       </div>
   </div>

   ${generateSalesTrendTable()}
</div>
   `;
}

function generateSalesTrendTable() {
   if (farmData.sales.length === 0) {
       return '<p style="margin-top: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>';
   }

   // Group sales by month
   const salesByMonth = {};
   farmData.sales.forEach(sale => {
       const monthKey = sale.date.substring(0, 7); // YYYY-MM
       if (!salesByMonth[monthKey]) {
           salesByMonth[monthKey] = {
               revenue: 0,
               quantity: 0,
               count: 0,
               avgPrice: 0
           };
       }
       salesByMonth[monthKey].revenue += sale.netRevenue;
       salesByMonth[monthKey].quantity += sale.quantity;
       salesByMonth[monthKey].count++;
   });

   // Calculate average prices
   Object.keys(salesByMonth).forEach(month => {
       const data = salesByMonth[month];
       data.avgPrice = data.quantity > 0 ? (data.revenue / data.quantity).toFixed(0) : 0;
   });

   const months = Object.keys(salesByMonth).sort().reverse();

   let html = `
       <div style="margin-top: 20px;">
           <h4>üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
           <div class="table-container">
               <table class="table">
                   <thead>
                       <tr>
                           <th>üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                           <th>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                           <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</th>
                           <th>üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                           <th>üíµ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ï‡∏±‡∏ß</th>
                       </tr>
                   </thead>
                   <tbody>
   `;

   months.forEach(month => {
       const data = salesByMonth[month];
       const monthName = new Date(month + '-01').toLocaleDateString('th-TH', { 
           year: 'numeric', 
           month: 'long' 
       });

       html += `
           <tr>
               <td>${monthName}</td>
               <td>${data.revenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
               <td>${data.quantity} ‡∏ï‡∏±‡∏ß</td>
               <td>${data.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
               <td>${data.avgPrice} ‡∏ö‡∏≤‡∏ó</td>
           </tr>
       `;
   });

   html += '</tbody></table></div></div>';
   return html;
}

function exportReport() {
   const reportType = document.getElementById('reportType').value;
   const reportData = {
       exportDate: new Date().toISOString(),
       reportType: reportType,
       version: SYSTEM_VERSION,
       farmData: farmData,
       summary: {
           totalPigs: farmData.pigs.reduce((sum, pig) => sum + pig.quantity, 0),
           totalSales: farmData.sales.reduce((sum, sale) => sum + sale.netRevenue, 0),
           totalStockValue: farmData.feeds.reduce((sum, feed) => sum + (feed.quantity * feed.price), 0) +
                          farmData.medical.reduce((sum, med) => sum + (med.quantity * med.price), 0),
           lowStockItems: getWarningItems().length,
           efficiency: calculateFarmEfficiency()
       },
       statistics: farmSystemData.statistics
   };

   const blob = new Blob([JSON.stringify(reportData, null, 2)], {type: 'application/json'});
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = `pig-farm-${reportType}-report-${new Date().toISOString().split('T')[0]}.json`;
   a.click();
   URL.revokeObjectURL(url);

   showAlert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
}

// === Enhanced Data Management Functions ===
function exportSystemData() {
   const exportData = {
       ...farmSystemData,
       exportDate: new Date().toISOString(),
       exportVersion: SYSTEM_VERSION,
       deviceInfo: {
           userAgent: navigator.userAgent,
           platform: navigator.platform,
           language: navigator.language,
           standalone: isStandalone
       }
   };

   const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = `pig-farm-complete-data-v${SYSTEM_VERSION}-${new Date().toISOString().split('T')[0]}.json`;
   a.click();
   URL.revokeObjectURL(url);

   showAlert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
}

function importBackupData(fileInput) {
   const file = fileInput.files[0];
   if (!file) return;

   const reader = new FileReader();
   reader.onload = function(e) {
       try {
           const importedData = JSON.parse(e.target.result);
           const migratedData = migrateData(importedData);
           
           if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå:\n- ‡∏™‡∏∏‡∏Å‡∏£: ${migratedData.farmData.pigs?.length || 0} ‡∏Å‡∏•‡∏∏‡πà‡∏°\n- ‡∏≠‡∏≤‡∏´‡∏≤‡∏£: ${migratedData.farmData.feeds?.length || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n- ‡∏¢‡∏≤: ${migratedData.farmData.medical?.length || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n- ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: ${migratedData.farmData.sales?.length || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`)) {
               
               farmSystemData = migratedData;
               farmData = migratedData.farmData;
               saveAllData();
               
               // Refresh all displays
               updateOverview();
               updateUsageSelects();
               checkStockLevels();
               
               showAlert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ${file.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
               
               setTimeout(() => location.reload(), 1500);
           }
       } catch (error) {
           showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå', 'error');
           console.error('Import error:', error);
       }
   };

   reader.readAsText(file);
}

function viewBackupHistory() {
   const backupKeys = [];
   for (let i = 0; i < localStorage.length; i++) {
       const key = localStorage.key(i);
       if (key.startsWith(`${STORAGE_KEY}_backup_`)) {
           backupKeys.push(key);
       }
   }

   if (backupKeys.length === 0) {
       showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
       return;
   }

   let message = '‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö:\n\n';
   backupKeys.forEach(key => {
       const timestamp = key.replace(`${STORAGE_KEY}_backup_`, '');
       const date = new Date(timestamp.replace(/-/g, ':')).toLocaleString('th-TH');
       message += `‚Ä¢ ${date}\n`;
   });

   message += '\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
   
   if (confirm(message)) {
       const latestBackupKey = backupKeys.sort().pop();
       const backupData = localStorage.getItem(latestBackupKey);
       
       if (backupData) {
           const blob = new Blob([backupData], {type: 'application/json'});
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `${latestBackupKey.replace(`${STORAGE_KEY}_`, '')}.json`;
           a.click();
           URL.revokeObjectURL(url);
           
           showAlert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
       }
   }
}

function addDataManagementSection() {
   const overviewSection = document.getElementById('overview');
   const dataManagementHTML = `
       <div class="card">
           <div class="card-title">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏£‡∏≠‡∏á</div>
           <div class="form-grid">
               <div>
                   <h4>‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h4>
                   <p><strong>üì± ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô:</strong> ${farmSystemData.version}</p>
                   <p><strong>üïê ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${new Date(farmSystemData.lastUpdate).toLocaleString('th-TH')}</p>
                   ${farmSystemData.previousVersion ? `<p><strong>‚¨ÜÔ∏è ‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡∏à‡∏≤‡∏Å:</strong> ${farmSystemData.previousVersion}</p>` : ''}
                   ${isStandalone ? '<p><strong>üì± ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span style="color: #27ae60;">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span></p>' : '<p><strong>üåê ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span style="color: #f39c12;">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ß‡πá‡∏ö</span></p>'}
                   <p><strong>üìä ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û:</strong> ${calculateFarmEfficiency()}%</p>
               </div>
               <div>
                   <h4>üîß ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                   <button class="btn btn-primary" onclick="exportSystemData()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                   <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackupData(this)">
                   <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                   <button class="btn btn-warning" onclick="viewBackupHistory()">üìã ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏£‡∏≠‡∏á</button>
                   <button class="btn btn-danger" onclick="resetSystemData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
               </div>
           </div>
       </div>
   `;

   const statsGrid = overviewSection.querySelector('.stats-grid');
   if (statsGrid) {
       statsGrid.insertAdjacentHTML('afterend', dataManagementHTML);
   }
}

function resetSystemData() {
   if (confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö:\n‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Å‡∏£\n‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£\n‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤\n‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô\n‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
       if (confirm('üö® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£!\n\n‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
           // Create backup before reset
           exportSystemData();
           
           // Reset to default
           farmSystemData = JSON.parse(JSON.stringify(DEFAULT_DATA_STRUCTURE));
           farmData = farmSystemData.farmData;
           
           saveAllData();
           
           showAlert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
           
           setTimeout(() => location.reload(), 2000);
       }
   }
}

// === System Initialization ===
function setDefaultDates() {
   const today = new Date().toISOString().split('T')[0];
   document.getElementById('pigEntryDate').value = today;
   document.getElementById('feedPurchaseDate').value = today;
   document.getElementById('medicalPurchaseDate').value = today;
   document.getElementById('saleDate').value = today;
}

// === Enhanced Mobile Optimizations ===
function optimizeForMobile() {
   // Handle virtual keyboard
   document.addEventListener('focusin', function(e) {
       if (e.target.matches('input, select, textarea')) {
           setTimeout(() => {
               e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
           }, 300);
       }
   });

   // Haptic feedback
   function hapticFeedback() {
       if (navigator.vibrate) {
           navigator.vibrate(50);
       }
   }

   document.addEventListener('click', function(e) {
       if (e.target.matches('.btn, .nav-tab')) {
           hapticFeedback();
       }
   });

   // Smooth scrolling
   document.body.style.webkitOverflowScrolling = 'touch';

   // Auto-hide address bar on mobile
   setTimeout(function() {
       window.scrollTo(0, 1);
   }, 100);

   // Handle orientation changes
   window.addEventListener('orientationchange', function() {
       setTimeout(handleViewportChange, 500);
   });
}

// === Enhanced Install Instructions ===
function showInstallInstructions() {
   const userAgent = navigator.userAgent.toLowerCase();
   let instructions = '';

   if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
       instructions = `üì± ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô iOS:
1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Share (üì§) ‡πÉ‡∏ô Safari
2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏°" 
3. ‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
4. ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏°

‚ú® ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á:
- ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ
- ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
- ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ‡∏à‡∏£‡∏¥‡∏á`;

   } else if (userAgent.includes('android')) {
       instructions = `üì± ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô Android:
1. ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π (‚ãÆ) ‡πÉ‡∏ô Chrome
2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Add to Home screen"
3. ‡∏Å‡∏î "Add" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
4. ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏°

‚ú® ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á:
- ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ
- ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
- ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ‡∏à‡∏£‡∏¥‡∏á`;

   } else {
       instructions = `üíª ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå:
1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚äï ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö URL (Chrome)
2. ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π ‚Üí "Install app"
3. ‡∏Å‡∏î "Install" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
4. ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏¢‡∏Å

‚ú® ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á:
- ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ
- ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Start Menu/Dock
- ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á`;
   }

   alert(instructions);
}

// Auto-save every 30 seconds
setInterval(saveAllData, 30000);

// Handle online/offline status
window.addEventListener('online', function() {
   showAlert('üåê ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
});

window.addEventListener('offline', function() {
   showAlert('üì¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡πÅ‡∏ï‡πà‡πÅ‡∏≠‡∏õ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'warning');
});

// PWA update detection
if ('serviceWorker' in navigator) {
   navigator.serviceWorker.addEventListener('controllerchange', function() {
       if (confirm('üîÑ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
           window.location.reload();
       }
   });
}

// Enhanced error handling
window.addEventListener('error', function(e) {
   console.error('App Error:', e.error);
   showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
});

window.addEventListener('unhandledrejection', function(e) {
   console.error('Unhandled Promise Rejection:', e.reason);
   showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
});

// === Final System Initialization ===
document.addEventListener('DOMContentLoaded', function() {
   console.log('üöÄ Initializing Pig Farm Management System...');
   
   // Load data and initialize
   loadAllData();
   updateOverview();
   updateUsageSelects();
   checkStockLevels();
   setDefaultDates();
   addDataManagementSection();
   optimizeForMobile();
   
   // Hide install button if already standalone
   if (isStandalone) {
       const installBtn = document.getElementById('manualInstall');
       if (installBtn) installBtn.style.display = 'none';
   }
   
   console.log('‚úÖ System initialized successfully');
   console.log(`üì± Version: ${SYSTEM_VERSION}`);
   console.log(`üîß Features: Pig Management, Feed/Medical Stock, Usage Tracking, Sales, Reports, PWA, Mobile Optimized`);
   console.log(`üì≤ PWA Status: ${isStandalone ? 'Installed App' : 'Web Browser'}`);
   console.log(`üìä Farm Efficiency: ${calculateFarmEfficiency()}%`);
   
   // Show welcome message for new users
   if (farmData.pigs.length === 0 && farmData.feeds.length === 0 && farmData.medical.length === 0) {
       setTimeout(() => {
           showAlert('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏Å‡∏£! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 'success');
       }, 1000);
   }
});

console.log('üéâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏Å‡∏£ Mobile App ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
console.log(`üì± Enhanced Version: ${SYSTEM_VERSION}`);
console.log('üîß Features: Responsive Navigation, Enhanced PWA, Advanced Reports, Data Management, Mobile Optimized');
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-in ‡∏ô‡∏¥‡∏™‡∏¥‡∏ï</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h1>
  <p id="user-info"></p>
  <button id="login-btn">üîê Login ‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ @up.ac.th</button>
  <button id="logout-btn" style="display:none;">Logout</button>
  <p id="result"></p>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDeD73Yg2QhPXl0dD40uvCsVejpf38OYeY",
      authDomain: "qr-checkin-up.firebaseapp.com",
      projectId: "qr-checkin-up",
      storageBucket: "qr-checkin-up.firebasestorage.app",
      messagingSenderId: "780428257804",
      appId: "1:780428257804:web:31b68ff043623144679c29"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const studentList = ["65011610", "65011621", "65011632", "65011643", "65011665", "65011687", "65011698", "65012464", "65012778", "65072024", "65072025", "65072034", "65072046", "65072074", "65072081", "65072094", "65072100", "65072131", "65072148", "65072157", "65072158", "65072159", "65072170", "65072180", "65072206", "65077015", "66023670", "66070123", "66072004", "66072006", "66072011", "66072017", "66072018", "66072026", "66072044", "66072056", "66072075", "66072078", "66072096", "66072099", "66072104", "66072107", "66072108", "66072113", "66072116", "66072139", "66072148", "66072174", "66072175", "66072179", "66202196"]

    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const resultP = document.getElementById('result');
    const userInfo = document.getElementById('user-info');

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    let sessionId = "";

    if (token) {
      try {
        const decoded = JSON.parse(atob(token));
        sessionId = decoded.session;
      } catch (err) {
        resultP.textContent = "‚ùå Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
      }
    } else {
      resultP.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡πÉ‡∏ô URL";
    }

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async (user) => {
      if (user && user.email.endsWith('@up.ac.th')) {
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline';
        userInfo.textContent = `üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${user.email}`;

        const studentId = user.email.split('@')[0];
        if (!studentList.includes(studentId)) {
          resultP.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠";
          return;
        }

        if (!sessionId) {
          resultP.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö session ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠";
          return;
        }

        try {
          await db.collection("checkins").doc(sessionId).collection("students").doc(studentId).set({
            email: user.email,
            name: user.displayName,
            checkin_time: firebase.firestore.FieldValue.serverTimestamp()
          });
          resultP.textContent = "‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
        } catch (err) {
          resultP.textContent = "‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message;
        }
      } else {
        userInfo.textContent = "";
        loginBtn.style.display = 'inline';
        logoutBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>
